name: Auto Deploy Milestone Branch to Cloud Run

on:
  push:
    branches:
      - milestone/calendar-realtime-sync-nov2025
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies for smoke tests
        run: |
          python -m pip install --upgrade pip
          if [ -f smoke_requirements.txt ]; then
            pip install -r smoke_requirements.txt
          fi

      - name: Run smoke tests
        run: |
          if [ -d tests ]; then
            pytest -q tests || echo "âš ï¸  Smoke tests failed but continuing deployment"
          else
            echo "âš ï¸  No tests directory found, skipping tests"
          fi
        continue-on-error: true

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud config set run/region us-central1

      - name: Build and Deploy to Cloud Run
        run: |
          echo "ğŸ—ï¸  Submitting build to Cloud Build..."
          # cloudbuild.yaml handles both build and deploy
          # Use --async to avoid VPC-SC log permission issues
          BUILD_ID=$(gcloud builds submit --config=cloudbuild.yaml --async --format='value(id)')
          echo "Build ID: $BUILD_ID"

          # Wait for build to complete
          echo "â³ Waiting for build and deployment to complete..."
          gcloud builds log --stream $BUILD_ID || true  # Don't fail if we can't stream logs

          # Check build status
          BUILD_STATUS=$(gcloud builds describe $BUILD_ID --format='value(status)')
          if [ "$BUILD_STATUS" != "SUCCESS" ]; then
            echo "âŒ Build failed with status: $BUILD_STATUS"
            exit 1
          fi
          echo "âœ… Build and deployment completed successfully"

      - name: Get deployment URL
        id: get_url
        run: |
          URL=$(gcloud run services describe emailpilot-app --region us-central1 --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployment successful!"
          echo "ğŸŒ URL: $URL"

      - name: Health check
        run: |
          URL="${{ steps.get_url.outputs.url }}"
          echo "ğŸ¥ Running health check..."
          sleep 10
          curl -f "${URL}/health" || echo "âš ï¸  Health check failed"
          curl -f "${URL}/version" || echo "âš ï¸  Version check failed"
