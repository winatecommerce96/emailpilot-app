name: Preflight Deploy to Cloud Run (Manual)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "yes" to confirm deploy after tests'
        required: true
        default: 'no'
      service:
        description: 'Cloud Run service name'
        required: true
        default: 'emailpilot-app'
      region:
        description: 'Region'
        required: true
        default: 'us-central1'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}
      - uses: google-github-actions/setup-gcloud@v2
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install -r smoke_requirements.txt
      - name: Run smoke tests
        run: |
          pytest -q tests
      - name: Ensure confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "yes" ]; then echo "Confirmation required. Set confirm=yes." && exit 1; fi
      - name: Configure gcloud
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          gcloud config set run/region ${{ github.event.inputs.region }}
      - name: Build image with Cloud Build
        run: |
          IMAGE=gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ github.event.inputs.service }}:commit-${GITHUB_SHA::7}
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          gcloud builds submit --tag "$IMAGE"
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ github.event.inputs.service }} \
            --image "$IMAGE" \
            --platform managed \
            --region ${{ github.event.inputs.region }} \
            --allow-unauthenticated \
            --set-env-vars GOOGLE_CLOUD_PROJECT=${{ secrets.GCP_PROJECT_ID }}
