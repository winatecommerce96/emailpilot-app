# EmailPilot - Klaviyo Automation Platform

EmailPilot is a comprehensive FastAPI-based platform for automating Klaviyo email marketing campaigns, performance monitoring, and client management. The system features an integrated calendar for campaign planning, admin dashboard for system management, and Firebase integration for real-time data synchronization.

## Recent Architecture Updates (2025-08-12)

### âœ… Completed Reorganization
- **Single Entrypoint**: `main_firestore.py` is now the ONLY application entrypoint
- **Build System**: Frontend uses esbuild compilation (no more runtime Babel)
- **Static Assets**: All served from `/static/dist/` mount point (files in `frontend/public/dist/`)
- **Development Workflow**: Use `make` commands for all operations
- **Clean Structure**: Removed 400+ duplicate files and legacy code
- **Database**: Firestore-only (SQLAlchemy removed) - some routers temporarily disabled pending migration

### ðŸ”§ Latest Fixes (2025-08-12 Evening)
- **Dependencies**: All required packages in `requirements.txt` for Firestore-only operation
- **Virtual Environment**: Must use `.venv` (not conda) to avoid module conflicts
- **Static Paths**: All HTML files updated to use `/static/dist/` instead of relative `dist/`
- **Shell Issues**: Use proper quoting for paths with spaces, avoid complex pipes in zsh
- **API Testing**: Health and version endpoints confirmed working at `/health` and `/version`

## AI Team Configuration (autogenerated by team-configurator, 2025-08-12)

**Important: YOU MUST USE subagents when available for the task.**

### Detected Technology Stack
- **Backend Framework**: FastAPI (Python 3)
- **Database**: SQLAlchemy ORM with PostgreSQL/SQLite
- **Frontend Framework**: React (vanilla, loaded via CDN)
- **CSS Framework**: TailwindCSS
- **Cloud Services**: Google Cloud Platform (Secret Manager, Firestore, Firebase)
- **Authentication**: JWT with session management
- **File Storage**: Local filesystem with package upload system
- **API Integration**: Klaviyo REST API, Google APIs
- **Real-time Services**: Firebase/Firestore for calendar and data sync
- **Deployment**: Docker containerization, Google Cloud Run

### Specialist Assignments

| Task | Agent | Notes |
|------|-------|-------|
| **Admin Dashboard Components** | @react-component-architect | React component design for package upload UI, admin panels, and dashboard interfaces |
| **Backend Upload Handling** | @backend-developer | Python FastAPI endpoints for package upload, file processing, and deployment automation |
| **API Architecture & Endpoints** | @api-architect | RESTful API design for admin operations, package management, and system integration |
| **Database Operations** | @backend-developer | SQLAlchemy models for package tracking, deployment logs, and system state management |
| **File Storage Systems** | @backend-developer | Package storage, extraction, validation, and deployment pipeline implementation |
| **Frontend Dashboard UI** | @frontend-developer | User interface for admin controls, upload progress, and system monitoring |
| **Error Handling & Debugging** | @code-reviewer | Exception handling, logging, validation, and debugging system issues |
| **Performance & Optimization** | @performance-optimizer | Upload performance, database queries, and system resource optimization |

### Package Upload Functionality Focus Areas

#### 1. **Frontend Upload Interface** â†’ @react-component-architect
```javascript
// Current implementation needs enhancement for:
// - Better upload progress indicators
// - File validation and preview
// - Error state management
// - Package metadata display
```

#### 2. **Backend Upload Processing** â†’ @backend-developer
```python
# Key areas in main_firestore.py:
# - /api/admin/upload-package endpoint
# - File validation and extraction
# - Package deployment automation
# - Integration with existing system
```

#### 3. **Database Schema** â†’ @backend-developer
```sql
-- Potential tables needed:
-- packages (id, name, version, status, uploaded_at)
-- deployments (id, package_id, status, deployed_at, logs)
-- package_files (id, package_id, file_path, file_type)
```

#### 4. **File Management** â†’ @api-architect
```python
# File operations to optimize:
# - ZIP file extraction and validation
# - Package structure verification
# - Automatic backup before deployment
# - Rollback capabilities
```

### Current System Architecture

#### **FastAPI Backend Structure**
- `main_firestore.py` - SINGLE application entrypoint (all other main*.py files archived)
- `app/api/` - API route modules (14 routers: admin, auth, calendar, goals, performance, etc.)
- `app/models/` - SQLAlchemy database models
- `app/services/` - Business logic and external integrations
- `app/core/` - Configuration and database setup

#### **React Frontend Structure**
- `frontend/public/` - Static assets served at `/static`
- `frontend/public/dist/` - Compiled JavaScript bundles (esbuild)
- `frontend/public/components/` - React components (pre-compiled)
- Admin dashboard with package upload functionality
- Component-based architecture with state management
- TailwindCSS for responsive styling

#### **Development Commands**
```bash
make help        # Show all available commands
make dev         # Start development server (port 8000)
make dev-emu     # Start with Firestore emulator
make build       # Build frontend assets
make test        # Run tests
make deploy      # Deploy to Google Cloud Run
make validate    # Check development environment
```

#### **Key Integration Points**
- **Firebase/Firestore**: Real-time calendar and goals data
- **Google Cloud**: Secret Manager for secure configuration
- **Klaviyo API**: Performance data and campaign management (with live ping at `/api/admin/klaviyo/ping`)
- **Package System**: ZIP upload, extraction, and deployment
- **Health Monitoring**: `/health` and `/version` endpoints for production monitoring

### How to Use Your Team

- **For upload UI improvements**: "@react-component-architect enhance the package upload interface with better progress indicators and validation"
- **For backend processing**: "@backend-developer optimize the package extraction and deployment pipeline"
- **For API design**: "@api-architect design robust endpoints for package management with proper error handling"
- **For database operations**: "@backend-developer create database models for tracking package deployments"
- **For file operations**: "@backend-developer implement secure file validation and backup systems"
- **For performance**: "@performance-optimizer optimize upload handling for large packages"
- **For debugging**: "@code-reviewer investigate package upload failures and improve error reporting"

### Critical System Considerations

1. **Security**: Package uploads require validation to prevent malicious code execution
2. **Backup**: Automatic backup before any deployment to enable rollback
3. **Validation**: File type checking, structure validation, and dependency verification
4. **Monitoring**: Deployment logging and status tracking for admin visibility
5. **Performance**: Large file handling, progress tracking, and resource management
6. **Integration**: Seamless integration with existing EmailPilot components

### Important Development Notes

#### Always Use These Patterns:
- **Run Server**: Always use `uvicorn main_firestore:app --port 8000` (NOT main.py or other files)
- **Local Development URL**: ALWAYS use `http://localhost:8000` (NOT port 8080, 8001, or 127.0.0.1)
- **Static Files**: All frontend assets must be in `frontend/public/dist/` and served via `/static/dist/`
- **Build Frontend**: Run `make build` or `npm run build` before testing UI changes
- **API Prefixes**: All API routes use `/api/` prefix (e.g., `/api/admin`, `/api/auth`)
- **Environment**: Use `make dev-emu` for local Firestore emulator development
- **Virtual Environment**: Always activate `.venv` before running (NOT conda): `source .venv/bin/activate`

#### Common Issues & Solutions:
- **Wrong Port**: If you see port 8080 or 8001 errors, ensure using `http://localhost:8000`
- **Import Errors**: Ensure using `main_firestore.py` as entrypoint
- **404 on Static Files**: Check files are in `frontend/public/dist/` and HTML uses `/static/dist/` paths
- **API Connection Failed**: Verify using `http://localhost:8000` and all routers are included in `main_firestore.py`
- **CORS Issues**: CORS middleware is configured for localhost:8000 (NOT 8080 or other ports)
- **Missing Dependencies**: Run `pip install -r requirements.txt` in `.venv` (not conda)
- **ModuleNotFoundError**: You're likely in wrong environment - use `.venv`, not conda

#### Testing & Validation:
```bash
# Setup and run
source .venv/bin/activate  # IMPORTANT: Use venv, not conda
pip install -r requirements.txt  # Install all deps
make dev  # Start server on port 8000

# Quick health checks (use localhost:8000, NOT 127.0.0.1 or port 8080)
curl -s http://localhost:8000/health  # Should return {"status":"ok"}
curl -s http://localhost:8000/version  # Should return {"version":"1.0.0"}

# Validate setup
make validate    # Check your development environment
make test        # Run all tests
make health      # Check if server is running properly
```

#### Required Dependencies (Firestore-only):
```
fastapi>=0.112
google-cloud-firestore>=2.17
google-cloud-secret-manager>=2.16.0
uvicorn[standard]>=0.30
python-dotenv>=1.0
httpx>=0.24.0
pydantic>=2.0.0
pydantic-settings>=2.0.0
python-multipart>=0.0.6
itsdangerous>=2.2.0
jinja2>=3.1.0
pyjwt>=2.8.0
requests>=2.31.0
```

Your EmailPilot development team is ready to enhance the package upload functionality and resolve any admin dashboard issues\!
EOF < /dev/null