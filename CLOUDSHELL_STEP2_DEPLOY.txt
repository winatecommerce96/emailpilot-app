cd ~
mkdir -p mcp-deployment-fix
cd mcp-deployment-fix
cat > deploy_mcp.sh << 'SCRIPT_END'
#!/bin/bash
echo "ðŸš€ EmailPilot MCP Integration Fix"
echo "=================================="

PROJECT_ID="emailpilot-438321"
SERVICE_NAME="emailpilot-api"
REGION="us-central1"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

gcloud config set project $PROJECT_ID

echo "Creating MCP implementation..."

mkdir -p app/api
cat > app/api/mcp.py << 'EOF'
from fastapi import APIRouter, HTTPException
from datetime import datetime

router = APIRouter()

@router.get("/health")
async def mcp_health():
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "version": "1.0.0"
    }

@router.get("/models")
async def get_models():
    return [
        {"id": 1, "provider": "claude", "model_name": "claude-3-opus", "display_name": "Claude 3 Opus"},
        {"id": 2, "provider": "openai", "model_name": "gpt-4-turbo", "display_name": "GPT-4 Turbo"},
        {"id": 3, "provider": "gemini", "model_name": "gemini-pro", "display_name": "Gemini Pro"}
    ]

@router.get("/clients")
async def get_clients():
    return []

@router.post("/clients")
async def create_client(client: dict):
    client["id"] = "client_1"
    client["created_at"] = datetime.utcnow().isoformat()
    return client
EOF

cat > main_firestore.py << 'EOF'
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(title="EmailPilot API with MCP")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

try:
    from app.api.mcp import router as mcp_router
    app.include_router(mcp_router, prefix="/api/mcp", tags=["mcp"])
    print("MCP routes registered")
except:
    @app.get("/api/mcp/models")
    async def fallback_models():
        return [{"id": 1, "provider": "claude", "model_name": "claude-3-opus"}]
    
    @app.get("/api/mcp/clients")  
    async def fallback_clients():
        return []

@app.get("/health")
async def health():
    return {"status": "healthy"}

@app.get("/")
async def root():
    return {"message": "EmailPilot API with MCP"}
EOF

cat > requirements.txt << 'EOF'
fastapi==0.104.1
uvicorn==0.24.0
google-cloud-firestore==2.11.1
pydantic==2.4.2
EOF

cat > Dockerfile << 'EOF'
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
EXPOSE 8080
CMD ["uvicorn", "main_firestore:app", "--host", "0.0.0.0", "--port", "8080"]
EOF

echo "Building container..."
gcloud builds submit --tag gcr.io/$PROJECT_ID/$SERVICE_NAME:mcp-$TIMESTAMP

echo "Deploying to Cloud Run..."
gcloud run deploy $SERVICE_NAME \
    --image gcr.io/$PROJECT_ID/$SERVICE_NAME:mcp-$TIMESTAMP \
    --region $REGION \
    --platform managed \
    --allow-unauthenticated \
    --port 8080

echo "Waiting for deployment..."
sleep 20

SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region $REGION --format 'value(status.url)')

echo "Testing endpoints..."
curl -s "$SERVICE_URL/api/mcp/models" | head -20

echo ""
echo "Done! Test with:"
echo "curl $SERVICE_URL/api/mcp/models"
SCRIPT_END

chmod +x deploy_mcp.sh
./deploy_mcp.sh