# Deployment Agent Configuration v4.0 - SPA Enhanced
# Specialized for Single Page Application (SPA) deployment
# EmailPilot.ai SPA Configuration - 2025-08-11

agent_name: emailpilot-spa-deployment-specialist
version: 4.0.0
last_updated: 2025-08-11

application_architecture:
  type: Single Page Application (SPA)
  frontend_framework: React
  backend_framework: FastAPI
  routing_mode: client_side
  build_system: npm/webpack
  static_hosting: nginx_in_container
  api_pattern: /api/*
  
spa_specific_knowledge:
  critical_understanding: |
    EmailPilot is a SINGLE PAGE APPLICATION with these characteristics:
    - ALL routes (except /api/*) must serve index.html
    - Client-side routing handles navigation
    - Static assets served from /static or /assets
    - API calls are proxied to backend services
    - Browser handles route changes without server requests
    - Deep linking requires special server configuration
    
  spa_routing_requirements: |
    1. Nginx/server must redirect ALL non-API routes to index.html
    2. React Router handles client-side navigation
    3. 404 errors should serve index.html (let React handle)
    4. Static assets must have correct MIME types
    5. API routes (/api/*) proxy to backend service
    
deployment_strategies:
  spa_frontend_changes:
    required_steps:
      1. Build React app with production optimizations
      2. Generate static assets (JS bundles, CSS, images)
      3. Configure nginx for SPA routing (catch-all to index.html)
      4. Build Docker container with nginx and static files
      5. Deploy container to Cloud Run
      6. Verify client-side routing works
      7. Test deep links and browser refresh
      
    build_commands: |
      # Build production SPA
      cd frontend
      npm ci --production=false
      npm run build
      
      # Output will be in build/ or dist/ directory
      # Contains index.html and static assets
      
  nginx_spa_configuration: |
    # nginx.conf for SPA
    server {
        listen 8080;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;
        
        # Serve static assets with proper caching
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # API proxy to backend
        location /api {
            proxy_pass http://backend-service:8000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
        
        # SPA catch-all: serve index.html for all routes
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        # Security headers for SPA
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

docker_spa_configuration:
  spa_dockerfile: |
    # Multi-stage build for SPA
    # Stage 1: Build the React app
    FROM node:18-alpine AS builder
    WORKDIR /app
    
    # Copy package files
    COPY package*.json ./
    RUN npm ci --production=false
    
    # Copy source code
    COPY . .
    
    # Build production bundle
    RUN npm run build
    
    # Stage 2: Serve with nginx
    FROM nginx:alpine
    
    # Copy nginx config for SPA
    COPY nginx.conf /etc/nginx/conf.d/default.conf
    
    # Copy built React app
    COPY --from=builder /app/build /usr/share/nginx/html
    
    # Expose port
    EXPOSE 8080
    
    # Start nginx
    CMD ["nginx", "-g", "daemon off;"]
    
  integrated_spa_dockerfile: |
    # Dockerfile for SPA + Backend in single container
    FROM node:18-alpine AS frontend-builder
    WORKDIR /app/frontend
    COPY frontend/package*.json ./
    RUN npm ci --production=false
    COPY frontend/ .
    RUN npm run build
    
    FROM python:3.9-slim
    WORKDIR /app
    
    # Install nginx
    RUN apt-get update && apt-get install -y nginx supervisor
    
    # Copy backend
    COPY backend/requirements.txt .
    RUN pip install -r requirements.txt
    COPY backend/ ./backend/
    
    # Copy frontend build
    COPY --from=frontend-builder /app/frontend/build /usr/share/nginx/html
    
    # Copy nginx config
    COPY nginx-spa.conf /etc/nginx/sites-enabled/default
    
    # Copy supervisor config
    COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
    
    EXPOSE 8080
    CMD ["/usr/bin/supervisord"]

spa_deployment_script: |
  #!/bin/bash
  # EmailPilot SPA Deployment Script
  # Handles Single Page Application deployment
  
  set -euo pipefail
  
  # Configuration
  PROJECT_ID="emailpilot-438321"
  SERVICE_NAME="emailpilot-spa"
  REGION="us-central1"
  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
  
  echo "=== Starting SPA Deployment ==="
  
  # Step 1: Build React SPA
  echo "1. Building React SPA..."
  cd frontend
  npm ci --production=false
  npm run build
  cd ..
  
  # Step 2: Verify build output
  echo "2. Verifying SPA build..."
  if [ ! -f "frontend/build/index.html" ]; then
    echo "ERROR: index.html not found in build directory"
    exit 1
  fi
  
  # Step 3: Create nginx config for SPA
  echo "3. Creating nginx SPA configuration..."
  cat > nginx.conf << 'NGINX'
  server {
      listen 8080;
      root /usr/share/nginx/html;
      index index.html;
      
      # SPA routing - serve index.html for all non-file routes
      location / {
          try_files $uri $uri/ /index.html;
      }
      
      # API proxy
      location /api {
          proxy_pass http://localhost:8000;
      }
      
      # Static assets caching
      location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
          expires 1y;
          add_header Cache-Control "public, immutable";
      }
  }
  NGINX
  
  # Step 4: Build Docker container with SPA
  echo "4. Building Docker container..."
  cat > Dockerfile << 'DOCKERFILE'
  FROM nginx:alpine
  COPY nginx.conf /etc/nginx/conf.d/default.conf
  COPY frontend/build /usr/share/nginx/html
  RUN sed -i 's/listen 80/listen 8080/' /etc/nginx/conf.d/default.conf
  EXPOSE 8080
  CMD ["nginx", "-g", "daemon off;"]
  DOCKERFILE
  
  # Build and push
  IMAGE_TAG="gcr.io/$PROJECT_ID/$SERVICE_NAME:spa-$TIMESTAMP"
  gcloud builds submit --tag $IMAGE_TAG
  
  # Step 5: Deploy to Cloud Run
  echo "5. Deploying SPA to Cloud Run..."
  gcloud run deploy $SERVICE_NAME \
    --image=$IMAGE_TAG \
    --region=$REGION \
    --allow-unauthenticated \
    --port=8080 \
    --memory=256Mi \
    --min-instances=1 \
    --max-instances=100
  
  # Step 6: Test SPA routing
  echo "6. Testing SPA routing..."
  SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format='value(status.url)')
  
  # Test root
  curl -sf "$SERVICE_URL/" > /dev/null && echo "✅ Root route works"
  
  # Test client-side route (should return index.html, not 404)
  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL/dashboard")
  if [ "$HTTP_CODE" = "200" ]; then
    echo "✅ Client-side routing works"
  else
    echo "❌ Client-side routing failed (HTTP $HTTP_CODE)"
  fi
  
  echo "=== ✅ SPA Deployment Complete ==="
  echo "URL: $SERVICE_URL"

spa_verification:
  routing_tests:
    - path: "/"
      expected: "200 with index.html"
    - path: "/dashboard"
      expected: "200 with index.html (SPA routing)"
    - path: "/settings/profile"
      expected: "200 with index.html (deep link)"
    - path: "/api/health"
      expected: "200 or 401 (API route)"
    - path: "/static/js/main.js"
      expected: "200 with JS content"
    - path: "/nonexistent"
      expected: "200 with index.html (SPA handles 404)"
      
  browser_tests: |
    1. Navigate directly to /dashboard - should load dashboard
    2. Refresh browser on /settings - should maintain route
    3. Use browser back/forward - should work with React Router
    4. Deep link to /campaigns/123 - should load specific campaign
    
spa_troubleshooting:
  common_issues:
    blank_page:
      cause: "Incorrect base URL or asset paths"
      solution: "Check PUBLIC_URL in React build"
      
    404_on_refresh:
      cause: "Server not configured for SPA routing"
      solution: "Ensure nginx redirects all routes to index.html"
      
    api_calls_fail:
      cause: "Proxy configuration incorrect"
      solution: "Verify /api proxy in nginx config"
      
    routing_not_working:
      cause: "React Router not configured properly"
      solution: "Check BrowserRouter base path"
      
monitoring_spa_health:
  metrics_to_track:
    - Initial page load time
    - Time to interactive (TTI)
    - Bundle size
    - Client-side route changes
    - API response times
    - JavaScript errors in browser console
    
  logging_setup: |
    # Add client-side error tracking
    window.addEventListener('error', (e) => {
      // Send to logging service
      console.error('SPA Error:', e);
    });
    
    // Track route changes
    history.pushState = new Proxy(history.pushState, {
      apply: (target, thisArg, argList) => {
        console.log('Route change:', argList[2]);
        return target.apply(thisArg, argList);
      }
    });

cdn_and_caching:
  cloudflare_setup: |
    # Page Rules for SPA
    1. /api/* - Cache Level: Bypass
    2. /static/* - Cache Level: Standard, Edge Cache TTL: 1 month
    3. /* - Cache Level: Standard, Always Online: On
    
  cache_busting: |
    # React automatically adds hash to filenames
    # main.abc123.js instead of main.js
    # This allows aggressive caching
    
best_practices:
  spa_deployment:
    always:
      - Build with production flag (npm run build)
      - Minimize bundle size with code splitting
      - Configure server for SPA routing
      - Test deep links and refresh behavior
      - Implement proper error boundaries
      - Add loading states for async components
      
    never:
      - Serve development build in production
      - Forget to handle client-side 404s
      - Mix server-side and client-side routing
      - Ignore bundle size optimization
      - Skip browser compatibility testing
      
    performance:
      - Enable gzip/brotli compression
      - Implement lazy loading for routes
      - Use CDN for static assets
      - Preload critical resources
      - Implement service worker for offline support

enhanced_capabilities:
  progressive_web_app: |
    # Convert SPA to PWA
    1. Add manifest.json
    2. Implement service worker
    3. Enable offline functionality
    4. Add install prompt
    
  server_side_rendering: |
    # Add SSR for SEO if needed
    1. Use Next.js for React SSR
    2. Configure for hybrid rendering
    3. Static generation for marketing pages
    4. Client-side for app pages

expertise_summary: |
  The EmailPilot SPA Deployment Agent v4.0 understands that:
  1. EmailPilot is a Single Page Application requiring special routing
  2. ALL non-API routes must serve index.html for client-side routing
  3. Static assets need proper caching headers
  4. React Router handles navigation, not the server
  5. Build process creates optimized bundles for production
  6. Nginx configuration is critical for SPA functionality
  7. Deep links and refresh must work correctly
  8. API calls are proxied through the same domain
  9. Bundle size optimization is crucial for performance
  10. Client-side error tracking is essential for debugging