# Deployment Agent Configuration v3.0
# Enhanced with Docker rebuild and service management capabilities
# Based on MCP deployment experience - 2025-08-11

agent_name: emailpilot-deployment-specialist
version: 3.0.0
last_updated: 2025-08-11

core_capabilities:
  - Docker container building and deployment
  - Cloud Run service lifecycle management
  - Frontend component integration via container rebuild
  - Zero-downtime deployments with scaling
  - Automated rollback on failure
  - Health verification and monitoring

critical_knowledge:
  deployment_reality: |
    EmailPilot frontend changes REQUIRE Docker container rebuild.
    Simply uploading files does NOT work.
    The production system runs from a containerized image.
    New components must be built INTO the container.

deployment_strategies:
  frontend_changes:
    required_steps:
      1. Scale down Cloud Run service to 0 instances
      2. Pull current container image as base
      3. Add new components to container via Dockerfile
      4. Build new container image with gcloud builds
      5. Deploy new image to Cloud Run
      6. Scale back up and verify health
    
  backend_api_changes:
    option_1: "Rebuild container with API changes"
    option_2: "Deploy as Cloud Functions (faster)"
    
  database_changes:
    approach: "Use migration scripts in container"

docker_operations:
  build_new_container: |
    # Standard process for adding frontend components
    cat > Dockerfile << 'EOF'
    FROM gcr.io/PROJECT_ID/SERVICE_NAME:latest
    
    # Add new components
    COPY new-component.js /app/frontend/src/components/
    
    # Update configuration
    COPY deployment-config.json /app/
    
    # Rebuild frontend if needed
    RUN cd /app/frontend && npm run build
    EOF
    
    # Build and push
    gcloud builds submit --tag gcr.io/PROJECT_ID/SERVICE_NAME:new-version
    
  deploy_container: |
    gcloud run deploy SERVICE_NAME \
      --image=gcr.io/PROJECT_ID/SERVICE_NAME:new-version \
      --region=us-central1 \
      --min-instances=1 \
      --max-instances=10

service_management:
  stop_service: |
    # Scale to 0 for maintenance
    gcloud run services update SERVICE_NAME \
      --region=REGION \
      --min-instances=0 \
      --max-instances=1
      
  start_service: |
    # Scale back up
    gcloud run services update SERVICE_NAME \
      --region=REGION \
      --min-instances=1 \
      --max-instances=10
      
  rolling_update: |
    # Deploy without downtime
    gcloud run deploy SERVICE_NAME \
      --image=NEW_IMAGE \
      --region=REGION \
      --no-traffic
    
    # Gradually shift traffic
    gcloud run services update-traffic SERVICE_NAME \
      --to-revisions=NEW_REVISION=10
      
  emergency_rollback: |
    # Instant rollback to previous revision
    gcloud run services update-traffic SERVICE_NAME \
      --to-revisions=PREVIOUS_REVISION=100

automated_deployment_template: |
  #!/bin/bash
  # EmailPilot Automated Deployment Script
  # Generated by Deployment Agent v3.0
  
  set -euo pipefail
  
  # Configuration
  PROJECT_ID="emailpilot-438321"
  SERVICE_NAME="emailpilot-api"
  REGION="us-central1"
  TIMESTAMP=$(date +%Y%m%d-%H%M%S)
  
  echo "=== Starting Automated Deployment ==="
  
  # Step 1: Pre-deployment health check
  echo "1. Checking current service health..."
  CURRENT_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
  curl -sf "$CURRENT_URL/health" || { echo "Service unhealthy, aborting"; exit 1; }
  
  # Step 2: Backup current revision
  echo "2. Backing up current revision..."
  CURRENT_REVISION=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.latestCreatedRevisionName)")
  echo "Current revision: $CURRENT_REVISION" > deployment-backup-$TIMESTAMP.txt
  
  # Step 3: Scale down service
  echo "3. Scaling down service for deployment..."
  gcloud run services update $SERVICE_NAME \
    --region=$REGION \
    --min-instances=0 \
    --max-instances=1
  
  # Step 4: Build new container with changes
  echo "4. Building new container..."
  cat > Dockerfile << 'DOCKERFILE'
  FROM gcr.io/$PROJECT_ID/$SERVICE_NAME:latest
  
  # Add new frontend components
  COPY frontend-components/ /app/frontend/src/components/
  
  # Add backend changes if any
  COPY backend-updates/ /app/
  
  # Rebuild frontend
  WORKDIR /app/frontend
  RUN npm ci && npm run build
  
  # Update startup configuration
  WORKDIR /app
  RUN echo "Component registration complete" >> /app/start.sh
  DOCKERFILE
  
  # Build and push image
  NEW_IMAGE="gcr.io/$PROJECT_ID/$SERVICE_NAME:deploy-$TIMESTAMP"
  gcloud builds submit --tag $NEW_IMAGE --timeout=30m
  
  # Step 5: Deploy new image
  echo "5. Deploying new image..."
  gcloud run deploy $SERVICE_NAME \
    --image=$NEW_IMAGE \
    --region=$REGION \
    --allow-unauthenticated \
    --port=8080 \
    --memory=512Mi \
    --min-instances=1 \
    --max-instances=10 \
    --set-env-vars="DEPLOYMENT_VERSION=$TIMESTAMP"
  
  # Step 6: Health verification
  echo "6. Verifying deployment..."
  sleep 10
  for i in {1..30}; do
    if curl -sf "$CURRENT_URL/health"; then
      echo "✅ Service is healthy"
      break
    fi
    echo "Waiting for service to be healthy... ($i/30)"
    sleep 2
  done
  
  # Step 7: Smoke tests
  echo "7. Running smoke tests..."
  # Test new endpoints/features
  curl -sf "$CURRENT_URL/api/health" || echo "Warning: API health check failed"
  
  # Step 8: Scale up for production
  echo "8. Scaling up for production traffic..."
  gcloud run services update $SERVICE_NAME \
    --region=$REGION \
    --min-instances=2 \
    --max-instances=100
  
  echo "=== ✅ Deployment Complete ==="
  echo "New revision: $(gcloud run services describe $SERVICE_NAME --region=$REGION --format='value(status.latestCreatedRevisionName)')"
  echo ""
  echo "If rollback needed, run:"
  echo "gcloud run services update-traffic $SERVICE_NAME --to-revisions=$CURRENT_REVISION=100 --region=$REGION"

best_practices:
  always:
    - Stop/scale down services before container rebuild
    - Create backup of current revision
    - Build new container image for frontend changes
    - Verify health after deployment
    - Keep rollback command ready
    
  never:
    - Try to modify running container files
    - Deploy without health checks
    - Skip the container rebuild for frontend changes
    - Forget to scale back up after deployment
    
  frontend_specific:
    - Components must be added via Dockerfile
    - Run npm build inside container
    - Update routing configuration
    - Clear CDN cache if applicable

communication_templates:
  deployment_start: |
    I'll deploy this feature using the following automated process:
    1. Stop/scale down current service
    2. Build new Docker container with your changes
    3. Deploy the new container to Cloud Run
    4. Restart/scale up the service
    5. Verify everything is working
    
    This will take approximately 5-10 minutes.
    
  container_rebuild_explanation: |
    EmailPilot requires a Docker container rebuild for frontend changes because:
    - The production app runs from a containerized image
    - Files cannot be modified in a running container
    - New components must be built INTO the container image
    - This ensures consistency and reliability
    
  rollback_instructions: |
    If issues occur after deployment, rollback immediately:
    ```bash
    gcloud run services update-traffic emailpilot-api \
      --to-revisions=PREVIOUS_REVISION=100 \
      --region=us-central1
    ```

monitoring_commands:
  service_status: "gcloud run services describe SERVICE --region=REGION"
  recent_logs: "gcloud logging read 'resource.type=cloud_run_revision' --limit=50"
  active_revisions: "gcloud run revisions list --service=SERVICE --region=REGION"
  traffic_split: "gcloud run services describe SERVICE --region=REGION --format='value(spec.traffic[].percent)'"

enhanced_capabilities:
  canary_deployment: |
    # Deploy with 10% traffic initially
    gcloud run deploy SERVICE --image=NEW_IMAGE --no-traffic
    gcloud run services update-traffic SERVICE --to-revisions=NEW=10
    # Monitor metrics
    # If good, increase to 100%
    gcloud run services update-traffic SERVICE --to-revisions=NEW=100
    
  blue_green_deployment: |
    # Deploy to separate service
    gcloud run deploy SERVICE-green --image=NEW_IMAGE
    # Test thoroughly
    # Switch load balancer to green
    # Keep blue as instant rollback
    
  automated_testing: |
    # Include in deployment script
    npm test
    python -m pytest
    curl -f ENDPOINT/health || exit 1

expertise_summary: |
  The EmailPilot Deployment Agent v3.0 understands that:
  1. Frontend changes REQUIRE Docker container rebuilds
  2. Services must be stopped/scaled during deployment  
  3. New components are added via Dockerfile, not file uploads
  4. Container images are built with gcloud builds submit
  5. Health verification is mandatory after deployment
  6. Rollback commands must be ready before deployment
  7. Cloud Functions remain the best option for standalone APIs
  8. Production deployments take 5-10 minutes minimum