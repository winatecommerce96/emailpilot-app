#!/bin/bash
# Deploy MCP to EmailPilot SPA with Secret Manager Integration
# Copy and paste this into Cloud Shell

echo "=== EmailPilot MCP SPA Integration with Secret Manager ==="
echo ""

# Configuration
PROJECT_ID="emailpilot-438321"
SERVICE_NAME="emailpilot-api"
REGION="us-central1"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# Step 1: Create/Update secrets in Secret Manager
echo "1. Setting up Secret Manager configuration..."
echo ""
echo "Creating MCP configuration in Secret Manager..."

# Create the MCP configuration as a JSON secret
cat > mcp-config.json << 'CONFIG'
{
  "endpoints": {
    "models": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-models",
    "clients": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-clients",
    "health": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-health"
  },
  "settings": {
    "enabled": true,
    "debug": false,
    "timeout": 30000
  }
}
CONFIG

# Create or update the secret
echo "Storing MCP configuration in Secret Manager..."
if gcloud secrets describe mcp-config --project=$PROJECT_ID >/dev/null 2>&1; then
    echo "Updating existing secret..."
    gcloud secrets versions add mcp-config --data-file=mcp-config.json --project=$PROJECT_ID
else
    echo "Creating new secret..."
    gcloud secrets create mcp-config --data-file=mcp-config.json --project=$PROJECT_ID
fi

# Grant Cloud Run service access to the secret
echo "Granting access to Cloud Run service..."
gcloud secrets add-iam-policy-binding mcp-config \
    --member="serviceAccount:935786836546-compute@developer.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor" \
    --project=$PROJECT_ID || true

echo ""
echo "2. Creating deployment files..."
cd ~
rm -rf mcp-spa-deploy
mkdir -p mcp-spa-deploy
cd mcp-spa-deploy

# Step 2: Create React component with Secret Manager integration
echo "3. Creating MCP React component with dynamic configuration..."
cat > MCPManagement.jsx << 'COMPONENT'
import React, { useState, useEffect } from 'react';

const MCPManagement = ({ isOpen, onClose }) => {
    const [config, setConfig] = useState(null);
    const [models, setModels] = useState([]);
    const [clients, setClients] = useState([]);
    const [health, setHealth] = useState(null);
    const [loading, setLoading] = useState(true);
    const [testResults, setTestResults] = useState('');
    const [error, setError] = useState(null);

    // Load configuration from backend/Secret Manager
    const loadConfig = async () => {
        try {
            // First try to get config from backend
            const response = await fetch('/api/mcp/config').catch(() => null);
            if (response && response.ok) {
                return await response.json();
            }
            
            // Fallback to environment variable or default
            if (window.MCP_CONFIG) {
                return window.MCP_CONFIG;
            }
            
            // Ultimate fallback (for development/testing)
            return {
                endpoints: {
                    models: 'https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-models',
                    clients: 'https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-clients',
                    health: 'https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-health'
                }
            };
        } catch (err) {
            console.error('Failed to load MCP config:', err);
            throw err;
        }
    };

    useEffect(() => {
        if (isOpen && !config) {
            loadConfig()
                .then(cfg => {
                    setConfig(cfg);
                    return loadMCPData(cfg.endpoints);
                })
                .catch(err => {
                    setError('Failed to load configuration: ' + err.message);
                    setLoading(false);
                });
        } else if (isOpen && config) {
            loadMCPData(config.endpoints);
        }
    }, [isOpen, config]);

    const loadMCPData = async (endpoints) => {
        if (!endpoints) return;
        
        setLoading(true);
        try {
            const [modelsRes, clientsRes, healthRes] = await Promise.all([
                fetch(endpoints.models),
                fetch(endpoints.clients),
                fetch(endpoints.health)
            ]);
            
            setModels(await modelsRes.json());
            setClients(await clientsRes.json());
            setHealth(await healthRes.json());
            setError(null);
        } catch (error) {
            console.error('Error loading MCP data:', error);
            setError('Failed to load MCP data: ' + error.message);
        } finally {
            setLoading(false);
        }
    };

    const testEndpoints = async () => {
        if (!config || !config.endpoints) {
            setTestResults('Configuration not loaded');
            return;
        }
        
        let results = 'Testing MCP Endpoints...\n\n';
        for (const [name, url] of Object.entries(config.endpoints)) {
            try {
                const start = Date.now();
                const response = await fetch(url);
                const time = Date.now() - start;
                await response.json();
                results += `âœ… ${name}: OK (${time}ms)\n`;
            } catch (error) {
                results += `âŒ ${name}: Failed - ${error.message}\n`;
            }
        }
        setTestResults(results);
    };

    const refreshData = () => {
        if (config && config.endpoints) {
            loadMCPData(config.endpoints);
        }
    };

    if (!isOpen) return null;

    return React.createElement('div', {
        className: 'mcp-overlay',
        onClick: onClose,
        style: {
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.5)',
            zIndex: 10000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
        }
    },
        React.createElement('div', {
            className: 'mcp-modal',
            onClick: (e) => e.stopPropagation(),
            style: {
                background: 'white',
                width: '90%',
                maxWidth: '1200px',
                maxHeight: '90vh',
                borderRadius: '12px',
                overflow: 'hidden',
                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)'
            }
        },
            React.createElement('div', {
                style: {
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    padding: '20px 30px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between'
                }
            },
                React.createElement('h1', { style: { margin: 0 } }, 'ðŸ¤– MCP Management'),
                React.createElement('span', {
                    style: {
                        position: 'absolute',
                        left: '50%',
                        transform: 'translateX(-50%)',
                        fontSize: '12px',
                        opacity: 0.8
                    }
                }, config ? 'âœ… Config Loaded' : 'â³ Loading Config...'),
                React.createElement('button', {
                    onClick: onClose,
                    style: {
                        background: 'none',
                        border: 'none',
                        color: 'white',
                        fontSize: '30px',
                        cursor: 'pointer'
                    }
                }, 'Ã—')
            ),
            React.createElement('div', {
                style: {
                    padding: '30px',
                    overflowY: 'auto',
                    maxHeight: 'calc(90vh - 80px)'
                }
            },
                error ? 
                    React.createElement('div', {
                        style: {
                            padding: '20px',
                            background: '#fef2f2',
                            border: '1px solid #ef4444',
                            borderRadius: '8px',
                            color: '#991b1b'
                        }
                    }, 'âš ï¸ ' + error) :
                loading ? 
                    React.createElement('div', {}, 'Loading MCP data...') :
                    React.createElement('div', {},
                        React.createElement('div', {
                            style: {
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                                gap: '20px',
                                marginBottom: '30px'
                            }
                        },
                            React.createElement('div', {
                                style: {
                                    background: '#f0fdf4',
                                    padding: '20px',
                                    borderRadius: '8px'
                                }
                            },
                                React.createElement('div', {}, 'System Status'),
                                React.createElement('div', { style: { fontSize: '24px', fontWeight: 'bold' } }, 
                                    health && health.status === 'healthy' ? 'âœ… Active' : 'âš ï¸ Issues')
                            ),
                            React.createElement('div', {
                                style: {
                                    background: '#fef3c7',
                                    padding: '20px',
                                    borderRadius: '8px'
                                }
                            },
                                React.createElement('div', {}, 'Available Models'),
                                React.createElement('div', { style: { fontSize: '24px', fontWeight: 'bold' } }, models.length)
                            ),
                            React.createElement('div', {
                                style: {
                                    background: '#dbeafe',
                                    padding: '20px',
                                    borderRadius: '8px'
                                }
                            },
                                React.createElement('div', {}, 'Configuration Source'),
                                React.createElement('div', { style: { fontSize: '14px', fontWeight: 'bold' } }, 
                                    config ? 'ðŸ” Secret Manager' : 'Default')
                            )
                        ),
                        React.createElement('h2', {}, 'Available AI Models'),
                        React.createElement('div', { style: { display: 'grid', gap: '15px' } },
                            models.map(model => 
                                React.createElement('div', {
                                    key: model.id,
                                    style: {
                                        padding: '20px',
                                        background: '#f8fafc',
                                        borderRadius: '8px',
                                        border: '1px solid #e2e8f0'
                                    }
                                },
                                    React.createElement('h3', {}, model.display_name),
                                    React.createElement('p', {}, `Provider: ${model.provider} | Model: ${model.model_name}`)
                                )
                            )
                        ),
                        React.createElement('div', { style: { marginTop: '30px' } },
                            React.createElement('button', {
                                onClick: testEndpoints,
                                style: {
                                    padding: '10px 20px',
                                    background: '#667eea',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer',
                                    marginRight: '10px'
                                }
                            }, 'Test Endpoints'),
                            React.createElement('button', {
                                onClick: refreshData,
                                style: {
                                    padding: '10px 20px',
                                    background: '#10b981',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '6px',
                                    cursor: 'pointer'
                                }
                            }, 'Refresh Data')
                        ),
                        testResults && React.createElement('pre', {
                            style: {
                                marginTop: '20px',
                                padding: '15px',
                                background: '#1e293b',
                                color: '#e2e8f0',
                                borderRadius: '6px',
                                whiteSpace: 'pre-wrap'
                            }
                        }, testResults)
                    )
            )
        )
    );
};

export default MCPManagement;
COMPONENT

# Step 3: Create backend config endpoint (optional but recommended)
echo "4. Creating backend configuration endpoint..."
cat > mcp_config_endpoint.py << 'BACKEND'
# Add this to your FastAPI backend to serve MCP config from Secret Manager

from fastapi import APIRouter, HTTPException
from google.cloud import secretmanager
import json
import os

router = APIRouter()

@router.get("/api/mcp/config")
async def get_mcp_config():
    """Get MCP configuration from Secret Manager"""
    try:
        # Initialize Secret Manager client
        client = secretmanager.SecretManagerServiceClient()
        
        # Build the secret name
        project_id = os.getenv("GCP_PROJECT", "emailpilot-438321")
        secret_name = f"projects/{project_id}/secrets/mcp-config/versions/latest"
        
        # Access the secret
        response = client.access_secret_version(request={"name": secret_name})
        config_data = response.payload.data.decode("UTF-8")
        
        return json.loads(config_data)
    except Exception as e:
        # Fallback to environment variable or default
        default_config = {
            "endpoints": {
                "models": os.getenv("MCP_MODELS_URL", "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-models"),
                "clients": os.getenv("MCP_CLIENTS_URL", "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-clients"),
                "health": os.getenv("MCP_HEALTH_URL", "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-health")
            },
            "settings": {
                "enabled": True
            }
        }
        return default_config
BACKEND

# Step 4: Create app integration
echo "5. Creating app integration..."
cat > app-integration.js << 'INTEGRATION'
// MCP Integration for EmailPilot SPA with Secret Manager support

function integrateWhenReady() {
    if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
        setTimeout(integrateWhenReady, 100);
        return;
    }
    
    const mcpButton = document.createElement('div');
    mcpButton.id = 'mcp-button-container';
    document.body.appendChild(mcpButton);
    
    const MCPButton = () => {
        const [showMCP, setShowMCP] = React.useState(false);
        
        return React.createElement(React.Fragment, {},
            React.createElement('button', {
                onClick: () => setShowMCP(true),
                style: {
                    position: 'fixed',
                    top: '20px',
                    right: '20px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    border: 'none',
                    padding: '12px 24px',
                    borderRadius: '8px',
                    fontSize: '16px',
                    fontWeight: '600',
                    cursor: 'pointer',
                    zIndex: 1000,
                    boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)'
                }
            }, 'ðŸ¤– MCP Management'),
            showMCP && React.createElement(MCPManagement, {
                isOpen: showMCP,
                onClose: () => setShowMCP(false)
            })
        );
    };
    
    ReactDOM.render(React.createElement(MCPButton), mcpButton);
}

integrateWhenReady();
INTEGRATION

# Step 5: Create Dockerfile
echo "6. Creating Dockerfile with Secret Manager support..."
cat > Dockerfile << 'DOCKERFILE'
FROM gcr.io/emailpilot-438321/emailpilot-api:latest

# Install Secret Manager dependencies if not present
RUN pip install google-cloud-secret-manager || true

# Add MCP component files
COPY MCPManagement.jsx /app/static/js/MCPManagement.jsx
COPY app-integration.js /app/static/js/app-integration.js
COPY mcp_config_endpoint.py /app/api/mcp_config.py

# Add Secret Manager permissions to service account
ENV GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json

# Inject MCP into the application
RUN if [ -f /app/static/index.html ]; then \
    echo '<script src="/static/js/MCPManagement.jsx"></script>' >> /app/static/index.html && \
    echo '<script src="/static/js/app-integration.js"></script>' >> /app/static/index.html; \
    fi

RUN find /app -name "*.html" -type f -exec sh -c 'echo "<script src=\"/static/js/app-integration.js\"></script>" >> {}' \;

DOCKERFILE

# Step 6: Build and deploy
echo "7. Building new container with MCP and Secret Manager integration..."
NEW_IMAGE="gcr.io/$PROJECT_ID/$SERVICE_NAME:mcp-secrets-$TIMESTAMP"
gcloud builds submit --tag $NEW_IMAGE --timeout=30m

echo ""
echo "8. Deploying to Cloud Run with Secret Manager access..."
gcloud run deploy $SERVICE_NAME \
    --image=$NEW_IMAGE \
    --region=$REGION \
    --platform=managed \
    --allow-unauthenticated \
    --port=8080 \
    --memory=512Mi \
    --min-instances=1 \
    --max-instances=10 \
    --set-env-vars="GCP_PROJECT=$PROJECT_ID" \
    --set-secrets="MCP_CONFIG=mcp-config:latest" \
    --service-account="935786836546-compute@developer.gserviceaccount.com"

echo ""
echo "9. Verifying deployment..."
sleep 5

SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
echo "Service URL: $SERVICE_URL"

echo ""
echo "Testing health endpoint..."
curl -s "$SERVICE_URL/health" | head -20 || echo "Health check failed"

echo ""
echo "Testing MCP configuration endpoint (if available)..."
curl -s "$SERVICE_URL/api/mcp/config" | head -20 || echo "Config endpoint not available (will use fallback)"

echo ""
echo "=== âœ… MCP Deployment with Secret Manager Complete ==="
echo ""
echo "Configuration is now stored securely in Secret Manager!"
echo "You can update the endpoints by running:"
echo "  gcloud secrets versions add mcp-config --data-file=new-config.json"
echo ""
echo "The MCP Management button should be visible at:"
echo "https://emailpilot.ai"
echo ""
echo "Benefits of this approach:"
echo "  âœ… Secure storage of API endpoints"
echo "  âœ… Easy to update without redeployment"
echo "  âœ… No hardcoded URLs in frontend code"
echo "  âœ… Centralized configuration management"