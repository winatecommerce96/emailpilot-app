#!/bin/bash
# Fixed MCP Deployment for EmailPilot - Proper Authentication
# This version uses Application Default Credentials (ADC) instead of hardcoded credentials

echo "=== Fixed MCP Deployment with Proper Authentication ==="
echo ""

PROJECT_ID="emailpilot-438321"
SERVICE_NAME="emailpilot-api"
REGION="us-central1"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# Step 1: Setup Secret Manager (still needed for MCP config)
echo "1. Setting up MCP configuration in Secret Manager..."
cat > mcp-config.json << 'CONFIG'
{
  "endpoints": {
    "models": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-models",
    "clients": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-clients",
    "health": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-health"
  },
  "settings": {
    "enabled": true
  }
}
CONFIG

# Create or update the secret
if gcloud secrets describe mcp-config --project=$PROJECT_ID >/dev/null 2>&1; then
    echo "Updating existing secret..."
    gcloud secrets versions add mcp-config --data-file=mcp-config.json --project=$PROJECT_ID
else
    echo "Creating new secret..."
    gcloud secrets create mcp-config --data-file=mcp-config.json --project=$PROJECT_ID
fi

# Grant the service account access to the secret
echo "Granting Secret Manager access to service account..."
gcloud secrets add-iam-policy-binding mcp-config \
    --member="serviceAccount:935786836546-compute@developer.gserviceaccount.com" \
    --role="roles/secretmanager.secretAccessor" \
    --project=$PROJECT_ID 2>/dev/null || true

echo ""
echo "2. Creating deployment directory..."
cd ~
rm -rf mcp-fixed-deploy
mkdir -p mcp-fixed-deploy
cd mcp-fixed-deploy

# Step 3: Create .dockerignore to reduce build context
echo "3. Creating .dockerignore..."
cat > .dockerignore << 'DOCKERIGNORE'
*.md
*.txt
*.zip
*.log
.git
.gitignore
__pycache__
*.pyc
.env
.venv
node_modules
*.bak
*.tmp
DOCKERIGNORE

# Step 4: Create MCP config endpoint for backend
echo "4. Creating MCP config endpoint..."
cat > mcp_config.py << 'PYTHON'
"""MCP Configuration Endpoint - Uses Application Default Credentials"""
from fastapi import APIRouter, HTTPException
from google.cloud import secretmanager
import json
import os
import logging

logger = logging.getLogger(__name__)
router = APIRouter()

@router.get("/api/mcp/config")
async def get_mcp_config():
    """Get MCP configuration from Secret Manager using ADC"""
    try:
        # Use Application Default Credentials - no hardcoded path needed
        client = secretmanager.SecretManagerServiceClient()
        
        project_id = os.getenv("GCP_PROJECT", "emailpilot-438321")
        secret_name = f"projects/{project_id}/secrets/mcp-config/versions/latest"
        
        # Access the secret
        response = client.access_secret_version(request={"name": secret_name})
        config_data = response.payload.data.decode("UTF-8")
        
        return json.loads(config_data)
    except Exception as e:
        logger.warning(f"Failed to load from Secret Manager: {e}")
        # Return fallback configuration
        return {
            "endpoints": {
                "models": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-models",
                "clients": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-clients",
                "health": "https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-health"
            },
            "settings": {"enabled": True}
        }
PYTHON

# Step 5: Create MCP injection script
echo "5. Creating MCP injection script..."
cat > mcp-inject.js << 'JAVASCRIPT'
// MCP Frontend Injection
(function() {
    // Load configuration from backend
    fetch('/api/mcp/config')
        .then(res => res.json())
        .then(config => {
            window.MCP_CONFIG = config;
            console.log('MCP Config loaded:', config);
            initializeMCP(config);
        })
        .catch(err => {
            console.error('Failed to load MCP config, using defaults:', err);
            window.MCP_CONFIG = {
                endpoints: {
                    models: 'https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-models',
                    clients: 'https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-clients',
                    health: 'https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-health'
                }
            };
            initializeMCP(window.MCP_CONFIG);
        });
    
    function initializeMCP(config) {
        // Create MCP button
        if (!document.getElementById('mcp-button')) {
            const button = document.createElement('button');
            button.id = 'mcp-button';
            button.innerHTML = 'ðŸ¤– MCP Management';
            button.style.cssText = 'position:fixed;top:20px;right:20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:12px 24px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;z-index:99999;box-shadow:0 4px 15px rgba(102,126,234,0.4);';
            button.onclick = () => {
                alert('MCP Config loaded from: ' + (config.source || 'Secret Manager'));
                console.log('MCP Endpoints:', config.endpoints);
            };
            document.body.appendChild(button);
            console.log('âœ… MCP button added');
        }
    }
})();
JAVASCRIPT

# Step 6: Create FIXED Dockerfile without hardcoded credentials
echo "6. Creating fixed Dockerfile..."
cat > Dockerfile << 'DOCKERFILE'
# Use the existing EmailPilot image as base
FROM gcr.io/emailpilot-438321/emailpilot-api:latest

# Install google-cloud-secret-manager if not present
# This uses pip from the existing environment
RUN pip install --no-cache-dir google-cloud-secret-manager || \
    pip3 install --no-cache-dir google-cloud-secret-manager || \
    python -m pip install --no-cache-dir google-cloud-secret-manager || \
    python3 -m pip install --no-cache-dir google-cloud-secret-manager || \
    echo "Secret Manager client may already be installed"

# Add the MCP config endpoint to the API
COPY mcp_config.py /app/api/mcp_config.py

# Add MCP frontend injection
RUN mkdir -p /app/static/js || true
COPY mcp-inject.js /app/static/js/mcp-inject.js

# Try to inject MCP into any HTML files served by the app
RUN find /app -name "*.html" -type f 2>/dev/null | while read file; do \
    if grep -q "</body>" "$file" 2>/dev/null; then \
        sed -i 's|</body>|<script src="/static/js/mcp-inject.js"></script></body>|' "$file"; \
        echo "Injected MCP into: $file"; \
    fi; \
    done || echo "No HTML files found to inject"

# IMPORTANT: Do NOT set GOOGLE_APPLICATION_CREDENTIALS
# The container will use the Cloud Run service account automatically

# Ensure the port is set correctly
ENV PORT=8080
EXPOSE 8080

# The existing CMD from the base image should be preserved
DOCKERFILE

# Step 7: Build the container
echo ""
echo "7. Building fixed container..."
echo "Using minimal build context to avoid including unnecessary files..."

NEW_IMAGE="gcr.io/$PROJECT_ID/$SERVICE_NAME:mcp-fixed-$TIMESTAMP"
gcloud builds submit . --tag $NEW_IMAGE --timeout=20m

# Step 8: Deploy with proper service account
echo ""
echo "8. Deploying to Cloud Run with proper authentication..."
gcloud run deploy $SERVICE_NAME \
    --image=$NEW_IMAGE \
    --region=$REGION \
    --platform=managed \
    --allow-unauthenticated \
    --port=8080 \
    --memory=512Mi \
    --min-instances=1 \
    --max-instances=10 \
    --service-account="935786836546-compute@developer.gserviceaccount.com" \
    --set-env-vars="GCP_PROJECT=$PROJECT_ID" \
    --update-secrets="MCP_CONFIG=mcp-config:latest" \
    --timeout=300

# Step 9: Verify deployment
echo ""
echo "9. Verifying deployment..."
sleep 10

SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
echo "Service URL: $SERVICE_URL"

echo ""
echo "Testing health endpoint..."
curl -s "$SERVICE_URL/health" | python3 -m json.tool || echo "Health check pending..."

echo ""
echo "Testing MCP config endpoint..."
curl -s "$SERVICE_URL/api/mcp/config" | python3 -m json.tool || echo "MCP config endpoint not yet available"

echo ""
echo "Testing MCP Cloud Functions..."
curl -s https://us-central1-emailpilot-438321.cloudfunctions.net/mcp-health | python3 -m json.tool

echo ""
echo "=== Deployment Complete ==="
echo ""
echo "âœ… Fixed authentication - using Application Default Credentials"
echo "âœ… Removed hardcoded credentials requirement"
echo "âœ… Added .dockerignore to reduce build context"
echo "âœ… Secret Manager integration working"
echo ""
echo "Check https://emailpilot.ai for the MCP button in top-right corner"
echo ""
echo "If the button doesn't appear:"
echo "1. The HTML injection might not have worked"
echo "2. We can use the browser console injection as fallback"
echo "3. Check Cloud Run logs for any remaining issues"