<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Campaign Calendar - Rogue Creamery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .day {
            border: 1px solid #e5e7eb;
            min-height: 140px; /* Increased min-height for more space */
            transition: background-color 0.3s;
            padding-bottom: 0.5rem;
            position: relative;
        }
        .day:hover {
            background-color: #f9fafb;
        }
        .day-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            text-align: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .day-number {
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.5rem;
        }
        .event {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            margin: 0.25rem;
            border-radius: 0.375rem;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            align-items: center;
        }
        .event:active {
            cursor: grabbing;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content-area {
             max-height: 70vh;
             overflow-y: auto;
        }
        .add-event-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            opacity: 0;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .day:hover .add-event-btn {
            opacity: 1;
        }
        .dragging {
            opacity: 0.5;
        }
        #ai-review-section, #import-log-section, #commit-log-section {
            white-space: pre-wrap;
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg">
        <div class="p-6 border-b border-gray-200">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <div class="flex items-center space-x-2">
                        <select id="client-selector" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        <button id="add-client-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <h1 id="calendar-title" class="text-2xl sm:text-3xl font-bold text-gray-800 mt-2">September 2025</h1>
                </div>
                <div class="flex items-center space-x-2">
                     <button id="import-plan-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 flex items-center space-x-2 disabled:bg-blue-300 disabled:cursor-not-allowed" disabled>
                        <span id="import-btn-text">Import from Google Doc</span>
                        <div id="import-loader" class="loader hidden"></div>
                     </button>
                     <button id="undo-changes-btn" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700 hidden">Undo Changes</button>
                    <button id="prev-month-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <button id="next-month-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2">
                <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-red-300"></div><span class="text-xs text-gray-600 font-medium">RRB Promotion</span></div>
                <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-green-200"></div><span class="text-xs text-gray-600 font-medium">Cheese Club</span></div>
                <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-blue-200"></div><span class="text-xs text-gray-600 font-medium">Nurturing/Education</span></div>
                <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-purple-200"></div><span class="text-xs text-gray-600 font-medium">Community/Lifestyle</span></div>
                <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-yellow-200"></div><span class="text-xs text-gray-600 font-medium">Re-engagement</span></div>
                <div class="flex items-center space-x-2"><div class="w-4 h-4 rounded-full bg-orange-300"></div><span class="text-xs text-gray-600 font-medium">SMS Alert</span></div>
            </div>
        </div>

        <div>
            <div class="grid grid-cols-7">
                <div class="day-name">SUN</div>
                <div class="day-name">MON</div>
                <div class="day-name">TUE</div>
                <div class="day-name">WED</div>
                <div class="day-name">THU</div>
                <div class="day-name">FRI</div>
                <div class="day-name">SAT</div>
            </div>
            <div id="calendar-grid" class="calendar-grid">
                <!-- Calendar days will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto mt-8 space-y-8">
        <button id="ai-review-btn" class="w-full px-6 py-3 bg-gray-800 text-white font-semibold rounded-lg hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-800">AI Review and Export</button>
        
        <div id="ai-review-section" class="hidden p-6 bg-white rounded-xl shadow-lg">
            <div id="ai-loading" class="hidden text-center">
                <p class="text-lg font-medium text-gray-700">Analyzing your campaign plan...</p>
                <div class="mt-4 animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
            </div>
            <div id="ai-results"></div>
            <div id="asana-export-section" class="hidden mt-6">
                <h3 class="text-xl font-bold text-gray-800">Asana Export</h3>
                <p class="text-sm text-gray-500 mb-2">Copy the text below and paste it into an Asana task.</p>
                <div class="relative">
                    <textarea id="asana-export-content" readonly class="w-full h-64 p-3 bg-gray-100 rounded-md font-mono text-xs"></textarea>
                    <button id="copy-asana-btn" class="absolute top-2 right-2 px-3 py-1 bg-gray-600 text-white text-xs font-semibold rounded-md hover:bg-gray-700">Copy</button>
                </div>
            </div>
        </div>

        <button id="commit-calendar-btn" class="w-full px-6 py-3 bg-green-700 text-white font-semibold rounded-lg hover:bg-green-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-700 disabled:bg-green-300 disabled:cursor-not-allowed" disabled>Authorize & Commit to Google Sheet</button>

        <div id="import-log-section" class="hidden p-6 bg-gray-50 rounded-xl shadow-inner">
            <h3 class="text-xl font-bold text-gray-800">Import Log</h3>
            <pre id="import-log-content" class="mt-4 bg-gray-900 text-white text-xs p-4 rounded-md overflow-x-auto"></pre>
        </div>
        
        <div id="commit-log-section" class="hidden p-6 bg-gray-50 rounded-xl shadow-inner">
            <h3 class="text-xl font-bold text-gray-800">Commit Log</h3>
            <pre id="commit-log-content" class="mt-4 bg-gray-900 text-white text-xs p-4 rounded-md overflow-x-auto"></pre>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all scale-95">
            <div id="modal-content-area" class="modal-content-area p-6">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, initializeFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, setLogLevel, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- STATE MANAGEMENT ---
        let currentDate = new Date(2025, 8, 1); // September 2025
        let campaignData = {};
        let originalCampaignPlan = null;
        let originalCampaignDataAfterImport = null;
        let draggedEventId = null;
        let clients = [];
        let currentClientId = null;
        
        // --- Initialization State ---
        let gapiInited = false;
        let gisInited = false;
        let pickerInited = false;
        let firebaseReady = false;
        let tokenClient;

        // Firebase state
        let db, auth, userId, appId;

        // --- CONFIGURATION ---
        const GEMINI_API_KEY = "AIzaSyDZxn9-FekvRhcvRfneulDrebD0RFxUpvs";
        const GOOGLE_API_KEY = "AIzaSyAMeP8IjAfqmHAh7MeN5lpu2OpHhfRTTEg";
        const GOOGLE_CLIENT_ID = "1058910766003-pqu4avth8ltclpbtpk81k0ln21dl8jue.apps.googleusercontent.com";
        const SCOPES = 'https://www.googleapis.com/auth/documents.readonly https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/spreadsheets';

        // --- DOM ELEMENTS ---
        const modal = document.getElementById('modal');
        const modalContentArea = document.getElementById('modal-content-area');
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarTitle = document.getElementById('calendar-title');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const importPlanBtn = document.getElementById('import-plan-btn');
        const importBtnText = document.getElementById('import-btn-text');
        const importLoader = document.getElementById('import-loader');
        const undoChangesBtn = document.getElementById('undo-changes-btn');
        const aiReviewBtn = document.getElementById('ai-review-btn');
        const aiReviewSection = document.getElementById('ai-review-section');
        const aiLoading = document.getElementById('ai-loading');
        const aiResults = document.getElementById('ai-results');
        const asanaExportSection = document.getElementById('asana-export-section');
        const asanaExportContent = document.getElementById('asana-export-content');
        const copyAsanaBtn = document.getElementById('copy-asana-btn');
        const importLogSection = document.getElementById('import-log-section');
        const importLogContent = document.getElementById('import-log-content');
        const commitCalendarBtn = document.getElementById('commit-calendar-btn');
        const commitLogSection = document.getElementById('commit-log-section');
        const commitLogContent = document.getElementById('commit-log-content');
        const clientSelector = document.getElementById('client-selector');
        const addClientBtn = document.getElementById('add-client-btn');

        // --- FUNCTIONS ---
        
        function log(message, type = 'import') {
            const logSection = type === 'commit' ? commitLogSection : importLogSection;
            const logContent = type === 'commit' ? commitLogContent : importLogContent;
            if (logSection.classList.contains('hidden')) {
                logSection.classList.remove('hidden');
            }
            logContent.textContent += `\n${new Date().toLocaleTimeString()} - ${message}`;
        }

        /**
         * Converts a zero-based column index to A1 notation (e.g., 0 -> A, 26 -> AA).
         * @param {number} index The zero-based column index.
         * @returns {string} The A1 notation for the column.
         */
        function columnIndexToA1(index) {
            let a1 = '';
            let temp = index;
            while (temp >= 0) {
                a1 = String.fromCharCode((temp % 26) + 65) + a1;
                temp = Math.floor(temp / 26) - 1;
            }
            return a1;
        }

        async function saveClientData() {
            if (!currentClientId) return;
            // Each client's data is stored in a document named after their ID.
            const clientDocRef = doc(db, `artifacts/${appId}/users/${userId}/clients/${currentClientId}`);
            const dataToSave = {
                // Save the client's name along with their data
                name: clients.find(c => c.id === currentClientId)?.name,
                campaignData: JSON.parse(JSON.stringify(campaignData)),
                originalCampaignPlan: originalCampaignPlan,
                originalCampaignDataAfterImport: originalCampaignDataAfterImport
            };
            await setDoc(clientDocRef, dataToSave, { merge: true });
            log(`Saved data for client: ${currentClientId}`, 'import');
        }

        async function loadClientData(clientId) {
            currentClientId = clientId;
            // Each client's data is stored in a document named after their ID.
            const clientRef = doc(db, `artifacts/${appId}/users/${userId}/clients/${clientId}`);
            const clientSnap = await getDoc(clientRef);

            if (clientSnap.exists()) {
                const clientData = clientSnap.data();
                campaignData = clientData.campaignData || {};
                originalCampaignPlan = clientData.originalCampaignPlan || null;
                originalCampaignDataAfterImport = clientData.originalCampaignDataAfterImport || null;
                undoChangesBtn.classList.toggle('hidden', !originalCampaignDataAfterImport);
                log(`Loaded data for client: ${clientData.name || clientId}`);
            } else {
                campaignData = {};
                originalCampaignPlan = null;
                originalCampaignDataAfterImport = null;
                undoChangesBtn.classList.add('hidden');
                log(`No data found for client: ${clientId}. Initializing fresh calendar.`);
            }
            generateCalendar();
        }

        function generateCalendar() {
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            calendarTitle.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay();

            const prevLastDay = new Date(year, month, 0);
            const prevDays = prevLastDay.getDate();
            for (let i = startDayOfWeek; i > 0; i--) {
                const day = prevDays - i + 1;
                const date = new Date(year, month - 1, day);
                calendarGrid.appendChild(createDayElement(day, date, true));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                 const date = new Date(year, month, day);
                calendarGrid.appendChild(createDayElement(day, date));
            }

            const nextDays = 42 - (startDayOfWeek + daysInMonth);
            for (let day = 1; day <= nextDays; day++) {
                const date = new Date(year, month + 1, day);
                calendarGrid.appendChild(createDayElement(day, date, true));
            }
            
            renderAllEvents();
        }

        function createDayElement(dayNumber, date, isOtherMonth = false) {
            const dayEl = document.createElement('div');
            const dateString = date.toISOString().split('T')[0];
            dayEl.className = `day ${isOtherMonth ? 'text-gray-400 bg-gray-50' : ''}`;
            dayEl.dataset.date = dateString;

            const dayNumberEl = document.createElement('div');
            dayNumberEl.className = 'day-number';
            dayNumberEl.textContent = dayNumber;
            dayEl.appendChild(dayNumberEl);

            const addBtn = document.createElement('button');
            addBtn.className = 'add-event-btn text-gray-400 hover:text-indigo-600';
            addBtn.innerHTML = '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>';
            addBtn.addEventListener('click', () => {
                renderModalContent(null, dateString);
                openModal();
            });
            dayEl.appendChild(addBtn);

            dayEl.addEventListener('dragover', e => e.preventDefault());
            dayEl.addEventListener('drop', e => {
                e.preventDefault();
                if (draggedEventId) {
                    const draggedEl = document.getElementById(draggedEventId);
                    dayEl.appendChild(draggedEl);
                    campaignData[draggedEventId].date = dateString;
                    draggedEventId = null;
                    saveClientData();
                }
            });
            return dayEl;
        }
        
        function renderAllEvents() {
            Object.keys(campaignData).forEach(eventId => {
                const event = campaignData[eventId];
                const dayEl = document.querySelector(`.day[data-date="${event.date}"]`);
                if (dayEl && !document.getElementById(eventId)) {
                    const eventEl = createEventElement(eventId, event);
                    dayEl.appendChild(eventEl);
                }
            });
        }
        
        function createEventElement(eventId, eventData) {
            const eventEl = document.createElement('div');
            eventEl.id = eventId;
            eventEl.className = `event ${eventData.color || 'bg-gray-200 text-gray-800'}`;
            eventEl.draggable = true;
            eventEl.innerHTML = eventData.title;
            addEventListenersToEvent(eventEl);
            return eventEl;
        }

        async function processPlanFromDoc(docId) {
            importBtnText.textContent = 'Processing...';
            importLoader.classList.remove('hidden');
            importPlanBtn.disabled = true;
            importLogContent.textContent = ''; // Clear previous logs
            log('Starting Google Doc import...');
            
            try {
                log(`Fetching content for Google Doc ID: ${docId}`);
                const docResponse = await gapi.client.docs.documents.get({
                    documentId: docId,
                });
                
                const docContent = docResponse.result.body.content;
                let textData = '';
                
                function extractTextFromElement(element) {
                    let text = '';
                    if (element.paragraph) {
                        element.paragraph.elements.forEach(el => {
                            if (el.textRun) {
                                text += el.textRun.content;
                            }
                        });
                    }
                    if (element.table) {
                        element.table.tableRows.forEach(row => {
                            row.tableCells.forEach(cell => {
                                let cellText = '';
                                cell.content.forEach(cellElement => {
                                    cellText += extractTextFromElement(cellElement);
                                });
                                text += cellText.replace(/\s+/g, ' ').trim() + '\t';
                            });
                            text += '\n';
                        });
                    }
                    return text;
                }
                
                docContent.forEach(element => {
                    textData += extractTextFromElement(element);
                });
                
                originalCampaignPlan = textData;
                log('Successfully extracted text from Google Doc. Processing in batches...');
                
                const parsedJson = await processCampaignsInBatches(textData);
                
                log(`AI batch processing complete. Found ${parsedJson.length} campaigns.`);
                await populateCalendarFromData(parsedJson);

            } catch (error) {
                console.error("Error processing plan from Doc:", error);
                log(`\n\nERROR: ${error.message}\nFailed to process the Google Doc.`);
                if (textData) {
                    log(`\nDebugging info:`);
                    log(`- Total extracted text length: ${textData.length}`);
                    log(`- First 500 characters of extracted text:`);
                    log(textData.substring(0, 500));
                }
            } finally {
                importBtnText.textContent = 'Import from Google Doc';
                importLoader.classList.add('hidden');
                importPlanBtn.disabled = false;
            }
        }

        async function callGeminiAPI(prompt, schema = null) {
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    maxOutputTokens: 8192,
                    temperature: 0.1
                }
            };
            
            if (schema) {
                payload.generationConfig.responseSchema = schema;
            }

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }
            
            const result = await response.json();
            return result.candidates[0].content.parts[0].text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
        }

        async function processCampaignsInBatches(textData) {
            const campaigns = [];
            
            const lines = textData.split('\n');
            const tableLines = lines.filter(line => 
                line.includes('\t') && 
                (line.includes('2025-') || line.match(/^\d+\t/))
            );
            
            log(`Found ${tableLines.length} potential campaign rows to process in batches.`);
            
            const batchSize = 8;
            for (let i = 0; i < tableLines.length; i += batchSize) {
                const batch = tableLines.slice(i, i + batchSize);
                const batchText = batch.join('\n');
                
                log(`Processing batch ${Math.floor(i/batchSize) + 1} (campaigns ${i+1}-${Math.min(i+batchSize, tableLines.length)})`);
                
                const batchPrompt = `
                    Parse the following campaign table rows into a JSON array. Each line is a tab-separated row.
                    
                    Field order: Week | Send Date | Send Time | Segment(s) | Subject Line A/B | Preview Text | Hero H1 | Sub-head | Hero Image | CTA Copy | Offer | A/B Test Idea | Secondary Message/SMS
                    
                    Return JSON with camelCase keys: week, sendDate, sendTime, segments, subjectLineAB, previewText, heroH1, subhead, heroImage, ctaCopy, offer, abTestIdea, secondaryMessageSMS
                    
                    Rows to parse:
                    ${batchText}
                `;
                
                try {
                    const batchResult = await callGeminiAPI(batchPrompt);
                    const batchCampaigns = JSON.parse(batchResult);
                    campaigns.push(...batchCampaigns);
                    
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Delay between batches
                    
                } catch (error) {
                    log(`Error processing batch ${Math.floor(i/batchSize) + 1}: ${error.message}`);
                }
            }
            
            return campaigns;
        }

        async function populateCalendarFromData(parsedData) {
            log(`Populating calendar with ${parsedData.length} campaigns...`);
            campaignData = {}; // Clear existing data
            let successCount = 0;
            let errorCount = 0;

            parsedData.forEach((item, index) => {
                try {
                    const eventId = `event-import-${Date.now()}-${index}`;
                    
                    const subjectLine = item.subjectLineAB;
                    const heroH1 = item.heroH1;
                    const sendDate = item.sendDate;
                    const secondaryMessage = item.secondaryMessageSMS;

                    if (!sendDate || !/^\d{4}-\d{2}-\d{2}$/.test(sendDate.trim())) {
                        throw new Error(`Invalid or missing 'sendDate' format: ${sendDate}`);
                    }

                    let title;
                    if (subjectLine && subjectLine.trim().toLowerCase() !== "n/a - sms only") {
                        title = subjectLine.split('/')[0].trim();
                    } else if (secondaryMessage) {
                        title = "SMS: " + secondaryMessage.split('!')[0].split('?')[0].substring(0, 30) + '...';
                    } else {
                        title = heroH1 || 'Untitled Campaign';
                    }

                    const color = getColorForTitle(title);

                    campaignData[eventId] = {
                        date: sendDate.trim(),
                        title: title,
                        color: color,
                        content: `<strong>Week:</strong> ${item.week || 'N/A'}<br><strong>Send Time:</strong> ${item.sendTime || 'N/A'}<br><strong>Segment(s):</strong> ${item.segments || 'N/A'}<br><strong>Subject A:</strong> ${subjectLine ? subjectLine.split('/')[0].trim() : 'N/A'}<br><strong>Subject B:</strong> ${subjectLine ? (subjectLine.split('/')[1]?.trim() || 'N/A') : 'N/A'}<br><strong>Preview Text:</strong> ${item.previewText || 'N/A'}<br><strong>Hero H1:</strong> ${heroH1 || 'N/A'}<br><strong>Sub-head:</strong> ${item.subhead || 'N/A'}<br><strong>Hero Image:</strong> ${item.heroImage || 'N/A'}<br><strong>CTA Copy:</strong> ${item.ctaCopy || 'N/A'}<br><strong>Offer:</strong> ${item.offer || 'N/A'}<br><strong>A/B Test:</strong> ${item.abTestIdea || 'N/A'}<br><strong>Secondary/SMS:</strong> ${secondaryMessage || 'N/A'}`
                    };
                    successCount++;
                } catch (e) {
                    errorCount++;
                    log(`  - ERROR processing row ${index + 2}: ${e.message}. Skipping.`);
                    console.error(`Error on row ${index + 2}:`, item, e);
                }
            });

            originalCampaignDataAfterImport = JSON.parse(JSON.stringify(campaignData));
            
            await saveClientData();

            undoChangesBtn.classList.remove('hidden');
            generateCalendar();
            log(`\n\nImport complete and saved to database.\n  - Successfully added: ${successCount} campaigns.\n  - Failed to add: ${errorCount} campaigns.`);
        }
        
        function getColorForTitle(title) {
            if (title.toLowerCase().includes('rrb') || title.toLowerCase().includes('pre-order')) return 'bg-red-300 text-red-800 font-bold';
            if (title.toLowerCase().includes('club')) return 'bg-green-200 text-green-800';
            if (title.toLowerCase().includes('sms')) return 'bg-orange-300 text-orange-800';
            if (title.toLowerCase().includes('miss you') || title.toLowerCase().includes('reconnect')) return 'bg-yellow-200 text-yellow-800';
            if (title.toLowerCase().includes('board') || title.toLowerCase().includes('gifting') || title.toLowerCase().includes('burger')) return 'bg-purple-200 text-purple-800';
            return 'bg-blue-200 text-blue-800';
        }

        function renderModalContent(eventId = null, date = null) {
            const isNew = !eventId;
            const data = isNew ? { title: '', content: '<strong>Segment:</strong> <br><strong>Send Time:</strong> <br><strong>Subject A:</strong> <br><strong>Subject B:</strong> <br><strong>Preview Text:</strong> <br><strong>Main CTA:</strong> <br><strong>Offer:</strong> <br><strong>A/B Test:</strong> ' } : campaignData[eventId];
            
            modalContentArea.innerHTML = `
                <div class="flex justify-between items-start">
                    <h2 class="text-xl font-bold text-gray-800">${isNew ? 'Create New Campaign' : data.title}</h2>
                    <button id="modal-close" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                </div>
                <div id="modal-view-mode" class="${isNew ? 'hidden' : ''}">
                    <div class="mt-4 text-sm text-gray-600 space-y-3">${data.content}</div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="modal-duplicate-btn" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Duplicate</button>
                        <button id="modal-edit-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Edit</button>
                    </div>
                </div>
                <div id="modal-edit-mode" class="${isNew ? '' : 'hidden'}">
                    <div class="mt-4 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Campaign Title</label>
                            <input type="text" id="edit-title" value="${data.title}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Campaign Details (use <br> for new lines)</label>
                            <textarea id="edit-content" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">${data.content.replace(/<br>/g, '\n')}</textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-between">
                        <button id="modal-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 ${isNew ? 'hidden' : ''}">Delete</button>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                            <button id="modal-save-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save</button>
                        </div>
                    </div>
                </div>
                <div id="modal-delete-confirm" class="hidden mt-4 text-center">
                    <p class="text-lg font-medium text-gray-900">Are you sure?</p>
                    <p class="text-sm text-gray-500">This action cannot be undone.</p>
                    <div class="mt-4 flex justify-center space-x-4">
                        <button id="modal-delete-no" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                        <button id="modal-delete-yes" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Yes, Delete</button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-close').addEventListener('click', closeModal);
            if (!isNew) {
                document.getElementById('modal-edit-btn').addEventListener('click', () => {
                    document.getElementById('modal-view-mode').classList.add('hidden');
                    document.getElementById('modal-edit-mode').classList.remove('hidden');
                });
                document.getElementById('modal-duplicate-btn').addEventListener('click', () => duplicateEvent(eventId));
            }
            document.getElementById('modal-cancel-btn').addEventListener('click', () => {
                if(isNew) closeModal();
                else {
                    document.getElementById('modal-edit-mode').classList.add('hidden');
                    document.getElementById('modal-view-mode').classList.remove('hidden');
                    document.getElementById('modal-delete-confirm').classList.add('hidden');
                }
            });
            document.getElementById('modal-save-btn').addEventListener('click', () => saveEvent(eventId, date));
            if (!isNew) {
                document.getElementById('modal-delete-btn').addEventListener('click', () => {
                     document.getElementById('modal-edit-mode').classList.add('hidden');
                     document.getElementById('modal-delete-confirm').classList.remove('hidden');
                });
                document.getElementById('modal-delete-no').addEventListener('click', () => {
                    document.getElementById('modal-delete-confirm').classList.add('hidden');
                    document.getElementById('modal-edit-mode').classList.remove('hidden');
                });
                document.getElementById('modal-delete-yes').addEventListener('click', () => deleteEvent(eventId));
            }
        }
        function openModal() {
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            setTimeout(() => modal.querySelector('.transform').classList.remove('scale-95'), 10);
        }
        function closeModal() {
            modal.querySelector('.transform').classList.add('scale-95');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        function saveEvent(eventId, date) {
            const newTitle = document.getElementById('edit-title').value;
            const newContent = document.getElementById('edit-content').value.replace(/\n/g, '<br>');
            
            if (eventId) {
                campaignData[eventId].title = newTitle;
                campaignData[eventId].content = newContent;
                const eventEl = document.getElementById(eventId);
                eventEl.innerHTML = newTitle;
            } else {
                const newId = 'event-' + Date.now();
                campaignData[newId] = { date: date, title: newTitle, content: newContent, color: 'bg-gray-200 text-gray-800' };
                const eventEl = createEventElement(newId, campaignData[newId]);
                document.querySelector(`.day[data-date="${date}"]`).appendChild(eventEl);
            }
            saveClientData();
            closeModal();
        }
        function deleteEvent(eventId) {
            delete campaignData[eventId];
            document.getElementById(eventId)?.remove();
            saveClientData();
            closeModal();
        }
        function duplicateEvent(eventId) {
            const originalEvent = campaignData[eventId];
            const newId = 'event-dupe-' + Date.now();
            
            const newEventData = JSON.parse(JSON.stringify(originalEvent));
            newEventData.title = `${originalEvent.title} (Copy)`;
            
            campaignData[newId] = newEventData;
            
            const newEventEl = createEventElement(newId, newEventData);
            document.querySelector(`.day[data-date="${originalEvent.date}"]`).appendChild(newEventEl);
            
            saveClientData();
            closeModal();
        }
        function addEventListenersToEvent(eventEl) {
            eventEl.addEventListener('click', (e) => {
                e.stopPropagation();
                renderModalContent(eventEl.id);
                openModal();
            });
            eventEl.addEventListener('dragstart', (e) => {
                draggedEventId = e.target.id;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            });
            eventEl.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
            });
        }
        
        async function handleAiReview() {
            if (!originalCampaignPlan) {
                alert('Please import a campaign plan first to compare against.');
                return;
            }

            aiReviewSection.classList.remove('hidden');
            aiResults.classList.add('hidden');
            asanaExportSection.classList.add('hidden');
            aiLoading.classList.remove('hidden');

            const currentPlan = Object.values(campaignData).map(event => {
                return `Date: ${event.date}\nTitle: ${event.title}\nDetails:\n${event.content.replace(/<br>/g, '\n').replace(/<strong>/g, '').replace(/<\/strong>/g, '')}`;
            }).join('\n\n---\n\n');

            const prompt = `
                You are a world-class email and SMS marketing strategist and data analyst, specializing in e-commerce for premium consumer brands.

                Here is the ORIGINAL campaign plan that was imported:
                --- ORIGINAL PLAN ---
                ${originalCampaignPlan}
                --- END ORIGINAL PLAN ---

                Here is the CURRENT state of the calendar after potential user modifications:
                --- CURRENT PLAN ---
                ${currentPlan}
                --- END CURRENT PLAN ---

                You are an expert Direct-to-Consumer CRM strategist with 15+ years of experience optimizing email, SMS, and push notification campaigns for maximum revenue generation.
Your task is to perform a comprehensive analysis of the CURRENT CRM calendar plan to evaluate its potential for driving sales and customer lifetime value.
ANALYSIS FRAMEWORK:
1. Change Analysis (if applicable)
Identify material changes between original and current plan that impact revenue potential (e.g., "Flash Sale moved from month-start to mid-month," "High-AOV segment campaign removed").
2. Revenue-Focused Evaluation Criteria:
A. Strategic Revenue Architecture (30% weight)

Sales Momentum Building: Does the calendar create escalating desire leading to major sales events?
Offer Ladder Strategy: Is there a logical progression from soft sells to harder promotions?
Conversion Path Clarity: Can you trace how each touchpoint moves customers toward purchase?
Theme-to-Revenue Alignment: Do monthly/quarterly themes directly support revenue goals?

B. Audience Monetization Strategy (25% weight)

Segment Value Optimization: Are high-value segments (VIPs, frequent buyers) receiving proportionally more attention?
Lifecycle Revenue Capture: How well does the plan monetize each customer lifecycle stage?
Win-back Revenue Potential: Are lapsed customer campaigns strategically timed and incentivized?
Personalization Depth: Level of behavioral targeting vs. spray-and-pray?

C. Channel Synergy & Amplification (20% weight)

Cross-Channel Revenue Multiplication: Do SMS/Push amplify email campaigns or cannibalize them?
Channel-Specific Value Props: Is each channel used for its unique strengths?
Urgency Creation: How effectively do channels work together to create FOMO?

D. Tactical Execution Excellence (15% weight)

Send Frequency Optimization: Balance between revenue maximization and fatigue
Content Mix ROI: Ratio of promotional vs. value content and impact on engagement
Testing Infrastructure: A/B test opportunities built into calendar

E. Performance Predictability (10% weight)

Historical Performance Integration: Does plan leverage past winning strategies?
KPI Achievability: Are revenue targets realistic based on send volume and offers?
Competitive Differentiation: How does this stack against industry best practices?

3. Sales Effectiveness Grade
Assign a letter grade (A+ to F) based on projected revenue impact:

A+/A: Projected to exceed revenue goals by 15%+
B+/B: Likely to meet revenue goals
C+/C: May fall short of goals by 10-20%
D or below: Significant revenue risk

4. Revenue-Driving Recommendations
Provide 3-5 specific, high-impact changes that could increase revenue by at least 10%. Focus on:

Quick wins (implementable in <1 week)
Strategic pivots (1-month horizon)
Testing opportunities with high upside

OUTPUT FORMAT:
GRADE: [Letter Grade]

REVENUE IMPACT SUMMARY: [One sentence explaining projected impact on sales]

TOP REVENUE OPPORTUNITIES:
- [Opportunity 1 - Include potential revenue lift %]
- [Opportunity 2 - Include potential revenue lift %]
- [Opportunity 3 - Include potential revenue lift %]

CRITICAL FIXES REQUIRED:
- [Fix 1 - What's broken and costing revenue]
- [Fix 2 - What's broken and costing revenue]
            `;
            
            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                
                if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                    throw new Error("Gemini API Key not provided. Please add your Gemini API Key to the script.");
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const result = await response.json();
                const aiResponseText = result.candidates[0].content.parts[0].text;
                
                const [gradeLine, ...feedbackLines] = aiResponseText.split('\n');
                const grade = gradeLine.replace('GRADE: ', '');
                const feedback = feedbackLines.join('\n').replace('FEEDBACK:', '');

                aiResults.innerHTML = `<h3 class="text-2xl font-bold text-gray-800">Campaign Grade: <span class="text-indigo-600">${grade}</span></h3><div class="mt-4 text-gray-700">${feedback}</div>`;
                
                formatForAsana();

            } catch (error) {
                aiResults.innerHTML = `<p class="text-red-500">An error occurred during the AI review. Please try again.</p>`;
                console.error("AI Review Error:", error);
            } finally {
                aiLoading.classList.add('hidden');
                aiResults.classList.remove('hidden');
                asanaExportSection.classList.remove('hidden');
            }
        }

        function formatForAsana() {
            let asanaText = `Rogue Creamery September 2025 Campaign Plan\n\n`;
            const sortedEvents = Object.values(campaignData).sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedEvents.forEach(event => {
                asanaText += `## ${event.title} - ${event.date}\n`;
                const details = event.content
                    .replace(/<br>/g, '\n')
                    .replace(/<strong>/g, '- **')
                    .replace(/<\/strong>:/g, '**:')
                asanaText += `${details}\n\n`;
            });

            asanaExportContent.value = asanaText;
        }

        async function handleCommit() {
            commitLogContent.textContent = '';
            log('Starting commit process...', 'commit');
            if (!gapiInited || !gisInited) {
                log('Google API not ready. Please wait a moment and try again.', 'commit');
                return;
            }

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                log('Authorization successful.', 'commit');
                await processCommitFile();
            };

            if (gapi.client.getToken() === null) {
                log('Requesting authorization...', 'commit');
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                log('Already authorized. Proceeding to commit.', 'commit');
                await processCommitFile();
            }
        }

        async function processCommitFile() {
            try {
                const sheetUrl = prompt("Please enter the full URL of the Google Sheet:");
                if (!sheetUrl) {
                    log('Commit cancelled by user.', 'commit');
                    return;
                }
                const spreadsheetId = new URL(sheetUrl).pathname.split('/')[3];
                if (!spreadsheetId) {
                    throw new Error("Could not parse Spreadsheet ID from URL.");
                }
                log(`Extracted Spreadsheet ID: ${spreadsheetId}`, 'commit');

                log('Reading existing data from Google Sheet...', 'commit');
                const range = '2025 Calendar!A1:ZZ100'; // Read a large range
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: spreadsheetId,
                    range: range,
                });
                const existingData = response.result.values || [];
                log('Successfully read existing sheet data.', 'commit');

                const month = currentDate.getMonth();
                const year = currentDate.getFullYear();
                
                const campaignsForMonth = Object.values(campaignData).filter(event => {
                    const eventDate = new Date(event.date + 'T00:00:00');
                    return eventDate.getMonth() === month && eventDate.getFullYear() === year;
                });

                if (campaignsForMonth.length === 0) {
                    log('No campaigns found for the current month. Nothing to commit.', 'commit');
                    return;
                }

                const campaignsJSON = JSON.stringify(campaignsForMonth, null, 2);
                
                const promptForAI = `
                    You are a data mapping expert. Your task is to determine the exact row and column for campaigns to be placed in a spreadsheet.

                    Here is the structure of the target spreadsheet (first few rows):
                    --- SPREADSHEET STRUCTURE ---
                    ${existingData.slice(0, 5).map(row => row.join(',')).join('\n')}
                    --- END SPREADSHEET STRUCTURE ---

                    Here is the campaign data to place for the month of ${currentDate.toLocaleString('default', { month: 'long' })} ${year}:
                    --- CAMPAIGN DATA ---
                    ${campaignsJSON}
                    --- END CAMPAIGN DATA ---

                    For each campaign, return a JSON object with the campaign title, the 0-indexed row number, and the 0-indexed column number where it should be placed.
                    - The row is determined by the day of the month.
                    - The column is determined by the month and the day of the week.
                    - If you are uncertain, provide your best logical guess. Always provide a row and column.
                `;

                log('Sending data to AI for cell mapping...', 'commit');
                
                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "title": { "type": "STRING" },
                            "row": { "type": "NUMBER" },
                            "column": { "type": "NUMBER" }
                        }
                    }
                };

                const chatHistory = [{ role: "user", parts: [{ text: promptForAI }] }];
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                };
                
                if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                    throw new Error("Gemini API Key not provided. Please add your Gemini API Key to the script.");
                }
                
                const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

                const geminiResponse = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!geminiResponse.ok) throw new Error(`AI Mapping Error: ${geminiResponse.status}`);
                const geminiResult = await geminiResponse.json();
                const cellMappings = JSON.parse(geminiResult.candidates[0].content.parts[0].text);
                log(`AI mapping complete. Received ${cellMappings.length} cell placements.`, 'commit');

                const dataForUpdate = cellMappings.map(mapping => {
                    // FIX: Use '\n' for a proper newline character in Sheets.
                    const existingValue = (existingData[mapping.row] && existingData[mapping.row][mapping.column]) ? existingData[mapping.row][mapping.column] + '\n' : '';
                    return {
                        // FIX: Use robust columnIndexToA1 function for correct column naming.
                        range: `'2025 Calendar'!${columnIndexToA1(mapping.column)}${mapping.row + 1}`,
                        values: [[existingValue + mapping.title]]
                    };
                });

                log('Sending updated data to Google Sheets API...', 'commit');
                await gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        valueInputOption: 'USER_ENTERED',
                        data: dataForUpdate
                    }
                });

                log('Commit complete. Your Google Sheet has been updated successfully.', 'commit');

            } catch (error) {
                log(`ERROR during commit process: ${error.message}`, 'commit');
                console.error("Commit error:", error);
            }
        }

        // --- EVENT LISTENERS ---
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        });

        importPlanBtn.addEventListener('click', () => {
             if (!gapiInited || !gisInited) {
                alert('Google API is not ready. Please wait a moment and try again.');
                log('Import attempted but APIs not ready.');
                return;
            }
            
            log('Import button clicked. Requesting authorization...');
            tokenClient.callback = (resp) => {
                if (resp.error !== undefined) {
                    log(`OAuth error: ${resp.error}`);
                    throw (resp);
                }
                log('OAuth authorization successful.');
                createPicker();
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                log('Already authorized. Opening picker...');
                createPicker();
            }
        });

        function createPicker() {
            if (!pickerInited) {
                log('ERROR: Google Picker API not ready.');
                return;
            }

            try {
                const picker = new google.picker.PickerBuilder()
                    .addView(google.picker.ViewId.DOCS)
                    .setOAuthToken(gapi.client.getToken().access_token)
                    .setDeveloperKey(GOOGLE_API_KEY)
                    .setCallback(pickerCallback)
                    .build();
                picker.setVisible(true);
                log('Google Picker opened.');
            } catch (error) {
                log(`ERROR creating picker: ${error.message}`);
                console.error('Picker creation error:', error);
            }
        }

        async function pickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                const doc = data.docs[0];
                log(`Selected document: ${doc.name} (ID: ${doc.id})`);
                await processPlanFromDoc(doc.id);
            }
        }

        undoChangesBtn.addEventListener('click', () => {
            if (originalCampaignDataAfterImport) {
                campaignData = JSON.parse(JSON.stringify(originalCampaignDataAfterImport));
                saveClientData();
                generateCalendar();
                log("Calendar state has been reverted to the last import.");
            } else {
                alert("No original plan has been imported yet to undo to.");
            }
        });

        aiReviewBtn.addEventListener('click', handleAiReview);
        commitCalendarBtn.addEventListener('click', handleCommit);

        copyAsanaBtn.addEventListener('click', () => {
            asanaExportContent.select();
            document.execCommand('copy');
            copyAsanaBtn.textContent = 'Copied!';
            setTimeout(() => { copyAsanaBtn.textContent = 'Copy'; }, 2000);
        });
        
        addClientBtn.addEventListener('click', async () => {
            const clientName = prompt("Enter the new client's name:");
            if (clientName) {
                const clientId = clientName.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
                const newClient = { id: clientId, name: clientName };
                
                // Add the new client to the local list
                clients.push(newClient);

                // Create a new document for this client in the 'clients' collection
                const newClientRef = doc(db, `artifacts/${appId}/users/${userId}/clients/${clientId}`);
                await setDoc(newClientRef, { name: clientName });

                updateClientSelector();
                clientSelector.value = clientId;
                await loadClientData(clientId);
            }
        });

        clientSelector.addEventListener('change', (e) => {
            loadClientData(e.target.value);
        });

        function updateClientSelector() {
            clientSelector.innerHTML = '';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelector.appendChild(option);
            });
        }


        // --- INITIALIZATION ---
        function gapiLoaded() {
            log('GAPI Library loaded.');
            gapi.load('client:picker', initializeGapiClient);
        }
        async function initializeGapiClient() {
            try {
                if (GOOGLE_API_KEY === "YOUR_GOOGLE_API_KEY_HERE") {
                    log('ERROR: Google API Key not set. Please replace with your actual Google API key.');
                    return;
                }
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: [
                        'https://sheets.googleapis.com/$discovery/rest?version=v4',
                        'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                        'https://docs.googleapis.com/$discovery/rest?version=v1'
                    ],
                });
                log('GAPI client initialized.');
                gapiInited = true;
                pickerInited = true; // Picker is loaded with client
                checkApisReady();
            } catch (error) {
                log(`ERROR initializing GAPI: ${error.message}`);
                console.error('GAPI init error:', error);
            }
        }
        function gisLoaded() {
            log('GIS Library loaded.');
            try {
                if (GOOGLE_CLIENT_ID === "YOUR_GOOGLE_CLIENT_ID_HERE.apps.googleusercontent.com") {
                     log('ERROR: Google Client ID not set. Please replace with your actual Client ID.');
                    return;
                }
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // Define callback dynamically
                });
                log('OAuth2 token client initialized.');
                gisInited = true;
                checkApisReady();
            } catch (error) {
                log(`ERROR initializing GIS: ${error.message}`);
                console.error('GIS init error:', error);
            }
        }

        function checkApisReady() {
            if (gapiInited && gisInited && firebaseReady) {
                log('All services are ready. Buttons enabled.');
                importPlanBtn.disabled = false;
                commitCalendarBtn.disabled = false;
            } else {
                log(`Service Status - Firebase: ${firebaseReady}, GAPI: ${gapiInited}, GIS: ${gisInited}`);
            }
        }
        
        // Make init functions globally available for script callbacks
        window.gapiLoaded = gapiLoaded;
        window.gisLoaded = gisLoaded;
        
        const gapiScript = document.createElement('script');
        gapiScript.src = 'https://apis.google.com/js/api.js';
        gapiScript.async = true;
        gapiScript.defer = true;
        gapiScript.onload = () => gapiLoaded();
        document.head.appendChild(gapiScript);

        const gisScript = document.createElement('script');
        gisScript.src = 'https://accounts.google.com/gsi/client';
        gisScript.async = true;
        gisScript.defer = true;
        gisScript.onload = () => gisLoaded();
        document.head.appendChild(gisScript);
        
        window.addEventListener('DOMContentLoaded', async () => {
            log('Initializing Application...');
            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyCSbMLOfdfyopHrmK5b4FT4z-G3jyyBUQQ",
                    authDomain: "campaign-calendar-v2.firebaseapp.com",
                    projectId: "campaign-calendar-v2",
                    storageBucket: "campaign-calendar-v2.firebasestorage.app",
                    messagingSenderId: "854829559919",
                    appId: "1:854829559919:web:6a127f2defcf9fc2ce1d9a"
                };
                log('Firebase config loaded.');
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                log('Firebase initialized. Authenticating...');
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                log(`Authenticated with User ID: ${userId}`);
                
                log("Authentication complete. Initializing Firestore...");
                db = initializeFirestore(app, {
                    experimentalForceLongPolling: true,
                });
                setLogLevel('debug');

                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                // CORRECTED LOGIC: Reference the 'clients' collection directly.
                const clientsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/clients`);
                log('Database references created. Fetching client list from collection...');

                const querySnapshot = await getDocs(clientsCollectionRef);
                clients = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (clients.length > 0) {
                    log(`Found ${clients.length} clients.`);
                    updateClientSelector();
                    await loadClientData(clients[0].id);
                } else {
                    log('No clients found in the database. Ready to add new clients.');
                    generateCalendar();
                }
                firebaseReady = true;
                checkApisReady();
            } catch (error) {
                 console.error("Firebase initialization failed:", error);
                 log(`FATAL ERROR during initialization: ${error.message}.`);
                 firebaseReady = false;
            }
        });
    </script>
</body>
</html>