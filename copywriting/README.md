# EmailPilot Copywriting Module

A standalone module for generating AI-powered email copywriting variants using multiple copywriting frameworks with full body copy, AI review, and chat refinement.

## ðŸš€ Latest Updates: Timeout Fixes & Content Intelligence

### âœ… Fixed Timeout Issues & Enhanced Fallback Content
The latest update addresses user feedback about timeouts and generic fallback content:

- **Extended Timeouts**: AI operations now allow up to 120 seconds (increased from 60s)
- **Better Loading UX**: Clear messaging about expected wait times (30-90 seconds)
- **Intelligent Fallbacks**: When AI services timeout, fallback content now parses and uses actual brief content instead of generic templates
- **Contextual Generation**: Coffee + Fall themes automatically detected and used in subject lines, messaging, and body copy
- **Smart Offers**: Discount percentages extracted from briefs and applied contextually

### âœ… Full AI Capabilities via Orchestrator
The copywriting module integrates with EmailPilot's centralized AI Orchestrator, providing:

- **Unified AI Interface**: Single point of access to all AI providers (OpenAI, Claude, Gemini)
- **Automatic Fallbacks**: Built-in retry logic with provider fallback chains
- **Marketing Optimization**: Special handling for marketing content to avoid safety filters
- **Cost Management**: Token tracking and usage analytics
- **Response Caching**: Automatic caching to reduce API costs
- **Model Discovery**: Live model availability checking

### Configuration
Set in your `.env` file:
```bash
USE_ORCHESTRATOR=true          # Use AI Orchestrator (recommended)
EMAILPILOT_BASE_URL=http://localhost:8000  # Main app URL
```

### How It Works
1. **With Orchestrator** (`USE_ORCHESTRATOR=true`):
   - Routes all AI calls through `/api/ai/complete` endpoint
   - Automatic provider selection based on content type
   - Marketing content automatically uses Gemini 2.0 Flash
   - Full fallback chain: Gemini â†’ Claude â†’ GPT-4 â†’ Gemini Pro

2. **Direct Mode** (`USE_ORCHESTRATOR=false`):
   - Falls back to direct API calls (requires API keys)
   - Used when main app is unavailable

### Benefits
- **No API Keys Needed**: Orchestrator handles all authentication
- **Better Reliability**: Automatic fallbacks prevent failures
- **Marketing-Optimized**: Avoids safety filter blocks on promotional content
- **Cost Tracking**: Monitor usage across all providers
- **Faster Response**: Cached responses for repeated queries

## Features

### Core Functionality
- **AI Model Selection**: Dropdown menu to explicitly choose which AI model to use (Claude, GPT-4, Gemini, etc.)
- **Active Agent Selection**: Checkboxes to select which AI agents participate in copy generation
- **Agent & Model Execution**: Selected agents and models are actually invoked through MCP service
- **Client Selection**: Dropdown populated from Firestore with all available clients
- **Brand Context Integration**: Automatically retrieves and applies brand voice, tone, and style guidelines
- **5 Copywriting Variants**: Generates variants using different frameworks (AIDA, FOMO, PAS, BAB, 4Ps)
- **Full Body Copy**: Each variant includes complete email body text generated by AI models

### New Interface Features
- **All Variants Visible**: All 5 generated versions displayed on page simultaneously
- **Inline Expansion**: Click any variant to expand inline (no popups)
- **Cross-Variant Borrowing**: Keep all versions visible to mix and match ideas
- **Full Context Display**: Complete email body shown for comprehensive review

### AI Review System
- **Letter Grade**: Each variant receives a grade (A+, A, B+, etc.)
- **Strengths & Improvements**: Specific feedback on what works and what could be better
- **Brief Alignment**: Analysis of how well the copy matches original brief goals
- **Teacher-Like Feedback**: Constructive, encouraging, and instructive tone
- **Specific Suggestions**: Section-by-section improvement recommendations

### AI Copy Refinement Assistant
The Refinement Assistant appears directly beneath each expanded email variant, providing an intuitive workflow for iterative improvements.

#### Interface Design
- **Contextual Placement**: Assistant appears immediately below the selected email version
- **Visibility**: Both email and assistant visible on standard laptop screens (1366x768+)
- **Visual Hierarchy**: Gradient blue background distinguishes refinement area
- **Compact Input**: Expandable textarea that grows with content
- **Keyboard Shortcut**: âŒ˜+Enter for quick refinement submission

#### How to Use the Refinement Assistant

1. **Select an Email Variant**
   - Click any generated variant to expand it
   - The Refinement Assistant appears below automatically

2. **Enter Refinement Instructions**
   - Type natural language instructions in the input field
   - Examples:
     - "Make the subject line more urgent"
     - "Shorten the CTA to 3 words"
     - "Add emojis to increase engagement"
     - "Make the tone more formal"
     - "Emphasize the limited-time offer"

3. **Apply Refinements**
   - Click "Refine Copy" or press âŒ˜+Enter
   - AI processes your instruction and updates the variant
   - Changes are applied in real-time to the preview

4. **Track Refinement History**
   - See last 3 refinements with timestamps
   - Each shows the instruction given and when applied
   - History persists for the session

5. **Reset if Needed**
   - "Reset to Original" button appears after refinements
   - Non-destructive - restores the initial generated version
   - Clears refinement history for that variant

#### Refinement Metadata
Each refinement logs:
- `refined_from`: Original variant ID
- `user_instruction`: The refinement request
- `provider`: AI provider used (OpenAI/Claude/Gemini)
- `model`: Specific model that processed the refinement
- `timestamp`: When the refinement was applied
- `changes_made`: List of specific changes applied

#### Technical Implementation
- **API Endpoint**: `/api/refine` handles refinement requests
- **State Management**: React state tracks refinement history per variant
- **Original Preservation**: Original variants stored separately for reset
- **Real-time Updates**: Variant updates immediately on successful refinement
- **Error Handling**: Graceful fallback to template-based refinements

### AI Chat Interface (Legacy)
- **Alternative Method**: Bottom chat interface for conversational refinements
- **Use Case**: Complex multi-step refinements or exploratory changes

## Installation & Setup

### 1. Configure AI Providers

Copy the example environment file and add your API keys:
```bash
cd /Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/copywriting
cp .env.example .env
```

Edit `.env` and add at least one API key:
```bash
# Choose one or more providers:
OPENAI_API_KEY=sk-...          # For GPT models
ANTHROPIC_API_KEY=sk-ant-...   # For Claude models  
GOOGLE_API_KEY=AIza...         # For Gemini models

# Set MCP routing (false = direct AI calls, true = route through MCP)
MCP_ENABLED=false
```

### 2. Start the Module

Run the startup script:
```bash
./start.sh
```

This will:
- Load environment variables from `.env`
- Check which AI providers are configured
- Create a virtual environment
- Install dependencies
- Start the server on port 8002

### 3. Verify Setup

The startup script will show:
- Which AI providers are available
- MCP routing status (enabled/disabled)
- Server URL (http://localhost:8002)

## Usage

1. **Access the module**: Open http://localhost:8002 in your browser

2. **Submit a brief**: 
   - Click "New Campaign Brief"
   - View available AI agents at top of dialog
   - Select a client from the dropdown (fetched from Firestore)
   - Paste your campaign brief
   - Click "Generate Copy"

3. **Review all variants**: 
   - All 5 variants displayed on single page
   - Click any variant to expand and see full email body
   - Other variants remain visible for comparison
   - Each variant shows framework, creativity level, and preview

4. **Edit inline**: 
   - Click into any field to edit directly
   - Full email body is editable in expanded view
   - Changes save automatically to the variant

5. **Get AI Review**: 
   - Click "AI Review" button on any expanded variant
   - Receive letter grade and detailed feedback
   - See strengths, improvements, and brief alignment
   - Get encouraging, teacher-like guidance

6. **Refine with AI Chat**: 
   - Use chat interface at bottom when variant is expanded
   - Request specific changes: "make subject line shorter"
   - AI applies edits directly to the current variant
   - Continue refining until satisfied

## API Endpoints

- `GET /` - Serve the web interface
- `GET /health` - Health check endpoint
- `GET /api/models` - Fetch available AI models from MCP service
- `GET /api/agents` - Fetch available AI agents from Agent/MCP services
- `GET /api/clients` - Fetch list of clients from Firestore with brand context
- `POST /api/generate-copy` - Generate copywriting variants using selected model and agents
- `GET /api/frameworks` - Get available frameworks and creativity levels
- `POST /api/review` - Get AI review with grade and feedback for a variant
- `POST /api/chat` - Chat with AI for copy refinements and inline edits

## Integration with EmailPilot

1. **Client Data**: Fetches clients directly from Firestore database with full brand context
2. **AI Agents**: Dynamically retrieves agent list from:
   - Agent Service: `http://localhost:8000/api/agents/list`
   - MCP Service: `http://localhost:8000/api/mcp/agents`
   - Falls back to predefined agents if services unavailable
3. **Agent Orchestration**: Connects to `http://localhost:8000/api/agents/invoke` with brand context
4. **Brand Context**: Automatically applies:
   - Brand voice and tone
   - Personality and values
   - Target audience
   - Style guidelines
   - Emoji usage preferences
   - Formality level
5. **Fallback Mode**: If services are unavailable, uses fallback data and logic

## Environment Variables

- `GOOGLE_CLOUD_PROJECT`: Set to your GCP project ID (defaults to `emailpilot-438321` in start script)
  - Required for Firestore client access
  - The start script will set this automatically if not already configured

## Copywriting Frameworks

1. **AIDA** - Attention, Interest, Desire, Action
2. **FOMO** - Fear of Missing Out
3. **PAS** - Problem, Agitate, Solution
4. **BAB** - Before, After, Bridge
5. **4Ps** - Promise, Picture, Proof, Push

## Creativity Levels

- **Conservative**: Professional, no emojis
- **Moderate**: Balanced approach
- **Bold**: More engaging, uses emojis
- **Experimental**: Creative and daring
- **Wild**: Maximum creativity and emoji usage

## Generated Content Elements

Each variant includes:
- Subject Line A & B (for A/B testing)
- Preview Text
- Hero H1 (main headline)
- Sub-head
- Hero Image filename & tone note
- CTA Copy
- Offer (if applicable)
- A/B Test Idea
- SMS/Secondary Message variant

## Development

The module is built with:
- **Backend**: FastAPI (Python)
- **Frontend**: React with TailwindCSS
- **Port**: 8002 (separate from main app)

To modify the copywriting logic, edit the `generate_framework_content()` function in `main.py`.

## Notes

- The module runs independently on port 8002
- It can work with or without the main EmailPilot app running
- The final "Submit" button is currently a placeholder for future integration
- In production, the content generation would use actual AI models instead of templates