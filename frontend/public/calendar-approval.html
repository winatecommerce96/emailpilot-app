<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Approval - EmailPilot</title>
    <meta name="description" content="Review and approve your EmailPilot campaign calendar">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EüìÖ%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Red Hat Display', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0F0F1E 0%, #1A1A2E 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #8A6CF7, #C5FF75);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glow-button {
            background: linear-gradient(135deg, #8A6CF7, #7B5FEE);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .glow-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(138, 108, 247, 0.4);
        }
        
        .glow-button.primary {
            background: linear-gradient(135deg, #C5FF75, #9FD938);
            color: #1A1A2E;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-header {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            font-weight: 600;
            padding: 8px;
        }
        
        .calendar-day {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 8px;
            min-height: 120px;
            position: relative;
        }
        
        .calendar-day.has-campaigns {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(138, 108, 247, 0.3);
        }
        
        .campaign-pill {
            background: linear-gradient(135deg, rgba(138, 108, 247, 0.8), rgba(197, 255, 117, 0.8));
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            margin: 2px 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            z-index: 100;
        }
        
        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 1px solid rgba(255, 193, 7, 0.4);
        }
        
        .status-approved {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.4);
        }
    </style>
</head>
<body class="text-white">
    <!-- Status Badge -->
    <div id="statusBadge" class="status-badge status-pending">
        Pending Approval
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-black gradient-text mb-4">Campaign Calendar Approval</h1>
            <div id="clientInfo" class="text-xl text-white/80">
                <!-- Client info will be loaded here -->
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-4 gap-4 mb-8">
            <div class="glass-card text-center">
                <div class="text-2xl font-bold" id="totalCampaigns">0</div>
                <div class="text-sm text-white/50">Total Campaigns</div>
            </div>
            <div class="glass-card text-center">
                <div class="text-2xl font-bold" id="expectedRevenue">$0</div>
                <div class="text-sm text-white/50">Expected Revenue</div>
            </div>
            <div class="glass-card text-center">
                <div class="text-2xl font-bold" id="avgOpenRate">0%</div>
                <div class="text-sm text-white/50">Avg Open Rate</div>
            </div>
            <div class="glass-card text-center">
                <div class="text-2xl font-bold" id="monthGoal">$0</div>
                <div class="text-sm text-white/50">Month Goal</div>
            </div>
        </div>

        <!-- Calendar View -->
        <div class="glass-card mb-8">
            <div id="calendarContainer" class="calendar-grid">
                <!-- Calendar will be rendered here -->
            </div>
        </div>

        <!-- Campaign List -->
        <div class="glass-card mb-8">
            <h2 class="text-2xl font-bold mb-4">Campaign Details</h2>
            <div id="campaignList" class="space-y-2">
                <!-- Campaign list will be rendered here -->
            </div>
        </div>

        <!-- Approval Actions -->
        <div class="glass-card text-center">
            <h2 class="text-2xl font-bold mb-4">Review & Approve</h2>
            <p class="text-white/60 mb-6">
                Please review the campaign calendar above. Once you're satisfied with the schedule, 
                click the approve button to confirm.
            </p>
            
            <div class="flex gap-4 justify-center">
                <button onclick="approveCalendar()" class="glow-button primary" id="approveBtn"
                    aria-label="Approve this campaign calendar" tabindex="0">
                    <span aria-hidden="true">‚úÖ</span> Approve Calendar
                </button>
                <button onclick="toggleChangeRequest()" class="glow-button" id="changeRequestBtn"
                    aria-label="Request changes to this campaign calendar" tabindex="0">
                    <span aria-hidden="true">‚úèÔ∏è</span> Request Changes
                </button>
            </div>
            
            <div id="approvalMessage" class="mt-6 hidden">
                <div class="text-green-400 text-xl font-bold">‚úÖ Calendar Approved!</div>
                <p class="text-white/60 mt-2">Thank you for your approval. We'll begin executing this campaign schedule.</p>
            </div>
            
            <!-- Change Request Form (Initially Hidden) -->
            <div id="changeRequestForm" class="mt-6 hidden">
                <div class="glass-card p-6 text-left max-w-2xl mx-auto">
                    <h3 class="text-xl font-bold mb-4">üìù Request Changes</h3>
                    <p class="text-white/60 mb-4">
                        Please describe the changes you'd like to make. Be as specific as possible - 
                        each request will be turned into a task for our team.
                    </p>
                    
                    <textarea 
                        id="changeRequestText" 
                        class="w-full bg-black/30 text-white p-4 rounded-lg border border-white/20 focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-400/50"
                        rows="6"
                        aria-label="Describe the changes you'd like to make to the calendar"
                        placeholder="Examples:&#10;- Move the Flash Sale from the 15th to the 20th&#10;- Add a Back to School campaign on August 10th&#10;- Remove the newsletter on the 8th&#10;- Change the promotion campaign to focus on summer products"
                        required
                    ></textarea>
                    
                    <div class="flex gap-3 mt-4">
                        <button onclick="submitChangeRequest()" class="glow-button primary">
                            üì§ Submit Changes
                        </button>
                        <button onclick="toggleChangeRequest()" class="glow-button">
                            Cancel
                        </button>
                    </div>
                    
                    <div id="changeRequestSuccess" class="mt-4 hidden">
                        <div class="text-green-400 font-semibold">‚úÖ Changes submitted successfully!</div>
                        <p class="text-white/60 text-sm mt-1">Our team will review and update the calendar shortly.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let approvalData = null;
        
        // Get approval ID from URL (supports both path and hash)
        function getApprovalId() {
            // First check if there's a hash (for static serving)
            if (window.location.hash) {
                return window.location.hash.substring(1);
            }
            // Otherwise get from path
            const pathParts = window.location.pathname.split('/');
            const lastPart = pathParts[pathParts.length - 1];
            // If we're on the static page without an ID, return null
            if (lastPart === 'calendar-approval.html') {
                return null;
            }
            return lastPart;
        }
        
        // Load approval data
        async function loadApprovalData() {
            const approvalId = getApprovalId();
            
            if (!approvalId) {
                document.body.innerHTML = `
                    <div class="container mx-auto px-4 py-16 text-center">
                        <h1 class="text-4xl font-bold text-red-400 mb-4">No Approval ID Provided</h1>
                        <p class="text-white/60">Please use the link provided in your email or by your account manager.</p>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/calendar/approval/${approvalId}`);
                if (!response.ok) throw new Error('Failed to load approval page');
                
                const result = await response.json();
                approvalData = result.data;
                
                renderApprovalPage();
            } catch (error) {
                console.error('Error loading approval:', error);
                document.body.innerHTML = `
                    <div class="container mx-auto px-4 py-16 text-center">
                        <h1 class="text-4xl font-bold text-red-400 mb-4">Page Not Found</h1>
                        <p class="text-white/60">This approval page could not be found or has expired.</p>
                    </div>
                `;
            }
        }
        
        // Render the approval page
        function renderApprovalPage() {
            if (!approvalData) return;
            
            // Update client info
            document.getElementById('clientInfo').innerHTML = `
                <strong>${approvalData.client_name}</strong> - ${approvalData.month_name} ${approvalData.year}
            `;
            
            // Update status badge
            if (approvalData.status === 'approved') {
                const badge = document.getElementById('statusBadge');
                badge.className = 'status-badge status-approved';
                badge.textContent = 'Approved';
                
                // Hide approve button
                document.getElementById('approveBtn').style.display = 'none';
                document.getElementById('approvalMessage').classList.remove('hidden');
            }
            
            // Calculate stats
            const campaigns = approvalData.campaigns || [];
            const totalRevenue = campaigns.reduce((sum, c) => 
                sum + (c.metrics?.revenue || c.expected_metrics?.revenue || 0), 0);
            const avgOpenRate = campaigns.reduce((sum, c) => 
                sum + (c.metrics?.openRate || c.expected_metrics?.open_rate || 0), 0) / (campaigns.length || 1);
            
            // Update stats
            document.getElementById('totalCampaigns').textContent = campaigns.length;
            document.getElementById('expectedRevenue').textContent = `$${Math.round(totalRevenue).toLocaleString()}`;
            document.getElementById('avgOpenRate').textContent = `${(avgOpenRate * 100).toFixed(1)}%`;
            document.getElementById('monthGoal').textContent = '$50k'; // Default, could be from client settings
            
            // Render calendar
            renderCalendar(campaigns);
            
            // Render campaign list
            renderCampaignList(campaigns);
        }
        
        // Render calendar grid
        function renderCalendar(campaigns) {
            const container = document.getElementById('calendarContainer');
            const year = approvalData.year;
            const month = parseInt(approvalData.month) - 1; // JS months are 0-indexed
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear and add headers
            container.innerHTML = `
                <div class="calendar-header">Sun</div>
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
            `;
            
            // Add empty cells
            for (let i = 0; i < firstDay; i++) {
                container.innerHTML += '<div class="calendar-day opacity-30"></div>';
            }
            
            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCampaigns = campaigns.filter(c => {
                    const campaignDate = new Date(c.date);
                    return campaignDate.getDate() === day;
                });
                
                const hasCampaigns = dayCampaigns.length > 0 ? 'has-campaigns' : '';
                
                container.innerHTML += `
                    <div class="calendar-day ${hasCampaigns}">
                        <div class="text-xs text-white/50 mb-1">${day}</div>
                        ${dayCampaigns.map(c => `
                            <div class="campaign-pill" onclick="showCampaignDetails('${c.id || Math.random()}')" style="cursor: pointer;">
                                <span>${c.emoji || 'üìß'}</span>
                                <span class="truncate">${c.name}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
        
        // Render campaign list
        function renderCampaignList(campaigns) {
            const container = document.getElementById('campaignList');
            
            const sortedCampaigns = [...campaigns].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            container.innerHTML = sortedCampaigns.map(c => {
                const date = new Date(c.date);
                const dateStr = date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="glass-card p-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${c.emoji || 'üìß'}</span>
                            <div>
                                <div class="font-semibold">${c.name}</div>
                                <div class="text-sm text-white/50">${dateStr} at ${c.time || '10:00 AM'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-white/50">Expected</div>
                            <div class="font-semibold">
                                $${Math.round(c.metrics?.revenue || c.expected_metrics?.revenue || 0).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Approve calendar
        async function approveCalendar() {
            const approvalId = getApprovalId();
            
            try {
                const response = await fetch(`/api/calendar/approval/${approvalId}/accept`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Failed to approve calendar');
                
                // Update UI
                const badge = document.getElementById('statusBadge');
                badge.className = 'status-badge status-approved';
                badge.textContent = 'Approved';
                
                document.getElementById('approveBtn').style.display = 'none';
                document.getElementById('approvalMessage').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error approving calendar:', error);
                alert('Failed to approve calendar. Please try again.');
            }
        }
        
        // Toggle change request form
        function toggleChangeRequest() {
            const form = document.getElementById('changeRequestForm');
            form.classList.toggle('hidden');
            
            // Clear form if hiding
            if (form.classList.contains('hidden')) {
                document.getElementById('changeRequestText').value = '';
                document.getElementById('changeRequestSuccess').classList.add('hidden');
            }
        }
        
        // Submit change request
        async function submitChangeRequest() {
            const changeText = document.getElementById('changeRequestText').value.trim();
            
            if (!changeText) {
                alert('Please describe the changes you need.');
                return;
            }
            
            const approvalId = getApprovalId();
            
            // Parse the text into individual tasks
            const tasks = parseChangeRequests(changeText);
            
            try {
                const response = await fetch(`/api/calendar/approval/${approvalId}/request-changes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        change_request: changeText,
                        tasks: tasks,
                        requested_at: new Date().toISOString(),
                        client_name: approvalData.client_name
                    })
                });
                
                if (!response.ok) throw new Error('Failed to submit changes');
                
                // Show success message
                document.getElementById('changeRequestSuccess').classList.remove('hidden');
                
                // Clear the textarea after a delay
                setTimeout(() => {
                    document.getElementById('changeRequestText').value = '';
                    toggleChangeRequest();
                }, 2000);
                
            } catch (error) {
                console.error('Error submitting changes:', error);
                alert('Failed to submit changes. Please try again.');
            }
        }
        
        // Parse change requests into tasks
        function parseChangeRequests(text) {
            const tasks = [];
            
            // Split by newlines and common delimiters
            const lines = text.split(/[\n\r]+/);
            
            lines.forEach(line => {
                line = line.trim();
                
                // Skip empty lines
                if (!line) return;
                
                // Remove common prefixes like bullets, numbers, etc.
                line = line.replace(/^[-‚Ä¢*]\s*/, '');
                line = line.replace(/^\d+[\.)]\s*/, '');
                
                // Identify task type based on keywords
                let taskType = 'general';
                if (line.toLowerCase().includes('move')) taskType = 'move';
                else if (line.toLowerCase().includes('add')) taskType = 'add';
                else if (line.toLowerCase().includes('remove') || line.toLowerCase().includes('delete')) taskType = 'remove';
                else if (line.toLowerCase().includes('change') || line.toLowerCase().includes('update')) taskType = 'update';
                
                if (line.length > 0) {
                    tasks.push({
                        description: line,
                        type: taskType,
                        status: 'pending'
                    });
                }
            });
            
            // If no clear tasks were parsed, create one general task
            if (tasks.length === 0 && text.trim().length > 0) {
                tasks.push({
                    description: text.trim(),
                    type: 'general',
                    status: 'pending'
                });
            }
            
            return tasks;
        }
        
        // Show campaign details in a modal
        function showCampaignDetails(campaignId) {
            // Find the campaign
            const campaign = approvalData.campaigns.find(c => (c.id || Math.random()) == campaignId);
            if (!campaign) return;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.id = 'campaignDetailModal';
            modal.onclick = (e) => {
                if (e.target === modal) closeCampaignDetails();
            };
            
            const date = new Date(campaign.date);
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            modal.innerHTML = `
                <div class="glass-card max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold gradient-text">Campaign Details</h2>
                        <button onclick="closeCampaignDetails()" class="text-white/60 hover:text-white text-2xl">‚úï</button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Header with emoji -->
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-4xl">${campaign.emoji || 'üìß'}</span>
                            <div>
                                <h3 class="text-xl font-semibold">${campaign.name}</h3>
                                <p class="text-white/60">${campaign.type ? campaign.type.charAt(0).toUpperCase() + campaign.type.slice(1) : 'Email'} Campaign</p>
                            </div>
                        </div>
                        
                        <!-- Date and Time -->
                        <div class="glass-card p-4">
                            <div class="text-sm text-white/50 mb-1">Schedule</div>
                            <div class="font-semibold">${dateStr}</div>
                            <div class="text-white/70">Send time: ${campaign.time || '10:00 AM'}</div>
                        </div>
                        
                        <!-- Target Segment -->
                        ${campaign.target_segment ? `
                        <div class="glass-card p-4">
                            <div class="text-sm text-white/50 mb-1">Target Audience</div>
                            <div class="font-semibold">${campaign.target_segment}</div>
                            ${campaign.segment_size ? `<div class="text-white/70">Estimated reach: ${campaign.segment_size.toLocaleString()} contacts</div>` : ''}
                        </div>
                        ` : ''}
                        
                        <!-- Subject Lines -->
                        ${campaign.subject_lines && campaign.subject_lines.length > 0 ? `
                        <div class="glass-card p-4">
                            <div class="text-sm text-white/50 mb-2">Subject Line Options</div>
                            ${campaign.subject_lines.map((subject, i) => `
                                <div class="mb-1">
                                    <span class="text-white/50">${i + 1}.</span> ${subject}
                                </div>
                            `).join('')}
                        </div>
                        ` : ''}
                        
                        <!-- Expected Performance -->
                        <div class="glass-card p-4">
                            <div class="text-sm text-white/50 mb-2">Expected Performance</div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <div class="text-2xl font-bold text-blue-400">
                                        ${((campaign.metrics?.openRate || campaign.expected_metrics?.open_rate || 0.2) * 100).toFixed(1)}%
                                    </div>
                                    <div class="text-xs text-white/50">Open Rate</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-400">
                                        ${((campaign.metrics?.clickRate || campaign.expected_metrics?.click_rate || 0.03) * 100).toFixed(1)}%
                                    </div>
                                    <div class="text-xs text-white/50">Click Rate</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-yellow-400">
                                        $${Math.round(campaign.metrics?.revenue || campaign.expected_metrics?.revenue || 0).toLocaleString()}
                                    </div>
                                    <div class="text-xs text-white/50">Expected Revenue</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description if available -->
                        ${campaign.description ? `
                        <div class="glass-card p-4">
                            <div class="text-sm text-white/50 mb-1">Campaign Description</div>
                            <div class="text-white/80">${campaign.description}</div>
                        </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div class="flex gap-3 justify-end mt-6">
                            <button onclick="closeCampaignDetails()" class="glow-button">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Close campaign details modal
        function closeCampaignDetails() {
            const modal = document.getElementById('campaignDetailModal');
            if (modal) modal.remove();
        }
        
        // Keyboard navigation support
        document.addEventListener('keydown', function(e) {
            // ESC key closes modal
            if (e.key === 'Escape') {
                const modal = document.getElementById('campaignDetailModal');
                if (modal) closeCampaignDetails();
            }
            
            // Enter key on buttons
            if (e.key === 'Enter' && e.target.tagName === 'BUTTON') {
                e.target.click();
            }
        });
        
        // Security: Prevent XSS by sanitizing text content
        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
        
        // Enhanced error handling with user-friendly messages
        function handleError(error, operation = 'operation') {
            console.error(`Error during ${operation}:`, error);
            
            let message = `Failed to ${operation}`;
            if (error.status === 429) {
                message = 'Too many requests. Please wait a moment and try again.';
            } else if (error.status === 404) {
                message = 'The requested page could not be found.';
            } else if (error.status >= 500) {
                message = 'Server error. Please try again later.';
            }
            
            // Create accessible error message
            const errorEl = document.createElement('div');
            errorEl.setAttribute('role', 'alert');
            errorEl.setAttribute('aria-live', 'polite');
            errorEl.className = 'fixed top-4 right-4 bg-red-500/20 text-red-400 border border-red-500/40 px-4 py-3 rounded-lg z-50';
            errorEl.textContent = message;
            
            document.body.appendChild(errorEl);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorEl.parentNode) {
                    errorEl.remove();
                }
            }, 5000);
        }
        
        // Load on page ready
        document.addEventListener('DOMContentLoaded', loadApprovalData);
    </script>
</body>
</html>