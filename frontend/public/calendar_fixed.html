<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmailPilot Calendar - Firebase Integration</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase v9 modular SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        
        // Use your actual Firebase configuration - you may need to get this from Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyB0RrH7hbER2R-SzXfNmFe0O32HhH7HBEM", // This might be incorrect
            authDomain: "emailpilot-438321.firebaseapp.com",
            projectId: "emailpilot-438321",
            storageBucket: "emailpilot-438321.appspot.com",
            messagingSenderId: "104067375141",
            appId: "1:104067375141:web:2b65c86eec8e8c8b4c9f3a"
        };

        let app, db, auth;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log('Firebase initialized successfully');
            
            // Make available globally
            window.firebaseApp = app;
            window.firebaseDb = db;
            window.firebaseAuth = auth;
            window.firebaseUtils = {
                collection, getDocs, doc, getDoc, setDoc, deleteDoc, query, where, signInAnonymously
            };
            
            // Test connection
            signInAnonymously(auth).then(() => {
                console.log('Anonymous auth successful');
                
                // Test database connection
                getDocs(collection(db, 'clients')).then((snapshot) => {
                    console.log(`Found ${snapshot.size} clients in database`);
                    window.dispatchEvent(new CustomEvent('firebaseReady'));
                }).catch(error => {
                    console.error('Database connection test failed:', error);
                    if (error.code === 'permission-denied') {
                        console.log('Permission denied - this is normal for production Firebase');
                        window.dispatchEvent(new CustomEvent('firebaseReady'));
                    }
                });
                
            }).catch(error => {
                console.error('Authentication failed:', error);
                // Try without authentication for testing
                console.log('Trying without authentication...');
                window.dispatchEvent(new CustomEvent('firebaseReady'));
            });
            
        } catch (error) {
            console.error('Firebase initialization failed:', error);
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .day { border: 1px solid #e5e7eb; min-height: 120px; position: relative; padding: 4px; }
        .day:hover { background-color: #f9fafb; }
        .event { 
            font-size: 0.75rem; padding: 2px 6px; margin: 2px 0; border-radius: 4px; 
            cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="calendar-root" class="min-h-screen p-4"></div>

    <script>
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // Campaign colors
        const CAMPAIGN_COLORS = {
            'RRB Promotion': 'bg-red-300 text-red-800',
            'Cheese Club': 'bg-green-200 text-green-800',
            'Nurturing/Education': 'bg-blue-200 text-blue-800',
            'Community/Lifestyle': 'bg-purple-200 text-purple-800',
            'Re-engagement': 'bg-yellow-200 text-yellow-800',
            'SMS Alert': 'bg-orange-300 text-orange-800',
            'default': 'bg-gray-200 text-gray-800'
        };

        function CalendarApp() {
            const [clients, setClients] = useState([]);
            const [selectedClient, setSelectedClient] = useState(null);
            const [campaigns, setCampaigns] = useState({});
            const [currentDate, setCurrentDate] = useState(new Date(2025, 8, 1));
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);

            useEffect(() => {
                // Wait for Firebase to be ready
                const handleFirebaseReady = () => {
                    setFirebaseReady(true);
                    loadClients();
                };

                if (window.firebaseDb) {
                    handleFirebaseReady();
                } else {
                    window.addEventListener('firebaseReady', handleFirebaseReady);
                    return () => window.removeEventListener('firebaseReady', handleFirebaseReady);
                }
            }, []);

            const loadClients = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    if (!window.firebaseDb || !window.firebaseUtils) {
                        throw new Error('Firebase not initialized');
                    }

                    const { collection, getDocs } = window.firebaseUtils;
                    const clientsCollection = collection(window.firebaseDb, 'clients');
                    const snapshot = await getDocs(clientsCollection);
                    
                    const clientsData = [];
                    snapshot.forEach(doc => {
                        clientsData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    console.log(`Loaded ${clientsData.length} clients:`, clientsData);
                    setClients(clientsData);
                    
                    if (clientsData.length > 0) {
                        const firstClient = clientsData[0];
                        setSelectedClient(firstClient);
                        await loadClientData(firstClient.id);
                    } else {
                        // Create a sample client for testing
                        console.log('No clients found, creating sample client...');
                        const sampleClientId = await createSampleClient();
                        if (sampleClientId) {
                            await loadClients(); // Reload clients
                        }
                    }
                    
                } catch (err) {
                    console.error('Error loading clients:', err);
                    setError(`Firebase connection error: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const createSampleClient = async () => {
                try {
                    const { doc, setDoc } = window.firebaseUtils;
                    const clientId = 'sample-client-' + Date.now();
                    
                    const sampleCampaigns = {
                        'event-sample-1': {
                            date: '2025-09-15',
                            title: 'Sample RRB Promotion',
                            content: 'Sample campaign content',
                            color: 'bg-red-300 text-red-800'
                        },
                        'event-sample-2': {
                            date: '2025-09-20',
                            title: 'Sample Cheese Club',
                            content: 'Sample cheese club campaign',
                            color: 'bg-green-200 text-green-800'
                        }
                    };
                    
                    const clientDoc = doc(window.firebaseDb, 'clients', clientId);
                    await setDoc(clientDoc, {
                        name: 'Sample Client',
                        campaignData: sampleCampaigns,
                        created: new Date().toISOString()
                    });
                    
                    console.log('Sample client created:', clientId);
                    return clientId;
                } catch (error) {
                    console.error('Error creating sample client:', error);
                    return null;
                }
            };

            const loadClientData = async (clientId) => {
                try {
                    const { doc, getDoc } = window.firebaseUtils;
                    const clientDoc = doc(window.firebaseDb, 'clients', clientId);
                    const clientSnap = await getDoc(clientDoc);
                    
                    if (clientSnap.exists()) {
                        const data = clientSnap.data();
                        const campaignData = data.campaignData || {};
                        console.log(`Loaded ${Object.keys(campaignData).length} campaigns for client:`, clientId);
                        setCampaigns(campaignData);
                    } else {
                        console.log('No campaign data found for client:', clientId);
                        setCampaigns({});
                    }
                } catch (error) {
                    console.error('Error loading client data:', error);
                    setCampaigns({});
                }
            };

            const handleClientChange = async (clientId) => {
                const client = clients.find(c => c.id === clientId);
                setSelectedClient(client);
                if (client) {
                    await loadClientData(client.id);
                }
            };

            const createClient = async () => {
                const name = prompt('Enter client name:');
                if (name && name.trim()) {
                    try {
                        const { doc, setDoc } = window.firebaseUtils;
                        const clientId = name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
                        const clientDoc = doc(window.firebaseDb, 'clients', clientId);
                        
                        await setDoc(clientDoc, {
                            name: name.trim(),
                            campaignData: {},
                            created: new Date().toISOString()
                        });
                        
                        console.log('Client created:', clientId);
                        await loadClients(); // Reload clients
                        
                        // Select the new client
                        const newClient = { id: clientId, name: name.trim() };
                        setSelectedClient(newClient);
                        await loadClientData(clientId);
                    } catch (err) {
                        alert(`Failed to create client: ${err.message}`);
                    }
                }
            };

            const handleDayClick = async (dateString) => {
                if (!selectedClient) return;
                
                const title = prompt('Enter campaign title:');
                if (title && title.trim()) {
                    try {
                        const eventId = 'event-' + Date.now();
                        const campaignType = detectCampaignType(title);
                        
                        const updatedCampaigns = {
                            ...campaigns,
                            [eventId]: {
                                date: dateString,
                                title: title.trim(),
                                content: '',
                                color: CAMPAIGN_COLORS[campaignType] || CAMPAIGN_COLORS.default
                            }
                        };
                        
                        // Save to Firebase
                        const { doc, setDoc } = window.firebaseUtils;
                        const clientDoc = doc(window.firebaseDb, 'clients', selectedClient.id);
                        await setDoc(clientDoc, {
                            name: selectedClient.name,
                            campaignData: updatedCampaigns,
                            lastModified: new Date().toISOString()
                        }, { merge: true });
                        
                        setCampaigns(updatedCampaigns);
                        console.log('Campaign created:', eventId);
                    } catch (error) {
                        console.error('Error saving campaign:', error);
                        alert('Failed to save campaign');
                    }
                }
            };

            const handleEventClick = (eventId, eventData) => {
                const newTitle = prompt('Edit campaign title:', eventData.title);
                if (newTitle !== null && newTitle.trim() && selectedClient) {
                    const updatedCampaigns = {
                        ...campaigns,
                        [eventId]: {
                            ...eventData,
                            title: newTitle.trim()
                        }
                    };
                    
                    // Save to Firebase
                    const { doc, setDoc } = window.firebaseUtils;
                    const clientDoc = doc(window.firebaseDb, 'clients', selectedClient.id);
                    setDoc(clientDoc, {
                        name: selectedClient.name,
                        campaignData: updatedCampaigns,
                        lastModified: new Date().toISOString()
                    }, { merge: true }).then(() => {
                        setCampaigns(updatedCampaigns);
                        console.log('Campaign updated:', eventId);
                    }).catch(error => {
                        console.error('Error updating campaign:', error);
                        alert('Failed to update campaign');
                    });
                }
            };

            const detectCampaignType = (title) => {
                const text = title.toLowerCase();
                if (text.includes('rrb') || text.includes('promotion')) return 'RRB Promotion';
                if (text.includes('cheese club')) return 'Cheese Club';
                if (text.includes('nurturing') || text.includes('education')) return 'Nurturing/Education';
                if (text.includes('community') || text.includes('lifestyle')) return 'Community/Lifestyle';
                if (text.includes('re-engagement')) return 'Re-engagement';
                if (text.includes('sms')) return 'SMS Alert';
                return 'default';
            };

            const generateCalendarDays = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                const firstDay = new Date(year, month, 1);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const days = [];
                const currentDay = new Date(startDate);
                
                for (let i = 0; i < 42; i++) {
                    const dateString = currentDay.toISOString().split('T')[0];
                    const isCurrentMonth = currentDay.getMonth() === month;
                    const dayEvents = Object.entries(campaigns).filter(([id, campaign]) => campaign.date === dateString);
                    
                    days.push({
                        date: new Date(currentDay),
                        dateString,
                        dayNumber: currentDay.getDate(),
                        isCurrentMonth,
                        events: dayEvents
                    });
                    
                    currentDay.setDate(currentDay.getDate() + 1);
                }
                
                return days;
            };

            const calendarDays = generateCalendarDays();

            if (loading) {
                return React.createElement('div', {
                    className: "flex items-center justify-center h-screen"
                }, React.createElement('div', {
                    className: "text-center"
                }, [
                    React.createElement('div', {
                        key: 'spinner',
                        className: "inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"
                    }),
                    React.createElement('p', {
                        key: 'text',
                        className: "mt-2 text-sm text-gray-500"
                    }, 'Connecting to Firebase...')
                ]));
            }

            if (error) {
                return React.createElement('div', {
                    className: "flex items-center justify-center h-screen"
                }, React.createElement('div', {
                    className: "text-center max-w-md"
                }, [
                    React.createElement('div', {
                        key: 'error',
                        className: "text-red-600 mb-4"
                    }, '❌ Firebase Connection Error'),
                    React.createElement('p', {
                        key: 'message',
                        className: "text-sm text-gray-600 mb-4"
                    }, error),
                    React.createElement('button', {
                        key: 'retry',
                        onClick: () => {
                            setError(null);
                            loadClients();
                        },
                        className: "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    }, 'Try Again'),
                    React.createElement('div', {
                        key: 'help',
                        className: "mt-4 text-xs text-gray-400"
                    }, [
                        React.createElement('p', { key: 'note' }, 'Note: Make sure Firebase is properly configured'),
                        React.createElement('p', { key: 'project' }, 'Project: emailpilot-438321')
                    ])
                ]));
            }

            return React.createElement('div', {
                className: "max-w-7xl mx-auto space-y-6"
            }, [
                // Header
                React.createElement('div', {
                    key: 'header',
                    className: "flex justify-between items-center"
                }, [
                    React.createElement('h1', {
                        key: 'title',
                        className: "text-3xl font-bold text-gray-900"
                    }, 'EmailPilot Firebase Calendar'),
                    
                    React.createElement('div', {
                        key: 'controls',
                        className: "flex items-center space-x-4"
                    }, [
                        clients.length > 0 && React.createElement('select', {
                            key: 'select',
                            value: selectedClient?.id || '',
                            onChange: (e) => handleClientChange(e.target.value),
                            className: "border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        }, clients.map(client => 
                            React.createElement('option', {
                                key: client.id,
                                value: client.id
                            }, client.name)
                        )),
                        React.createElement('button', {
                            key: 'add',
                            onClick: createClient,
                            className: "px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                        }, 'Add Client')
                    ])
                ]),

                // Status
                React.createElement('div', {
                    key: 'status',
                    className: firebaseReady ? "bg-green-50 border border-green-200 rounded-lg p-4" : "bg-yellow-50 border border-yellow-200 rounded-lg p-4"
                }, React.createElement('div', {
                    className: "flex items-center"
                }, [
                    React.createElement('div', {
                        key: 'icon',
                        className: firebaseReady ? "text-green-600 mr-2" : "text-yellow-600 mr-2"
                    }, firebaseReady ? '✅' : '⚠️'),
                    React.createElement('div', { key: 'text' }, [
                        React.createElement('h4', {
                            key: 'title',
                            className: firebaseReady ? "text-sm font-medium text-green-900" : "text-sm font-medium text-yellow-900"
                        }, firebaseReady ? 'Firebase Connected' : 'Firebase Connecting...'),
                        React.createElement('p', {
                            key: 'details',
                            className: firebaseReady ? "text-xs text-green-700 mt-1" : "text-xs text-yellow-700 mt-1"
                        }, `Project: emailpilot-438321 • Clients: ${clients.length} • Campaigns: ${Object.keys(campaigns).length}`)
                    ])
                ])),

                // Calendar
                selectedClient && React.createElement('div', {
                    key: 'calendar',
                    className: "bg-white rounded-xl shadow-lg"
                }, [
                    // Calendar header
                    React.createElement('div', {
                        key: 'cal-header',
                        className: "p-6 border-b border-gray-200"
                    }, React.createElement('div', {
                        className: "flex justify-between items-center"
                    }, [
                        React.createElement('h2', {
                            key: 'month',
                            className: "text-2xl font-bold text-gray-800"
                        }, currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })),
                        
                        React.createElement('div', {
                            key: 'nav',
                            className: "flex items-center space-x-2"
                        }, [
                            React.createElement('button', {
                                key: 'prev',
                                onClick: () => {
                                    const newDate = new Date(currentDate);
                                    newDate.setMonth(newDate.getMonth() - 1);
                                    setCurrentDate(newDate);
                                },
                                className: "p-2 rounded-full text-gray-500 hover:bg-gray-100 text-xl"
                            }, '←'),
                            React.createElement('button', {
                                key: 'next',
                                onClick: () => {
                                    const newDate = new Date(currentDate);
                                    newDate.setMonth(newDate.getMonth() + 1);
                                    setCurrentDate(newDate);
                                },
                                className: "p-2 rounded-full text-gray-500 hover:bg-gray-100 text-xl"
                            }, '→')
                        ])
                    ])),

                    // Legend
                    React.createElement('div', {
                        key: 'legend',
                        className: "p-4 border-b border-gray-200"
                    }, React.createElement('div', {
                        className: "flex flex-wrap items-center justify-center gap-x-4 gap-y-2"
                    }, Object.entries(CAMPAIGN_COLORS).filter(([key]) => key !== 'default').map(([type, colorClass]) =>
                        React.createElement('div', {
                            key: type,
                            className: "flex items-center space-x-2"
                        }, [
                            React.createElement('div', {
                                key: 'color',
                                className: `w-4 h-4 rounded-full ${colorClass.split(' ')[0]}`
                            }),
                            React.createElement('span', {
                                key: 'label',
                                className: "text-xs text-gray-600 font-medium"
                            }, type)
                        ])
                    ))),

                    // Calendar grid
                    React.createElement('div', {
                        key: 'grid',
                        className: "p-4"
                    }, [
                        // Day headers
                        React.createElement('div', {
                            key: 'headers',
                            className: "grid grid-cols-7 mb-2"
                        }, ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(day =>
                            React.createElement('div', {
                                key: day,
                                className: "text-center text-xs font-semibold text-gray-600 py-2"
                            }, day)
                        )),

                        // Calendar days
                        React.createElement('div', {
                            key: 'days',
                            className: "calendar-grid"
                        }, calendarDays.map((day, index) =>
                            React.createElement('div', {
                                key: index,
                                className: `day ${day.isCurrentMonth ? 'bg-white hover:bg-gray-50 cursor-pointer' : 'bg-gray-50 text-gray-400'}`,
                                onClick: () => day.isCurrentMonth && handleDayClick(day.dateString)
                            }, [
                                React.createElement('div', {
                                    key: 'number',
                                    className: "text-sm font-medium mb-1"
                                }, day.dayNumber),
                                
                                React.createElement('div', {
                                    key: 'events',
                                    className: "space-y-1"
                                }, day.events.map(([eventId, event]) =>
                                    React.createElement('div', {
                                        key: eventId,
                                        className: `event ${event.color || 'bg-gray-200 text-gray-800'}`,
                                        onClick: (e) => {
                                            e.stopPropagation();
                                            handleEventClick(eventId, event);
                                        },
                                        title: event.title
                                    }, event.title)
                                ))
                            ])
                        ))
                    ])
                ]),

                // No client message
                !selectedClient && clients.length === 0 && React.createElement('div', {
                    key: 'no-clients',
                    className: "text-center py-12"
                }, [
                    React.createElement('div', {
                        key: 'message',
                        className: "text-gray-500 mb-4"
                    }, 'No clients found in Firebase'),
                    React.createElement('p', {
                        key: 'instructions',
                        className: "text-sm text-gray-400 mb-4"
                    }, 'Click "Add Client" to create your first client, or check Firebase Console for existing data'),
                    React.createElement('button', {
                        key: 'create',
                        onClick: createClient,
                        className: "px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
                    }, 'Create First Client')
                ])
            ]);
        }

        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('calendar-root');
            if (container) {
                const root = createRoot(container);
                root.render(React.createElement(CalendarApp));
            }
        });
    </script>
</body>
</html>