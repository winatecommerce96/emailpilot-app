<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Master - EmailPilot AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@900&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React and React DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- React Select -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/react-select@5.8.0/dist/react-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/react-select@5.8.0/dist/react-select.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --brand-blue: #3369DC;
            --brand-purple: #8A6CF7;
            --brand-lime: #C5FF75;
            --black: #000000;
            --white: #FFFFFF;

            /* Typography Scale - Professional Hierarchy */
            --text-hero: 32px;
            --text-section: 24px;
            --text-subsection: 20px;
            --text-body: 16px;
            --text-small: 14px;
            --text-tiny: 12px;

            /* Line Heights for Readability */
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Font Weights - Limited Palette */
            --font-regular: 400;
            --font-semibold: 600;

            /* Spacing System (8px base) */
            --space-1: 8px;
            --space-2: 16px;
            --space-3: 24px;
            --space-4: 32px;
            --space-5: 40px;
            --space-6: 48px;
            --space-8: 64px;

            /* Container Max-Width for 12-column grid */
            --container-max: 1440px;
            --container-padding: var(--space-3);

            /* Touch Target Minimum */
            --touch-target: 44px;

            /* Channel Colors - Professional, Accessible */
            --channel-email: #3b82f6;      /* Blue - Email campaigns */
            --channel-sms: #10b981;        /* Green - SMS campaigns */
            --channel-both: #8b5cf6;       /* Purple - Multi-channel */
            --channel-email-bg: rgba(59, 130, 246, 0.1);
            --channel-sms-bg: rgba(16, 185, 129, 0.1);
            --channel-both-bg: rgba(139, 92, 246, 0.1);

            /* Status Colors */
            --status-draft: #6b7280;       /* Gray - Draft */
            --status-scheduled: #f59e0b;   /* Amber - Scheduled */
            --status-sent: #10b981;        /* Green - Sent */
            --status-draft-bg: rgba(107, 116, 128, 0.1);
            --status-scheduled-bg: rgba(245, 158, 11, 0.1);
            --status-sent-bg: rgba(16, 185, 129, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            font-size: var(--text-body);
            line-height: var(--line-height-normal);
            font-weight: var(--font-regular);
            background: #000000;
            color: #FFFFFF;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Typography Utilities */
        h1, .text-hero {
            font-size: var(--text-hero);
            line-height: var(--line-height-tight);
            font-weight: var(--font-semibold);
        }

        h2, .text-section {
            font-size: var(--text-section);
            line-height: var(--line-height-tight);
            font-weight: var(--font-semibold);
        }

        h3, .text-subsection {
            font-size: var(--text-subsection);
            line-height: var(--line-height-normal);
            font-weight: var(--font-semibold);
        }

        p, .text-body {
            font-size: var(--text-body);
            line-height: var(--line-height-relaxed);
        }

        .text-small {
            font-size: var(--text-small);
            line-height: var(--line-height-normal);
        }

        .text-tiny {
            font-size: var(--text-tiny);
            line-height: var(--line-height-normal);
        }
        
        /* Light Mode Base Styles */
        body.light-mode {
            background: #f5f7fa;
            color: #1a1a1a;
        }
        
        body.light-mode .gradient-bg {
            background: linear-gradient(125deg, #ffffff 0%, #f0f2f5 50%, #ffffff 100%);
        }
        
        body.light-mode .gradient-orbs {
            opacity: 0.2;
        }
        
        body.light-mode .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.25);  /* Increased contrast from 0.1 to 0.25 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        /* Disabled light mode glass-card hover effect for better readability
        body.light-mode .glass-card:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(51, 105, 220, 0.3);
            box-shadow: 0 20px 40px rgba(51, 105, 220, 0.15);
        } */
        
        body.light-mode .calendar-grid {
            background: rgba(255, 255, 255, 0.9);
        }
        
        body.light-mode .calendar-header {
            color: #3369DC;
            font-weight: 700;
        }
        
        body.light-mode .calendar-day {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.3);  /* Increased contrast from 0.15 to 0.3 */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        /* Disabled hover effect for better readability
        body.light-mode .calendar-day:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(51, 105, 220, 0.4);
        } */
        
        body.light-mode .calendar-day.today {
            background: linear-gradient(135deg, rgba(197, 255, 117, 0.2), rgba(197, 255, 117, 0.1));
            border-color: rgba(197, 255, 117, 0.6);
        }
        
        body.light-mode .day-number {
            color: #3369DC;
            font-weight: 700;
        }
        
        body.light-mode .glow-button {
            background: linear-gradient(135deg, rgba(51, 105, 220, 0.1), rgba(138, 108, 247, 0.1));
            border: 1px solid rgba(51, 105, 220, 0.3);
            color: #1a1a1a;
        }
        
        body.light-mode .glow-button:hover {
            background: linear-gradient(135deg, rgba(51, 105, 220, 0.2), rgba(138, 108, 247, 0.2));
            border-color: rgba(138, 108, 247, 0.5);
            box-shadow: 0 10px 30px rgba(51, 105, 220, 0.2);
        }
        
        body.light-mode .glow-button.primary {
            background: linear-gradient(135deg, #3369DC, #8A6CF7);
            color: #FFFFFF;
        }
        
        body.light-mode .stat-card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* Disabled light mode stat-card hover effect for better readability
        body.light-mode .stat-card:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(51, 105, 220, 0.3);
        } */
        
        body.light-mode .gradient-text {
            background: linear-gradient(135deg, #3369DC 0%, #8A6CF7 50%, #667EEA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Welcome section text readability in light mode */
        body.light-mode .welcome-section p {
            color: rgba(26, 26, 26, 0.9) !important;
        }

        body.light-mode .welcome-section strong {
            color: #3369DC !important;
        }

        body.light-mode .welcome-section div[style*="flex"] {
            color: rgba(26, 26, 26, 0.7) !important;
        }

        body.light-mode .modal-backdrop {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        body.light-mode .modal-content {
            background: #ffffff;
            color: #1a1a1a;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode input,
        body.light-mode select,
        body.light-mode textarea {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.25);  /* Increased contrast from 0.1 to 0.25 */
            color: #1a1a1a;
        }
        
        body.light-mode input:focus,
        body.light-mode select:focus,
        body.light-mode textarea:focus {
            background: #ffffff;
            border-color: #3369DC;
            box-shadow: 0 0 0 3px rgba(51, 105, 220, 0.1);
        }
        
        body.light-mode .toast {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(250, 250, 250, 0.98));
            border: 1px solid rgba(51, 105, 220, 0.3);
            color: #1a1a1a;
        }
        
        body.light-mode .save-status {
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a1a;
        }
        
        body.light-mode .campaign-pill {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(0, 0, 0, 0.3) !important;  /* Increased contrast from 0.15 to 0.3 */
            color: rgba(0, 0, 0, 0.9);
        }

        body.light-mode .campaign-pill-text {
            color: rgba(0, 0, 0, 0.95);
        }

        body.light-mode .campaign-pill-meta {
            color: rgba(0, 0, 0, 0.7);
        }

        body.light-mode .campaign-pill-meta-badge {
            background: rgba(0, 0, 0, 0.1);
            color: rgba(0, 0, 0, 0.8);
        }

        /* Light Mode - Text Visibility Fixes */
        body.light-mode .text-small {
            color: rgba(26, 26, 26, 0.8) !important;  /* Dark text for light bg */
        }

        body.light-mode #searchInput {
            color: #1a1a1a !important;  /* Dark text for search input */
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(0, 0, 0, 0.25) !important;
            placeholder-color: rgba(26, 26, 26, 0.5);
        }

        body.light-mode #searchInput::placeholder {
            color: rgba(26, 26, 26, 0.5);
        }

        /* Light Mode - Holiday Markers High Contrast */
        body.light-mode .klaviyo-event-text {
            color: #1a1a1a !important;  /* Dark text on light bg */
            font-weight: 600 !important;
        }

        body.light-mode .klaviyo-event.planning {
            background: rgba(138, 108, 247, 0.3) !important;
            border-color: rgba(138, 108, 247, 0.7) !important;
            color: #5b21b6 !important;  /* Dark purple text */
        }

        body.light-mode .klaviyo-event.planning .klaviyo-event-text {
            color: #5b21b6 !important;
        }

        body.light-mode .klaviyo-event.campaign {
            background: rgba(34, 197, 94, 0.25) !important;
            border-color: rgba(34, 197, 94, 0.6) !important;
            color: #166534 !important;  /* Dark green text */
        }

        body.light-mode .klaviyo-event.campaign .klaviyo-event-text {
            color: #166534 !important;
        }

        body.light-mode .klaviyo-event.review {
            background: rgba(251, 146, 60, 0.3) !important;
            border-color: rgba(251, 146, 60, 0.7) !important;
            color: #9a3412 !important;  /* Dark orange text */
        }

        body.light-mode .klaviyo-event.review .klaviyo-event-text {
            color: #9a3412 !important;
        }

        body.light-mode .holiday-indicator {
            background: rgba(251, 191, 36, 0.25) !important;
            border-color: rgba(251, 191, 36, 0.6) !important;
            color: #92400e !important;  /* Dark amber text */
        }

        /* Light Mode - Resend Campaign Borders */
        body.light-mode .campaign-pill.is-resend {
            border: 2px dashed #d97706 !important;  /* Darker amber dashed border */
            border-left: 4px solid #d97706 !important;
            background: rgba(251, 191, 36, 0.15) !important;
        }

        /* Light Mode - Grade Performance Card */
        body.light-mode .grade-card {
            border-color: rgba(0, 0, 0, 0.25) !important;  /* Match other stat cards */
        }

        body.light-mode .grade-card .curiosity-badge {
            display: none !important;  /* Hide bouncing pill in light mode */
        }

        body.light-mode .stat-value,
        body.light-mode .stat-label {
            color: #1a1a1a !important;
        }

        /* Studio Lights Theme Toggle */
        .header-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            align-items: flex-end;
        }

        .studio-theme-toggle {
            display: flex;
            justify-content: flex-end;
            width: 100%;
        }

        .studio-toggle-button {
            border: none;
            border-radius: 999px;
            padding: 0.65rem 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.85rem;
            cursor: pointer;
            min-width: 240px;
            background: rgba(255, 255, 255, 0.1);
            color: #f5f5ff;
            box-shadow: 0 12px 30px rgba(13, 17, 38, 0.35);
            transition: transform 0.25s ease, background 0.4s ease, color 0.4s ease, box-shadow 0.4s ease;
        }

        .studio-toggle-button:hover {
            transform: translateY(-3px);
        }

        .studio-toggle-icon {
            font-size: 1.9rem;
            line-height: 1;
        }

        .studio-toggle-label strong {
            display: block;
            font-size: 0.95rem;
            letter-spacing: 0.04em;
        }

        .studio-toggle-label small {
            font-size: 0.78rem;
            opacity: 0.75;
        }

        body.sunrise-theme .studio-toggle-button {
            background: linear-gradient(120deg, #fef3c7, #fecdd3, #fbcfe8);
            color: #312e81;
            box-shadow: 0 12px 40px rgba(248, 191, 143, 0.55);
        }

        body.midnight-theme .studio-toggle-button {
            background: linear-gradient(120deg, #1e1b4b, #0f172a, #020617);
            color: #e0f2fe;
            box-shadow: 0 12px 40px rgba(15, 23, 42, 0.8);
        }

        body.sunrise-theme .gradient-bg {
            background: linear-gradient(135deg, #fff7ed 0%, #fef3c7 40%, #f5d0fe 100%);
        }

        body.sunrise-theme .orb1 {
            background: radial-gradient(circle, #fde68a 0%, transparent 70%);
        }

        body.sunrise-theme .orb2 {
            background: radial-gradient(circle, #fbcfe8 0%, transparent 70%);
        }

        body.sunrise-theme .orb3 {
            background: radial-gradient(circle, #bfdbfe 0%, transparent 70%);
        }

        body.midnight-theme .gradient-bg {
            background: radial-gradient(circle at top, #030712 0%, #020617 45%, #000000 100%);
        }
        
        /* Disabled light mode campaign-pill hover effect for better readability
        body.light-mode .campaign-pill:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.25);
        } */
        
        body.light-mode .changes-panel {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(255, 140, 0, 0.4);
            color: #1a1a1a;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Red Hat Display', sans-serif;
            font-weight: 900;
            letter-spacing: -0.02em;
        }
        
        /* Animated Gradient Background */
        .gradient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(125deg, #000000 0%, #0a0a0a 50%, #000000 100%);
            z-index: -3;
        }
        
        .gradient-orbs {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.5;
        }
        
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            animation: float 20s infinite ease-in-out;
        }
        
        .orb1 {
            top: -10%;
            left: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, #3369DC 0%, transparent 70%);
            animation-delay: 0s;
        }
        
        .orb2 {
            top: 50%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #8A6CF7 0%, transparent 70%);
            animation-delay: 5s;
        }
        
        .orb3 {
            bottom: -10%;
            left: 30%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #C5FF75 0%, transparent 70%);
            animation-delay: 10s;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(30px, -30px) scale(1.05); }
            50% { transform: translate(-20px, 20px) scale(0.95); }
            75% { transform: translate(-30px, -20px) scale(1.02); }
        }
        
        /* Glass Cards with Glow */
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            position: relative;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            color: rgba(255, 255, 255, 0.9);  /* Light text on dark background */
        }

        .glass-card p,
        .glass-card h1,
        .glass-card h2,
        .glass-card h3,
        .glass-card h4,
        .glass-card h5,
        .glass-card h6 {
            color: rgba(255, 255, 255, 0.95);  /* Even lighter for headings */
        }
        
        .glass-card:before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 20px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(197, 255, 117, 0.3), rgba(138, 108, 247, 0.3), rgba(51, 105, 220, 0.3));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        /* Disabled glass-card hover effects for better readability
        .glass-card:hover:before {
            opacity: 1;
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
            box-shadow: 0 20px 40px rgba(138, 108, 247, 0.2);
        } */
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #3369DC 0%, #8A6CF7 50%, #C5FF75 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Modern Buttons */
        .glow-button {
            position: relative;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(51, 105, 220, 0.1), rgba(138, 108, 247, 0.1));
            color: #FFFFFF;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            overflow: hidden;
        }
        
        .glow-button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(197, 255, 117, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .glow-button:hover:before {
            left: 100%;
        }
        
        .glow-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(138, 108, 247, 0.3);
            border-color: rgba(197, 255, 117, 0.5);
        }
        
        .glow-button.primary {
            background: linear-gradient(135deg, #3369DC, #8A6CF7);
            border: none;
        }
        
        .glow-button.primary:hover {
            box-shadow: 0 10px 40px rgba(138, 108, 247, 0.5);
        }

        /* Campaign Filter Pills */
        .campaign-filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 11px;
        }

        .campaign-filter-pill:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .campaign-filter-pill.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
            color: rgba(255, 255, 255, 0.9);
        }

        body.light-mode .campaign-filter-pill {
            border-color: rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            color: rgba(0, 0, 0, 0.4);
        }

        body.light-mode .campaign-filter-pill:hover {
            border-color: rgba(138, 108, 247, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }

        body.light-mode .campaign-filter-pill.active {
            border-color: rgba(138, 108, 247, 0.8);
            background: rgba(138, 108, 247, 0.1);
            color: rgba(0, 0, 0, 0.9);
            box-shadow: 0 4px 20px rgba(138, 108, 247, 0.15);
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
        }

        /* Ensure grid is never overridden */
        #calendarContainer.calendar-grid {
            display: grid !important;
        }
        
        .calendar-header {
            padding: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #8A6CF7;
        }
        
        .calendar-day {
            min-height: 110px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            transition: all 0.3s;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Scrollbar styling for calendar days */
        .calendar-day::-webkit-scrollbar {
            width: 4px;
        }

        .calendar-day::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 2px;
        }

        .calendar-day::-webkit-scrollbar-thumb {
            background: rgba(197, 255, 117, 0.3);
            border-radius: 2px;
        }

        .calendar-day::-webkit-scrollbar-thumb:hover {
            background: rgba(197, 255, 117, 0.5);
        }

        body.light-mode .calendar-day::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .calendar-day::-webkit-scrollbar-thumb {
            background: rgba(51, 105, 220, 0.3);
        }

        body.light-mode .calendar-day::-webkit-scrollbar-thumb:hover {
            background: rgba(51, 105, 220, 0.5);
        }
        
        /* Disabled hover effect for better readability in dark mode
        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(197, 255, 117, 0.2);
            transform: scale(1.02);
            z-index: 10;
        } */
        
        .calendar-day.today {
            background: linear-gradient(135deg, rgba(197, 255, 117, 0.1), rgba(197, 255, 117, 0.05));
            border-color: rgba(197, 255, 117, 0.5);
        }

        /* Hover effect for empty calendar days - shows + symbol */
        .calendar-day:not(:has(.campaign-pill)):hover {
            background: rgba(197, 255, 117, 0.08);
            border-color: rgba(197, 255, 117, 0.3);
            cursor: pointer;
            position: relative;
        }

        .calendar-day:not(:has(.campaign-pill)):hover::before {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 300;
            color: rgba(197, 255, 117, 0.5);
            pointer-events: none;
            z-index: 1;
        }

        body.light-mode .calendar-day:not(:has(.campaign-pill)):hover {
            background: rgba(138, 108, 247, 0.08);
            border-color: rgba(138, 108, 247, 0.3);
        }

        body.light-mode .calendar-day:not(:has(.campaign-pill)):hover::before {
            color: rgba(138, 108, 247, 0.5);
        }

        .day-number {
            font-weight: 700;
            font-size: 13px;
            color: #C5FF75;
            margin-bottom: 6px;
            line-height: 1;
        }
        
        /* Campaign Pills */
        .campaign-pill {
            padding: 10px 14px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-width: 100%;
            min-height: 44px;
            letter-spacing: 0.2px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #8A6CF7;
            color: rgba(255, 255, 255, 0.95);
        }

        .campaign-pill.is-resend {
            border: 2px dashed #fbbf24 !important;  /* Amber dashed border all around */
            border-left: 4px solid #fbbf24 !important;  /* Keep solid left accent */
        }

        /* Text content inside pill */
        .campaign-pill-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.5;
            padding-right: 8px;
            transition: padding-right 0.3s;
            font-weight: 600;
        }

        /* Campaign metadata row */
        .campaign-pill-meta {
            display: flex;
            gap: 6px;
            align-items: center;
            font-size: 11px;
            opacity: 0.95;
            flex-wrap: wrap;
        }

        .campaign-pill-meta-badge {
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.25);
            font-weight: 600;
            font-size: 10px;
            text-transform: none;
            letter-spacing: 0.3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 90%;
        }

        /* Approval status badges */
        .approval-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .approval-badge.pending {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid rgba(251, 191, 36, 0.4);
            color: #fbbf24;
        }

        .approval-badge.approved {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #22c55e;
        }

        .approval-badge.rejected {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
        }

        /* On hover, make room for actions - DISABLED to prevent text movement */
        /* .campaign-pill:hover .campaign-pill-text {
            padding-right: 55px;
        } */

        /* Expanded pill for single events */
        .campaign-pill.expanded-pill {
            min-height: auto;
            padding: 12px 14px;
        }

        .campaign-pill.expanded-pill .campaign-pill-text {
            -webkit-line-clamp: 3;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .campaign-pill-description {
            font-size: 12px;
            line-height: 1.5;
            opacity: 0.9;
            margin-top: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Disabled campaign-pill hover effect for better readability
        .campaign-pill:hover {
            transform: translateX(4px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        } */
        
        .campaign-pill.promotional {
            border-left-color: #F43F5E;
        }

        .campaign-pill.content {
            border-left-color: #3B82F6;
        }

        .campaign-pill.engagement {
            border-left-color: #A855F7;
        }

        .campaign-pill.seasonal {
            border-left-color: #22C55E;
        }

        .campaign-pill.gradient-purple,
        .campaign-pill.special {
            border-left-color: #EC4899;
        }

        /* SMS Campaign Pills - Different shades for SMS channel */
        .campaign-pill.sms-promotional {
            border-left-color: #FF6B6B;
        }

        .campaign-pill.sms-content {
            border-left-color: #4ECDC4;
        }

        .campaign-pill.sms-engagement {
            border-left-color: #667EEA;
        }

        .campaign-pill.sms-seasonal {
            border-left-color: #F093FB;
        }

        .campaign-pill.sms-special {
            border-left-color: #FEE140;
        }
        
        /* Holiday and Event Indicators */
        .holiday-indicator {
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 4px;
            padding: 2px 4px;
            margin-bottom: 2px;
            font-size: 8px;
            font-weight: 600;
            color: #FFD700;
            line-height: 1.2;
            display: flex;
            align-items: flex-start;
            gap: 3px;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .holiday-indicator-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.2;
        }

        .holiday-indicator > span:first-child,
        .klaviyo-event > span:first-child {
            flex-shrink: 0;
            font-size: 10px;
        }
        
        .holiday-indicator.major {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.2), rgba(0, 255, 0, 0.2));
            border-color: rgba(255, 215, 0, 0.5);
            font-weight: 700;
        }
        
        .holiday-indicator.federal {
            background: rgba(51, 105, 220, 0.15);
            border-color: rgba(51, 105, 220, 0.4);
            color: #6B9BFF;
        }
        
        .holiday-indicator.retail {
            background: linear-gradient(135deg, rgba(255, 140, 0, 0.2), rgba(255, 0, 128, 0.2));
            border-color: rgba(255, 140, 0, 0.5);
            color: #FF8C00;
            font-weight: 700;
        }
        
        .klaviyo-event {
            background: linear-gradient(135deg, rgba(138, 108, 247, 0.15), rgba(197, 255, 117, 0.15));
            border: 1px solid rgba(138, 108, 247, 0.4);
            border-radius: 4px;
            padding: 2px 4px;
            margin-bottom: 2px;
            font-size: 8px;
            font-weight: 600;
            color: #C5FF75;
            line-height: 1.2;
            display: flex;
            align-items: flex-start;
            gap: 3px;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .klaviyo-event-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.2;
        }
        
        .klaviyo-event.planning {
            background: rgba(138, 108, 247, 0.2);
            border-color: rgba(138, 108, 247, 0.5);
            color: #A78BFA;
        }
        
        .klaviyo-event.campaign {
            background: rgba(197, 255, 117, 0.2);
            border-color: rgba(197, 255, 117, 0.5);
            color: #C5FF75;
        }
        
        .klaviyo-event.review {
            background: rgba(255, 140, 0, 0.2);
            border-color: rgba(255, 140, 0, 0.5);
            color: #FFA500;
        }
        
        /* Holiday/Event section divider */
        .calendar-day-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 4px;
            padding-bottom: 2px;
            min-height: 12px;
            max-height: 50px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .calendar-day-header::-webkit-scrollbar {
            width: 2px;
        }

        .calendar-day-header::-webkit-scrollbar-thumb {
            background: rgba(197, 255, 117, 0.3);
            border-radius: 1px;
        }
        
        /* Season indicator bar */
        .season-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }
        
        .season-indicator.critical {
            background: linear-gradient(90deg, #FF0000, #FF00FF, #FF0000);
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        .season-indicator.high {
            background: linear-gradient(90deg, #FF8C00, #FFD700);
        }
        
        .season-indicator.medium {
            background: linear-gradient(90deg, #4ECDC4, #44A08D);
        }
        
        @keyframes pulse-glow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* Week view holiday display */
        .week-view .holiday-indicator {
            font-size: 9px;
            padding: 1px 4px;
        }
        
        .week-view .klaviyo-event {
            font-size: 9px;
            padding: 1px 4px;
        }
        
        /* List view holiday display */
        .list-view-item .holiday-section {
            background: rgba(255, 215, 0, 0.05);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }
        
        .list-view-item .klaviyo-section {
            background: rgba(138, 108, 247, 0.05);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(138, 108, 247, 0.2);
        }
        
        /* Stats Cards */
        .stat-card {
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            transition: all 0.3s;
            text-align: center;
        }

        /* Pill Toggle Buttons */
        .pill-toggle {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pill-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .pill-toggle.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Disabled stat-card hover effect for better readability
        .stat-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(138, 108, 247, 0.3);
            transform: translateY(-2px);
        } */
        
        /* Grade Card Special Styling */
        .grade-card {
            border-color: rgba(255, 215, 0, 0.2);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            /* Removed overflow: hidden to show emoji properly */
            position: relative;
        }
        
        /* Removed grade card pulse animation */

        /* Welcoming pulse animation for Select Client button */
        .select-client-welcome {
            animation: welcome-pulse 2s ease-in-out infinite;
        }

        @keyframes welcome-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(168, 85, 247, 0);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px 10px rgba(168, 85, 247, 0.4);
                transform: scale(1.05);
            }
        }
        
        /* Curiosity badge */
        .grade-card .curiosity-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff0080, #ff8c00);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 12px;
            /* animation: badge-bounce 1s ease-in-out infinite; */  /* REMOVED - No bouncing animation */
            z-index: 10;
        }
        
        @keyframes badge-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        
        /* Hover tooltip */
        .grade-card .hover-hint {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            opacity: 0;
        }
        
        /* Disabled grade-card hover effects for better readability
        .grade-card:hover .hover-hint {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }
        
        .grade-card:hover {
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
            transform: translateY(-4px) scale(1.05);
        } */
        
        .grade-card-bg {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(255, 140, 0, 0.05));
            opacity: 0;
            transition: all 0.6s ease;
            z-index: 1;
        }
        
        /* Disabled grade-card-bg hover effect for better readability
        .grade-card:hover .grade-card-bg {
            opacity: 1;
        } */
        
        /* Dynamic grade backgrounds */
        .grade-card.grade-a-plus .grade-card-bg {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.15), rgba(127, 255, 0, 0.15));
            opacity: 1;
            animation: sparkle 3s ease-in-out infinite;
        }
        
        .grade-card.grade-a .grade-card-bg {
            background: linear-gradient(135deg, rgba(127, 255, 0, 0.12), rgba(0, 255, 0, 0.12));
            opacity: 1;
        }
        
        .grade-card.grade-b .grade-card-bg {
            background: linear-gradient(135deg, rgba(255, 255, 0, 0.1), rgba(255, 215, 0, 0.1));
            opacity: 1;
        }
        
        .grade-card.grade-c .grade-card-bg {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.1), rgba(255, 140, 0, 0.1));
            opacity: 1;
        }
        
        .grade-card.grade-d .grade-card-bg {
            background: linear-gradient(135deg, rgba(255, 69, 0, 0.1), rgba(255, 99, 71, 0.1));
            opacity: 1;
        }
        
        .grade-card.grade-f .grade-card-bg {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.1), rgba(139, 0, 0, 0.1));
            opacity: 1;
        }
        
        /* Animated stars for A+ grade */
        .grade-card.grade-a-plus::before {
            content: '✨';
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 20px;
            animation: float-star 4s ease-in-out infinite;
            opacity: 0.6;
        }
        
        .grade-card.grade-a-plus::after {
            content: '⭐';
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 18px;
            animation: float-star 4s ease-in-out infinite reverse;
            opacity: 0.5;
        }
        
        @keyframes sparkle {
            0%, 100% { 
                background: linear-gradient(135deg, rgba(0, 255, 0, 0.15), rgba(127, 255, 0, 0.15));
                filter: brightness(1);
            }
            50% { 
                background: linear-gradient(135deg, rgba(127, 255, 0, 0.2), rgba(0, 255, 127, 0.2));
                filter: brightness(1.2);
            }
        }
        
        @keyframes float-star {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(10deg); }
            75% { transform: translateY(5px) rotate(-10deg); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* When grade is shown, just change the content, don't hide anything */
        .grade-card.has-grade #gradeDisplay {
            font-weight: 900;
            text-shadow: 0 0 10px currentColor;
        }
        
        .stat-value {
            font-family: 'Red Hat Display', sans-serif;
            font-size: 32px;
            font-weight: 900;
            background: linear-gradient(135deg, #8A6CF7, #C5FF75);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        /* Grade chip styles to keep emoji and label visible */
        .grade-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            position: relative;
            z-index: 10;
        }

        .grade-icon {
            font-size: 1.6rem;
            line-height: 1;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3369DC, #8A6CF7);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(138, 108, 247, 0.5);
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 15px 40px rgba(138, 108, 247, 0.7);
        }
        
        /* Grade Calendar FAB */
        .grade-fab {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: auto;
            min-width: 80px;
            height: 60px;
            padding: 0 20px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            z-index: 999;
            overflow: hidden;
            position: relative;
        }
        
        .grade-fab:before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 30px;
            padding: 2px;
            background: linear-gradient(135deg, #FFD700, #FFA500, #FF6347);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            opacity: 0;
            transition: opacity 0.4s;
        }
        
        .grade-fab:hover:before {
            opacity: 1;
        }
        
        .grade-fab-content {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 2;
        }
        
        .grade-icon {
            font-size: 24px;
            /* Professional static icon - no bouncing */
        }
        
        .grade-label {
            font-weight: 600;
            color: #FFD700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .grade-indicator {
            font-weight: 900;
            font-size: 18px;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            margin-left: 4px;
        }
        
        .grade-fab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 20px 40px rgba(255, 215, 0, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .grade-fab-glow {
            position: absolute;
            inset: -20px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }
        
        .grade-fab:hover .grade-fab-glow {
            opacity: 1;
        }
        
        /* Holiday Management FAB */
        .holiday-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .holiday-fab:hover {
            transform: scale(1.1) rotate(15deg);
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }
        
        /* Holiday Toggle Button - Minimal */
        .holiday-toggle {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            z-index: 100;
            opacity: 0.6;
        }
        
        .holiday-toggle:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.06);
            transform: scale(1.1);
        }
        
        .holiday-toggle.active {
            opacity: 1;
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.2);
        }
        
        .holiday-toggle.active:hover {
            background: rgba(34, 197, 94, 0.15);
        }
        
        /* Holiday Management Modal */
        .holiday-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .holiday-modal.active {
            display: flex;
        }
        
        .holiday-modal-content {
            background: rgba(20, 20, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: auto;
            padding: 30px;
        }
        
        /* Improved Holiday Indicators */
        .holiday-indicator {
            padding: 2px 6px !important;
            font-size: 9px !important;
            border-radius: 4px !important;
            margin: 1px !important;
            opacity: 0.9 !important;
            font-weight: 500 !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            backdrop-filter: blur(5px) !important;
        }
        
        .holiday-indicator.holiday {
            background: linear-gradient(135deg, rgba(255, 69, 0, 0.2), rgba(255, 140, 0, 0.2)) !important;
            border: 1px solid rgba(255, 140, 0, 0.4) !important;
            color: #FFA500 !important;
        }
        
        .holiday-indicator.klaviyo {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.2), rgba(168, 85, 247, 0.2)) !important;
            border: 1px dashed rgba(168, 85, 247, 0.5) !important;
            color: #A855F7 !important;
        }
        
        .holiday-indicator.major {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(248, 113, 113, 0.2)) !important;
            border: 1px solid rgba(248, 113, 113, 0.4) !important;
            color: #F87171 !important;
        }
        
        .holiday-indicator.federal {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.2)) !important;
            border: 1px solid rgba(96, 165, 250, 0.4) !important;
            color: #60A5FA !important;
        }
        
        .holiday-indicator.cultural {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(74, 222, 128, 0.2)) !important;
            border: 1px solid rgba(74, 222, 128, 0.4) !important;
            color: #4ADE80 !important;
        }
        
        .holiday-indicator.retail {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(252, 211, 77, 0.2)) !important;
            border: 1px solid rgba(252, 211, 77, 0.4) !important;
            color: #FCD34D !important;
        }
        
        /* Pulse animation for poor grades */
        @keyframes pulse-warning {
            0%, 100% { 
                box-shadow: 0 10px 30px rgba(255, 69, 0, 0.5);
                border-color: rgba(255, 69, 0, 0.5);
            }
            50% { 
                box-shadow: 0 10px 50px rgba(255, 69, 0, 0.8);
                border-color: rgba(255, 69, 0, 0.8);
            }
        }
        
        .grade-fab.poor-grade {
            animation: pulse-warning 2s ease-in-out infinite;
        }
        
        /* Scroll Animations */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s forwards;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-delay-1 { animation-delay: 0.1s; }
        .fade-in-delay-2 { animation-delay: 0.2s; }
        .fade-in-delay-3 { animation-delay: 0.3s; }
        
        /* Loading Animation */
        .pulse-loader {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3369DC, #8A6CF7);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* Week Timeline Styles */
        .week-timeline-header {
            margin-bottom: 24px;
        }

        .week-timeline-container {
            display: flex;
            gap: 0;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            max-height: calc(100vh - 300px);
            position: relative;
        }

        .week-timeline-times {
            flex-shrink: 0;
            width: 80px;
            background: rgba(255, 255, 255, 0.03);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            position: sticky;
            left: 0;
            z-index: 10;
            overflow: hidden;
        }

        .week-timeline-corner {
            height: 60px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .week-timeline-time-label {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .week-timeline-grid {
            flex: 1;
            position: relative;
            overflow-x: auto;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
            scroll-behavior: smooth;
        }

        /* Scrollbar styling for week view */
        .week-timeline-grid::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .week-timeline-grid::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .week-timeline-grid::-webkit-scrollbar-thumb {
            background: rgba(138, 108, 247, 0.5);
            border-radius: 4px;
        }

        .week-timeline-grid::-webkit-scrollbar-thumb:hover {
            background: rgba(138, 108, 247, 0.7);
        }

        .week-timeline-times::-webkit-scrollbar {
            width: 0px;
            display: none;
        }

        .week-timeline-days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            height: 60px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .week-timeline-day-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .week-timeline-day-header:last-child {
            border-right: none;
        }

        .week-timeline-day-header.is-today {
            background: rgba(197, 255, 117, 0.1);
            border-left: 2px solid rgba(197, 255, 117, 0.5);
            border-right: 2px solid rgba(197, 255, 117, 0.5);
        }

        .week-timeline-day-header .day-name {
            font-size: 13px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2px;
        }

        .week-timeline-day-header.is-today .day-name {
            color: #C5FF75;
        }

        .week-timeline-day-header .day-date {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .week-timeline-day-header.is-today .day-date {
            color: #C5FF75;
            font-weight: 600;
        }

        .week-timeline-hour-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            height: 60px;
        }

        .week-timeline-cell {
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.15s ease;
        }

        .week-timeline-cell:last-child {
            border-right: none;
        }

        .week-timeline-cell:hover {
            background: rgba(138, 108, 247, 0.1);
        }

        .week-timeline-cell.drag-over {
            background: rgba(197, 255, 117, 0.2);
            border: 2px dashed rgba(197, 255, 117, 0.6);
        }

        .week-timeline-cell.is-today-col {
            background: rgba(197, 255, 117, 0.03);
        }

        .week-timeline-campaigns {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            height: 1440px; /* 24 hours × 60px per hour = fixed height for accurate positioning */
            pointer-events: none;
        }

        .week-timeline-campaign {
            position: absolute;
            background: linear-gradient(135deg, rgba(138, 108, 247, 0.9), rgba(123, 95, 238, 0.9));
            border-left: 3px solid #8A6CF7;
            border-radius: 6px;
            padding: 6px 8px;
            cursor: move;
            pointer-events: all;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            margin: 0px 2px;  /* No top/bottom margin for perfect alignment with hour grid */
            min-height: 50px;
            z-index: 10;
        }

        .week-timeline-campaign:hover {
            transform: translateX(2px);
            box-shadow: 0 4px 12px rgba(138, 108, 247, 0.4);
            z-index: 20;
        }

        .week-timeline-campaign.promotional {
            background: linear-gradient(135deg, rgba(244, 63, 94, 0.9), rgba(220, 38, 38, 0.9));
            border-left-color: #F43F5E;
        }

        .week-timeline-campaign.content {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
            border-left-color: #3B82F6;
        }

        .week-timeline-campaign.engagement {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.9), rgba(147, 51, 234, 0.9));
            border-left-color: #A855F7;
        }

        .week-timeline-campaign.seasonal {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
            border-left-color: #22C55E;
        }

        .week-timeline-campaign.special {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.9), rgba(245, 158, 11, 0.9));
            border-left-color: #FBBF24;
        }

        .week-timeline-campaign.is-resend {
            border: 2px dashed #fbbf24 !important;  /* Amber dashed border */
            border-left: 4px solid #fbbf24 !important;  /* Solid left accent */
        }

        .week-timeline-campaign .campaign-time {
            font-size: 10px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 3px;
        }

        .week-timeline-campaign .campaign-name {
            font-size: 12px;
            font-weight: 600;
            color: white;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            margin-bottom: 3px;
        }

        .week-timeline-campaign .campaign-revenue {
            font-size: 11px;
            font-weight: 700;
            color: rgba(197, 255, 117, 1);
        }

        .week-timeline-now-indicator {
            position: absolute;
            left: 0;
            right: 0;
            z-index: 100;
            pointer-events: none;
        }

        .week-timeline-now-indicator .now-line {
            height: 2px;
            background: #F43F5E;
            box-shadow: 0 0 8px rgba(244, 63, 94, 0.6);
        }

        .week-timeline-now-indicator .now-dot {
            position: absolute;
            left: -6px;
            top: -5px;
            width: 12px;
            height: 12px;
            background: #F43F5E;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(244, 63, 94, 0.8);
            animation: pulse-now 2s infinite;
        }

        @keyframes pulse-now {
            0%, 100% {
                box-shadow: 0 0 12px rgba(244, 63, 94, 0.8);
            }
            50% {
                box-shadow: 0 0 20px rgba(244, 63, 94, 1);
            }
        }

        /* Light mode styles for week timeline */
        body.light-mode .week-timeline-container {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .week-timeline-times {
            background: rgba(0, 0, 0, 0.03);
            border-right-color: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .week-timeline-time-label {
            color: rgba(0, 0, 0, 0.6);
            border-bottom-color: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .week-timeline-days-header {
            background: rgba(0, 0, 0, 0.03);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .week-timeline-day-header {
            border-right-color: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .week-timeline-day-header .day-name {
            color: rgba(0, 0, 0, 0.9);
        }

        body.light-mode .week-timeline-day-header .day-date {
            color: rgba(0, 0, 0, 0.5);
        }

        body.light-mode .week-timeline-cell {
            border-right-color: rgba(0, 0, 0, 0.05);
            border-bottom-color: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .week-timeline-cell:hover {
            background: rgba(138, 108, 247, 0.05);
        }

        body.light-mode .week-timeline-campaign {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        body.light-mode .week-timeline-campaign:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .week-timeline-times {
                width: 60px;
            }

            .week-timeline-time-label {
                font-size: 9px;
            }

            .week-timeline-day-header .day-name {
                font-size: 11px;
            }

            .week-timeline-day-header .day-date {
                font-size: 9px;
            }

            .week-timeline-campaign {
                padding: 4px 6px;
                min-height: 40px;
            }

            .week-timeline-campaign .campaign-name {
                font-size: 10px;
            }

            .week-timeline-campaign .campaign-revenue {
                font-size: 9px;
            }
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-backdrop.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(20, 20, 20, 0.98) 0%, rgba(10, 10, 10, 0.98) 100%);
            border: 1px solid rgba(197, 255, 117, 0.2);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 100px rgba(138, 108, 247, 0.1);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            color: #C5FF75;
            font-size: 24px;
            display: flex;
            align-items: center;
        }
        
        .modal-body {
            margin-bottom: 24px;
        }
        
        .modal-body p {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }
        
        .modal-body textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(197, 255, 117, 0.2);
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 14px;
            resize: vertical;
            transition: all 0.3s;
        }
        
        .modal-body textarea:focus {
            outline: none;
            border-color: rgba(197, 255, 117, 0.5);
            background: rgba(0, 0, 0, 0.6);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 28px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #C5FF75;
            transform: rotate(90deg);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn-primary, .btn-secondary {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3369DC 0%, #8A6CF7 100%);
            border: none;
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(138, 108, 247, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #3369DC, #8A6CF7);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #8A6CF7, #C5FF75);
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.95), rgba(20, 20, 20, 0.95));
            border: 1px solid rgba(197, 255, 117, 0.3);
            padding: 16px 24px;
            border-radius: 12px;
            color: #C5FF75;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Add button in top-right corner */
        .add-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: rgba(197, 255, 117, 0.1);
            border: 1px solid rgba(197, 255, 117, 0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #C5FF75;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        /* Disabled hover effect for better readability
        .calendar-day:hover .add-btn {
            opacity: 0.7;
        } */
        
        .add-btn:hover {
            opacity: 1 !important;
            background: rgba(197, 255, 117, 0.2);
            transform: scale(1.1);
        }

        /* Campaign Pill Actions Override - removed, handled by .campaign-pill-text now */

        .campaign-pill:hover .pill-actions {
            opacity: 1;
            transform: translateX(0);
        }

        .pill-actions {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%) translateX(10px);
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 5; /* Ensure actions appear above text */
        }

        .pill-action {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .pill-action:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.15);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        
        /* List view specific action buttons */
        .list-view-actions {
            display: flex;
            gap: 6px;
            margin-left: 12px;
            position: relative;
            z-index: 20;
        }
        
        .list-view-actions .pill-action {
            width: 36px;
            height: 36px;
            font-size: 16px;
            background: rgba(138, 108, 247, 0.2);
            border: 1px solid rgba(138, 108, 247, 0.4);
            cursor: pointer;
            position: relative;
            z-index: 25;
            pointer-events: auto;
        }
        
        .list-view-actions .pill-action:hover {
            background: rgba(138, 108, 247, 0.4);
            border-color: rgba(138, 108, 247, 0.7);
            transform: scale(1.1);
            z-index: 30;
        }
        
        .list-view-actions .pill-action:active {
            transform: scale(0.95);
        }
        
        .list-view-actions .pill-action.copy:hover {
            background: rgba(67, 205, 255, 0.4);
            border-color: rgba(67, 205, 255, 0.7);
            box-shadow: 0 0 15px rgba(67, 205, 255, 0.4);
        }
        
        .list-view-actions .pill-action.edit:hover {
            background: rgba(197, 255, 117, 0.4);
            border-color: rgba(197, 255, 117, 0.7);
            box-shadow: 0 0 15px rgba(197, 255, 117, 0.4);
        }
        
        .list-view-actions .pill-action.delete:hover {
            background: rgba(255, 67, 67, 0.4);
            border-color: rgba(255, 67, 67, 0.7);
            box-shadow: 0 0 15px rgba(255, 67, 67, 0.4);
        }
        
        /* Ensure clickable area for list items */
        .list-view-content {
            cursor: pointer;
            flex: 1;
        }

        /* Enhanced List View Campaign Cards */
        .list-view-campaign-card {
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
        }

        .list-view-campaign-card:hover {
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px rgba(138, 108, 247, 0.2);
            transform: translateY(-2px);
        }

        .list-view-campaign-card:active {
            transform: scale(0.98);
        }

        .list-view-campaign-card.dragging {
            opacity: 0.4;
            transform: scale(0.95);
        }

        /* Campaign type color indicators */
        .list-view-campaign-card.campaign-promotional {
            border-left-color: #ff0080 !important;
        }

        .list-view-campaign-card.campaign-content {
            border-left-color: #3369DC !important;
        }

        .list-view-campaign-card.campaign-engagement {
            border-left-color: #8A6CF7 !important;
        }

        .list-view-campaign-card.campaign-seasonal {
            border-left-color: #C5FF75 !important;
        }

        .list-view-campaign-card.campaign-special,
        .list-view-campaign-card.campaign-gradient-purple {
            border-left-color: #9F7AEA !important;
        }

        /* SMS campaign colors */
        .list-view-campaign-card.campaign-sms-promotional {
            border-left-color: #FF6B6B !important;
        }

        .list-view-campaign-card.campaign-sms-content {
            border-left-color: #4ECDC4 !important;
        }

        .list-view-campaign-card.campaign-sms-engagement {
            border-left-color: #667EEA !important;
        }

        .list-view-campaign-card.campaign-sms-seasonal {
            border-left-color: #F093FB !important;
        }

        .list-view-campaign-card.campaign-sms-special {
            border-left-color: #FA709A !important;
        }

        /* Resend campaign styling for list view */
        .list-view-campaign-card.is-resend {
            border: 2px dashed #fbbf24 !important;  /* Amber dashed border */
            border-left: 4px solid #fbbf24 !important;  /* Solid left accent */
            background: rgba(251, 191, 36, 0.08) !important;
        }

        body.light-mode .list-view-campaign-card.is-resend {
            border: 2px dashed #d97706 !important;
            border-left: 4px solid #d97706 !important;
            background: rgba(251, 191, 36, 0.12) !important;
        }

        /* List view campaign details section */
        .list-view-campaign-details {
            margin-top: 12px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                max-height: 500px;
                transform: translateY(0);
            }
        }

        /* Drop zone styling */
        .list-view-drop-zone {
            transition: all 0.3s ease;
        }

        .list-view-drop-zone.drag-over {
            border-color: rgba(197, 255, 117, 0.5) !important;
            background-color: rgba(197, 255, 117, 0.05) !important;
        }

        /* Week container styling */
        .week-container {
            transition: all 0.3s ease;
        }

        .week-container:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        /* Chat Interface Styles */
        .ai-message {
            padding: 12px;
            background: rgba(138, 108, 247, 0.1);
            border-left: 3px solid #8A6CF7;
            border-radius: 8px;
        }

        .user-message {
            padding: 12px;
            background: rgba(197, 255, 117, 0.1);
            border-left: 3px solid #C5FF75;
            border-radius: 8px;
            color: #000;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #C5FF75;
        }

        body.light-mode .form-label {
            color: #8A6CF7;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #FFFFFF;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: rgba(197, 255, 117, 0.5);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(197, 255, 117, 0.2);
        }
        
        /* File Upload Styles */
        .file-upload-area {
            position: relative;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.02);
        }
        
        .file-upload-area:hover {
            border-color: rgba(197, 255, 117, 0.5);
            background: rgba(197, 255, 117, 0.05);
        }
        
        .file-upload-area.dragover {
            border-color: rgba(197, 255, 117, 0.8);
            background: rgba(197, 255, 117, 0.1);
            transform: scale(1.02);
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-upload-content {
            pointer-events: none;
        }
        
        body.light-mode .file-upload-area {
            border-color: rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.02);
        }
        
        body.light-mode .file-upload-area:hover {
            border-color: rgba(51, 105, 220, 0.5);
            background: rgba(51, 105, 220, 0.05);
        }
        
        body.light-mode .file-upload-area.dragover {
            border-color: rgba(51, 105, 220, 0.8);
            background: rgba(51, 105, 220, 0.1);
        }

        .form-select option {
            background: #000;
            color: #fff;
        }

        /* Save Status Indicator */
        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .save-status.show {
            opacity: 1;
            transform: translateY(0);
        }

        .save-status.saving {
            background: linear-gradient(135deg, #8A6CF7, #3369DC);
            color: white;
        }

        .save-status.saved {
            background: linear-gradient(135deg, #C5FF75, #8BED4F);
            color: #000;
        }

        .save-status.error {
            background: linear-gradient(135deg, #ff0080, #ff4444);
            color: white;
        }
        
        /* Celebration Overlay - Fixed Positioning */
        .celebration-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.95) !important;
            backdrop-filter: blur(15px) !important;
            z-index: 999999 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-direction: column !important;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            pointer-events: none;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .celebration-overlay.show {
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: all !important;
        }
        
        .celebration-content {
            background: rgba(255, 255, 255, 0.15) !important;
            backdrop-filter: blur(25px) !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 28px !important;
            padding: 50px 40px !important;
            text-align: center !important;
            max-width: 450px !important;
            width: 90vw !important;
            position: relative !important;
            z-index: 1000000 !important;
            animation: celebration-bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5) !important;
        }
        
        @keyframes celebration-bounce {
            0% {
                transform: scale(0.3) rotate(-12deg);
                opacity: 0;
            }
            70% {
                transform: scale(1.05) rotate(2deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        .fireworks {
            position: absolute !important;
            font-size: 2.5rem !important;
            animation: firework 3s ease-out infinite;
            pointer-events: none !important;
            z-index: 999998 !important;
        }
        
        @keyframes firework {
            0% {
                transform: translateY(0) scale(0);
                opacity: 1;
            }
            50% {
                transform: translateY(-100px) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-200px) scale(0);
                opacity: 0;
            }
        }
        
        body.light-mode .celebration-overlay {
            background: rgba(255, 255, 255, 0.95);
        }
        
        body.light-mode .celebration-content {
            background: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a1a;
        }
        
        /* Additional celebration overlay fixes */
        .celebration-overlay * {
            box-sizing: border-box !important;
        }
        
        .celebration-overlay .fireworks {
            position: absolute !important;
            z-index: 1000001 !important;
        }
        
        /* Goal Confidence Indicators */
        .stat-card.confidence-high {
            border-color: rgba(197, 255, 117, 0.5) !important;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(197, 255, 117, 0.05)) !important;
        }
        
        .stat-card.confidence-medium {
            border-color: rgba(138, 108, 247, 0.5) !important;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(138, 108, 247, 0.05)) !important;
        }
        
        .stat-card.confidence-low {
            border-color: rgba(255, 193, 7, 0.5) !important;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(255, 193, 7, 0.05)) !important;
        }
        
        body.light-mode .stat-card.confidence-high {
            border-color: rgba(197, 255, 117, 0.6) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(197, 255, 117, 0.1)) !important;
        }
        
        body.light-mode .stat-card.confidence-medium {
            border-color: rgba(138, 108, 247, 0.6) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(138, 108, 247, 0.1)) !important;
        }
        
        body.light-mode .stat-card.confidence-low {
            border-color: rgba(255, 193, 7, 0.6) !important;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 193, 7, 0.1)) !important;
        }
        
        /* Human Override Indicator */
        .override-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            cursor: help;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        /* ============================================ */
        /* Fullscreen Calendar Mode */
        /* ============================================ */
        .calendar-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 99999 !important;
            background: rgba(0, 0, 0, 0.98) !important;
            overflow: auto !important;
            padding: 20px !important;
            margin: 0 !important;
            max-width: 100vw !important;
            border-radius: 0 !important;
            animation: fadeIn 0.3s ease;
        }
        
        .calendar-fullscreen .calendar-grid {
            height: calc(100vh - 250px) !important;
            max-width: 100% !important;
            overflow: auto !important;
        }
        
        .calendar-fullscreen .calendar-day {
            min-height: 120px !important;
        }
        
        /* Light mode fullscreen */
        body.light-mode .calendar-fullscreen {
            background: rgba(255, 255, 255, 0.98) !important;
        }
        
        /* Hide other elements when calendar is fullscreen */
        body.calendar-is-fullscreen .gradient-bg,
        body.calendar-is-fullscreen .gradient-orbs,
        body.calendar-is-fullscreen .stats-grid,
        body.calendar-is-fullscreen #changeRequestsSection,
        body.calendar-is-fullscreen #campaignTypesContainer,
        body.calendar-is-fullscreen #aiChatSection,
        body.calendar-is-fullscreen #commandFab,
        body.calendar-is-fullscreen .mb-8:not(.calendar-fullscreen),
        body.calendar-is-fullscreen .holiday-toggle {
            display: none !important;
        }
        
        /* Fullscreen transition animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* ============================================ */
        /* Calendar Smooth Scroll Animations */
        /* ============================================ */
        .calendar-transition-container {
            position: relative;
            overflow: hidden;
            min-height: 600px;
        }
        
        .calendar-grid-wrapper {
            position: relative;
            width: 100%;
            transition: none;
        }
        
        /* Slide animations */
        @keyframes slideOutLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .calendar-slide-out-left {
            animation: slideOutLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            position: absolute !important;
            width: 100%;
        }
        
        .calendar-slide-out-right {
            animation: slideOutRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            position: absolute !important;
            width: 100%;
        }
        
        .calendar-slide-in-left {
            animation: slideInLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .calendar-slide-in-right {
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* Prevent interaction during animation */
        .calendar-animating {
            pointer-events: none;
        }
        
        /* ============================================ */
        /* Multi-Day Campaign Styles - Google Calendar Spanning */
        /* ============================================ */

        /* Week row container for multi-day spanning events - spans full grid */
        .multi-day-week-row {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        /* Wrapper with scrollbar for overflow - spans full grid */
        .multi-day-events-wrapper {
            grid-column: 1 / -1;
            max-height: 52px; /* ~2 events */
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: rgba(138, 108, 247, 0.4) transparent;
        }

        .multi-day-events-wrapper::-webkit-scrollbar {
            width: 4px;
        }

        .multi-day-events-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .multi-day-events-wrapper::-webkit-scrollbar-thumb {
            background: rgba(138, 108, 247, 0.4);
            border-radius: 2px;
        }

        /* In fullscreen mode, show all events */
        .calendar-fullscreen .multi-day-events-wrapper {
            max-height: none;
            overflow-y: visible;
        }

        /* Spanning event bar */
        .multi-day-event-span {
            height: 22px;
            background: linear-gradient(90deg,
                rgba(138, 108, 247, 0.6) 0%,
                rgba(197, 255, 117, 0.6) 100%);
            border-radius: 4px;
            padding: 0 8px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            margin: 1px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .multi-day-event-span:hover {
            background: linear-gradient(90deg,
                rgba(138, 108, 247, 0.8) 0%,
                rgba(197, 255, 117, 0.8) 100%);
            box-shadow: 0 2px 8px rgba(138, 108, 247, 0.4);
            transform: translateY(-1px);
        }

        /* Event continues from previous week */
        .multi-day-event-span.continues-left {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            margin-left: -3px;
            padding-left: 6px;
        }

        /* Event continues to next week */
        .multi-day-event-span.continues-right {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            margin-right: -3px;
            padding-right: 6px;
        }

        .multi-day-event-span .event-icon {
            flex-shrink: 0;
            font-size: 12px;
        }

        .multi-day-event-span .event-name {
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .multi-day-event-span .event-duration {
            font-size: 9px;
            opacity: 0.8;
            flex-shrink: 0;
        }

        /* Light mode adjustments */
        body.light-mode .multi-day-event-span {
            color: #333;
            background: linear-gradient(90deg,
                rgba(138, 108, 247, 0.5) 0%,
                rgba(197, 255, 117, 0.7) 100%);
        }

        body.light-mode .multi-day-event-span:hover {
            background: linear-gradient(90deg,
                rgba(138, 108, 247, 0.6) 0%,
                rgba(197, 255, 117, 0.8) 100%);
        }

        /* Legacy container - keep for backward compatibility but hidden */
        .multi-day-events-container {
            display: none;
        }
        
        /* ============================================ */
        /* Light Mode Text Visibility Fixes - UI/UX Master */
        /* ============================================ */
        
        /* Convert all white text with opacity to dark text */
        body.light-mode [class*="text-white/"] {
            color: rgba(0, 0, 0, 0.8) !important;
        }
        
        /* Specific opacity adjustments for better hierarchy */
        body.light-mode .text-white\/90 { color: rgba(0, 0, 0, 0.95) !important; }
        body.light-mode .text-white\/80 { color: rgba(0, 0, 0, 0.90) !important; }
        body.light-mode .text-white\/70 { color: rgba(0, 0, 0, 0.85) !important; }
        body.light-mode .text-white\/60 { color: rgba(0, 0, 0, 0.75) !important; }
        body.light-mode .text-white\/50 { color: rgba(0, 0, 0, 0.70) !important; }
        body.light-mode .text-white\/40 { color: rgba(0, 0, 0, 0.60) !important; }
        body.light-mode .text-white\/30 { color: rgba(0, 0, 0, 0.50) !important; }
        body.light-mode .text-white\/20 { color: rgba(0, 0, 0, 0.40) !important; }
        
        /* Gray text conversions */
        body.light-mode .text-gray-300 { color: #525252 !important; }
        body.light-mode .text-gray-400 { color: #404040 !important; }
        body.light-mode .text-gray-500 { color: #262626 !important; }
        
        /* Slate text conversions */
        body.light-mode .text-slate-300 { color: #475569 !important; }
        body.light-mode .text-slate-400 { color: #334155 !important; }
        body.light-mode .text-slate-500 { color: #1e293b !important; }
        
        /* Zinc text conversions */
        body.light-mode .text-zinc-300 { color: #52525b !important; }
        body.light-mode .text-zinc-400 { color: #3f3f46 !important; }
        body.light-mode .text-zinc-500 { color: #27272a !important; }
        
        /* Placeholder text for inputs */
        body.light-mode input::placeholder,
        body.light-mode textarea::placeholder {
            color: rgba(0, 0, 0, 0.4) !important;
        }
        
        /* Holiday and Event Pills - Darker for better visibility */
        body.light-mode .holiday-pill {
            background: rgba(234, 88, 12, 0.85) !important;
            color: #ffffff !important;
            border: 1px solid rgba(234, 88, 12, 1) !important;
            font-weight: 600 !important;
        }
        
        body.light-mode .klaviyo-pill {
            background: rgba(124, 58, 237, 0.85) !important;
            color: #ffffff !important;
            border: 1px solid rgba(124, 58, 237, 1) !important;
            font-weight: 600 !important;
        }
        
        /* Approval Status Badges */
        body.light-mode #approvalStatusBar span[class*="bg-green"] {
            background: rgba(34, 197, 94, 0.15) !important;
            border-color: rgba(34, 197, 94, 0.4) !important;
        }
        
        body.light-mode #approvalStatusBar .text-green-400 {
            color: #16a34a !important;
        }
        
        body.light-mode #approvalStatusBar .text-green-300\/70 {
            color: rgba(22, 163, 74, 0.7) !important;
        }
        
        body.light-mode #approvalStatusBar span[class*="bg-orange"] {
            background: rgba(234, 88, 12, 0.15) !important;
            border-color: rgba(234, 88, 12, 0.4) !important;
        }
        
        body.light-mode #approvalStatusBar .text-orange-400 {
            color: #ea580c !important;
        }
        
        body.light-mode #approvalStatusBar .text-orange-300\/70 {
            color: rgba(234, 88, 12, 0.7) !important;
        }
        
        /* Chat Interface */
        body.light-mode .bg-blue-500\/10 {
            background: rgba(59, 130, 246, 0.1) !important;
        }
        
        body.light-mode .text-blue-300 {
            color: #2563eb !important;
        }
        
        body.light-mode .text-blue-400 {
            color: #3b82f6 !important;
        }
        
        body.light-mode .bg-white\/5 {
            background: rgba(0, 0, 0, 0.05) !important;
        }
        
        /* Campaign Pills in Calendar */
        body.light-mode .campaign-pill {
            border: 1px solid rgba(0, 0, 0, 0.2) !important;
            color: #1a1a1a !important;
        }
        
        body.light-mode .campaign-pill span {
            color: inherit !important;
        }
        
        /* Hover States */
        body.light-mode .hover\:text-white:hover {
            color: #1a1a1a !important;
        }
        
        body.light-mode .hover\:text-red-400:hover {
            color: #dc2626 !important;
        }
        
        /* Borders */
        body.light-mode [class*="border-white/"] {
            border-color: rgba(0, 0, 0, 0.15) !important;
        }
        
        /* Dark Backgrounds to Light */
        body.light-mode .bg-black\/30 {
            background: rgba(0, 0, 0, 0.05) !important;
        }
        
        body.light-mode .bg-black\/20 {
            background: rgba(0, 0, 0, 0.03) !important;
        }
        
        body.light-mode .bg-black\/10 {
            background: rgba(0, 0, 0, 0.02) !important;
        }
        
        /* Task List Items */
        body.light-mode .line-through {
            color: rgba(0, 0, 0, 0.4) !important;
        }
        
        /* Close/Dismiss Buttons */
        body.light-mode button[onclick*="close"],
        body.light-mode button[onclick*="hide"],
        body.light-mode button[onclick*="dismiss"],
        body.light-mode button[onclick*="Cancel"] {
            color: rgba(0, 0, 0, 0.5) !important;
        }
        
        body.light-mode button[onclick*="close"]:hover,
        body.light-mode button[onclick*="hide"]:hover,
        body.light-mode button[onclick*="dismiss"]:hover,
        body.light-mode button[onclick*="Cancel"]:hover {
            color: rgba(0, 0, 0, 0.8) !important;
        }
        
        /* Segment Pills */
        body.light-mode .segment-pill {
            background: rgba(124, 58, 237, 0.1) !important;
            color: #6d28d9 !important;
            border: 1px solid rgba(124, 58, 237, 0.3) !important;
        }
        
        /* Calendar Event Text */
        body.light-mode .calendar-day .text-xs {
            color: #1a1a1a !important;
        }
        
        /* Modal Text */
        body.light-mode .modal-content p,
        body.light-mode .modal-content div,
        body.light-mode .modal-content span {
            color: #1a1a1a !important;
        }
        
        /* Loading Messages */
        body.light-mode .loading-messages {
            color: #1a1a1a !important;
        }
        
        /* Holiday Toggle Button */
        body.light-mode .holiday-toggle {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 2px solid rgba(34, 197, 94, 0.3) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }
        
        body.light-mode .holiday-toggle:hover {
            border-color: rgba(34, 197, 94, 0.5) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }
        
        /* Command Palette Items */
        body.light-mode .command-item {
            color: #1a1a1a !important;
        }
        
        body.light-mode .command-item:hover {
            background: rgba(59, 130, 246, 0.1) !important;
        }
        
        /* Stat Cards Text Visibility Fix */
        body.light-mode .stat-card .stat-value {
            color: #1a1a1a !important;
            font-weight: 700 !important;
        }
        
        body.light-mode .stat-card .stat-label {
            color: rgba(0, 0, 0, 0.7) !important;
            font-weight: 600 !important;
        }
        
        /* Grade Card Specific */
        body.light-mode .grade-card .stat-value,
        body.light-mode .grade-card .stat-label {
            color: #1a1a1a !important;
        }
        
        body.light-mode .grade-card .hover-hint {
            color: rgba(0, 0, 0, 0.8) !important;
        }
        
        /* Campaign Pills with Yellow - Darker for Light Mode */
        body.light-mode .campaign-pill.engagement {
            background: linear-gradient(135deg, #7c3aed, #6366f1) !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }
        
        body.light-mode .campaign-pill.seasonal {
            background: linear-gradient(135deg, #059669, #047857) !important;
            color: #ffffff !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
        }
        
        body.light-mode .campaign-pill.sms-special {
            background: linear-gradient(135deg, #dc2626, #f59e0b) !important;
            color: #ffffff !important;
        }
        
        /* Ensure all campaign pill text is visible */
        body.light-mode .campaign-pill {
            font-weight: 600 !important;
        }

        /* FIXED: Changed from white to dark text for Light mode visibility */
        body.light-mode .campaign-pill.promotional,
        body.light-mode .campaign-pill.content,
        body.light-mode .campaign-pill.special,
        body.light-mode .campaign-pill.sms-promotional,
        body.light-mode .campaign-pill.sms-content,
        body.light-mode .campaign-pill.sms-engagement,
        body.light-mode .campaign-pill.sms-seasonal {
            color: rgba(0, 0, 0, 0.95) !important;  /* Dark text instead of white */
        }

        /* Ensure campaign-pill-text inherits the dark color */
        body.light-mode .campaign-pill.promotional .campaign-pill-text,
        body.light-mode .campaign-pill.content .campaign-pill-text,
        body.light-mode .campaign-pill.special .campaign-pill-text,
        body.light-mode .campaign-pill.sms-promotional .campaign-pill-text,
        body.light-mode .campaign-pill.sms-content .campaign-pill-text,
        body.light-mode .campaign-pill.sms-engagement .campaign-pill-text,
        body.light-mode .campaign-pill.sms-seasonal .campaign-pill-text {
            color: rgba(0, 0, 0, 0.95) !important;  /* Dark text for readability */
        }

        /* ====================================================================
           READING MODE - Optimized for Maximum Readability
           ==================================================================== */

        /* Base Reading Mode Styles */
        body.reading-mode {
            background: #ffffff;
            color: #1a1a1a;
            font-size: 15px;
            line-height: 1.6;
        }

        body.reading-mode .gradient-bg {
            background: #fafafa;
        }

        body.reading-mode .gradient-orbs {
            display: none;
        }

        /* Enhanced Typography */
        body.reading-mode h1,
        body.reading-mode h2,
        body.reading-mode h3 {
            color: #000000;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        body.reading-mode .gradient-text {
            background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Welcome section text readability in reading mode */
        body.reading-mode .welcome-section p {
            color: rgba(26, 26, 26, 0.9) !important;
        }

        body.reading-mode .welcome-section strong {
            color: #1a1a1a !important;
        }

        body.reading-mode .welcome-section div[style*="flex"] {
            color: rgba(26, 26, 26, 0.7) !important;
        }

        /* Glass Cards - High Contrast */
        body.reading-mode .glass-card {
            background: #ffffff;
            backdrop-filter: none;
            border: 2px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }

        body.reading-mode .glass-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        /* Stat Cards - Enhanced Visibility */
        body.reading-mode .stat-card {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        body.reading-mode .stat-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12);
            transform: translateY(-2px);
        }

        body.reading-mode .stat-value {
            color: #000000 !important;
            font-size: 2rem !important;
            font-weight: 800 !important;
        }

        body.reading-mode .stat-label {
            color: #6b7280 !important;
            font-weight: 600 !important;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        /* Calendar Grid - Maximum Clarity */
        body.reading-mode .calendar-grid {
            background: #ffffff;
            border: 2px solid #d1d5db;
        }

        body.reading-mode .calendar-header {
            color: #000000;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: #f9fafb;
            padding: 12px 8px;
        }

        body.reading-mode .calendar-day {
            background: #ffffff;
            border: 1.5px solid #e5e7eb;
            box-shadow: none;
            transition: all 0.2s ease;
        }

        body.reading-mode .calendar-day:hover {
            background: #f9fafb;
            border-color: #3b82f6;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.12);
        }

        body.reading-mode .calendar-day.today {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        body.reading-mode .day-number {
            color: #000000;
            font-weight: 700;
            font-size: 1.1rem;
        }

        body.reading-mode .calendar-day.today .day-number {
            color: #1e40af;
            font-weight: 800;
        }

        /* Campaign Pills - High Contrast Colors */
        body.reading-mode .campaign-pill {
            border: 1.5px solid #d1d5db !important;
            font-weight: 600 !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08) !important;
        }

        body.reading-mode .campaign-pill.promotional {
            background: #fee2e2 !important;
            color: #991b1b !important;
            border-color: #f87171 !important;
        }

        body.reading-mode .campaign-pill.content {
            background: #dbeafe !important;
            color: #1e40af !important;
            border-color: #60a5fa !important;
        }

        body.reading-mode .campaign-pill.engagement {
            background: #e0e7ff !important;
            color: #3730a3 !important;
            border-color: #818cf8 !important;
        }

        body.reading-mode .campaign-pill.seasonal {
            background: #d1fae5 !important;
            color: #065f46 !important;
            border-color: #34d399 !important;
        }

        body.reading-mode .campaign-pill.sms-promotional {
            background: #fed7aa !important;
            color: #92400e !important;
            border-color: #fb923c !important;
        }

        /* Week View Timeline - Visible Hour Lines */
        body.reading-mode .week-timeline-cell {
            border-top: 1px solid #d1d5db !important;  /* Visible hour lines */
            border-right: 1px solid #e5e7eb !important;
        }

        body.reading-mode .week-timeline-cell:hover {
            background: rgba(59, 130, 246, 0.05) !important;
        }

        body.reading-mode .week-timeline-hour {
            color: #4b5563 !important;  /* Darker hour labels for visibility */
            font-weight: 600 !important;
        }

        /* Buttons - Clear and Actionable */
        body.reading-mode .glow-button {
            background: #ffffff;
            color: #1f2937;
            border: 2px solid #d1d5db;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            font-weight: 600;
        }

        body.reading-mode .glow-button:hover {
            background: #f9fafb;
            border-color: #3b82f6;
            color: #1e40af;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        body.reading-mode .glow-button.primary {
            background: #3b82f6;
            color: #ffffff;
            border-color: #2563eb;
        }

        body.reading-mode .glow-button.primary:hover {
            background: #2563eb;
            border-color: #1d4ed8;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        /* Header - Clean and Professional */
        body.reading-mode header {
            background: #ffffff;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        /* Filter Pills - Enhanced Visibility */
        body.reading-mode .glass-card.p-3 {
            background: #f9fafb;
            border: 1.5px solid #d1d5db;
        }

        body.reading-mode .glass-card.p-3:hover,
        body.reading-mode .glass-card.ring-2 {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        /* Modals - High Contrast */
        body.reading-mode .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
        }

        body.reading-mode .modal-content {
            background: #ffffff;
            border: 2px solid #d1d5db;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15);
            color: #1a1a1a;
        }

        body.reading-mode .modal-content input,
        body.reading-mode .modal-content select,
        body.reading-mode .modal-content textarea {
            background: #ffffff;
            border: 2px solid #d1d5db;
            color: #1a1a1a;
        }

        body.reading-mode .modal-content input:focus,
        body.reading-mode .modal-content select:focus,
        body.reading-mode .modal-content textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Message Boxes - Ensure Visibility */
        body.reading-mode .ai-message,
        body.reading-mode .user-message {
            background: #f9fafb !important;
            border: 1.5px solid #d1d5db !important;
            color: #1a1a1a !important;
        }

        body.reading-mode .ai-message {
            border-left-color: #8b5cf6 !important;
            border-left-width: 3px !important;
        }

        body.reading-mode .user-message {
            border-left-color: #10b981 !important;
            border-left-width: 3px !important;
        }

        /* All modal text elements */
        body.reading-mode .modal-content h1,
        body.reading-mode .modal-content h2,
        body.reading-mode .modal-content h3,
        body.reading-mode .modal-content h4,
        body.reading-mode .modal-content p,
        body.reading-mode .modal-content div,
        body.reading-mode .modal-content span,
        body.reading-mode .modal-content label,
        body.reading-mode .modal-content button {
            color: #1a1a1a !important;
        }

        /* Text Colors - High Contrast */
        body.reading-mode .text-white,
        body.reading-mode .text-white\/60,
        body.reading-mode .text-white\/80,
        body.reading-mode .text-white\/90 {
            color: #1a1a1a !important;
        }

        body.reading-mode .text-white\/40 {
            color: #4b5563 !important;
        }

        /* Modal-specific text overrides for maximum contrast */
        body.reading-mode .modal-content label,
        body.reading-mode .modal-content .form-label {
            color: #111827 !important;
            font-weight: 600;
        }

        body.reading-mode .modal-content .text-sm,
        body.reading-mode .modal-content .text-xs {
            color: #1f2937 !important;
        }

        body.reading-mode .modal-content p,
        body.reading-mode .modal-content .file-upload-content p {
            color: #1a1a1a !important;
        }

        /* Borders - Enhanced Visibility */
        body.reading-mode [class*="border-white/"] {
            border-color: #d1d5db !important;
        }

        body.reading-mode .modal-content {
            border: 3px solid #9ca3af !important;
        }

        body.reading-mode .file-upload-area {
            border: 2px dashed #6b7280 !important;
            background: #f9fafb !important;
        }

        body.reading-mode .file-upload-area:hover {
            border-color: #3b82f6 !important;
            background: #eff6ff !important;
        }

        /* Grade Card */
        body.reading-mode .grade-card {
            background: #ffffff;
            border: 2px solid #fbbf24;
        }

        body.reading-mode .grade-card:hover {
            border-color: #f59e0b;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.25);
        }

        body.reading-mode .grade-card .stat-value,
        body.reading-mode .grade-card .stat-label {
            color: #000000 !important;
        }

        /* Holiday Toggle */
        body.reading-mode .holiday-toggle {
            background: #ffffff;
            border: 2px solid #10b981;
            color: #065f46;
        }

        body.reading-mode .holiday-toggle:hover {
            border-color: #059669;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }

        /* Loading States */
        body.reading-mode .loading-messages {
            color: #1a1a1a !important;
        }

        /* Ensure all text is readable */
        body.reading-mode p,
        body.reading-mode span,
        body.reading-mode div {
            color: inherit;
        }

        body.reading-mode .text-xs,
        body.reading-mode .text-sm {
            color: #1f2937 !important;
        }

        /* Form input backgrounds and borders */
        body.reading-mode .bg-white\/10,
        body.reading-mode .bg-white\/5 {
            background: #f3f4f6 !important;
            border: 1px solid #d1d5db !important;
        }

        /* ================================================== */
        /* Floating Action Button (FAB) & Command Menu Styles */
        /* ================================================== */

        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            border: none;
        }

        .fab:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
        }

        .fab:active {
            transform: translateY(-2px) scale(1.02);
        }

        .fab.has-changes {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 12px 32px rgba(249, 115, 22, 0.6);
            }
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.5);
            animation: bounce-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .command-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .command-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateX(4px);
        }

        .command-item:active {
            transform: translateX(2px) scale(0.98);
        }

        /* Reading mode overrides for command items */
        body.reading-mode .command-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
        }

        body.reading-mode .command-item:hover {
            background: #eff6ff;
            border-color: #3b82f6;
        }

        body.reading-mode .fab {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        body.reading-mode .fab:hover {
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.5);
        }

        /* ================================================== */
        /* Channel & Status Badge System */
        /* ================================================== */

        .channel-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: var(--text-tiny);
            font-weight: var(--font-semibold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .channel-badge.email {
            background: var(--channel-email-bg);
            color: var(--channel-email);
            border: 1px solid var(--channel-email);
        }

        .channel-badge.sms {
            background: var(--channel-sms-bg);
            color: var(--channel-sms);
            border: 1px solid var(--channel-sms);
        }

        .channel-badge.both {
            background: var(--channel-both-bg);
            color: var(--channel-both);
            border: 1px solid var(--channel-both);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: var(--text-tiny);
            font-weight: var(--font-semibold);
            text-transform: capitalize;
        }

        .status-badge.draft {
            background: var(--status-draft-bg);
            color: var(--status-draft);
            border: 1px solid var(--status-draft);
        }

        .status-badge.scheduled {
            background: var(--status-scheduled-bg);
            color: var(--status-scheduled);
            border: 1px solid var(--status-scheduled);
        }

        .status-badge.sent {
            background: var(--status-sent-bg);
            color: var(--status-sent);
            border: 1px solid var(--status-sent);
        }

        /* Reading mode badge overrides */
        body.reading-mode .channel-badge,
        body.reading-mode .status-badge {
            background: #ffffff;
            border-width: 2px;
        }

        /* ================================================== */
        /* Loading Skeletons */
        /* ================================================== */

        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.05) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0.05) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 16px;
            margin: 8px 0;
        }

        .skeleton-text.large {
            height: 24px;
        }

        .skeleton-pill {
            height: 44px;
            margin: 4px 0;
        }

        body.reading-mode .skeleton {
            background: linear-gradient(
                90deg,
                #e5e7eb 0%,
                #f3f4f6 50%,
                #e5e7eb 100%
            );
        }

        /* ================================================== */
        /* Button States - Enhanced Feedback */
        /* ================================================== */

        .glow-button {
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glow-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .glow-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .glow-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        .glow-button.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .glow-button.loading::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: button-spinner 0.6s linear infinite;
        }

        @keyframes button-spinner {
            to {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        /* ================================================== */
        /* Responsive Design - Mobile First */
        /* ================================================== */

        /* Tablet and below (< 1024px) */
        @media (max-width: 1023px) {
            :root {
                --text-hero: 28px;
                --text-section: 22px;
                --space-4: 24px;
                --space-6: 40px;
            }

            header {
                padding: var(--space-2) var(--space-3) !important;
            }

            header > div {
                flex-direction: column;
                align-items: flex-start !important;
                gap: var(--space-3) !important;
            }

            header nav {
                width: 100%;
                justify-content: flex-start !important;
            }

            main {
                padding: var(--space-3) var(--space-2) !important;
            }
        }

        /* Mobile (< 768px) */
        @media (max-width: 767px) {
            :root {
                --text-hero: 24px;
                --text-section: 20px;
                --text-subsection: 18px;
            }

            header nav {
                flex-wrap: wrap;
                gap: var(--space-1) !important;
            }

            header nav button {
                flex: 1 1 calc(50% - var(--space-1));
                min-width: 140px;
                justify-content: center;
            }

            .grid.grid-cols-1.md\\:grid-cols-5 {
                grid-template-columns: 1fr 1fr !important;
            }

            .calendar-day {
                min-height: 80px;
            }

            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
            }

            .modal-content {
                max-width: 95vw !important;
                margin: var(--space-2);
            }
        }

        /* Small Mobile (< 480px) */
        @media (max-width: 479px) {
            :root {
                --text-hero: 22px;
                --container-padding: var(--space-2);
            }

            header nav button {
                flex: 1 1 100%;
                width: 100%;
            }

            .grid.grid-cols-1.md\\:grid-cols-5 {
                grid-template-columns: 1fr !important;
            }

            h1.text-hero {
                font-size: 22px;
            }
        }

        /* ================================================== */
        /* Tooltip System */
        /* ================================================== */

        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: var(--text-small);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s, transform 0.2s;
            z-index: 10000;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .tooltip-wrapper:hover .tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-12px);
        }

        body.reading-mode .tooltip {
            background: #1f2937;
            border: 1px solid #374151;
        }

        body.reading-mode .tooltip::after {
            border-top-color: #1f2937;
        }

        /* ================================================== */
        /* Filter Chips System */
        /* ================================================== */

        .filter-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-1);
            padding: var(--space-2);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: var(--space-3);
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 999px;
            font-size: var(--text-small);
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            min-height: var(--touch-target);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
        }

        .filter-chip:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .filter-chip.active {
            background: linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-purple) 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 16px rgba(51, 105, 220, 0.4);
        }

        .filter-chip .check-icon {
            display: none;
            width: 16px;
            height: 16px;
        }

        .filter-chip.active .check-icon {
            display: block;
        }

        body.reading-mode .filter-chips-container {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
        }

        body.reading-mode .filter-chip {
            background: #ffffff;
            border-color: #d1d5db;
            color: #1f2937;
        }

        body.reading-mode .filter-chip:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        body.reading-mode .filter-chip.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #ffffff;
        }

        /* Reading Mode - Text Visibility Fixes */
        body.reading-mode .text-small {
            color: rgba(26, 26, 26, 0.8) !important;  /* Dark text for light bg */
        }

        body.reading-mode #searchInput {
            color: #1a1a1a !important;  /* Dark text for search input */
            background: #ffffff !important;
            border: 2px solid #d1d5db !important;
        }

        body.reading-mode #searchInput::placeholder {
            color: rgba(26, 26, 26, 0.5);
        }

        /* Reading Mode - Holiday Markers High Contrast */
        body.reading-mode .klaviyo-event-text {
            color: #1a1a1a !important;  /* Dark text on light bg */
            font-weight: 700 !important;
        }

        body.reading-mode .klaviyo-event.planning {
            background: rgba(138, 108, 247, 0.25) !important;
            border: 2px solid rgba(138, 108, 247, 0.8) !important;
            color: #5b21b6 !important;  /* Dark purple text */
        }

        body.reading-mode .klaviyo-event.planning .klaviyo-event-text {
            color: #5b21b6 !important;
        }

        body.reading-mode .klaviyo-event.campaign {
            background: rgba(34, 197, 94, 0.2) !important;
            border: 2px solid rgba(34, 197, 94, 0.7) !important;
            color: #166534 !important;  /* Dark green text */
        }

        body.reading-mode .klaviyo-event.campaign .klaviyo-event-text {
            color: #166534 !important;
        }

        body.reading-mode .klaviyo-event.review {
            background: rgba(251, 146, 60, 0.25) !important;
            border: 2px solid rgba(251, 146, 60, 0.8) !important;
            color: #9a3412 !important;  /* Dark orange text */
        }

        body.reading-mode .klaviyo-event.review .klaviyo-event-text {
            color: #9a3412 !important;
        }

        body.reading-mode .holiday-indicator {
            background: rgba(251, 191, 36, 0.2) !important;
            border: 2px solid rgba(251, 191, 36, 0.7) !important;
            color: #92400e !important;  /* Dark amber text */
            font-weight: 700 !important;
        }

        /* Reading Mode - Resend Campaign Borders */
        body.reading-mode .campaign-pill.is-resend {
            border: 2px dashed #d97706 !important;  /* Darker amber dashed border */
            border-left: 4px solid #d97706 !important;
            background: rgba(251, 191, 36, 0.15) !important;
        }

        /* Reading Mode - Grade Performance Card */
        body.reading-mode .grade-card {
            border: 2px solid #e5e7eb !important;  /* Match other stat cards */
        }

        body.reading-mode .grade-card .curiosity-badge {
            display: none !important;  /* Hide bouncing pill in reading mode */
        }

        body.reading-mode .stat-value,
        body.reading-mode .stat-label {
            color: #000000 !important;
        }

        /* Resend campaign styling */
        .campaign-pill.is-resend {
            border: 2px dashed #fbbf24 !important;  /* Amber dashed border all around */
            border-left: 4px solid #fbbf24 !important;  /* Solid left accent */
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05));
        }

        .resend-badge {
            background: #fbbf24;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-left: 4px;
        }

        /* NEW: Modified campaign badge for EmailPilot Simple workflow */
        .modified-badge {
            background: #3b82f6;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-left: 4px;
            cursor: help;
        }

        .modified-badge:hover {
            background: #2563eb;
        }

        .campaign-pill.is-modified {
            border-left: 4px solid #3b82f6 !important;
        }

        /* Campaign pill hover actions */
        .pill-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .campaign-pill:hover .pill-actions {
            opacity: 1;
        }

        .pill-action {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pill-action:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        /* Search input styling */
        #searchInput {
            transition: all 0.3s;
        }

        #searchInput:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Week view improvements */
        .week-timeline-container {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Better scrollbar */
        .week-timeline-container::-webkit-scrollbar {
            width: 8px;
        }

        .week-timeline-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .week-timeline-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .week-timeline-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Week navigation buttons */
        .week-nav-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Keyboard shortcuts help modal */
        .shortcuts-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2rem;
            z-index: 10000;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }

        .shortcuts-modal.show {
            display: block;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
            margin-top: 1rem;
        }

        .shortcut-key {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
        }

        /* Hide UI elements until client is selected */
        .requires-client {
            display: none !important;
        }

        .requires-client.client-selected {
            display: block !important;
        }

        /* Special case for flex containers */
        .requires-client.client-selected.flex {
            display: flex !important;
        }

        .requires-client.client-selected.grid {
            display: grid !important;
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="gradient-bg"></div>
    <div class="gradient-orbs">
        <div class="orb orb1"></div>
        <div class="orb orb2"></div>
        <div class="orb orb3"></div>
    </div>
    
    <!-- Header -->
    <header class="relative z-10 border-b border-white/10" style="padding: var(--space-3) var(--space-4);">
        <div style="max-width: var(--container-max); margin: 0 auto; display: flex; align-items: flex-start; justify-content: space-between; gap: var(--space-4); flex-wrap: wrap;">
            <div class="fade-in" style="flex-shrink: 0; display: flex; align-items: center; gap: var(--space-3);">
                <img src="https://storage.googleapis.com/msgsndr/TRirONHb88YKir68S63w/media/6918bebfa8777a48b1c68815.png" alt="EmailPilot Logo" style="height: 120px; width: auto; display: block;">
                <div>
                    <h1 class="text-hero" style="margin-bottom: var(--space-1);">
                        <span class="gradient-text">Campaign Co-Pilot</span>
                    </h1>
                    <p class="text-small" style="color: rgba(255, 255, 255, 0.7);">AI-Powered Campaign Planning</p>
                </div>
            </div>

            <div class="header-actions fade-in fade-in-delay-1">
                <nav style="display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; justify-content: flex-end;">
                    <button onclick="showClientModal()" class="glow-button select-client-welcome requires-client" id="selectClientBtn" style="min-height: var(--touch-target);">
                        <span style="margin-right: var(--space-1);">👤</span>
                        <span id="selectedClientName">Select Client</span>
                    </button>
                    <button onclick="generateWithAI()" class="glow-button primary requires-client" style="min-height: var(--touch-target);">
                        <span style="margin-right: var(--space-1);">✨</span>
                        <span>AI Calendar</span>
                    </button>
                    <button onclick="openMultiDayCampaignModal()" class="glow-button requires-client" style="min-height: var(--touch-target);">
                        <span style="margin-right: var(--space-1);">📅</span>
                        <span>Multi-Day</span>
                    </button>
                    <button onclick="openFileImportModal()" class="glow-button requires-client" style="min-height: var(--touch-target);">
                        <span style="margin-right: var(--space-1);">📥</span>
                        <span>Import</span>
                    </button>
                </nav>
            </div>
        </div>
        <!-- Toggle Pills Row - Below main header -->
        <div class="flex items-center gap-2 requires-client" style="max-width: var(--container-max); margin: var(--space-2) auto 0; padding: 0 var(--space-4);">
            <button id="strategyPill" onclick="toggleSection('strategy')" class="pill-toggle">
                <span class="text-orange-400">📋</span>
                <span>Strategy</span>
            </button>
            <button id="performancePill" onclick="toggleSection('performance')" class="pill-toggle">
                <span>📊</span>
                <span>Performance</span>
            </button>
            <button id="searchPill" onclick="toggleSection('search')" class="pill-toggle">
                <span>🔍</span>
                <span>Search</span>
            </button>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="relative z-10" style="padding: var(--space-4) var(--space-3);">
        <div style="max-width: var(--container-max); margin: 0 auto;">

            <!-- Welcome Message (shown before client selection) -->
            <div id="welcomeMessage" class="welcome-section fade-in" style="text-align: center; padding: var(--space-8) var(--space-4); margin-bottom: var(--space-6);">
                <img src="https://storage.googleapis.com/msgsndr/TRirONHb88YKir68S63w/media/6918bebfa8777a48b1c68815.png" alt="EmailPilot Logo" style="height: 180px; width: auto; margin: 0 auto var(--space-4) auto; display: block;">
                <h2 class="gradient-text" style="font-size: 2.5rem; font-weight: 900; margin-bottom: var(--space-3);">
                    Welcome to Campaign Co-Pilot
                </h2>
                <p style="font-size: 1.25rem; color: rgba(255, 255, 255, 0.8); max-width: 600px; margin: 0 auto var(--space-4) auto; line-height: 1.6;">
                    Your mission control center for precision message planning. Chart your course, navigate market conditions, and execute flawless campaigns with AI-powered flight assistance.
                </p>
                <button onclick="showClientModal()" class="glow-button select-client-welcome" style="min-height: var(--touch-target); font-size: 1.1rem; padding: var(--space-3) var(--space-6); margin: 0 auto var(--space-6) auto; display: block;">
                    <span style="margin-right: var(--space-2);">👤</span>
                    <span>SELECT CLIENT TO GET STARTED</span>
                </button>
                <div style="display: flex; gap: var(--space-3); justify-content: center; flex-wrap: wrap; color: rgba(255, 255, 255, 0.6); font-size: 0.875rem;">
                    <div style="display: flex; align-items: center; gap: var(--space-1);">
                        <span style="font-size: 1.25rem;">📅</span>
                        <span>Smart Calendar Planning</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-1);">
                        <span style="font-size: 1.25rem;">🤖</span>
                        <span>AI-Powered Insights</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-1);">
                        <span style="font-size: 1.25rem;">🔄</span>
                        <span>Real-Time Sync</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-1);">
                        <span style="font-size: 1.25rem;">📊</span>
                        <span>Performance Analytics</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-1);">
                        <span style="font-size: 1.25rem;">🎯</span>
                        <span>Goal Tracking</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-1);">
                        <span style="font-size: 1.25rem;">🗓️</span>
                        <span>Multi-View Calendar</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-1);">
                        <span style="font-size: 1.25rem;">✈️</span>
                        <span>Campaign Orchestration</span>
                    </div>
                </div>
            </div>

            <!-- Toggle Pills moved to header -->

            <!-- Search Panel (hidden by default) -->
            <div id="searchPanel" class="mb-3" style="display: none;">
                <div class="glass-card p-3">
                    <input type="text" id="campaignSearch" placeholder="Search campaigns..."
                           class="w-full bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-sm text-white placeholder-white/40 focus:outline-none focus:border-purple-500"
                           oninput="searchCampaigns(this.value)">
                </div>
            </div>

            <!-- Strategy Summary Panel (hidden by default) -->
            <div id="strategyPanel" class="mb-3" style="display: none;">
                <div class="glass-card p-4">
                    <div id="strategyContent" class="space-y-3 text-sm">
                        <!-- Strategy content will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Stats Row (Performance) - hidden by default, toggled by Performance pill -->
            <div id="statsRow" class="grid grid-cols-1 md:grid-cols-5 requires-client" style="display: none; gap: var(--space-3); margin-bottom: var(--space-4);">
                <div class="stat-card fade-in fade-in-delay-1">
                    <div class="stat-value" id="totalCampaigns">0</div>
                    <div class="stat-label">Total Campaigns</div>
                </div>
                <div class="stat-card fade-in fade-in-delay-2">
                    <div class="stat-value" id="expectedRevenue">$0</div>
                    <div class="stat-label">Expected Revenue</div>
                </div>
                <div class="stat-card fade-in fade-in-delay-3">
                    <div class="stat-value" id="avgOpenRate">0%</div>
                    <div class="stat-label">Avg Open Rate</div>
                </div>
                <div class="stat-card fade-in fade-in-delay-3">
                    <div class="stat-value" id="monthGoal">Loading...</div>
                    <div class="stat-label">Month Goal</div>
                </div>
                <!-- Grade Card -->
                <!-- Grade Performance - DISABLED for deployment - Backend functionality preserved -->
                <div class="stat-card fade-in fade-in-delay-4 grade-card needs-grading" style="cursor: not-allowed; position: relative; opacity: 0.4; pointer-events: none;" title="Coming soon - Feature in development">
                    <div class="curiosity-badge" id="curiosityBadge" style="background: linear-gradient(135deg, #6b7280, #9ca3af); color: white;">SOON</div>
                    <div class="hover-hint" id="gradeHoverHint" style="display: none;">Discover your score!</div>
                    <div class="grade-card-bg"></div>
                    <div class="stat-value grade-chip" id="gradeDisplay">
                        <span class="grade-icon" aria-hidden="true">🧑‍🏫</span>
                        <span>Grade</span>
                    </div>
                    <div class="stat-label" id="gradeLabel" style="position: relative; z-index: 10;">Performance</div>
                </div>
            </div>
            
            <!-- Client Change Requests (if any) -->
            <div id="changeRequestsSection" class="mb-6 hidden">
                <div class="glass-card p-4 border-l-4 border-yellow-500">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-yellow-400 mb-2">📝 Client Change Requests</h3>
                            <div id="changeRequestsList" class="space-y-2">
                                <!-- Change requests will be loaded here -->
                            </div>
                        </div>
                        <button onclick="dismissChangeRequests()" class="text-white/40 hover:text-white">✕</button>
                    </div>
                </div>
            </div>



            <!-- Campaign Types & Affinity Segments Legend -->
            <div class="mb-4 fade-in requires-client">
                <div id="campaignTypesContainer" class="flex flex-wrap gap-2">
                    <!-- Message Type Filters -->
                    <button onclick="toggleCampaignTypeFilter('email')" class="campaign-filter-pill active" data-filter="email">
                        <div class="w-3 h-3 rounded bg-blue-500"></div>
                        <span>Email</span>
                    </button>
                    <button onclick="toggleCampaignTypeFilter('sms')" class="campaign-filter-pill active" data-filter="sms">
                        <div class="w-3 h-3 rounded bg-green-500"></div>
                        <span>SMS</span>
                    </button>
                    <!-- Campaign Type Filters -->
                    <button onclick="toggleCampaignTypeFilter('promotional')" class="campaign-filter-pill active" data-filter="promotional">
                        <div class="w-3 h-3 rounded campaign-pill promotional"></div>
                        <span>Promotional</span>
                    </button>
                    <button onclick="toggleCampaignTypeFilter('content')" class="campaign-filter-pill active" data-filter="content">
                        <div class="w-3 h-3 rounded campaign-pill content"></div>
                        <span>Content</span>
                    </button>
                    <button onclick="toggleCampaignTypeFilter('resend')" class="campaign-filter-pill active" data-filter="resend">
                        <div class="w-3 h-3 rounded bg-amber-500"></div>
                        <span>Resend</span>
                    </button>
                    <!-- Affinity Segments (will be populated dynamically) -->
                    <div id="affinitySegments" class="contents">
                        <!-- Segments will be added here when client is selected -->
                    </div>
                </div>
            </div>

            <!-- Calendar Controls -->
            <div class="glass-card p-6 mb-8 fade-in requires-client">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <div class="flex items-center gap-4">
                            <button onclick="previousMonth()" class="glow-button">←</button>
                            <div>
                                <h2 class="text-3xl font-black text-white" id="currentMonth">August 2025</h2>
                                <!-- Approval Status (centered under month, more prominent) -->
                                <div id="approvalStatusBar" class="hidden mt-2 text-sm font-medium text-center">
                                    <span id="approvalStatusText"></span>
                                    <button id="unapproveBtn" onclick="unapproveCalendar()" class="ml-2 text-white/50 hover:text-red-400 transition-colors text-lg leading-none" title="Remove status">
                                        ×
                                    </button>
                                    <!-- Generate Briefs Button - Only shown when calendar is approved -->
                                    <button id="generateBriefsBtn" onclick="generateBriefs()" class="hidden ml-4 px-3 py-1 bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600 text-white text-xs font-bold rounded-full transition-all duration-200 shadow-lg hover:shadow-purple-500/25" title="Generate campaign briefs">
                                        📝 Generate Briefs
                                    </button>
                                </div>
                            </div>
                            <button onclick="nextMonth()" class="glow-button">→</button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="setView('month')" class="glow-button view-btn active" data-view="month">Month</button>
                        <button onclick="setView('week')" class="glow-button view-btn" data-view="week">Week</button>
                        <button onclick="setView('list')" class="glow-button view-btn" data-view="list">List</button>
                        <button onclick="toggleFullscreen()" class="glow-button" id="fullscreenBtn" title="Fullscreen">⛶</button>
                        <button onclick="saveToCloud()" class="glow-button primary">💾 Save</button>
                        <button onclick="undoLastChange()" class="glow-button" id="undoBtn" disabled title="Undo">↶</button>
                    </div>
                </div>
                
                <!-- Holiday Toggle Button -->
                <div class="holiday-toggle active" id="holidayToggle" onclick="toggleHolidays()" title="Hide Holidays">
                    🎄
                </div>
                
                <!-- Calendar Grid -->
                <div class="calendar-grid" id="calendarContainer">
                    <!-- Days of week headers -->
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>
                    
                    <!-- Calendar days will be generated here -->
                    <div id="calendarGrid"></div>
                </div>
            </div>

            <!-- AI Chat Interface -->
            <div id="aiChatSection" class="glass-card p-6 mb-8 requires-client" style="opacity: 1 !important; pointer-events: auto !important;">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-black gradient-text">Ask EmailPilot</h3>
                    <select id="llmSelector" class="glow-button bg-transparent border border-white/20 rounded-lg px-3 py-2">
                        <option value="openai">OpenAI GPT-4</option>
                        <option value="anthropic">Anthropic Claude</option>
                        <option value="google">Google Gemini</option>
                    </select>
                </div>
                
                <!-- Chat History -->
                <div id="chatHistory" class="bg-black/30 rounded-lg p-4 h-64 overflow-y-auto mb-4 space-y-3">
                    <div class="ai-message">
                        <div class="text-sm text-blue-400 mb-1">Ask EmailPilot</div>
                        <div class="text-white/90">Hello! I can help you manage your email campaigns. Try commands like:</div>
                        <ul class="text-white/70 text-sm mt-2 ml-4 list-disc">
                            <li>"Add a promotional campaign on the 15th"</li>
                            <li>"Move the newsletter from the 10th to the 12th"</li>
                            <li>"What campaigns are scheduled for next week?"</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Chat Input -->
                <div class="flex gap-3" style="position: relative; z-index: 500;">
                    <input 
                        type="text" 
                        id="chatInput" 
                        placeholder="Ask me anything about your campaigns..."
                        class="flex-1 bg-black/30 border border-white/20 rounded-lg px-4 py-3 text-white placeholder-white/50 focus:outline-none focus:border-lime-400/50 transition-colors"
                        style="pointer-events: auto !important; position: relative; z-index: 501; width: 100%;"
                        autocomplete="off"
                    >
                    <button onclick="sendChatMessage()" class="glow-button primary px-6" style="position: relative; z-index: 502;">Send</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Changes Panel - Hidden by default -->
    <div id="changesPanel" class="changes-panel" style="display: none;">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold gradient-text">📋 Pending Changes</h3>
            <button onclick="hideChangesPanel()" class="text-white/50 hover:text-white transition-colors">✕</button>
        </div>
        <div id="changesList" class="space-y-3">
            <!-- Changes will be populated here -->
        </div>
        <div class="mt-4 pt-4 border-t border-white/10 space-y-2">
            <button onclick="approveAllChanges()" class="glow-button primary w-full">✅ Approve All Changes</button>
            <button onclick="markAllChangesRead()" class="glow-button w-full">📋 Mark All as Read</button>
        </div>
    </div>
    
    <!-- Approval Celebration - Fixed Positioning -->
    <div id="celebrationOverlay" class="celebration-overlay">
        <div class="celebration-content">
            <div class="text-8xl mb-6 animate-bounce">🎉</div>
            <h1 class="text-5xl font-black gradient-text mb-4">APPROVED!</h1>
            <p class="text-xl text-white/90 mb-6">Your calendar has been approved!</p>
            <div class="text-sm text-white/70 mb-8">All changes have been successfully implemented</div>
            <button onclick="hideCelebration()" class="glow-button primary text-lg px-8 py-4">
                🎆 Continue to Calendar
            </button>
        </div>
        <!-- Animated fireworks -->
        <div class="fireworks" style="top: 10%; left: 20%">🎆</div>
        <div class="fireworks" style="top: 20%; right: 15%; animation-delay: 0.5s">✨</div>
        <div class="fireworks" style="top: 30%; left: 10%; animation-delay: 1s">🎇</div>
        <div class="fireworks" style="bottom: 30%; right: 20%; animation-delay: 1.5s">🎆</div>
        <div class="fireworks" style="bottom: 20%; left: 25%; animation-delay: 2s">✨</div>
        <div class="fireworks" style="top: 70%; right: 30%; animation-delay: 2.5s">🎆</div>
    </div>
    
    
    <!-- Loading Screen -->
    <div id="loadingScreen" class="modal-backdrop" style="display: none; z-index: 9999;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="mb-4" style="font-size: 64px;">✈️</div>
            <h3 class="text-2xl font-black gradient-text mb-4">Preparing for Takeoff!</h3>
            <div class="text-white/80 mb-4" id="loadingMessage">
                Pre-flight checks in progress...
            </div>
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-lime-400 border-t-transparent"></div>
        </div>
    </div>
    
    <!-- Client Selection Modal -->
    <div id="clientModal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-2xl font-black gradient-text mb-6">Select Client</h3>
            <div class="grid gap-3" id="clientList">
                <!-- Clients will be loaded here -->
            </div>
            <button onclick="closeClientModal()" class="glow-button w-full mt-6">Cancel</button>
        </div>
    </div>
    
    <!-- Context Input Modal -->
    <div id="contextModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    Provide Campaign Context
                </h2>
                <button onclick="closeContextModal()" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <p class="mb-4" style="color: rgba(255, 255, 255, 0.9);">
                    Do you have any important information about upcoming dates, events, or business priorities that should be considered for this calendar period?
                </p>
                <p class="text-sm mb-4" style="color: rgba(255, 255, 255, 0.6);">
                    For example: product launches, seasonal events, company milestones, industry events, or special promotions.
                </p>
                
                <textarea 
                    id="additionalContext" 
                    class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                    rows="6"
                    placeholder="Enter any relevant context here... (optional)"
                ></textarea>
            </div>
            
            <div class="modal-footer flex justify-end gap-3">
                <button onclick="closeContextModal()" class="btn-secondary">
                    Skip
                </button>
                <button onclick="submitContextAndGenerate()" class="btn-primary">
                    <i class="fas fa-sparkles mr-2"></i>
                    Continue & Generate
                </button>
            </div>
        </div>
    </div>
    
    <!-- Campaign Details Modal -->
    <div id="campaignModal" class="modal-backdrop">
        <div class="modal-content">
            <div id="campaignDetails">
                <!-- Campaign details will be loaded here -->
            </div>
            <button onclick="closeCampaignModal()" class="glow-button w-full mt-6">Close</button>
        </div>
    </div>
    
    <!-- Calendar Grading Modal -->
    <div id="gradingModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 800px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black gradient-text">Calendar Performance Grade</h2>
                <button onclick="closeGradingModal()" class="text-white/60 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div id="gradingResults">
                <!-- Grading results will be loaded here -->
            </div>
            
            <div class="flex gap-4 mt-6">
                <button onclick="applyGradeRecommendations()" class="glow-button primary flex-1">
                    <span style="margin-right: 8px;">✨</span> Apply AI Recommendations
                </button>
                <button onclick="closeGradingModal()" class="glow-button flex-1">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div id="createCampaignModal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-2xl font-black gradient-text mb-6">New Campaign</h3>
            <form id="campaignForm" onsubmit="createCampaign(event)">
                <div class="form-group">
                    <label class="form-label">Campaign Name</label>
                    <input type="text" id="campaignName" class="form-input" required placeholder="e.g. Summer Sale Newsletter">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Channel</label>
                        <select id="campaignChannel" class="form-select" required onchange="updateCampaignType()">
                            <option value="">Select Channel</option>
                            <option value="email">📧 Email</option>
                            <option value="sms">💬 SMS</option>
                            <option value="push">🔔 Push</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Message Type</label>
                        <select id="campaignMessageType" class="form-select" required onchange="updateCampaignType()">
                            <option value="">Select Type</option>
                            <option value="promotional">🎯 Promotional</option>
                            <option value="content">📰 Content</option>
                            <option value="resend">🔄 Resend</option>
                        </select>
                    </div>
                </div>

                <!-- Hidden field to store the combined campaign type -->
                <input type="hidden" id="campaignType" value="">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="campaignDate" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" id="campaignTime" class="form-input" value="10:00" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Subject Lines (comma separated)</label>
                    <textarea id="campaignSubjects" class="form-input" rows="3" placeholder="Black Friday Sale - 50% Off!, Last Chance - Sale Ends Tonight!"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Target Segment</label>
                    <select id="campaignSegment" class="form-select">
                        <option value="">All Subscribers</option>
                        <option value="engaged">Engaged Subscribers</option>
                        <option value="vip">VIP Customers</option>
                        <option value="new">New Subscribers</option>
                        <option value="lapsed">Win-Back Segment</option>
                    </select>
                </div>
                
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeCreateCampaignModal()" class="glow-button flex-1">Cancel</button>
                    <button type="submit" class="glow-button primary flex-1">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-backdrop">
        <div class="modal-content max-w-md">
            <h3 class="text-xl font-black gradient-text mb-4" id="confirmTitle">Confirm Action</h3>
            <p class="text-white/80 mb-6" id="confirmMessage">Are you sure you want to proceed?</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="glow-button flex-1">Cancel</button>
                <button onclick="confirmAction()" class="glow-button primary flex-1" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- File Import Modal -->
    <div id="fileImportModal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-2xl font-black gradient-text mb-6">Import Calendar File</h3>
            <div class="space-y-6">
                <div class="form-group">
                    <label class="form-label">Select File Type</label>
                    <select id="fileType" class="form-select" onchange="updateFileInputAccept()">
                        <option value="json">JSON (EmailPilot Format)</option>
                        <option value="csv">CSV (Spreadsheet)</option>
                        <option value="xlsx">Excel (.xlsx)</option>
                        <option value="ics">iCalendar (.ics)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Choose File</label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <input type="file" id="fileInput" class="file-input" accept=".json" onchange="handleFileSelect(event)">
                        <div class="file-upload-content">
                            <div class="text-4xl mb-3">📄</div>
                            <p class="text-lg font-semibold mb-2">Drop your file here or click to browse</p>
                            <p class="text-white/60 text-sm">Supported formats: JSON, CSV, Excel, iCalendar</p>
                        </div>
                    </div>
                    <div id="selectedFile" class="mt-3 hidden">
                        <div class="flex items-center gap-3 p-3 bg-white/10 rounded-lg">
                            <span class="text-2xl">📄</span>
                            <div class="flex-1">
                                <div class="font-semibold" id="fileName"></div>
                                <div class="text-sm text-white/60" id="fileSize"></div>
                            </div>
                            <button onclick="clearSelectedFile()" class="text-white/40 hover:text-white">✕</button>
                        </div>
                    </div>
                </div>
                
                <div id="csvPreview" class="form-group hidden">
                    <label class="form-label">Column Mapping (CSV/Excel)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-white/80">Campaign Name Column</label>
                            <select id="titleColumn" class="form-select text-sm"></select>
                        </div>
                        <div>
                            <label class="text-sm text-white/80">Date Column</label>
                            <select id="dateColumn" class="form-select text-sm"></select>
                        </div>
                        <div>
                            <label class="text-sm text-white/80">Campaign Type Column</label>
                            <select id="typeColumn" class="form-select text-sm"></select>
                        </div>
                        <div>
                            <label class="text-sm text-white/80">Description Column</label>
                            <select id="contentColumn" class="form-select text-sm"></select>
                        </div>
                    </div>
                </div>
                
                <div id="filePreview" class="hidden">
                    <label class="form-label">Preview</label>
                    <div class="bg-white/10 rounded-lg p-4 max-h-40 overflow-y-auto">
                        <div id="previewContent" class="text-sm font-mono"></div>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-8">
                    <button type="button" onclick="closeFileImportModal()" class="glow-button flex-1">Cancel</button>
                    <button type="button" onclick="processFileImport()" class="glow-button primary flex-1" id="importBtn" disabled>
                        <span class="mr-2">📥</span>Import Events
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Multi-Day Campaign Modal -->
    <div id="multiDayCampaignModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-2xl font-black gradient-text mb-6">Create Multi-Day Campaign</h3>
            <form id="multiDayCampaignForm" onsubmit="createMultiDayCampaign(event)">
                <div class="form-group">
                    <label class="form-label">Campaign Name</label>
                    <input type="text" id="multiDayName" class="form-input" required placeholder="e.g. Black Friday Week">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="multiDayStartDate" class="form-input" required onchange="updateMultiDayPreview()">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" id="multiDayEndDate" class="form-input" required onchange="updateMultiDayPreview()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Campaign Type</label>
                    <select id="multiDayType" class="form-input">
                        <option value="campaign">Standard Campaign</option>
                        <option value="promotional">Promotional Series</option>
                        <option value="seasonal">Seasonal Campaign</option>
                        <option value="special">Special Event</option>
                        <option value="nurture">Nurture Sequence</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea id="multiDayDescription" class="form-input" rows="3" placeholder="Campaign details, goals, or notes..."></textarea>
                </div>
                
                <div class="mt-4 p-3 bg-white/5 rounded-lg">
                    <div class="text-sm text-white/60 mb-1">Duration Preview:</div>
                    <div id="multiDayPreview" class="text-lg font-semibold">Select dates to see duration</div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="submit" class="glow-button primary flex-1">Create Campaign</button>
                    <button type="button" onclick="closeMultiDayCampaignModal()" class="glow-button flex-1">Cancel</button>
                </div>
            </form>

            <!-- JSON Import Section -->
            <div class="mt-6 pt-6 border-t border-white/10">
                <h4 class="text-lg font-semibold mb-3">Or Import from JSON</h4>
                <div class="form-group">
                    <label class="form-label">Paste JSON or Upload File</label>
                    <textarea id="multiDayJsonInput" class="form-input" rows="4" placeholder='[{"startDate": "2026-01-15", "endDate": "2026-01-20", "title": "New Year Sale", "type": "promotional", "description": "5-day promotion"}]'></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="importMultiDayJson()" class="glow-button primary flex-1">Import JSON</button>
                    <label class="glow-button flex-1 cursor-pointer text-center">
                        Upload File
                        <input type="file" accept=".json" onchange="uploadMultiDayJsonFile(event)" class="hidden">
                    </label>
                </div>
                <div class="mt-3 text-xs text-white/50">
                    Expected format: Array of events with date, title, type, description, send_time, segment
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Multi-Day Event Modal -->
    <div id="editMultiDayModal" class="modal-backdrop">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black gradient-text">Edit Multi-Day Event</h3>
                <button onclick="closeEditMultiDayModal()" class="text-white/40 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="editMultiDayForm" onsubmit="saveMultiDayEdit(event)">
                <input type="hidden" id="editMultiDayId">

                <div class="form-group">
                    <label class="form-label">Event Name</label>
                    <input type="text" id="editMultiDayName" class="form-input" required placeholder="e.g. Black Friday Week">
                </div>

                <div class="form-group">
                    <label class="form-label">Emoji</label>
                    <select id="editMultiDayEmoji" class="form-input">
                        <option value="📅">📅 Calendar</option>
                        <option value="🎉">🎉 Celebration</option>
                        <option value="🎄">🎄 Holiday</option>
                        <option value="🛍️">🛍️ Shopping</option>
                        <option value="💝">💝 Love</option>
                        <option value="🌟">🌟 Star</option>
                        <option value="🚀">🚀 Launch</option>
                        <option value="💰">💰 Sale</option>
                        <option value="🎁">🎁 Gift</option>
                        <option value="⏰">⏰ Reminder</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="editMultiDayStartDate" class="form-input" required onchange="updateEditMultiDayPreview()">
                    </div>

                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" id="editMultiDayEndDate" class="form-input" required onchange="updateEditMultiDayPreview()">
                    </div>
                </div>

                <div class="mt-2 p-3 bg-white/5 rounded-lg">
                    <div class="text-sm text-white/60 mb-1">Duration:</div>
                    <div id="editMultiDayPreview" class="text-lg font-semibold">-</div>
                </div>

                <div class="form-group mt-4">
                    <label class="form-label">Description (Optional)</label>
                    <textarea id="editMultiDayDescription" class="form-input" rows="3" placeholder="Event details, goals, or notes..."></textarea>
                </div>

                <div class="flex gap-3 mt-6">
                    <button type="button" onclick="confirmDeleteMultiDayEvent()" class="glow-button text-red-400 border-red-400/50">
                        Delete
                    </button>
                    <div class="flex-1"></div>
                    <button type="button" onclick="closeEditMultiDayModal()" class="glow-button">Cancel</button>
                    <button type="submit" class="glow-button primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Save Status Indicator -->
    <div id="saveStatus" class="save-status">
        <span id="saveStatusText">Saving...</span>
    </div>
    
    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <!-- AI Generation Processing Overlay -->
    <div id="aiGenerationOverlay" class="fixed inset-0 z-[9999] hidden" style="background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);">
        <div class="flex flex-col items-center justify-center h-full">
            <div class="text-center max-w-md px-6">
                <!-- Animated spinner -->
                <div class="mb-6">
                    <div class="inline-block w-16 h-16 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin"></div>
                </div>

                <!-- Main message -->
                <h3 id="aiOverlayTitle" class="text-2xl font-bold text-white mb-2">Generating Calendar with AI...</h3>

                <!-- Status message -->
                <p id="aiOverlayStatus" class="text-white/70 mb-4">Initializing workflow...</p>

                <!-- Progress stages -->
                <div id="aiOverlayStages" class="space-y-2 text-sm text-left">
                    <div class="flex items-center gap-2 text-white/50">
                        <span class="w-4">-</span>
                        <span>Analyzing client data</span>
                    </div>
                    <div class="flex items-center gap-2 text-white/50">
                        <span class="w-4">-</span>
                        <span>Generating campaign strategy</span>
                    </div>
                    <div class="flex items-center gap-2 text-white/50">
                        <span class="w-4">-</span>
                        <span>Creating calendar events</span>
                    </div>
                </div>

                <!-- Elapsed time -->
                <p id="aiOverlayTime" class="text-white/40 text-xs mt-4">Elapsed: 0s</p>

                <!-- Kill switch button -->
                <button onclick="terminateWorkflow()" class="mt-6 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors">
                    ⛔ Cancel Workflow
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // Simplified Fetch Wrapper (No Authentication Required)
        // ====================================================================

        // Simple wrapper function that just uses fetch directly
        async function authenticatedFetch(url, options = {}) {
            return fetch(url, options);
        }

        // ====================================================================
        // Firebase Initialization for Real-Time Sync
        // ====================================================================

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB0RrH7hbER2R-SzXfNmFe0O32HhH7HBEM",
            authDomain: "emailpilot-438321.firebaseapp.com",
            projectId: "emailpilot-438321",
            storageBucket: "emailpilot-438321.appspot.com",
            messagingSenderId: "104067375141",
            appId: "1:104067375141:web:2b65c86eec8e8c8b4c9f3a"
        };

        // Initialize Firebase app
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        console.log('🔥 Firebase initialized for real-time sync');

        // ====================================================================
        // Theme Cycling System - Dark → Light → Reading Mode
        // ====================================================================

        // Get saved theme or default to dark
        let currentTheme = localStorage.getItem('calendarTheme') || 'dark';

        function updateStudioThemeChip(theme) {
            const button = document.getElementById('studioThemeButton');
            const icon = document.getElementById('studioThemeIcon');
            const title = document.getElementById('studioThemeTitle');
            const subtitle = document.getElementById('studioThemeSubtitle');
            if (!button) return;

            const isSunrise = (theme === 'light' || theme === 'reading');
            button.setAttribute('aria-pressed', isSunrise ? 'true' : 'false');
            if (icon) icon.textContent = isSunrise ? '🌅' : '🌙';
            if (title) title.textContent = isSunrise ? 'Sunrise' : 'Midnight';
            if (subtitle) subtitle.textContent = isSunrise ? 'Studio lights on' : 'Studio lights off';
        }

        // Apply theme on page load
        function applyTheme(theme) {
            const body = document.body;
            const fabThemeIcon = document.getElementById('fabThemeIcon');

            // Remove all theme classes
            body.classList.remove('light-mode', 'reading-mode', 'sunrise-theme', 'midnight-theme');

            // Apply appropriate theme
            if (theme === 'light') {
                body.classList.add('light-mode', 'sunrise-theme');
                if (fabThemeIcon) fabThemeIcon.textContent = '☀️';
            } else if (theme === 'reading') {
                body.classList.add('reading-mode', 'sunrise-theme');
                if (fabThemeIcon) fabThemeIcon.textContent = '📖';
            } else {
                // dark mode (default)
                body.classList.add('midnight-theme');
                if (fabThemeIcon) fabThemeIcon.textContent = '🌙';
            }

            updateStudioThemeChip(theme);
        }

        // Cycle through themes
        function cycleTheme() {
            const themes = ['dark', 'light', 'reading'];
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            currentTheme = themes[nextIndex];

            // Save preference
            localStorage.setItem('calendarTheme', currentTheme);

            // Apply theme
            applyTheme(currentTheme);

            // Show toast notification
            const themeNames = {
                'dark': '🌙 Dark Mode',
                'light': '☀️ Light Mode',
                'reading': '📖 Reading Mode - Optimized for clarity'
            };

            if (typeof showToast === 'function') {
                showToast(`Switched to ${themeNames[currentTheme]}`, 'info');
            }
        }

        // Apply saved theme on page load
        document.addEventListener('DOMContentLoaded', async () => {
            applyTheme(currentTheme);

            const studioButton = document.getElementById('studioThemeButton');
            if (studioButton) {
                studioButton.addEventListener('click', () => {
                    const nextTheme = (currentTheme === 'light' || currentTheme === 'reading') ? 'dark' : 'light';
                    currentTheme = nextTheme;
                    localStorage.setItem('calendarTheme', currentTheme);
                    applyTheme(currentTheme);
                    if (typeof showToast === 'function') {
                        const copy = nextTheme === 'light' ? '☀️ Sunrise mode activated' : '🌙 Midnight mode activated';
                        showToast(copy, 'info');
                    }
                });
            }
        });

        // Also apply immediately (before DOMContentLoaded)
        applyTheme(currentTheme);

        // ====================================================================
        // Time Format Utilities
        // ====================================================================

        // Convert 24H time to 12H format (e.g., "14:00" -> "2:00 PM")
        function formatTime12H(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const hours12 = hours % 12 || 12;
            return `${hours12}:${String(minutes).padStart(2, '0')} ${period}`;
        }

        // Convert 12H time to 24H format (e.g., "2:00 PM" -> "14:00")
        function convertTo24Hour(time) {
            if (!time) return '10:00';
            // Already in 24H format if no AM/PM
            if (!/am|pm/i.test(time)) return time;

            const parts = time.trim().match(/(\d+):(\d+)\s*(AM|PM)/i);
            if (!parts) return '10:00';

            let hours = parseInt(parts[1]);
            const minutes = parts[2];
            const period = parts[3].toUpperCase();

            if (period === 'PM' && hours !== 12) hours += 12;
            if (period === 'AM' && hours === 12) hours = 0;

            return `${String(hours).padStart(2, '0')}:${minutes}`;
        }

        // ====================================================================
        // Calendar Manager Class
        // ====================================================================

        class CalendarManager {
            constructor() {
                this.campaigns = [];
                this.multiDayCampaigns = []; // New: Store multi-day campaigns
                this.clients = [];
                this.selectedClient = null;
                this.selectedDate = new Date();
                this.currentMonthGoal = 50000; // Default fallback value
                this.currentView = 'month';
                this.undoStack = [];
                this.chatHistory = [];
                this.selectedDay = null;
                this.pendingAction = null;
                this.holidays = {};  // Store holidays by date
                this.klaviyoEvents = {};  // Store Klaviyo events by date
                this.activeSeasons = [];  // Current e-commerce seasons
                this.showHolidays = true;  // Admin-only flag
                this.affinitySegments = [];
                this.lastSyncCheck = 0;
                this.draggedCampaignId = null;
                this.autoSaveTimeout = null;
                // Firestore real-time sync
                this.firestoreUnsubscribe = null;  // Firestore listener unsubscribe function
                this.initialLoadComplete = false;  // Flag to skip initial snapshot
                // Filtering state
                this.activeFilters = {
                    segments: [],  // Array of active segment names
                    channels: []   // Array of active channels ('email', 'sms')
                };
            }
            
            async loadClients() {
                // Show loading screen with aviation messages
                const loadingScreen = document.getElementById('loadingScreen');
                const loadingMessage = document.getElementById('loadingMessage');
                const messages = [
                    "Pre-flight checks in progress... 🛫",
                    "Fueling up the email engines... ⛽",
                    "Calibrating campaign altitude... 📐",
                    "Checking wind conditions for optimal delivery... 🌬️",
                    "Loading passenger manifest (your clients)... 📋",
                    "Tower, we're ready for departure... 🗼"
                ];
                
                loadingScreen.style.display = 'flex';
                let messageIndex = 0;
                
                // Rotate through messages
                const messageInterval = setInterval(() => {
                    messageIndex = (messageIndex + 1) % messages.length;
                    loadingMessage.textContent = messages[messageIndex];
                }, 2000);
                
                try {
                    // Fetch from production API - source of truth for client data
                    const clientsUrl = 'https://emailpilot.ai/api/clients';
                    const response = await fetch(clientsUrl);
                    if (response.ok) {
                        const clients = await response.json();

                        // Flatten asana_project_link from metadata to top level for calendar compatibility
                        clients.forEach(client => {
                            if (client.metadata && client.metadata.asana_project_link) {
                                client.asana_project_link = client.metadata.asana_project_link;
                            }
                        });

                        // Show all clients from shared library
                        this.clients = clients;
                        this.renderClientList();
                        showToast(`✈️ Cleared for landing with ${this.clients.length} clients`);
                    } else {
                        // Fallback to demo clients
                        this.clients = [
                            { id: 'demo-1', name: 'Demo Company', client_slug: 'demo' },
                            { id: 'demo-2', name: 'Test Brand', client_slug: 'test' }
                        ];
                        this.renderClientList();
                        showToast('Using demo flight plan (demo clients)');
                    }
                } catch (error) {
                    console.error('Failed to load clients:', error);
                    showToast('⚠️ Turbulence detected - using backup flight plan', 'warning');
                } finally {
                    // Hide loading screen
                    clearInterval(messageInterval);
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }
            }
            
            renderClientList() {
                const list = document.getElementById('clientList');
                list.innerHTML = this.clients.map(client => `
                    <button onclick="calendarManager.selectClient('${client.slug || client.id}')" class="glass-card p-4 text-left hover:border-purple-500/50 transition-all">
                        <div class="font-bold">${client.name}</div>
                        <div class="text-sm text-white/50">${client.slug || client.client_slug || 'N/A'}</div>
                    </button>
                `).join('');
            }
            
            selectClient(clientId) {
                // Find client by slug, id, or name
                this.selectedClient = this.clients.find(c =>
                    c.slug === clientId ||
                    c.id === clientId ||
                    c.name === clientId
                );

                if (!this.selectedClient) {
                    showToast('Client not found', 'error');
                    console.error('Client not found with ID:', clientId);
                    return;
                }

                // Ensure client has an identifier for API calls
                if (!this.selectedClient.id && !this.selectedClient.slug) {
                    this.selectedClient.id = this.selectedClient.slug || this.selectedClient.name;
                }

                console.log('Selected client:', this.selectedClient);
                document.getElementById('selectedClientName').textContent = this.selectedClient.name;
                closeClientModal();

                // Stop any existing polling first
                this.stopSyncPolling();

                // Load existing calendar data for this client
                this.loadFromCloud();
                // Check approval status
                checkApprovalStatus();
                // Check for any pending changes for this client
                setTimeout(() => {
                    checkForChanges();
                }, 500);
                showToast(`Selected ${this.selectedClient.name}`);
                
                // Load client's affinity segments
                this.loadAffinitySegments();
                
                // Check for change requests from this client
                this.loadChangeRequests();
                
                // Check for changes and notifications
                setTimeout(() => checkForChanges(), 1000);
                
                // Re-enable Ask EmailPilot now that a client is selected
                const chatInput = document.getElementById('chatInput');
                const chatHistory = document.getElementById('chatHistory');
                
                if (chatInput) {
                    chatInput.disabled = false;
                    chatInput.placeholder = 'Ask me anything about your calendar...';
                }
                
                if (chatHistory && !chatHistory.querySelector('.user-message')) {
                    // Only replace if no conversation has started
                    chatHistory.innerHTML = `
                        <div class="ai-message">
                            <div class="text-sm text-blue-400 mb-1">Ask EmailPilot</div>
                            <div class="text-white/90">Hello! I'm ready to help you manage ${this.selectedClient.name}'s campaigns. Try commands like:</div>
                            <ul class="text-white/70 text-sm mt-2 ml-4 list-disc">
                                <li>"Add a promotional campaign on the 15th"</li>
                                <li>"Move the newsletter from the 10th to the 12th"</li>
                                <li>"What campaigns are scheduled for next week?"</li>
                                <li>"Generate a month of campaigns"</li>
                                <li>"Clear all campaigns"</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Load existing calendar data
                this.loadFromCloud();

                // Show UI elements now that a client is selected
                document.querySelectorAll('.requires-client').forEach(el => {
                    el.classList.add('client-selected');
                });

                // Remove welcome pulse animation from Select Client button
                const selectClientBtn = document.getElementById('selectClientBtn');
                if (selectClientBtn) {
                    selectClientBtn.classList.remove('select-client-welcome');
                }

                // Hide welcome message
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (welcomeMessage) {
                    welcomeMessage.style.display = 'none';
                }

                // Save selected client to localStorage
                localStorage.setItem('lastSelectedClient', clientId);
                localStorage.setItem('lastSelectedClientName', this.selectedClient.name);

                // Start multi-user sync polling (5 second interval)
                this.startSyncPolling();
            }
            
            // Load change requests for the selected client
            async loadChangeRequests() {
                if (!this.selectedClient) return;

                try {
                    // Build approval ID to match what we're looking for
                    const year = this.selectedDate.getFullYear();
                    const month = String(this.selectedDate.getMonth() + 1).padStart(2, '0');
                    const approvalIdPrefix = `${this.selectedClient.client_slug || this.selectedClient.id}-${year}-${month}`;

                    const response = await authenticatedFetch(`/api/calendar/change-requests/${approvalIdPrefix}`);

                    // Silently skip if endpoint doesn't exist or returns an error
                    if (!response.ok) {
                        console.debug('Change requests service not available');
                        const section = document.getElementById('changeRequestsSection');
                        if (section) {
                            section.classList.add('hidden');
                        }
                        return;
                    }

                    const result = await response.json();
                    if (result.change_requests && result.change_requests.length > 0) {
                        this.displayChangeRequests(result.change_requests);
                    } else {
                        const section = document.getElementById('changeRequestsSection');
                        if (section) {
                            section.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    // Silently skip change requests if service not available
                    console.debug('Change requests service not available:', error.message);
                    const section = document.getElementById('changeRequestsSection');
                    if (section) {
                        section.classList.add('hidden');
                    }
                }
            }
            
            // Display change requests with task checkboxes
            displayChangeRequests(requests) {
                const section = document.getElementById('changeRequestsSection');
                const list = document.getElementById('changeRequestsList');
                
                if (!requests || requests.length === 0) {
                    section.classList.add('hidden');
                    // Update badges to show no requests
                    this.updateChangeRequestBadges(0);
                    return;
                }
                
                section.classList.remove('hidden');
                
                // Count tasks that need attention
                let totalTasks = 0;
                requests.forEach(r => {
                    if (r.tasks && r.tasks.length > 0) {
                        totalTasks += r.tasks.filter(t => t.status !== 'completed').length;
                    }
                });
                
                // Update notification badges with real count
                this.updateChangeRequestBadges(totalTasks || requests.length);
                
                // Sort by most recent first
                requests.sort((a, b) => new Date(b.requested_at) - new Date(a.requested_at));
                
                list.innerHTML = requests.map(request => {
                    const date = new Date(request.requested_at);
                    const dateStr = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const tasksHtml = request.tasks.map((task, index) => {
                        // Check if task was previously marked complete in localStorage
                        const taskKey = `task_${request.id}_${index}`;
                        const storedStatus = localStorage.getItem(taskKey);
                        const isCompleted = storedStatus === 'completed' || (storedStatus === null && task.status === 'completed');
                        
                        return `
                            <div class="flex items-start gap-2 ml-4 mt-1">
                                <input type="checkbox" 
                                       id="task-${request.id}-${index}"
                                       data-request-id="${request.id}"
                                       data-task-index="${index}"
                                       ${isCompleted ? 'checked' : ''}
                                       onchange="window.updateTaskStatus('${request.id}', ${index}, this.checked)"
                                       class="mt-1">
                                <label for="task-${request.id}-${index}" 
                                       class="text-sm text-white/70 ${isCompleted ? 'line-through opacity-50' : ''}">
                                    ${this.getTaskIcon(task.type)} ${task.description}
                                </label>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="border-b border-white/10 pb-3 mb-3 last:border-0">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-semibold text-white/90">
                                    ${request.client_name || 'Client'}
                                </div>
                                <div class="text-xs text-white/50">${dateStr}</div>
                            </div>
                            <div class="text-sm text-white/60 mb-2">${request.change_request}</div>
                            ${tasksHtml ? '<div class="space-y-1">' + tasksHtml + '</div>' : ''}
                        </div>
                    `;
                }).join('');
                
                // Add a "Mark All Complete" button if there are pending tasks
                const hasPendingTasks = requests.some(r => 
                    r.tasks.some(t => t.status !== 'completed')
                );
                
                if (hasPendingTasks) {
                    list.innerHTML += `
                        <div class="mt-3 pt-3 border-t border-white/10">
                            <button onclick="window.markAllTasksComplete()" class="text-sm text-green-400 hover:text-green-300">
                                ✓ Mark All Complete
                            </button>
                        </div>
                    `;
                }
            }
            
            getTaskIcon(type) {
                const icons = {
                    'move': '↔️',
                    'add': '➕',
                    'remove': '❌',
                    'update': '✏️',
                    'general': '📌'
                };
                return icons[type] || '📌';
            }
            
            // Update notification badges with change request count
            updateChangeRequestBadges(count) {
                const fabBadge = document.getElementById('fabNotificationBadge');
                const commandFab = document.getElementById('commandFab');
                
                if (count > 0) {
                    // Show badge
                    if (fabBadge) {
                        fabBadge.style.display = 'block';
                        fabBadge.textContent = count;
                    }
                    if (commandFab) {
                        commandFab.classList.add('has-changes');
                    }
                } else {
                    // Hide badge
                    if (fabBadge) fabBadge.style.display = 'none';
                    if (commandFab) commandFab.classList.remove('has-changes');
                }
            }
            
            loadAffinitySegments() {
                // Extract affinity segments from the selected client
                this.affinitySegments = [];

                if (this.selectedClient) {
                    const segmentColors = [
                        'linear-gradient(135deg, #FFD700, #FFA500)', // Gold
                        'linear-gradient(135deg, #4169E1, #1E90FF)', // Blue
                        'linear-gradient(135deg, #32CD32, #90EE90)'  // Green
                    ];

                    const segmentEmojis = ['⭐', '💎', '🆕'];

                    // First check for metadata.affinity_segments array (preferred)
                    const metadata = this.selectedClient.metadata || {};
                    if (metadata.affinity_segments && Array.isArray(metadata.affinity_segments) && metadata.affinity_segments.length > 0) {
                        metadata.affinity_segments.forEach((seg, index) => {
                            if (seg.name && seg.name.trim() !== '') {
                                this.affinitySegments.push({
                                    id: `segment_${index + 1}`,
                                    name: seg.name,
                                    emoji: segmentEmojis[index] || '📊',
                                    color: segmentColors[index] || segmentColors[0],
                                    definition: seg.description || ''
                                });
                            }
                        });
                    }

                    // Fallback: check for individual affinity_segment_X_name fields (in metadata or top-level)
                    if (this.affinitySegments.length === 0) {
                        for (let i = 1; i <= 3; i++) {
                            const segmentName = metadata[`affinity_segment_${i}_name`] || this.selectedClient[`affinity_segment_${i}_name`];
                            if (segmentName && segmentName.trim() !== '') {
                                this.affinitySegments.push({
                                    id: `segment_${i}`,
                                    name: segmentName,
                                    emoji: segmentEmojis[i - 1],
                                    color: segmentColors[i - 1],
                                    definition: metadata[`affinity_segment_${i}_definition`] || this.selectedClient[`affinity_segment_${i}_definition`] || ''
                                });
                            }
                        }
                    }

                    // If still no segments found, use defaults
                    if (this.affinitySegments.length === 0) {
                        this.affinitySegments = [
                            { id: 'vip', name: 'VIP Customers', emoji: '⭐', color: segmentColors[0] },
                            { id: 'regular', name: 'Regular Buyers', emoji: '💎', color: segmentColors[1] },
                            { id: 'new', name: 'New Subscribers', emoji: '🆕', color: segmentColors[2] }
                        ];
                    }

                    console.log('📊 Loaded affinity segments:', this.affinitySegments.map(s => s.name));
                }
                
                // Update the segments display with filtering
                const segmentsDiv = document.getElementById('affinitySegments');
                if (segmentsDiv) {
                    // Add only affinity segment pills (channel filters are at the top)
                    const segmentPills = this.affinitySegments.map(seg => `
                        <div class="glass-card p-3 flex-1 min-w-[140px] cursor-pointer hover:ring-2 hover:ring-purple-500 transition-all ${this.activeFilters.segments.includes(seg.name) ? 'ring-2 ring-purple-500 bg-purple-500/20' : ''}"
                             onclick="calendarManager.toggleSegmentFilter('${seg.name.replace(/'/g, "\\'")}')"
                             title="${seg.definition || seg.name} (Click to filter)">
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-4 h-4 rounded" style="background: ${seg.color};"></div>
                                <span class="text-xs font-semibold">${seg.emoji || ''} ${seg.name}</span>
                            </div>
                        </div>
                    `).join('');

                    segmentsDiv.innerHTML = segmentPills;
                }
                
                // Also update the target segment dropdown in the create campaign modal
                const segmentSelect = document.getElementById('campaignSegment');
                if (segmentSelect) {
                    const defaultOptions = `
                        <option value="">Select target segment...</option>
                        <option value="all">All Subscribers</option>
                    `;
                    const segmentOptions = this.affinitySegments.map(seg => 
                        `<option value="${seg.id}">${seg.emoji || ''} ${seg.name}</option>`
                    ).join('');
                    segmentSelect.innerHTML = defaultOptions + segmentOptions;
                }
            }
            
            // REMOVED: Duplicate loadFromCloud method - using the one at line 2883 instead
            
            async generateWithAI(additionalContext = '') {
                if (!this.selectedClient) {
                    showToast('Please select a client first', 'warning');
                    return;
                }

                showToast('Triggering AI Calendar workflow...', 'info');

                try {
                    // Calculate start and end dates for the selected month
                    const year = this.selectedDate.getFullYear();
                    const month = this.selectedDate.getMonth();
                    const startDate = new Date(year, month, 1).toISOString().slice(0, 10);
                    const endDate = new Date(year, month + 1, 0).toISOString().slice(0, 10);

                    // Build userInstructions combining additionalContext and multi-day events
                    let userInstructions = '';

                    // Add additionalContext if provided
                    if (additionalContext && additionalContext.trim()) {
                        userInstructions += additionalContext.trim();
                    }

                    // Add multi-day events information
                    if (this.multiDayCampaigns && this.multiDayCampaigns.length > 0) {
                        // Filter multi-day events that overlap with the selected month
                        const monthStart = new Date(year, month, 1);
                        const monthEnd = new Date(year, month + 1, 0);

                        const relevantMultiDayEvents = this.multiDayCampaigns.filter(event => {
                            const parseLocalDate = (dateStr) => {
                                if (dateStr instanceof Date) return new Date(dateStr);
                                const parts = dateStr.split('-');
                                return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                            };
                            const eventStart = parseLocalDate(event.startDate);
                            const eventEnd = parseLocalDate(event.endDate);
                            return eventStart <= monthEnd && eventEnd >= monthStart;
                        });

                        if (relevantMultiDayEvents.length > 0) {
                            if (userInstructions) {
                                userInstructions += '\n\n';
                            }
                            userInstructions += '--- Multi-Day Events/Reminders ---\n';
                            relevantMultiDayEvents.forEach(event => {
                                userInstructions += `• ${event.name} (${event.startDate} to ${event.endDate})`;
                                if (event.description) {
                                    userInstructions += `: ${event.description}`;
                                }
                                userInstructions += '\n';
                            });
                        }
                    }

                    const response = await authenticatedFetch('/api/calendar/workflow/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_name: this.selectedClient.client_slug || this.selectedClient.name,
                            start_date: startDate,
                            end_date: endDate,
                            stage: 'full',
                            userInstructions: userInstructions || null
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            const jobId = result.data.job_id;
                            const workflowId = result.data.workflow_id;
                            showToast(`Workflow started! Job: ${jobId}. Calendar will import automatically.`, 'success');

                            // Store workflow info for status checking
                            this.currentWorkflowId = workflowId;
                            this.currentJobId = jobId;

                            // Note: The workflow will push to /api/calendar/import when ready
                            // User can refresh or the app can poll for completion
                        } else {
                            showToast('Workflow started but response format unexpected', 'warning');
                        }
                    } else {
                        const error = await response.json();
                        showToast(`Workflow failed: ${error.detail || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    console.error('AI generation failed:', error);
                    showToast(`Connection error: ${error.message}`, 'error');
                }
            }
            
            generateDemoCampaigns() {
                const types = [
                    { type: 'promotional', name: 'Flash Sale', gradient: 'promotional' },
                    { type: 'content', name: 'Newsletter', gradient: 'content' },
                    { type: 'engagement', name: 'Survey', gradient: 'engagement' },
                    { type: 'seasonal', name: 'Holiday Special', gradient: 'seasonal' }
                ];
                
                const campaigns = [];
                for (let i = 0; i < 12; i++) {
                    const type = types[i % types.length];
                    const day = Math.floor(Math.random() * 28) + 1;
                    
                    campaigns.push({
                        id: `demo-${i}`,
                        name: type.name,
                        type: type.type,
                        date: new Date(this.selectedDate.getFullYear(), this.selectedDate.getMonth(), day),
                        gradient: type.gradient,
                        metrics: {
                            openRate: 0.2 + Math.random() * 0.2,
                            clickRate: 0.02 + Math.random() * 0.08,
                            revenue: 3000 + Math.random() * 15000
                        }
                    });
                }
                
                this.processCampaigns(campaigns);
                showToast('Generated demo campaigns', 'info');
            }
            
            processCampaigns(campaigns) {
                this.campaigns = campaigns.map(c => ({
                    ...c,
                    date: new Date(c.date),
                    gradient: c.color_gradient || c.gradient || this.getTypeGradient(c.type)
                }));
                this.renderCalendar();
                this.updateStats();
            }
            
            getTypeGradient(type) {
                const gradients = {
                    promotional: 'promotional',
                    content: 'content',
                    engagement: 'engagement',
                    seasonal: 'seasonal',
                    special: 'special',
                    custom: 'special',
                    mixed: 'content'
                };
                return gradients[type] || 'content';
            }
            
            getChannelGradient(type, channel) {
                // SMS campaigns get different shades
                if (channel === 'sms') {
                    const smsGradients = {
                        promotional: 'sms-promotional',
                        content: 'sms-content',
                        engagement: 'sms-engagement',
                        seasonal: 'sms-seasonal',
                        special: 'sms-special',
                        custom: 'sms-special',
                        mixed: 'sms-content'
                    };
                    return smsGradients[type] || 'sms-content';
                }
                // Email campaigns use default gradients
                return this.getTypeGradient(type);
            }
            
            renderCalendar() {
                const container = document.getElementById('calendarContainer');
                if (!container) {
                    console.error('Calendar container not found');
                    return;
                }
                
                // Clear and rebuild the calendar structure
                container.className = 'calendar-grid';
                container.innerHTML = `
                    <div class="calendar-header">Sun</div>
                    <div class="calendar-header">Mon</div>
                    <div class="calendar-header">Tue</div>
                    <div class="calendar-header">Wed</div>
                    <div class="calendar-header">Thu</div>
                    <div class="calendar-header">Fri</div>
                    <div class="calendar-header">Sat</div>
                `;
                
                const year = this.selectedDate.getFullYear();
                const month = this.selectedDate.getMonth();
                
                // PERMANENT FIX: Use local time consistently to avoid timezone issues
                const firstDayOfMonth = new Date(year, month, 1);
                const firstDay = firstDayOfMonth.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                
                // Verify August 2025 specifically (August 1, 2025 is a Friday = day 5)
                if (month === 7 && year === 2025) {
                    console.log(`August 2025: First day calculation = ${firstDay}, should be 5 (Friday)`);
                    // The calculation should already be correct now
                }
                
                // Debug logging for date verification
                console.log(`Rendering ${year}-${month + 1}: First day (${firstDayOfMonth.toDateString()}) is ${['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][firstDay]}`);

                // Add previous month's trailing days (instead of empty cells)
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevMonthYear = month === 0 ? year - 1 : year;
                const daysInPrevMonth = new Date(prevMonthYear, prevMonth + 1, 0).getDate();

                for (let i = firstDay - 1; i >= 0; i--) {
                    const prevDay = daysInPrevMonth - i;
                    const prevDate = new Date(prevMonthYear, prevMonth, prevDay);
                    const dayCampaigns = this.getCampaignsForDate(prevDate);

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day opacity-50 other-month';
                    dayDiv.dataset.day = prevDay;
                    dayDiv.dataset.month = prevMonth;
                    dayDiv.dataset.year = prevMonthYear;
                    dayDiv.ondragover = (e) => this.handleDragOver(e);
                    dayDiv.ondrop = (e) => this.handleDropAdjacentMonth(e, prevDate);
                    dayDiv.onclick = (e) => {
                        if (e.target === dayDiv || e.target.classList.contains('day-number')) {
                            this.openCreateCampaignModalForDate(prevDate);
                        }
                    };

                    // Get multi-day events for previous month date
                    const prevMultiDayHtml = this.renderMultiDayEventsForDate(prevDate);

                    dayDiv.innerHTML = `
                        <div class="day-number text-white/40">${prevDay}</div>
                        <div class="add-btn opacity-50" onclick="event.stopPropagation(); calendarManager.openCreateCampaignModalForDate(new Date(${prevMonthYear}, ${prevMonth}, ${prevDay}))">+</div>
                        ${prevMultiDayHtml}
                        <div class="space-y-1">
                            ${dayCampaigns}
                        </div>
                    `;

                    // Add drag handlers to all child elements programmatically
                    const children = dayDiv.querySelectorAll('.day-number, .add-btn, .space-y-1');
                    children.forEach(child => {
                        child.ondragover = (e) => this.handleDragOver(e);
                        child.ondrop = (e) => this.handleDropAdjacentMonth(e, prevDate);
                    });

                    container.appendChild(dayDiv);
                }

                // Add days of current month
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    const isToday = currentDate.toDateString() === today.toDateString();
                    const dayCampaigns = this.getCampaignsForDay(day);
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = `calendar-day ${isToday ? 'today' : ''}`;
                    dayDiv.dataset.day = day;
                    dayDiv.ondragover = (e) => this.handleDragOver(e);
                    dayDiv.ondrop = (e) => this.handleDrop(e, day);
                    dayDiv.onclick = (e) => {
                        if (e.target === dayDiv || e.target.classList.contains('day-number')) {
                            this.openCreateCampaignModal(day);
                        }
                    };
                    // Get holidays and events for this day
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayHolidays = this.holidays[dateStr] || [];
                    const dayKlaviyoEvents = this.klaviyoEvents[dateStr] || [];
                    
                    // Check for active seasons
                    let seasonClass = '';
                    if (this.activeSeasons && this.activeSeasons.length > 0) {
                        const highestIntensity = this.activeSeasons.reduce((max, season) => {
                            if (season.intensity === 'critical') return 'critical';
                            if (season.intensity === 'high' && max !== 'critical') return 'high';
                            if (season.intensity === 'medium' && max === '') return 'medium';
                            return max;
                        }, '');
                        if (highestIntensity) {
                            seasonClass = `<div class="season-indicator ${highestIntensity}"></div>`;
                        }
                    }
                    
                    // Get multi-day events for this date
                    const multiDayEventsHtml = this.renderMultiDayEventsForDate(currentDate);

                    dayDiv.innerHTML = `
                        ${seasonClass}
                        <div class="day-number">${day}</div>
                        <div class="add-btn" onclick="event.stopPropagation(); calendarManager.openCreateCampaignModal(${day})">+</div>
                        ${this.showHolidays ? `
                            <div class="calendar-day-header">
                                ${dayHolidays.map(h => `
                                    <div class="holiday-indicator ${h.category}" title="${h.name}">
                                        <span>${h.emoji || '📅'}</span>
                                        <span class="holiday-indicator-text">${h.name}</span>
                                    </div>
                                `).join('')}
                                ${dayKlaviyoEvents.map(e => `
                                    <div class="klaviyo-event ${e.category}" title="${e.name}">
                                        <span>${e.emoji || '📋'}</span>
                                        <span class="klaviyo-event-text">${e.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="calendar-day-header"></div>'}
                        ${multiDayEventsHtml}
                        <div class="space-y-1">
                            ${dayCampaigns}
                        </div>
                    `;

                    container.appendChild(dayDiv);
                }

                // Add next month's leading days to fill the grid
                const totalCellsRendered = firstDay + daysInMonth;
                const cellsNeeded = Math.ceil(totalCellsRendered / 7) * 7; // Round up to complete weeks
                const nextMonthDays = cellsNeeded - totalCellsRendered;

                const nextMonth = month === 11 ? 0 : month + 1;
                const nextMonthYear = month === 11 ? year + 1 : year;

                for (let day = 1; day <= nextMonthDays; day++) {
                    const nextDate = new Date(nextMonthYear, nextMonth, day);
                    const dayCampaigns = this.getCampaignsForDate(nextDate);

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day opacity-50 other-month';
                    dayDiv.dataset.day = day;
                    dayDiv.dataset.month = nextMonth;
                    dayDiv.dataset.year = nextMonthYear;
                    dayDiv.ondragover = (e) => this.handleDragOver(e);
                    dayDiv.ondrop = (e) => this.handleDropAdjacentMonth(e, nextDate);
                    dayDiv.onclick = (e) => {
                        if (e.target === dayDiv || e.target.classList.contains('day-number')) {
                            this.openCreateCampaignModalForDate(nextDate);
                        }
                    };

                    // Get multi-day events for next month date
                    const nextMultiDayHtml = this.renderMultiDayEventsForDate(nextDate);

                    dayDiv.innerHTML = `
                        <div class="day-number text-white/40">${day}</div>
                        <div class="add-btn opacity-50" onclick="event.stopPropagation(); calendarManager.openCreateCampaignModalForDate(new Date(${nextMonthYear}, ${nextMonth}, ${day}))">+</div>
                        ${nextMultiDayHtml}
                        <div class="space-y-1">
                            ${dayCampaigns}
                        </div>
                    `;

                    // Add drag handlers to all child elements programmatically
                    const children = dayDiv.querySelectorAll('.day-number, .add-btn, .space-y-1');
                    console.log(`📌 Attaching handlers to ${children.length} children for next month day ${day}, date:`, nextDate);
                    children.forEach((child, idx) => {
                        child.ondragover = (e) => {
                            console.log(`🔵 DRAGOVER on next month child ${idx} for day ${day}`);
                            return this.handleDragOver(e);
                        };
                        child.ondrop = (e) => {
                            console.log(`🟢 DROP on next month child ${idx} for day ${day}, target date:`, nextDate);
                            return this.handleDropAdjacentMonth(e, nextDate);
                        };
                    });

                    container.appendChild(dayDiv);
                }

                // Render multi-day spanning events after all day cells are in place
                this.renderMultiDaySpanningEvents(container, year, month, firstDay, daysInMonth);
            }

            renderMultiDayBars(container, year, month, firstDay, daysInMonth) {
                // Remove any existing bar container
                const existingBars = container.querySelector('.multi-day-bars-overlay');
                if (existingBars) existingBars.remove();

                if (!this.multiDayCampaigns || this.multiDayCampaigns.length === 0) return;

                // Create overlay container for bars
                const barsOverlay = document.createElement('div');
                barsOverlay.className = 'multi-day-bars-overlay';
                barsOverlay.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 10;';

                // Get all day cells for position calculation
                const dayCells = container.querySelectorAll('.calendar-day');
                if (dayCells.length === 0) return;

                // Make container relative for absolute positioning
                container.style.position = 'relative';

                // Calculate cell dimensions after render
                setTimeout(() => {
                    const firstCell = dayCells[0];
                    const containerRect = container.getBoundingClientRect();

                    // Track vertical slots used per row to stack multiple events
                    const rowSlots = {};

                    this.multiDayCampaigns.forEach(campaign => {
                        const startDate = new Date(campaign.startDate);
                        const endDate = new Date(campaign.endDate);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(0, 0, 0, 0);

                        // Process each week the event spans
                        let currentDate = new Date(startDate);

                        while (currentDate <= endDate) {
                            // Find the cell index for this date
                            const cellIndex = this.getCellIndexForDate(currentDate, year, month, firstDay, daysInMonth);
                            if (cellIndex === -1) {
                                currentDate.setDate(currentDate.getDate() + 1);
                                continue;
                            }

                            // Calculate which row this cell is in
                            const row = Math.floor(cellIndex / 7);

                            // Find start and end of this segment (within this week row)
                            const rowStartCell = row * 7;
                            const rowEndCell = rowStartCell + 6;

                            // Segment start: either event start or beginning of row
                            let segmentStartIndex = cellIndex;
                            let segmentStartDate = new Date(currentDate);

                            // Segment end: either event end or end of row
                            let segmentEndDate = new Date(Math.min(endDate.getTime(), this.getDateForCellIndex(rowEndCell, year, month, firstDay, daysInMonth).getTime()));
                            let segmentEndIndex = this.getCellIndexForDate(segmentEndDate, year, month, firstDay, daysInMonth);

                            if (segmentEndIndex === -1) segmentEndIndex = rowEndCell;

                            // Get or create slot tracker for this row
                            if (!rowSlots[row]) rowSlots[row] = [];

                            // Find available slot
                            let slot = 0;
                            while (rowSlots[row][slot] && rowSlots[row][slot] > segmentStartIndex) {
                                slot++;
                            }
                            rowSlots[row][slot] = segmentEndIndex + 1;

                            // Get actual cell positions from DOM
                            const startCell = dayCells[segmentStartIndex];
                            const endCell = dayCells[segmentEndIndex];

                            if (!startCell || !endCell) {
                                currentDate.setDate(currentDate.getDate() + 1);
                                continue;
                            }

                            const startRect = startCell.getBoundingClientRect();
                            const endRect = endCell.getBoundingClientRect();

                            // Calculate position relative to container
                            const left = startRect.left - containerRect.left + 2;
                            const width = (endRect.right - startRect.left) - 4;
                            // Position 42px from top of cell (below day number and holidays, above campaign cards)
                            const top = startRect.top - containerRect.top + 42 + (slot * 24);

                            // Determine if bar continues from/to adjacent weeks
                            const continuesLeft = segmentStartDate > startDate;
                            const continuesRight = segmentEndDate < endDate;

                            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                            // Create bar element
                            const bar = document.createElement('div');
                            bar.className = `multi-day-bar ${continuesLeft ? 'continues-left' : ''} ${continuesRight ? 'continues-right' : ''}`;
                            bar.style.cssText = `left: ${left}px; width: ${width}px; top: ${top}px;`;
                            bar.onclick = () => showMultiDayCampaignDetails(campaign.id);
                            bar.title = `${campaign.name} (${duration} days)`;
                            bar.innerHTML = `
                                <span class="multi-day-bar-icon">${campaign.emoji || '📅'}</span>
                                <span class="multi-day-bar-text">${continuesLeft ? '' : campaign.name}</span>
                            `;

                            barsOverlay.appendChild(bar);

                            // Move to next week
                            currentDate = new Date(segmentEndDate);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    });

                    container.appendChild(barsOverlay);
                }, 0);
            }

            getCellIndexForDate(date, year, month, firstDay, daysInMonth) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);

                // Check if in previous month
                if (d.getMonth() < month || (d.getMonth() === 11 && month === 0 && d.getFullYear() < year)) {
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevYear = month === 0 ? year - 1 : year;
                    if (d.getMonth() === prevMonth && d.getFullYear() === prevYear) {
                        const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();
                        const dayOfPrevMonth = d.getDate();
                        const cellIndex = firstDay - (daysInPrevMonth - dayOfPrevMonth) - 1;
                        return cellIndex >= 0 ? cellIndex : -1;
                    }
                    return -1;
                }

                // Check if in current month
                if (d.getMonth() === month && d.getFullYear() === year) {
                    return firstDay + d.getDate() - 1;
                }

                // Check if in next month
                const nextMonth = month === 11 ? 0 : month + 1;
                const nextYear = month === 11 ? year + 1 : year;
                if (d.getMonth() === nextMonth && d.getFullYear() === nextYear) {
                    return firstDay + daysInMonth + d.getDate() - 1;
                }

                return -1;
            }

            getDateForCellIndex(cellIndex, year, month, firstDay, daysInMonth) {
                if (cellIndex < firstDay) {
                    // Previous month
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevYear = month === 0 ? year - 1 : year;
                    const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();
                    const day = daysInPrevMonth - (firstDay - cellIndex - 1);
                    return new Date(prevYear, prevMonth, day);
                } else if (cellIndex < firstDay + daysInMonth) {
                    // Current month
                    return new Date(year, month, cellIndex - firstDay + 1);
                } else {
                    // Next month
                    const nextMonth = month === 11 ? 0 : month + 1;
                    const nextYear = month === 11 ? year + 1 : year;
                    const day = cellIndex - firstDay - daysInMonth + 1;
                    return new Date(nextYear, nextMonth, day);
                }
            }

            getMultiDayCampaignsForDay(day) {
                // This method is no longer used for rendering but kept for compatibility
                return '';
            }
            
            getCampaignsForDay(day) {
                const year = this.selectedDate.getFullYear();
                const month = this.selectedDate.getMonth();
                let campaigns = this.campaigns.filter(c => {
                    return c.date.getFullYear() === year &&
                           c.date.getMonth() === month &&
                           c.date.getDate() === day;
                });

                // Apply search filter
                if (window.searchQuery && window.searchQuery.trim() !== '') {
                    const query = window.searchQuery.toLowerCase();
                    campaigns = campaigns.filter(c => {
                        return (c.name && c.name.toLowerCase().includes(query)) ||
                               (c.type && c.type.toLowerCase().includes(query)) ||
                               (c.segment && c.segment.toLowerCase().includes(query)) ||
                               (c.description && c.description.toLowerCase().includes(query));
                    });
                }

                // Apply channel filters
                if (this.activeFilters.channels.length > 0) {
                    campaigns = campaigns.filter(c => {
                        return this.activeFilters.channels.includes(c.channel || 'email');
                    });
                }

                // Apply segment filters
                if (this.activeFilters.segments.length > 0) {
                    campaigns = campaigns.filter(c => {
                        const campaignSegments = c.segments || c.segment || c.audience || [];
                        const segmentList = Array.isArray(campaignSegments) ? campaignSegments : [campaignSegments];

                        // Check if campaign has any of the active filter segments
                        return this.activeFilters.segments.some(filterSeg =>
                            segmentList.some(campSeg =>
                                campSeg && campSeg.toLowerCase().includes(filterSeg.toLowerCase())
                            )
                        );
                    });
                }

                // Apply campaign filters (both channel AND type)
                campaigns = campaigns.filter(c => {
                    // Check if campaign's type (promotional/content) is enabled
                    // Default to true for unknown types to prevent filtering out valid campaigns
                    const typeMatch = campaignTypeFilters[c.type] !== false;

                    // Check if campaign's channel (email/sms/push) is enabled
                    const channel = c.channel || 'email';
                    const channelMatch = campaignTypeFilters[channel];

                    // Comprehensive resend check (matches rendering logic in line ~6081)
                    const isResend = c.is_resend || c.type === 'resend' || c.campaignMessageType === 'Resend' || (c.name && c.name.toLowerCase().includes('resend'));
                    const resendMatch = isResend ? campaignTypeFilters['resend'] : true;

                    // Campaign must match type AND channel AND resend filter
                    return typeMatch && channelMatch && resendMatch;
                });

                return campaigns.map(c => {
                    // Get channel-specific emoji
                    let channelEmoji = '📧'; // Default email
                    if (c.channel === 'sms') {
                        channelEmoji = '📱';
                    } else if (c.channel === 'push') {
                        channelEmoji = '💻';
                    } else if (c.emoji) {
                        channelEmoji = c.emoji;
                    }

                    // Get audience/segments to display - filter out channel labels only (keep ALL)
                    const segments = c.segments || c.segment || c.audience || [];
                    const segmentsList = Array.isArray(segments) ? segments : [segments];
                    const excludeLabels = ['email', 'sms', 'push', 'EMAIL', 'SMS', 'PUSH'];
                    const audienceList = segmentsList
                        .filter(s => s && !excludeLabels.includes(s))
                        .map(s => {
                            // Capitalize first letter of each word for display
                            return s.split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                .join(' ');
                        });

                    // Determine if this is the only campaign for the day (for expanded view)
                    const isSingleEvent = campaigns.length === 1;

                    // Check if this is a resend campaign (comprehensive check)
                    const isResend = c.is_resend || c.type === 'resend' || c.campaignMessageType === 'Resend' || c.name.toLowerCase().includes('resend');

                    // NEW: Check if campaign was modified
                    const isModified = c.modified === true;
                    const modifiedBadgeTitle = isModified && c.modified_fields?.length > 0
                        ? `Edited: ${c.modified_fields.join(', ')}`
                        : '';

                    return `
                    <div class="campaign-pill ${c.gradient || c.type} ${isResend ? "is-resend" : ""} ${isSingleEvent ? 'expanded-pill' : ''} ${isModified ? 'is-modified' : ''}"
                         draggable="true"
                         ondragstart="calendarManager.handleDragStart(event, '${c.id}')"
                         ondragend="calendarManager.handleDragEnd(event)"
                         onclick="showCampaignDetails('${c.id}')"
                         title="${c.name}${isModified ? ' (Modified)' : ''}">
                        <span class="campaign-pill-text">
                            ${channelEmoji} ${c.name}${isResend ? " <span class=\'resend-badge\'>↻ RESEND</span>" : ""}${isModified ? ` <span class='modified-badge' title='${modifiedBadgeTitle}'>✏️ EDITED</span>` : ""}
                        </span>
                        ${audienceList.length > 0 ? `
                        <div class="campaign-pill-meta">
                            ${audienceList.map(aud => `<span class="campaign-pill-meta-badge">🎯 ${aud}</span>`).join('')}
                        </div>
                        ` : ''}
                        ${isSingleEvent && c.description ? `<div class="campaign-pill-description">${c.description}</div>` : ''}
                        <div class="pill-actions">
                            <div class="pill-action" onclick="event.stopPropagation(); duplicateCampaign('${c.id}')" title="Duplicate">📋</div>
                            <div class="pill-action" onclick="event.stopPropagation(); calendarManager.resendCampaign('${c.id}')" title="Resend (Next Day)">📮</div>
                            <div class="pill-action" onclick="event.stopPropagation(); editCampaign('${c.id}')" title="Edit">✏️</div>
                            <div class="pill-action" onclick="event.stopPropagation(); confirmDeleteCampaign('${c.id}')" title="Delete">🗑️</div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            // Get campaigns for a specific date (used for adjacent month dates)
            getCampaignsForDate(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();

                let campaigns = this.campaigns.filter(c => {
                    return c.date.getFullYear() === year &&
                           c.date.getMonth() === month &&
                           c.date.getDate() === day;
                });

                // Apply the same filters as getCampaignsForDay
                if (window.searchQuery && window.searchQuery.trim() !== '') {
                    const query = window.searchQuery.toLowerCase();
                    campaigns = campaigns.filter(c => {
                        return (c.name && c.name.toLowerCase().includes(query)) ||
                               (c.type && c.type.toLowerCase().includes(query)) ||
                               (c.segment && c.segment.toLowerCase().includes(query)) ||
                               (c.description && c.description.toLowerCase().includes(query));
                    });
                }

                if (this.activeFilters.channels.length > 0) {
                    campaigns = campaigns.filter(c => {
                        return this.activeFilters.channels.includes(c.channel || 'email');
                    });
                }

                if (this.activeFilters.segments.length > 0) {
                    campaigns = campaigns.filter(c => {
                        const campaignSegments = c.segments || c.segment || c.audience || [];
                        const segmentList = Array.isArray(campaignSegments) ? campaignSegments : [campaignSegments];
                        return this.activeFilters.segments.some(filterSeg =>
                            segmentList.some(campSeg =>
                                campSeg && campSeg.toLowerCase().includes(filterSeg.toLowerCase())
                            )
                        );
                    });
                }

                campaigns = campaigns.filter(c => {
                    // Default to true for unknown types to prevent filtering out valid campaigns
                    const typeMatch = campaignTypeFilters[c.type] !== false;
                    const channel = c.channel || 'email';
                    const channelMatch = campaignTypeFilters[channel];
                    // Comprehensive resend check (matches main getCampaignsForDay logic)
                    const isResend = c.is_resend || c.type === 'resend' || c.campaignMessageType === 'Resend' || (c.name && c.name.toLowerCase().includes('resend'));
                    const resendMatch = isResend ? campaignTypeFilters['resend'] : true;
                    return typeMatch && channelMatch && resendMatch;
                });

                return campaigns.map(c => {
                    let channelEmoji = '📧';
                    if (c.channel === 'sms') channelEmoji = '📱';
                    else if (c.channel === 'push') channelEmoji = '💻';
                    else if (c.emoji) channelEmoji = c.emoji;

                    const isResend = c.is_resend || c.type === 'resend' || c.campaignMessageType === 'Resend' || (c.name && c.name.toLowerCase().includes('resend'));

                    return `
                    <div class="campaign-pill ${c.gradient || c.type} ${isResend ? "is-resend" : ""}"
                         draggable="true"
                         ondragstart="calendarManager.handleDragStart(event, '${c.id}')"
                         ondragend="calendarManager.handleDragEnd(event)"
                         onclick="showCampaignDetails('${c.id}')"
                         title="${c.name}">
                        <span class="campaign-pill-text">
                            ${channelEmoji} ${c.name}${isResend ? " <span class='resend-badge'>↻</span>" : ""}
                        </span>
                    </div>
                    `;
                }).join('');
            }

            // Get multi-day campaigns that span a specific date
            getMultiDayCampaignsForDate(date) {
                if (!this.multiDayCampaigns || this.multiDayCampaigns.length === 0) {
                    return [];
                }

                const checkDate = new Date(date);
                checkDate.setHours(0, 0, 0, 0);

                return this.multiDayCampaigns
                    .filter(campaign => {
                        const startDate = new Date(campaign.startDate);
                        const endDate = new Date(campaign.endDate);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(0, 0, 0, 0);
                        return checkDate >= startDate && checkDate <= endDate;
                    })
                    .map(campaign => {
                        const startDate = new Date(campaign.startDate);
                        const endDate = new Date(campaign.endDate);
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(0, 0, 0, 0);

                        const isStart = checkDate.getTime() === startDate.getTime();
                        const isEnd = checkDate.getTime() === endDate.getTime();
                        const isMiddle = !isStart && !isEnd;

                        // Calculate duration in days
                        const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

                        return {
                            ...campaign,
                            isStart,
                            isMiddle,
                            isEnd,
                            duration
                        };
                    });
            }

            // Render multi-day events HTML for a specific date (legacy - returns empty)
            renderMultiDayEventsForDate(date) {
                // Multi-day events are now rendered in spanning rows, not per-day
                return '';
            }

            // Get all weeks in the current month view
            getWeeksInMonthView(year, month, firstDay, daysInMonth) {
                const weeks = [];
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevMonthYear = month === 0 ? year - 1 : year;
                const daysInPrevMonth = new Date(prevMonthYear, prevMonth + 1, 0).getDate();

                // Total cells in the grid
                const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;

                for (let weekStart = 0; weekStart < totalCells; weekStart += 7) {
                    const weekDates = [];
                    for (let i = 0; i < 7; i++) {
                        const cellIndex = weekStart + i;
                        let date;

                        if (cellIndex < firstDay) {
                            // Previous month
                            const day = daysInPrevMonth - (firstDay - cellIndex - 1);
                            date = new Date(prevMonthYear, prevMonth, day);
                        } else if (cellIndex - firstDay < daysInMonth) {
                            // Current month
                            const day = cellIndex - firstDay + 1;
                            date = new Date(year, month, day);
                        } else {
                            // Next month
                            const nextMonth = month === 11 ? 0 : month + 1;
                            const nextMonthYear = month === 11 ? year + 1 : year;
                            const day = cellIndex - firstDay - daysInMonth + 1;
                            date = new Date(nextMonthYear, nextMonth, day);
                        }
                        weekDates.push(date);
                    }
                    weeks.push({
                        startDate: weekDates[0],
                        endDate: weekDates[6],
                        dates: weekDates
                    });
                }

                return weeks;
            }

            // Get multi-day events that overlap a specific week
            getMultiDayEventsForWeek(weekStart, weekEnd) {
                if (!this.multiDayCampaigns || this.multiDayCampaigns.length === 0) {
                    return [];
                }

                const weekStartTime = new Date(weekStart).setHours(0, 0, 0, 0);
                const weekEndTime = new Date(weekEnd).setHours(23, 59, 59, 999);

                // Parse dates as local time to avoid UTC timezone shift
                const parseLocalDate = (dateStr) => {
                    if (dateStr instanceof Date) return new Date(dateStr);
                    const parts = dateStr.split('-');
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                };

                return this.multiDayCampaigns.filter(campaign => {
                    const eventStart = parseLocalDate(campaign.startDate).setHours(0, 0, 0, 0);
                    const eventEnd = parseLocalDate(campaign.endDate).setHours(23, 59, 59, 999);

                    // Event overlaps with week if it starts before week ends and ends after week starts
                    return eventStart <= weekEndTime && eventEnd >= weekStartTime;
                }).map(campaign => {
                    // Parse dates as local time to avoid UTC timezone shift
                    // "2026-01-01" should be Jan 1st local, not Dec 31st UTC
                    const parseLocalDate = (dateStr) => {
                        if (dateStr instanceof Date) return new Date(dateStr);
                        const parts = dateStr.split('-');
                        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    };

                    const eventStart = parseLocalDate(campaign.startDate);
                    const eventEnd = parseLocalDate(campaign.endDate);
                    eventStart.setHours(0, 0, 0, 0);
                    eventEnd.setHours(0, 0, 0, 0);

                    // Calculate segment boundaries within this week
                    const segmentStart = new Date(Math.max(eventStart.getTime(), weekStartTime));
                    const segmentEnd = new Date(Math.min(eventEnd.getTime(), weekEndTime));

                    // Calculate day indices (0-6 for Sun-Sat)
                    const startCol = Math.round((segmentStart - weekStart) / (1000 * 60 * 60 * 24));
                    const endCol = Math.round((segmentEnd - weekStart) / (1000 * 60 * 60 * 24));

                    // Calculate total duration
                    const duration = Math.ceil((eventEnd - eventStart) / (1000 * 60 * 60 * 24)) + 1;

                    return {
                        ...campaign,
                        segmentStart,
                        segmentEnd,
                        startCol: Math.max(0, startCol),
                        endCol: Math.min(6, endCol),
                        duration,
                        continuesLeft: eventStart < segmentStart,
                        continuesRight: eventEnd > segmentEnd
                    };
                });
            }

            // Assign events to rows to avoid overlaps
            assignEventsToRows(events) {
                const rows = [];

                // Sort events by start column, then by duration (longer first)
                events.sort((a, b) => {
                    if (a.startCol !== b.startCol) return a.startCol - b.startCol;
                    return b.duration - a.duration;
                });

                events.forEach(event => {
                    // Find a row where this event fits
                    let placed = false;
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const canPlace = !row.some(existing =>
                            !(event.endCol < existing.startCol || event.startCol > existing.endCol)
                        );
                        if (canPlace) {
                            row.push(event);
                            placed = true;
                            break;
                        }
                    }
                    if (!placed) {
                        rows.push([event]);
                    }
                });

                return rows;
            }

            // Render spanning multi-day events for a week
            renderMultiDaySpanningEvents(container, year, month, firstDay, daysInMonth) {
                if (!this.multiDayCampaigns || this.multiDayCampaigns.length === 0) {
                    return;
                }

                const weeks = this.getWeeksInMonthView(year, month, firstDay, daysInMonth);
                const dayCells = container.querySelectorAll('.calendar-day');

                weeks.forEach((week, weekIndex) => {
                    const weekEvents = this.getMultiDayEventsForWeek(week.startDate, week.endDate);
                    if (weekEvents.length === 0) return;

                    const eventRows = this.assignEventsToRows(weekEvents);

                    // Create wrapper for scrolling
                    const wrapper = document.createElement('div');
                    wrapper.className = 'multi-day-events-wrapper';

                    // Create container for all rows in this week
                    const rowContainer = document.createElement('div');
                    rowContainer.className = 'multi-day-week-events';

                    eventRows.forEach((row, rowIndex) => {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'multi-day-week-row';

                        row.forEach(event => {
                            const eventEl = document.createElement('div');
                            eventEl.className = 'multi-day-event-span';
                            if (event.continuesLeft) eventEl.classList.add('continues-left');
                            if (event.continuesRight) eventEl.classList.add('continues-right');

                            // Set grid column span
                            eventEl.style.gridColumn = `${event.startCol + 1} / ${event.endCol + 2}`;

                            // Always show name on every week segment for easier identification
                            // Only show duration badge on first segment
                            const isFirstSegment = !event.continuesLeft;

                            eventEl.innerHTML = `
                                <span class="event-icon">${event.emoji || '📅'}</span>
                                <span class="event-name">${event.name}</span>
                                ${isFirstSegment && event.duration > 1 ? `<span class="event-duration">${event.duration}d</span>` : ''}
                            `;

                            eventEl.title = `${event.name} (${event.duration} days)`;
                            eventEl.onclick = () => showMultiDayCampaignDetails(event.id);

                            rowDiv.appendChild(eventEl);
                        });

                        rowContainer.appendChild(rowDiv);
                    });

                    wrapper.appendChild(rowContainer);

                    // Insert after the week's header row (day headers are first 7 children)
                    // We need to insert before the first day cell of this week
                    const firstCellOfWeek = dayCells[weekIndex * 7];
                    if (firstCellOfWeek) {
                        container.insertBefore(wrapper, firstCellOfWeek);
                    }
                });
            }

            // Open create campaign modal with a specific date pre-selected
            openCreateCampaignModalForDate(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const day = date.getDate();

                // Navigate to the target month if not already there
                if (year !== this.selectedDate.getFullYear() || month !== this.selectedDate.getMonth()) {
                    this.selectedDate = new Date(year, month, 1);
                    updateMonthDisplay();
                    this.renderCalendar();
                }

                // Open the modal with the specific date
                document.getElementById('campaignDate').value = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                document.getElementById('createCampaignModal').classList.add('show');
                setTimeout(() => {
                    document.getElementById('campaignName').focus();
                }, 100);
            }

            // Handle drop on adjacent month dates
            async handleDropAdjacentMonth(e, targetDate) {
                e.preventDefault();

                // Use this.draggedCampaignId instead of e.dataTransfer (matches handleDrop pattern)
                console.log('🔍 Dragged Campaign ID:', this.draggedCampaignId);

                const campaign = this.campaigns.find(c => c.id === this.draggedCampaignId);
                console.log('🔍 Campaign found:', campaign ? `${campaign.name} (${campaign.id})` : 'NONE');

                if (!campaign) {
                    console.error('❌ No campaign found for ID:', this.draggedCampaignId);
                    return;
                }

                // Debug logging to diagnose date issue
                console.log('🐛 DROP DEBUG:', {
                    campaignName: campaign.name,
                    campaignOldDate: campaign.date,
                    targetDate: targetDate,
                    targetDateType: typeof targetDate,
                    targetDateString: targetDate.toString(),
                    targetDateISO: targetDate.toISOString(),
                    month: targetDate.getMonth(),
                    monthName: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][targetDate.getMonth()],
                    day: targetDate.getDate(),
                    year: targetDate.getFullYear()
                });

                // Update the campaign's date
                this.saveState();
                campaign.date = new Date(targetDate);

                // Navigate to the target month
                this.selectedDate = new Date(targetDate);
                updateMonthDisplay();
                localStorage.setItem('lastSelectedMonth', this.selectedDate.toISOString());

                // Load events for the new month and restart sync (like month navigation buttons do)
                await this.loadFromCloud();
                this.startSyncPolling();

                // Re-render to show in new month
                this.renderCalendar();
                this.updateStats();

                // Save to backend
                this.quickUpdate(campaign);

                showToast(`Moved "${campaign.name}" to ${targetDate.toLocaleDateString()}`);
            }

            // Filter toggle functions
            toggleSegmentFilter(segmentName) {
                const idx = this.activeFilters.segments.indexOf(segmentName);
                if (idx === -1) {
                    // Clear channel filters when filtering by segment
                    this.activeFilters.channels = [];
                    this.activeFilters.segments.push(segmentName);
                } else {
                    this.activeFilters.segments.splice(idx, 1);
                }
                this.renderCalendar();
                this.updateSegmentDisplay();
                showToast(`${idx === -1 ? 'Filtering' : 'Removed filter'} for ${segmentName}`, 'info');
            }

            toggleChannelFilter(channel) {
                const idx = this.activeFilters.channels.indexOf(channel);
                if (idx === -1) {
                    // Clear segment filters when filtering by channel
                    this.activeFilters.segments = [];
                    this.activeFilters.channels = [channel]; // Only one channel at a time
                } else {
                    this.activeFilters.channels.splice(idx, 1);
                }
                this.renderCalendar();
                this.updateSegmentDisplay();
                const channelName = channel === 'email' ? 'Email' : 'SMS';
                showToast(`${idx === -1 ? 'Showing only' : 'Showing all'} ${channelName} campaigns`, 'info');
            }

            clearAllFilters() {
                this.activeFilters.segments = [];
                this.activeFilters.channels = [];
                this.renderCalendar();
                this.updateSegmentDisplay();
                showToast('Cleared all filters', 'info');
            }

            async loadMonthGoal() {
                if (!this.selectedClient) return;

                try {
                    // Get current month and year
                    const currentMonth = this.selectedDate.getMonth() + 1;
                    const currentYear = this.selectedDate.getFullYear();

                    // Fetch goals for this client, year, and month
                    const response = await authenticatedFetch(`/api/goals/${this.selectedClient.id}?year=${currentYear}&month=${currentMonth}`);

                    if (response.ok) {
                        const goals = await response.json();

                        if (goals && goals.length > 0) {
                            const goal = goals[0];

                            // Check for multi-metric support first
                            if (goal.metrics && goal.metrics.revenue) {
                                this.currentMonthGoal = goal.metrics.revenue.goal || goal.metrics.revenue.predicted || 50000;
                            } else if (goal.revenue_goal) {
                                // Fallback to legacy field
                                this.currentMonthGoal = goal.revenue_goal;
                            } else {
                                this.currentMonthGoal = 50000;
                            }

                            // Update the display
                            const goalElement = document.getElementById('monthGoal');
                            if (goalElement) {
                                goalElement.textContent = this.formatCurrency(this.currentMonthGoal);
                            }

                            // Store the full goal data for reference
                            this.currentGoalData = goal;

                            // Show confidence indicator if available
                            if (goal.confidence) {
                                this.showGoalConfidence(goal.confidence);
                            }

                            // Show if it's a human override
                            if (goal.human_override) {
                                this.showHumanOverrideIndicator();
                            }
                        } else {
                            // No goals found, use default
                            this.currentMonthGoal = 50000;
                            const goalElement = document.getElementById('monthGoal');
                            if (goalElement) {
                                goalElement.textContent = '$50k';
                            }
                            console.debug('No goals found for this month - using default $50k');
                        }
                    } else {
                        // Goals endpoint not available or returned error - use default
                        console.debug('Goals service not available - using default $50k');
                        this.currentMonthGoal = 50000;
                        const goalElement = document.getElementById('monthGoal');
                        if (goalElement) {
                            goalElement.textContent = '$50k';
                        }
                    }
                } catch (error) {
                    // Silently use default on error - goals are optional
                    console.debug('Goals service not available:', error.message);
                    this.currentMonthGoal = 50000;
                    const goalElement = document.getElementById('monthGoal');
                    if (goalElement) {
                        goalElement.textContent = '$50k';
                    }
                }
            }
            
            formatCurrency(value) {
                if (value >= 1000000) {
                    return `$${(value / 1000000).toFixed(1)}M`;
                } else if (value >= 1000) {
                    return `$${(value / 1000).toFixed(0)}k`;
                } else {
                    return `$${value.toFixed(0)}`;
                }
            }
            
            showGoalConfidence(confidence) {
                const goalCard = document.querySelector('#monthGoal').parentElement;
                if (goalCard) {
                    // Remove existing confidence classes
                    goalCard.classList.remove('confidence-high', 'confidence-medium', 'confidence-low');
                    // Add new confidence class
                    goalCard.classList.add(`confidence-${confidence}`);
                    
                    // Add tooltip
                    goalCard.title = `Confidence: ${confidence}`;
                }
            }
            
            showHumanOverrideIndicator() {
                const goalCard = document.querySelector('#monthGoal').parentElement;
                if (goalCard && !goalCard.querySelector('.override-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.className = 'override-indicator';
                    indicator.innerHTML = '<i class="fas fa-user-edit"></i>';
                    indicator.title = 'Manually adjusted goal';
                    goalCard.appendChild(indicator);
                }
            }
            
            updateStats() {
                // Apply the same filters used in getCampaignsForDay to get accurate count
                let filteredCampaigns = this.campaigns.filter(c => {
                    // Check if campaign's type (promotional/content) is enabled
                    // Default to true for unknown types to prevent filtering out valid campaigns
                    const typeMatch = campaignTypeFilters[c.type] !== false;

                    // Check if campaign's channel (email/sms/push) is enabled
                    const channel = c.channel || 'email';
                    const channelMatch = campaignTypeFilters[channel];

                    // Comprehensive resend check (matches getCampaignsForDay logic)
                    const isResend = c.is_resend || c.type === 'resend' || c.campaignMessageType === 'Resend' || (c.name && c.name.toLowerCase().includes('resend'));
                    const resendMatch = isResend ? campaignTypeFilters['resend'] : true;

                    return typeMatch && channelMatch && resendMatch;
                });

                // Apply search filter if active
                if (window.searchQuery && window.searchQuery.trim() !== '') {
                    const query = window.searchQuery.toLowerCase();
                    filteredCampaigns = filteredCampaigns.filter(c => {
                        return (c.name && c.name.toLowerCase().includes(query)) ||
                               (c.type && c.type.toLowerCase().includes(query)) ||
                               (c.segment && c.segment.toLowerCase().includes(query)) ||
                               (c.description && c.description.toLowerCase().includes(query));
                    });
                }

                const totalCampaigns = filteredCampaigns.length;
                const totalRevenue = filteredCampaigns.reduce((sum, c) => {
                    return sum + (c.metrics?.revenue || c.expected_metrics?.revenue || 0);
                }, 0);
                const avgOpenRate = filteredCampaigns.reduce((sum, c) => {
                    return sum + (c.metrics?.openRate || c.expected_metrics?.open_rate || 0);
                }, 0) / (totalCampaigns || 1);

                document.getElementById('totalCampaigns').textContent = totalCampaigns;
                document.getElementById('expectedRevenue').textContent = `$${Math.round(totalRevenue).toLocaleString()}`;
                document.getElementById('avgOpenRate').textContent = `${(avgOpenRate * 100).toFixed(1)}%`;

                // Reset grade when calendar changes
                this.resetGrade();
            }
            
            resetGrade() {
                const gradeCard = document.querySelector('.grade-card');
                const gradeDisplay = document.getElementById('gradeDisplay');
                const gradeLabel = document.getElementById('gradeLabel');
                
                if (gradeCard) {
                    // Remove grade classes to reset to ungraded state
                    gradeCard.classList.remove('has-grade', 'grade-a', 'grade-a-plus', 'grade-b', 'grade-c', 'grade-d', 'grade-f');
                    gradeCard.classList.add('needs-grading');
                }
                
                if (gradeDisplay) {
                    gradeDisplay.innerHTML = '<span class="grade-icon" aria-hidden="true">🧑‍🏫</span><span>Grade</span>';
                    gradeDisplay.style.color = '';
                    gradeDisplay.style.textShadow = '';
                }
                
                if (gradeLabel) {
                    gradeLabel.textContent = 'Performance';
                }
            }

            // New CRUD Methods
            openCreateCampaignModal(day) {
                this.selectedDay = day;
                const year = this.selectedDate.getFullYear();
                const month = this.selectedDate.getMonth();
                const dateStr = new Date(year, month, day).toISOString().split('T')[0];
                
                document.getElementById('campaignDate').value = dateStr;
                document.getElementById('createCampaignModal').classList.add('show');
            }

            saveState() {
                this.undoStack.push(JSON.parse(JSON.stringify(this.campaigns)));
                if (this.undoStack.length > 10) {
                    this.undoStack.shift(); // Keep only last 10 states
                }
                document.getElementById('undoBtn').disabled = false;
            }

            duplicateCampaign(campaignId) {
                const campaign = this.campaigns.find(c => c.id === campaignId);
                if (!campaign) return;
                
                this.saveState();
                
                // Find the next available date after the original campaign
                const occupiedDates = new Set(this.campaigns.map(c => c.date.toDateString()));
                let newDate = new Date(campaign.date);
                let daysToAdd = 1;
                
                // Find next available date (skip weekends for B2B)
                while (daysToAdd < 30) {
                    newDate = new Date(campaign.date);
                    newDate.setDate(newDate.getDate() + daysToAdd);
                    
                    // Skip weekends
                    if (newDate.getDay() === 0 || newDate.getDay() === 6) {
                        daysToAdd++;
                        continue;
                    }
                    
                    // Check if date is available
                    if (!occupiedDates.has(newDate.toDateString())) {
                        break;
                    }
                    daysToAdd++;
                }
                
                const newCampaign = {
                    ...campaign,
                    id: 'campaign-' + Date.now(),
                    name: campaign.name + ' (Copy)',
                    date: newDate,
                    type: campaign.type === 'resend' ? 'resend' : campaign.type  // Preserve resend type
                };

                this.campaigns.push(newCampaign);

                // Re-render based on current view to maintain view state
                if (this.currentView === 'list') {
                    renderListView();
                } else if (this.currentView === 'week') {
                    renderWeekView();
                } else {
                    this.renderCalendar();
                }

                this.updateStats();

                // Auto-save to cloud
                this.saveToCloud();

                showToast(`Campaign duplicated to ${newDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}!`, 'success');
            }

            // PHASE 1.1: Resend Feature - Create resend for next day
            resendCampaign(campaignId) {
                const campaign = this.campaigns.find(c => c.id === campaignId);
                if (!campaign) return;

                this.saveState();

                // Create resend for next day
                const resendDate = new Date(campaign.date);
                resendDate.setDate(resendDate.getDate() + 1);

                const resendCampaign = {
                    ...campaign,
                    id: 'campaign-' + Date.now(),
                    name: 'Resend: ' + campaign.name.replace(/^Resend:\s*/, ''),
                    date: resendDate,
                    is_resend: true,
                    type: 'resend',  // Set message type to resend
                    campaignMessageType: 'Resend'  // Explicit field for UI display
                };
                
                this.campaigns.push(resendCampaign);
                
                // Re-render based on current view
                if (this.currentView === 'list') {
                    renderListView();
                } else if (this.currentView === 'week') {
                    renderWeekView();
                } else {
                    this.renderCalendar();
                }
                
                this.updateStats();
                this.saveToCloud();
                
                showToast(`📮 Resend scheduled for ${resendDate.toLocaleDateString()}`, 'success');
            }


            editCampaign(campaignId) {
                const campaign = this.campaigns.find(c => c.id === campaignId);
                if (!campaign) return;

                // Pre-populate form with existing data
                document.getElementById('campaignName').value = campaign.name;

                // Set Channel and Message Type dropdowns
                document.getElementById('campaignChannel').value = campaign.channel || 'email';
                document.getElementById('campaignMessageType').value = campaign.type || 'promotional';
                document.getElementById('campaignType').value = campaign.type; // Hidden field

                document.getElementById('campaignDate').value = campaign.date.toISOString().split('T')[0];
                // Convert time to 24H format for input field (handles both 12H and 24H formats)
                const timeValue = campaign.time || campaign.send_time || '10:00';
                document.getElementById('campaignTime').value = convertTo24Hour(timeValue);
                document.getElementById('campaignSubjects').value = campaign.subject_lines?.join(', ') || '';
                document.getElementById('campaignSegment').value = campaign.target_segment || campaign.segment || campaign.segments || '';

                // Update modal title for edit mode
                const modalTitle = document.querySelector('#createCampaignModal h3');
                if (modalTitle) {
                    modalTitle.textContent = '✏️ Edit Campaign';
                }

                // Update submit button text
                const submitButton = document.querySelector('#campaignForm button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = '<span class="text-base">💾 Save Changes</span>';
                }

                // Store editing campaign ID
                document.getElementById('campaignForm').dataset.editingId = campaignId;
                document.getElementById('createCampaignModal').classList.add('show');
                
                // Focus on the name field
                setTimeout(() => {
                    document.getElementById('campaignName').focus();
                }, 100);
                
                showToast(`Editing: ${campaign.name}`, 'info');
            }

            confirmDeleteCampaign(campaignId) {
                const campaign = this.campaigns.find(c => c.id === campaignId);
                if (!campaign) return;
                
                this.pendingAction = () => this.deleteCampaign(campaignId);
                document.getElementById('confirmTitle').textContent = '🗑️ Delete Campaign';
                document.getElementById('confirmMessage').innerHTML = `
                    <div class="text-center">
                        <div class="mb-2">Are you sure you want to delete:</div>
                        <div class="font-bold text-lg mb-2">"${campaign.name}"</div>
                        <div class="text-sm text-white/60">
                            ${campaign.date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                        </div>
                    </div>
                `;
                document.getElementById('confirmBtn').textContent = 'Delete Campaign';
                document.getElementById('confirmBtn').className = 'glow-button bg-red-500 hover:bg-red-600';
                document.getElementById('confirmModal').classList.add('show');
            }

            deleteCampaign(campaignId) {
                const campaign = this.campaigns.find(c => c.id === campaignId);
                const campaignName = campaign ? campaign.name : 'Campaign';

                this.saveState();
                this.campaigns = this.campaigns.filter(c => c.id !== campaignId);

                // Re-render based on current view to maintain view state
                if (this.currentView === 'list') {
                    renderListView();
                } else if (this.currentView === 'week') {
                    renderWeekView();
                } else {
                    this.renderCalendar();
                }

                this.updateStats();


                // Delete from Firestore directly (surgical delete, no cascade)
                if (campaign && campaign.id) {
                    authenticatedFetch(`/api/calendar/events/${campaign.id}`, { 
                        method: 'DELETE' 
                    }).catch(err => console.warn('Failed to delete event:', err));
                }

                showToast(`🗑️ "${campaignName}" deleted successfully`, 'success');
            }

            // Firestore Integration - Uses calendar_events collection
            async saveToCloud() {
                if (!this.selectedClient) {
                    showToast('Please select a client first', 'warning');
                    return false;
                }

                const clientId = this.selectedClient.slug || this.selectedClient.id;
                if (!clientId || clientId === 'undefined') {
                    showToast('Invalid client selected', 'error');
                    return false;
                }
                
                showSaveStatus('saving', 'Saving to cloud...');
                
                try {
                    // Calculate visible date range (including adjacent month dates in the grid)
                    // This must match the date range in loadCampaigns and startSyncPolling
                    const year = this.selectedDate.getFullYear();
                    const month = this.selectedDate.getMonth(); // 0-11

                    // Get first day of month and calculate how many previous month days are visible
                    const firstDayOfMonth = new Date(year, month, 1);
                    const firstDay = firstDayOfMonth.getDay(); // 0 = Sunday

                    // Calculate previous month info
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevMonthYear = month === 0 ? year - 1 : year;
                    const daysInPrevMonth = new Date(prevMonthYear, prevMonth + 1, 0).getDate();

                    // Calculate current month info
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    // Calculate next month info
                    const totalCellsForCurrentMonth = firstDay + daysInMonth;
                    const cellsNeeded = Math.ceil(totalCellsForCurrentMonth / 7) * 7;
                    const nextMonthDays = cellsNeeded - totalCellsForCurrentMonth;

                    // Start date: include previous month's trailing days if needed
                    let queryStartDate;
                    if (firstDay > 0) {
                        const prevMonthStartDay = daysInPrevMonth - firstDay + 1;
                        queryStartDate = new Date(prevMonthYear, prevMonth, prevMonthStartDay);
                    } else {
                        queryStartDate = new Date(year, month, 1);
                    }

                    // End date: include next month's leading days if needed
                    let queryEndDate;
                    if (nextMonthDays > 0) {
                        const nextMonth = month === 11 ? 0 : month + 1;
                        const nextMonthYear = month === 11 ? year + 1 : year;
                        queryEndDate = new Date(nextMonthYear, nextMonth, nextMonthDays);
                    } else {
                        queryEndDate = new Date(year, month, daysInMonth);
                    }

                    // Format as YYYY-MM-DD strings for API query
                    const monthStart = queryStartDate.toISOString().split('T')[0];
                    const monthEnd = queryEndDate.toISOString().split('T')[0];

                    console.log(`💾 Saving events: ${monthStart} to ${monthEnd} (includes adjacent month dates)`);

                    // Fetch existing events
                    const existingResponse = await authenticatedFetch(`/api/calendar/events?client_id=${clientId}&start_date=${monthStart}&end_date=${monthEnd}`);
                    
                    let existingEvents = [];
                    if (existingResponse.ok) {
                        const existingData = await existingResponse.json();
                        existingEvents = existingData.events || existingData;
                    }
                    
                    // Create maps for comparison
                    const existingMap = new Map(existingEvents.map(e => [e.id, e]));
                    const localMap = new Map(this.campaigns.map(c => [c.id, c]));
                    
                    // Determine operations
                    const toCreate = [];
                    const toUpdate = [];
                    const toDelete = [];
                    
                    // Find creates and updates
                    for (const campaign of this.campaigns) {
                        // Ensure time always has AM/PM before saving
                        let timeToSave = campaign.time || campaign.send_time || '10:00 AM';
                        if (timeToSave && !timeToSave.toLowerCase().includes('am') && !timeToSave.toLowerCase().includes('pm')) {
                            timeToSave = timeToSave + ' AM';
                        }

                        const eventData = {
                            title: campaign.name,
                            event_date: `${campaign.date.getFullYear()}-${String(campaign.date.getMonth() + 1).padStart(2, '0')}-${String(campaign.date.getDate()).padStart(2, '0')}`,
                            client_id: clientId,
                            content: campaign.description || '',
                            color: this.getChannelColor(campaign.channel),
                            event_type: campaign.type,
                            channel: campaign.channel || 'email',
                            time: timeToSave,  // Save with AM/PM
                            send_time: timeToSave,  // Save both fields
                            segment: campaign.segment || 'all',
                            expected_metrics: campaign.metrics || {},
                            gradient: campaign.gradient,
                            emoji: campaign.emoji,
                            is_resend: campaign.is_resend || false,  // ✅ Include is_resend for border styling
                            campaignMessageType: campaign.campaignMessageType || null,  // ✅ Include message type

                            // NEW: EmailPilot Simple workflow support
                            custom_fields: campaign.custom_fields || campaign.originalData || {},  // Preserve all enriched data
                            original_id: campaign.original_id || campaign.id,  // Track original import ID
                            import_metadata: campaign.import_metadata || null,  // Source, batch_id, enriched_context_key

                            // NEW: Modification tracking
                            created_at: campaign.created_at || new Date().toISOString(),
                            updated_at: new Date().toISOString(),
                            modified: campaign.modified || false,
                            modified_fields: campaign.modified_fields || []
                        };
                        
                        if (existingMap.has(campaign.id)) {
                            // Event exists - may need update
                            toUpdate.push({ id: campaign.id, data: eventData });
                        } else {
                            // New event
                            toCreate.push(eventData);
                        }
                    }
                    
                    // Find deletes
                    for (const existingEvent of existingEvents) {
                        if (!localMap.has(existingEvent.id)) {
                            toDelete.push(existingEvent.id);
                        }
                    }
                    
                    // Execute surgical operations
                    const operations = [];
                    
                    // Creates
                    for (const event of toCreate) {
                        operations.push(
                            authenticatedFetch('/api/calendar/events', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(event)
                            }).catch(err => console.warn('Create failed:', err))
                        );
                    }
                    
                    // Updates
                    for (const {id, data} of toUpdate) {
                        operations.push(
                            authenticatedFetch(`/api/calendar/events/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            }).catch(err => console.warn('Update failed:', err))
                        );
                    }
                    
                    // Deletes
                    for (const id of toDelete) {
                        operations.push(
                            authenticatedFetch(`/api/calendar/events/${id}`, {
                                method: 'DELETE'
                            }).catch(err => console.warn('Delete failed:', err))
                        );
                    }
                    
                    // Wait for all operations
                    await Promise.all(operations);

                    // Save multi-day campaigns to Firestore
                    await this.saveMultiDayCampaignsToCloud();

                    showSaveStatus('saved', 'Saved to cloud!');
                    showToast('Calendar saved successfully!');

                    // Save chat history if exists
                    if (this.chatHistory && this.chatHistory.length > 0) {
                        await this.saveChatHistory();
                    }

                    // Update hash
                    this.lastEventHash = this.computeEventHash();

                    // Broadcast sync
                    this.broadcastSync();
                    return true;
                    
                } catch (error) {
                    console.error('Save failed:', error);
                    showSaveStatus('error', 'Save failed - ' + error.message);
                    showToast('Failed to save: ' + error.message, 'error');
                    return false;
                }
            }


            // Helper method to get channel color
            getChannelColor(channel) {
                if (channel === 'sms') {
                    return 'bg-purple-200 text-purple-800';
                }
                return 'bg-blue-200 text-blue-800';
            }

            // Save multi-day campaigns to Firestore
            async saveMultiDayCampaignsToCloud() {
                if (!this.selectedClient || !this.multiDayCampaigns) return;

                const clientId = this.selectedClient.slug || this.selectedClient.id;
                if (!clientId || clientId === 'undefined') return;

                try {
                    // Fetch existing multi-day events from Firestore
                    const existingResponse = await authenticatedFetch(`/api/calendar/multiday-events?client_id=${clientId}`);
                    let existingEvents = [];
                    if (existingResponse.ok) {
                        const existingData = await existingResponse.json();
                        existingEvents = existingData.events || [];
                    }

                    // Create maps for comparison
                    const existingMap = new Map(existingEvents.map(e => [e.id, e]));
                    const localMap = new Map(this.multiDayCampaigns.map(c => [c.id, c]));

                    const operations = [];

                    // Find creates and updates
                    for (const campaign of this.multiDayCampaigns) {
                        const eventData = {
                            client_id: clientId,
                            name: campaign.name,
                            start_date: typeof campaign.startDate === 'string' ? campaign.startDate : campaign.startDate.toISOString().split('T')[0],
                            end_date: typeof campaign.endDate === 'string' ? campaign.endDate : campaign.endDate.toISOString().split('T')[0],
                            event_type: campaign.type || 'reminder',
                            emoji: campaign.emoji || '📅',
                            description: campaign.description || '',
                            color: campaign.color || 'multi-day-campaign'
                        };

                        if (existingMap.has(campaign.id)) {
                            // Update existing
                            operations.push(
                                authenticatedFetch(`/api/calendar/multiday-events/${campaign.id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(eventData)
                                }).catch(err => console.warn('Multi-day update failed:', err))
                            );
                        } else {
                            // Create new
                            operations.push(
                                authenticatedFetch('/api/calendar/multiday-events', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(eventData)
                                }).then(async (response) => {
                                    if (response.ok) {
                                        const created = await response.json();
                                        // Update local campaign with Firestore ID
                                        const localCampaign = this.multiDayCampaigns.find(c => c.id === campaign.id);
                                        if (localCampaign && created.id) {
                                            localCampaign.id = created.id;
                                        }
                                    }
                                }).catch(err => console.warn('Multi-day create failed:', err))
                            );
                        }
                    }

                    // Find deletes
                    for (const existingEvent of existingEvents) {
                        if (!localMap.has(existingEvent.id)) {
                            operations.push(
                                authenticatedFetch(`/api/calendar/multiday-events/${existingEvent.id}`, {
                                    method: 'DELETE'
                                }).catch(err => console.warn('Multi-day delete failed:', err))
                            );
                        }
                    }

                    if (operations.length > 0) {
                        await Promise.all(operations);
                        console.log(`📅 Saved ${this.multiDayCampaigns.length} multi-day campaigns to cloud`);
                    }
                } catch (error) {
                    console.error('Failed to save multi-day campaigns:', error);
                }
            }

            // Load multi-day campaigns from Firestore
            async loadMultiDayCampaignsFromCloud() {
                if (!this.selectedClient) return;

                const clientId = this.selectedClient.slug || this.selectedClient.id;
                if (!clientId || clientId === 'undefined') return;

                try {
                    const response = await authenticatedFetch(`/api/calendar/multiday-events?client_id=${clientId}`);

                    if (response.ok) {
                        const data = await response.json();
                        const events = data.events || [];

                        // Convert to local format
                        this.multiDayCampaigns = events.map(event => ({
                            id: event.id,
                            name: event.name,
                            startDate: event.start_date,
                            endDate: event.end_date,
                            type: event.event_type || 'reminder',
                            description: event.description || '',
                            isMultiDay: true,
                            color: event.color || 'multi-day-campaign',
                            emoji: event.emoji || '📅',
                            created_at: event.created_at
                        }));

                        console.log(`📅 Loaded ${this.multiDayCampaigns.length} multi-day campaigns from cloud`);
                    } else {
                        this.multiDayCampaigns = [];
                    }
                } catch (error) {
                    console.error('Failed to load multi-day campaigns:', error);
                    this.multiDayCampaigns = [];
                }
            }

            // ====================================================================
            // Fast-Path Methods for Single Operations (Skip Fetch+Compare)
            // ====================================================================

            async quickUpdate(campaign) {
                const eventData = {
                    title: campaign.name,
                    event_date: `${campaign.date.getFullYear()}-${String(campaign.date.getMonth() + 1).padStart(2, '0')}-${String(campaign.date.getDate()).padStart(2, '0')}`,
                    client_id: this.selectedClient?.slug || this.selectedClient?.id,
                    content: campaign.description || '',
                    color: this.getChannelColor(campaign.channel),
                    event_type: campaign.type,
                    channel: campaign.channel || 'email',
                    time: campaign.time,
                    send_time: campaign.send_time || campaign.time,
                    segment: campaign.segment || 'all',
                    expected_metrics: campaign.metrics || {},
                    gradient: campaign.gradient,
                    emoji: campaign.emoji,
                    is_resend: campaign.is_resend || false
                };

                console.log('📤 quickUpdate sending FULL PAYLOAD:', {
                    id: campaign.id,
                    payload: eventData,
                    original_campaign: {
                        type: campaign.type,
                        is_resend: campaign.is_resend,
                        time: campaign.time
                    }
                });

                try {
                    const response = await authenticatedFetch(`/api/calendar/events/${campaign.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(eventData)
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('❌ quickUpdate failed with status:', response.status, errorData);
                        return false;
                    }

                    const responseData = await response.json();
                    console.log('✅ quickUpdate succeeded, BACKEND RESPONSE:', {
                        id: campaign.id,
                        response: responseData
                    });
                    return true;
                } catch (err) {
                    console.error('❌ quickUpdate exception:', err);
                    return false;
                }
            }

            async quickCreate(campaign) {
                const eventData = {
                    title: campaign.name,
                    event_date: `${campaign.date.getFullYear()}-${String(campaign.date.getMonth() + 1).padStart(2, '0')}-${String(campaign.date.getDate()).padStart(2, '0')}`,
                    client_id: this.selectedClient?.slug || this.selectedClient?.id,
                    content: campaign.description || '',
                    color: this.getChannelColor(campaign.channel),
                    event_type: campaign.type,
                    channel: campaign.channel || 'email',
                    time: campaign.time,
                    segment: campaign.segment || 'all',
                    expected_metrics: campaign.metrics || {},
                    gradient: campaign.gradient,
                    emoji: campaign.emoji,
                    is_resend: campaign.is_resend || false
                };

                console.log('📤 quickCreate sending:', { event_type: eventData.event_type, time: eventData.time });

                try {
                    const response = await authenticatedFetch('/api/calendar/events', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(eventData)
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('❌ quickCreate failed with status:', response.status, errorData);
                        return false;
                    }

                    const result = await response.json();
                    // Update local campaign ID with Firestore ID
                    campaign.id = result.id || result.event_id || campaign.id;
                    console.log('✅ quickCreate succeeded, campaign ID:', campaign.id);
                    return true;
                } catch (err) {
                    console.error('❌ quickCreate exception:', err);
                    return false;
                }
            }

            // Save chat history to calendar_chat_history collection
            async saveChatHistory() {
                try {
                    const response = await authenticatedFetch('/api/calendar/ai/save-conversation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: this.selectedClient.id,
                            conversation: this.chatHistory
                        })
                    });

                    if (!response.ok) {
                        console.debug('Chat history save failed (backend may be unavailable):', response.status);
                    }
                } catch (error) {
                    // Expected if backend AI service is not running
                    console.debug('Chat history save unavailable:', error.message);
                }
            }

            // ====================================================================
            // Client Approval Functions
            // ====================================================================

            async requestApprovalForAll() {
                if (!this.selectedClient) {
                    showToast('Please select a client first', 'warning');
                    return false;
                }

                showSaveStatus('saving', '📋 Requesting approval for all campaigns...');

                let successCount = 0;
                let failCount = 0;

                for (const campaign of this.campaigns) {
                    if (!campaign.id) continue; // Skip unsaved campaigns

                    try {
                        const response = await authenticatedFetch(`/api/calendar/events/${campaign.id}/request-approval`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            campaign.approval_status = 'pending_approval';
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        console.error(`Failed to request approval for campaign ${campaign.id}:`, error);
                        failCount++;
                    }
                }

                // Re-render to show approval status
                this.renderCalendar();

                if (failCount === 0) {
                    showSaveStatus('saved', `✅ Approval requested for ${successCount} campaigns`);
                    showToast(`Approval requested for ${successCount} campaigns`, 'success');
                } else {
                    showSaveStatus('error', `⚠️ ${successCount} succeeded, ${failCount} failed`);
                    showToast(`${successCount} succeeded, ${failCount} failed`, 'warning');
                }

                return successCount > 0;
            }

            async unapproveCalendar() {
                if (!this.selectedClient) {
                    showToast('Please select a client first', 'warning');
                    return false;
                }

                if (!confirm('Mark entire calendar for client approval? This will flag all campaigns as needing review.')) {
                    return false;
                }

                return await this.requestApprovalForAll();
            }

            async approveEvent(eventId) {
                try {
                    const response = await authenticatedFetch(`/api/calendar/events/${eventId}/approve`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // Update local campaign status
                        const campaign = this.campaigns.find(c => c.id === eventId);
                        if (campaign) {
                            campaign.approval_status = 'approved';
                            this.renderCalendar();
                        }

                        showToast('✅ Campaign approved', 'success');
                        return true;
                    } else {
                        throw new Error('Approval failed');
                    }
                } catch (error) {
                    console.error('Error approving event:', error);
                    showToast('Failed to approve campaign', 'error');
                    return false;
                }
            }

            async rejectEvent(eventId) {
                try {
                    const response = await authenticatedFetch(`/api/calendar/events/${eventId}/reject`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (response.ok) {
                        const result = await response.json();

                        // Update local campaign status
                        const campaign = this.campaigns.find(c => c.id === eventId);
                        if (campaign) {
                            campaign.approval_status = 'rejected';
                            this.renderCalendar();
                        }

                        showToast('❌ Campaign rejected', 'warning');
                        return true;
                    } else {
                        throw new Error('Rejection failed');
                    }
                } catch (error) {
                    console.error('Error rejecting event:', error);
                    showToast('Failed to reject campaign', 'error');
                    return false;
                }
            }

            async getApprovalRequests() {
                if (!this.selectedClient) {
                    showToast('Please select a client first', 'warning');
                    return [];
                }

                const clientId = this.selectedClient.slug || this.selectedClient.id;

                try {
                    const response = await authenticatedFetch(`/api/calendar/approval-requests?client_id=${clientId}`);

                    if (response.ok) {
                        const result = await response.json();
                        return result.events || [];
                    } else {
                        throw new Error('Failed to fetch approval requests');
                    }
                } catch (error) {
                    console.error('Error fetching approval requests:', error);
                    showToast('Failed to fetch approval requests', 'error');
                    return [];
                }
            }

            // Load events from Firestore calendar_events collection
            async loadFromCloud() {
                if (!this.selectedClient) {
                    console.warn('loadFromCloud: No client selected');
                    return;
                }

                // Get client identifier (prefer slug over id)
                const clientId = this.selectedClient.slug || this.selectedClient.id;
                if (!clientId || clientId === 'undefined') {
                    console.error('loadFromCloud: Invalid client ID:', clientId);
                    showToast('Invalid client selected', 'error');
                    return;
                }
                
                // Show loading indicator immediately
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'fixed top-20 right-4 bg-blue-500/20 text-blue-400 px-4 py-2 rounded-lg border border-blue-500/40 z-50';
                loadingIndicator.innerHTML = '⏳ Loading calendar events...';
                document.body.appendChild(loadingIndicator);
                
                try {
                    // Calculate visible date range (including adjacent month dates in the grid)
                    const year = this.selectedDate.getFullYear();
                    const month = this.selectedDate.getMonth(); // 0-11

                    // Get first day of month and calculate how many previous month days are visible
                    const firstDayOfMonth = new Date(year, month, 1);
                    const firstDay = firstDayOfMonth.getDay(); // 0 = Sunday

                    // Calculate previous month info
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevMonthYear = month === 0 ? year - 1 : year;
                    const daysInPrevMonth = new Date(prevMonthYear, prevMonth + 1, 0).getDate();

                    // Calculate current month info
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    // Calculate next month info
                    const totalCellsForCurrentMonth = firstDay + daysInMonth;
                    const cellsNeeded = Math.ceil(totalCellsForCurrentMonth / 7) * 7; // Round up to complete weeks
                    const nextMonthDays = cellsNeeded - totalCellsForCurrentMonth;

                    // Start date: include previous month's trailing days if needed
                    let queryStartDate;
                    if (firstDay > 0) {
                        const prevMonthStartDay = daysInPrevMonth - firstDay + 1;
                        queryStartDate = new Date(prevMonthYear, prevMonth, prevMonthStartDay);
                    } else {
                        queryStartDate = new Date(year, month, 1);
                    }

                    // End date: include next month's leading days if needed
                    let queryEndDate;
                    if (nextMonthDays > 0) {
                        const nextMonth = month === 11 ? 0 : month + 1;
                        const nextMonthYear = month === 11 ? year + 1 : year;
                        queryEndDate = new Date(nextMonthYear, nextMonth, nextMonthDays);
                    } else {
                        queryEndDate = new Date(year, month, daysInMonth);
                    }

                    // Format as YYYY-MM-DD strings for API query
                    const monthStart = queryStartDate.toISOString().split('T')[0];
                    const monthEnd = queryEndDate.toISOString().split('T')[0];

                    console.log(`📅 Loading events from API: ${monthStart} to ${monthEnd} (includes adjacent month dates)`);

                    // Parallel fetch for events, goals, holidays, and multi-day campaigns
                    const [eventsResponse, goalsPromise, holidaysPromise, multiDayPromise] = await Promise.all([
                        authenticatedFetch(`/api/calendar/events?client_id=${clientId}&start_date=${monthStart}&end_date=${monthEnd}`),
                        this.loadMonthGoal(), // Load goals in parallel
                        this.loadHolidaysAndEvents(), // Load holidays in parallel
                        this.loadMultiDayCampaignsFromCloud() // Load multi-day campaigns in parallel
                    ]);
                    
                    if (eventsResponse.ok) {
                        const eventsData = await eventsResponse.json();
                        const events = eventsData.events || eventsData; // Handle both wrapped and direct array

                        // Convert Firestore events to campaign format
                        this.campaigns = events.map(event => {
                            // FIX: Parse date string to avoid timezone shift
                            // "2025-12-01" should stay December 1, not convert to UTC
                            // Handle both 'date' and 'event_date' field names from Firestore
                            const dateString = event.date || event.event_date;

                            // Defensive check for missing date
                            if (!dateString) {
                                console.error('Event missing date field:', event);
                                return null;
                            }

                            const dateParts = dateString.split('-');
                            const eventDate = new Date(
                                parseInt(dateParts[0]), // year
                                parseInt(dateParts[1]) - 1, // month (0-indexed)
                                parseInt(dateParts[2]) // day
                            );

                            // Ensure time always has AM/PM for proper week view rendering
                            let timeValue = event.time || event.send_time || '10:00 AM';
                            // If time doesn't have AM/PM, add it
                            if (timeValue && !timeValue.toLowerCase().includes('am') && !timeValue.toLowerCase().includes('pm')) {
                                timeValue = timeValue + ' AM';  // Default to AM if not specified
                            }

                            return {
                                id: event.id,
                                name: event.title,
                                type: event.event_type || 'promotional',
                                date: eventDate,
                                time: timeValue,
                                send_time: timeValue,  // Ensure both fields are set
                                channel: event.channel || 'email',
                                segment: event.segment || 'all',
                                description: event.content || '',
                                gradient: event.gradient || this.getTypeGradient(event.event_type),
                                emoji: event.emoji || this.getTypeEmoji(event.event_type),
                                metrics: event.expected_metrics || { openRate: 0.25, clickRate: 0.05, revenue: 5000 },
                                is_resend: event.is_resend || false,
                                campaignMessageType: event.campaignMessageType || (event.is_resend || event.event_type === 'resend' ? 'Resend' : null)
                            };
                        }).filter(event => event !== null); // Remove any null events from bad data
                        
                        this.renderCalendar();
                        this.updateStats();

                        // Update hash for change detection
                        this.lastEventHash = this.computeEventHash();

                        // Only show toast if we loaded events
                        if (this.campaigns.length > 0) {
                            showToast(`Loaded ${this.campaigns.length} campaigns`, 'success');
                        }
                    } else {
                        // If no events found, ensure calendar is cleared
                        this.campaigns = [];
                        this.renderCalendar();
                        this.updateStats();

                        // Update hash after clearing
                        this.lastEventHash = this.computeEventHash();
                    }
                    
                    // Load chat history in background (don't wait for it)
                    this.loadChatHistory().catch(console.error);
                    
                } catch (error) {
                    console.error('Failed to load from cloud:', error);
                    showToast('Failed to load calendar events', 'error');
                    // Clear campaigns on error to show empty state
                    this.campaigns = [];
                    this.renderCalendar();
                    this.updateStats();

                    // Update hash even on error
                    this.lastEventHash = this.computeEventHash();
                } finally {
                    // Remove loading indicator
                    if (loadingIndicator.parentNode) {
                        loadingIndicator.remove();
                    }
                }
            }
            
            // Load holidays and Klaviyo events for the current month
            async loadHolidaysAndEvents() {
                const year = this.selectedDate.getFullYear();
                const month = this.selectedDate.getMonth() + 1;

                try {
                    const response = await authenticatedFetch(`/api/calendar/holidays/?year=${year}&month=${month}&include_klaviyo=true&include_seasons=true`);

                    if (response.ok) {
                        const data = await response.json();

                        // Clear existing holidays for this month
                        this.holidays = {};
                        this.klaviyoEvents = {};

                        // Process holidays and events
                        data.holidays.forEach(item => {
                            const dateKey = item.date;

                            if (item.type === 'holiday' || item.type === 'custom') {
                                if (!this.holidays[dateKey]) {
                                    this.holidays[dateKey] = [];
                                }
                                this.holidays[dateKey].push(item);
                            } else if (item.type === 'klaviyo') {
                                if (!this.klaviyoEvents[dateKey]) {
                                    this.klaviyoEvents[dateKey] = [];
                                }
                                this.klaviyoEvents[dateKey].push(item);
                            }
                        });

                        // Store active seasons if any
                        if (data.holidays.length > 0 && data.holidays[0].active_seasons) {
                            this.activeSeasons = data.holidays[0].active_seasons;
                        }

                        console.debug(`Loaded ${Object.keys(this.holidays).length} holiday dates and ${Object.keys(this.klaviyoEvents).length} Klaviyo event dates`);
                    } else {
                        // Silently continue without holidays if endpoint doesn't exist
                        console.debug('Holiday service not available - continuing without holiday data');
                    }
                } catch (error) {
                    // Silently continue without holidays - non-critical feature
                    console.debug('Holiday service not available:', error.message);
                }
            }
            
            // Add drag and drop handlers
            handleDragStart(e, campaignId) {
                this.draggedCampaignId = campaignId;
                e.dataTransfer.effectAllowed = 'move';
                e.target.style.opacity = '0.5';
            }
            
            handleDragEnd(e) {
                e.target.style.opacity = '';
                this.draggedCampaignId = null;
            }
            
            handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }
            
            async handleDrop(e, targetDay) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }

                if (this.draggedCampaignId) {
                    const campaign = this.campaigns.find(c => c.id === this.draggedCampaignId);
                    if (campaign) {
                        const oldDay = campaign.date.getDate();
                        if (oldDay !== targetDay) {
                            // Save state for undo
                            this.saveState();

                            // Update campaign date
                            campaign.date.setDate(targetDay);

                            // Re-render calendar
                            this.renderCalendar();
                            this.updateStats();

                            // Fast-path update (single PUT request, no fetch+compare)
                            await this.quickUpdate(campaign);

                            showToast(`Campaign moved from ${oldDay} to ${targetDay}`);
                        }
                    }
                }

                return false;
            }
            
            // Auto-save method with debouncing
            async autoSaveToCloud() {
                // Clear existing timeout
                if (this.autoSaveTimeout) {
                    clearTimeout(this.autoSaveTimeout);
                }
                
                // Set new timeout for auto-save (debounce for 1 second)
                this.autoSaveTimeout = setTimeout(async () => {
                    await this.saveToCloud();
                    // broadcastSync() is called within saveToCloud() after successful save
                }, 1000);
            }
            
            // Broadcast sync to other views/tabs
            broadcastSync() {
                // Use localStorage to communicate between tabs/views
                const syncData = {
                    clientId: this.selectedClient?.id,
                    timestamp: Date.now(),
                    campaigns: this.campaigns.length,
                    campaigns_data: JSON.stringify(this.campaigns),
                    action: 'calendar_updated'
                };
                localStorage.setItem('calendar_sync', JSON.stringify(syncData));
                
                // Also trigger custom event for same-page sync
                window.dispatchEvent(new CustomEvent('calendarSync', { detail: syncData }));
                
                // Broadcast on multiple channels for better reliability
                document.dispatchEvent(new CustomEvent('calendar_data_updated', { 
                    detail: { 
                        client: this.selectedClient,
                        campaigns: this.campaigns,
                        timestamp: Date.now()
                    } 
                }));
            }
            
            // Listen for sync updates
            setupSyncListener() {
                // Listen for localStorage changes (other tabs)
                window.addEventListener('storage', (e) => {
                    if (e.key === 'calendar_sync' && e.newValue) {
                        const syncData = JSON.parse(e.newValue);
                        if (syncData.clientId === this.selectedClient?.id) {
                            this.handleSyncUpdate(syncData);
                        }
                    }
                });
                
                // Listen for same-page sync events
                window.addEventListener('calendarSync', (e) => {
                    if (e.detail.clientId === this.selectedClient?.id) {
                        this.handleSyncUpdate(e.detail);
                    }
                });
                
                // Enhanced cross-tab sync - listen for page visibility changes
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        // Page became visible - check for updates
                        this.checkForSyncUpdates();
                    }
                });
                
                // Listen for window focus events
                window.addEventListener('focus', () => {
                    this.checkForSyncUpdates();
                });
            }
            
            // Save campaigns to localStorage (placeholder - using Firestore now)
            saveToLocalStorage() {
                // No-op: We're using Firestore for persistence now
                // This method exists for backwards compatibility
                console.log('📝 saveToLocalStorage called (using Firestore instead)');
            }

            // Check for pending sync updates
            checkForSyncUpdates() {
                const syncData = localStorage.getItem('calendar_sync');
                if (syncData) {
                    try {
                        const parsed = JSON.parse(syncData);
                        if (parsed.clientId === this.selectedClient?.id && 
                            parsed.timestamp > (this.lastSyncCheck || 0)) {
                            this.lastSyncCheck = Date.now();
                            this.handleSyncUpdate(parsed);
                        }
                    } catch (error) {
                        console.error('Error checking sync updates:', error);
                    }
                }
            }
            
            // Handle incoming sync updates
            handleSyncUpdate(syncData) {
                showToast(`🔄 Calendar updated (${syncData.campaigns} campaigns)`);

                // If we have campaign data, use it directly for immediate sync
                if (syncData.campaigns_data) {
                    try {
                        const updatedCampaigns = JSON.parse(syncData.campaigns_data);
                        this.campaigns = updatedCampaigns;
                        this.renderCalendar();
                        showToast('✅ Calendar synchronized with latest changes', 'success');
                        return;
                    } catch (error) {
                        console.error('Error parsing sync data:', error);
                    }
                }

                // Fallback to cloud reload if no data or error
                setTimeout(() => {
                    this.loadFromCloud();
                }, 500);
            }

            // Compute hash of current events for change detection
            computeEventHash(campaigns = null) {
                const campaignsToHash = campaigns || this.campaigns;

                if (!campaignsToHash || campaignsToHash.length === 0) {
                    return 'empty';
                }

                // Helper to normalize time format (add AM if missing AM/PM)
                const normalizeTime = (time) => {
                    if (!time) return '';
                    // If time doesn't have AM/PM, add AM (matches Firestore listener normalization)
                    if (!time.toLowerCase().includes('am') && !time.toLowerCase().includes('pm')) {
                        return time + ' AM';
                    }
                    return time;
                };

                // Create a deterministic hash from campaign data
                const eventData = campaignsToHash
                    .map(c => {
                        const dateStr = c.date instanceof Date ? c.date.toISOString().split('T')[0] : c.date;
                        const timeStr = normalizeTime(c.send_time || c.time || '');
                        return `${c.id}:${c.name}:${dateStr}:${c.type}:${timeStr}`;
                    })
                    .sort()
                    .join('|');

                // Simple hash using DJB2 algorithm (handles UTF-8)
                let hash = 5381;
                for (let i = 0; i < eventData.length; i++) {
                    hash = ((hash << 5) + hash) + eventData.charCodeAt(i);
                }
                return (hash >>> 0).toString(36); // Convert to base36 string
            }

            // ====================================================================
            // Firestore Real-Time Listener for Multi-User Sync
            // ====================================================================

            // Start Firestore real-time listener for changes from other users
            startSyncPolling() {
                console.log('🔥 startSyncPolling called');

                // Clear any existing listener
                this.stopSyncPolling();

                // Get client identifier
                const clientId = this.selectedClient?.slug || this.selectedClient?.id;
                if (!clientId || clientId === 'undefined') {
                    console.warn('startSyncPolling: Invalid client ID, cannot start sync');
                    return;
                }

                // Calculate visible date range (including adjacent month dates in the grid)
                const year = this.selectedDate.getFullYear();
                const month = this.selectedDate.getMonth(); // 0-11

                // Get first day of month and calculate how many previous month days are visible
                const firstDayOfMonth = new Date(year, month, 1);
                const firstDay = firstDayOfMonth.getDay(); // 0 = Sunday

                // Calculate previous month info
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevMonthYear = month === 0 ? year - 1 : year;
                const daysInPrevMonth = new Date(prevMonthYear, prevMonth + 1, 0).getDate();

                // Calculate current month info
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Calculate next month info
                const totalCellsForCurrentMonth = firstDay + daysInMonth;
                const cellsNeeded = Math.ceil(totalCellsForCurrentMonth / 7) * 7; // Round up to complete weeks
                const nextMonthDays = cellsNeeded - totalCellsForCurrentMonth;

                // Start date: include previous month's trailing days if needed
                let queryStartDate;
                if (firstDay > 0) {
                    const prevMonthStartDay = daysInPrevMonth - firstDay + 1;
                    queryStartDate = new Date(prevMonthYear, prevMonth, prevMonthStartDay);
                } else {
                    queryStartDate = new Date(year, month, 1);
                }

                // End date: include next month's leading days if needed
                let queryEndDate;
                if (nextMonthDays > 0) {
                    const nextMonth = month === 11 ? 0 : month + 1;
                    const nextMonthYear = month === 11 ? year + 1 : year;
                    queryEndDate = new Date(nextMonthYear, nextMonth, nextMonthDays);
                } else {
                    queryEndDate = new Date(year, month, daysInMonth);
                }

                // Format as YYYY-MM-DD strings for Firestore query
                const monthStart = queryStartDate.toISOString().split('T')[0];
                const monthEnd = queryEndDate.toISOString().split('T')[0];

                console.log(`🔥 Firestore real-time sync starting for client: ${clientId}, month: ${monthStart} to ${monthEnd} (includes adjacent month dates)`);

                // Verify Firestore is initialized
                if (typeof db === 'undefined' || !db) {
                    console.error('❌ Firestore (db) is not initialized - real-time sync disabled');
                    return;
                }

                // Listen to calendar_events collection for this client and month
                try {
                    this.firestoreUnsubscribe = db.collection('calendar_events')
                        .where('client_id', '==', clientId)
                        .where('event_date', '>=', monthStart)
                        .where('event_date', '<=', monthEnd)
                        .onSnapshot((snapshot) => {
                            console.log('🔥 Firestore snapshot received, documents:', snapshot.size);
                        // Skip if this is the initial load
                        if (!this.initialLoadComplete) {
                            this.initialLoadComplete = true;
                            return;
                        }

                        // Check if there are any changes
                        const changes = snapshot.docChanges();
                        if (changes.length === 0) {
                            return;
                        }

                        console.log(`🔄 Firestore detected ${changes.length} changes`);

                        // Reload campaigns from Firestore
                        const updatedCampaigns = [];
                        snapshot.forEach((doc) => {
                            const event = doc.data();

                            // Defensive check for missing date field
                            const dateString = event.event_date || event.date;
                            if (!dateString) {
                                console.error('Firestore event missing date field:', doc.id, event);
                                return; // Skip this event
                            }

                            const dateParts = dateString.split('-');
                            const eventDate = new Date(
                                parseInt(dateParts[0]),
                                parseInt(dateParts[1]) - 1,
                                parseInt(dateParts[2])
                            );

                            // Ensure time always has AM/PM for proper week view rendering
                            let timeValue = event.send_time || event.time || '10:00 AM';
                            // If time doesn't have AM/PM, add it
                            if (timeValue && !timeValue.toLowerCase().includes('am') && !timeValue.toLowerCase().includes('pm')) {
                                timeValue = timeValue + ' AM';  // Default to AM if not specified
                            }

                            const campaignObj = {
                                id: doc.id,
                                name: event.title,
                                type: event.event_type || 'promotional',
                                date: eventDate,
                                time: timeValue,
                                send_time: timeValue,  // Ensure both fields are set
                                channel: event.channel || 'email',
                                segment: event.segment || 'all',
                                description: event.description || event.content || '',
                                gradient: event.gradient || this.getTypeGradient(event.event_type),
                                emoji: event.emoji || this.getTypeEmoji(event.event_type),
                                metrics: event.expected_metrics || event.metrics || { openRate: 0.25, clickRate: 0.05, revenue: 5000 },
                                is_resend: event.is_resend || event.event_type === 'resend'  // Include is_resend from Firestore
                            };

                            // LOG: What Firestore gave us for this document
                            if (changes.some(change => change.doc.id === doc.id)) {
                                console.log('🔍 FIRESTORE CHANGED DOC:', {
                                    id: doc.id,
                                    raw_event: {
                                        event_type: event.event_type,
                                        is_resend: event.is_resend,
                                        time: event.time,
                                        send_time: event.send_time
                                    },
                                    mapped_campaign: {
                                        type: campaignObj.type,
                                        is_resend: campaignObj.is_resend,
                                        time: campaignObj.time
                                    }
                                });
                            }

                            updatedCampaigns.push(campaignObj);
                        });

                        // Compute hash of incoming data
                        const incomingHash = this.computeEventHash(updatedCampaigns);
                        const currentHash = this.computeEventHash(this.campaigns);

                        // LOG: Compare what Firestore has vs what we have locally
                        const changedId = changes[0]?.doc.id;
                        if (changedId) {
                            const localCampaign = this.campaigns.find(c => c.id === changedId);
                            const firestoreCampaign = updatedCampaigns.find(c => c.id === changedId);
                            console.log('🔍 HASH COMPARISON:', {
                                incomingHash,
                                currentHash,
                                matches: incomingHash === currentHash,
                                changed_campaign_id: changedId,
                                local_campaign: localCampaign ? {
                                    type: localCampaign.type,
                                    is_resend: localCampaign.is_resend,
                                    time: localCampaign.time
                                } : 'NOT FOUND',
                                firestore_campaign: firestoreCampaign ? {
                                    type: firestoreCampaign.type,
                                    is_resend: firestoreCampaign.is_resend,
                                    time: firestoreCampaign.time
                                } : 'NOT FOUND'
                            });
                        }

                        // Only update if data actually changed (prevents bounce from own changes)
                        if (incomingHash === currentHash) {
                            console.log('🔄 Firestore data matches local state - skipping update');
                            return;
                        }

                        // Update local campaigns
                        this.campaigns = updatedCampaigns;

                        // Re-render based on current view to maintain view state
                        if (this.currentView === 'list') {
                            renderListView();
                        } else if (this.currentView === 'week') {
                            renderWeekView();
                        } else {
                            this.renderCalendar();
                        }
                        this.updateStats();

                        // Show subtle notification
                        const notification = document.createElement('div');
                        notification.className = 'fixed top-20 right-4 bg-blue-500/90 text-white px-4 py-2 rounded-lg border border-blue-300 z-50 animate-fade-in';
                        notification.innerHTML = '🔄 Calendar updated in real-time';
                        document.body.appendChild(notification);

                        setTimeout(() => {
                            notification.style.opacity = '0';
                            notification.style.transition = 'opacity 0.5s';
                            setTimeout(() => notification.remove(), 500);
                        }, 2000);
                    }, (error) => {
                        console.error('❌ Firestore sync error:', error);
                        // If permissions error, show helpful message
                        if (error.code === 'permission-denied') {
                            console.warn('⚠️ Firestore permissions denied - check security rules');
                        }
                    });

                    console.log('✅ Firestore listener successfully attached');
                } catch (error) {
                    console.error('❌ Failed to setup Firestore listener:', error);
                }
            }

            // Stop Firestore listener
            stopSyncPolling() {
                if (this.firestoreUnsubscribe) {
                    this.firestoreUnsubscribe();
                    this.firestoreUnsubscribe = null;
                    this.initialLoadComplete = false;
                    console.log('🔥 Firestore real-time sync stopped');
                }
            }
            
            // Load chat history from calendar_conversations collection
            async loadChatHistory() {
                try {
                    const response = await authenticatedFetch(`/api/calendar/ai/get-conversation/${this.selectedClient.id}`);
                    if (response.ok) {
                        const data = await response.json();
                        this.chatHistory = data.conversation || [];
                        // Render chat history if needed
                        this.renderChatHistory();
                    } else if (response.status === 404) {
                        // Expected: No conversation history exists yet - start fresh
                        console.debug(`No conversation history for ${this.selectedClient.id} - starting fresh`);
                        this.chatHistory = [];
                    } else {
                        // Unexpected error
                        console.warn(`Unexpected response loading chat history: ${response.status}`);
                        this.chatHistory = [];
                    }
                } catch (error) {
                    // Network or other errors - expected if backend AI service is not running
                    console.debug('Chat history unavailable:', error.message);
                    this.chatHistory = [];
                }
            }
            
            // Render chat history in the UI
            renderChatHistory() {
                const container = document.getElementById('chatResponse');
                if (!container || this.chatHistory.length === 0) return;
                
                // Clear existing content and render history
                container.innerHTML = '';
                this.chatHistory.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.role}`;
                    messageDiv.innerHTML = `
                        <div class="mb-2 p-3 rounded-lg ${message.role === 'user' ? 'bg-blue-500/10 text-blue-300' : 'bg-white/5 text-white/90'}">
                            <div class="font-semibold mb-1">${message.role === 'user' ? 'You' : 'EmailPilot'}:</div>
                            <div>${message.content}</div>
                        </div>
                    `;
                    container.appendChild(messageDiv);
                });
            }

            undoLastChange() {
                if (this.undoStack.length === 0) return;
                
                this.campaigns = this.undoStack.pop();
                this.renderCalendar();
                this.updateStats();
                
                if (this.undoStack.length === 0) {
                    document.getElementById('undoBtn').disabled = true;
                }
                
                showToast('Undo successful!');
            }
            
            // Clear all campaigns for the current viewing month only
            async clearCurrentMonth() {
                // Save state before clearing
                this.saveState();

                // Get the year and month of the currently selected date
                const currentYear = this.selectedDate.getFullYear();
                const currentMonth = this.selectedDate.getMonth();

                // Find campaigns to delete from the current viewing month
                const campaignsToDelete = this.campaigns.filter(campaign => {
                    const campaignYear = campaign.date.getFullYear();
                    const campaignMonth = campaign.date.getMonth();
                    return (campaignYear === currentYear && campaignMonth === currentMonth);
                });

                // Find multi-day events that overlap with this month
                const monthStart = new Date(currentYear, currentMonth, 1);
                const monthEnd = new Date(currentYear, currentMonth + 1, 0); // Last day of month

                const multiDayToDelete = this.multiDayCampaigns.filter(event => {
                    const parseLocalDate = (dateStr) => {
                        if (dateStr instanceof Date) return new Date(dateStr);
                        const parts = dateStr.split('-');
                        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                    };
                    const eventStart = parseLocalDate(event.startDate);
                    const eventEnd = parseLocalDate(event.endDate);
                    // Event overlaps with month if it starts before month ends and ends after month starts
                    return eventStart <= monthEnd && eventEnd >= monthStart;
                });

                const deletedCount = campaignsToDelete.length;
                const deletedMultiDayCount = multiDayToDelete.length;

                if (deletedCount === 0 && deletedMultiDayCount === 0) {
                    showSaveStatus('error', 'No campaigns to clear in this month');
                    return;
                }

                // CRITICAL: Stop Firestore listener to prevent race condition
                // The listener would immediately restore events after we delete them
                const wasListening = !!this.firestoreUnsubscribe;
                if (wasListening) {
                    this.stopSyncPolling();
                    console.log('🛑 Temporarily stopped Firestore listener during clear month');
                }

                // Remove from local array FIRST (optimistic update for immediate UI feedback)
                this.campaigns = this.campaigns.filter(campaign => {
                    const campaignYear = campaign.date.getFullYear();
                    const campaignMonth = campaign.date.getMonth();
                    // Keep campaigns that are NOT in the current viewing month
                    return !(campaignYear === currentYear && campaignMonth === currentMonth);
                });

                // Remove multi-day events from local array
                const multiDayIdsToDelete = multiDayToDelete.map(e => e.id);
                this.multiDayCampaigns = this.multiDayCampaigns.filter(event =>
                    !multiDayIdsToDelete.includes(event.id)
                );

                // Update UI immediately
                this.renderCalendar();
                this.updateStats();

                // Delete each campaign from Firestore using DELETE API
                const deletePromises = campaignsToDelete.map(campaign => {
                    if (campaign.id) {
                        return authenticatedFetch(`/api/calendar/events/${campaign.id}`, {
                            method: 'DELETE'
                        }).catch(err => {
                            console.warn('Failed to delete campaign from Firestore:', campaign.id, err);
                        });
                    }
                    return Promise.resolve();
                });

                // Delete multi-day events from Firestore
                const deleteMultiDayPromises = multiDayToDelete.map(event => {
                    if (event.id) {
                        return authenticatedFetch(`/api/calendar/multiday-events/${event.id}`, {
                            method: 'DELETE'
                        }).catch(err => {
                            console.warn('Failed to delete multi-day event from Firestore:', event.id, err);
                        });
                    }
                    return Promise.resolve();
                });

                try {
                    // Wait for all deletes to complete
                    await Promise.all([...deletePromises, ...deleteMultiDayPromises]);

                    // Show success feedback
                    const monthName = this.selectedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    const totalDeleted = deletedCount + deletedMultiDayCount;
                    const multiDayText = deletedMultiDayCount > 0 ? ` + ${deletedMultiDayCount} multi-day events` : '';
                    showSaveStatus('saved', `✅ Permanently deleted ${deletedCount} campaigns${multiDayText} from ${monthName}`);

                    // Restart Firestore listener after a delay to allow Firestore to propagate changes
                    if (wasListening) {
                        setTimeout(() => {
                            this.startSyncPolling();
                            console.log('✅ Restarted Firestore listener after clear month');
                        }, 1500);  // 1.5 second delay to ensure Firestore has propagated deletes
                    }
                } catch (error) {
                    console.error('Error clearing month:', error);
                    showSaveStatus('error', 'Failed to clear month - some events may not have been deleted');

                    // Restart listener even on error
                    if (wasListening) {
                        setTimeout(() => {
                            this.startSyncPolling();
                        }, 1000);
                    }

                    throw error;  // Re-throw so wrapper function knows it failed
                }
            }

            // AI Chat Integration with Calendar Manipulation
            async sendChatMessage(message) {
                if (!message) return;
                
                // Add user message to chat
                this.addChatMessage(message, 'user');
                
                // Process command locally first
                const localResult = this.processLocalCommand(message);
                if (localResult.handled) {
                    this.addChatMessage(localResult.response, 'ai');
                    return;
                }
                
                // Show typing indicator for API calls
                const chatHistory = document.getElementById('chatHistory');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'ai-message typing';
                typingDiv.innerHTML = `<div class="text-sm text-blue-400 mb-1">AI Assistant</div><div class="text-white/90">Thinking...</div>`;
                chatHistory.appendChild(typingDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                try {
                    // Use the new calendar chat endpoint
                    const response = await authenticatedFetch('/api/calendar/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            context: {
                                client_name: this.selectedClient?.name || 'No client selected',
                                campaign_count: this.campaigns.length,
                                total_revenue: this.campaigns.reduce((sum, c) => sum + (c.metrics?.revenue || 5000), 0),
                                current_month: this.selectedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                                campaigns_list: JSON.stringify(this.campaigns.map(c => ({
                                    id: c.id,
                                    name: c.name,
                                    type: c.type,
                                    date: c.date.toISOString(),
                                    day: c.date.getDate()
                                })))
                            },
                            provider: document.getElementById('llmSelector').value
                        })
                    });
                    
                    typingDiv.remove();
                    
                    if (response.ok) {
                        const result = await response.json();
                        // AI response received
                        
                        // Add AI response to chat
                        this.addChatMessage(result.response, 'ai');
                        
                        // Execute the structured action if present
                        if (result.action) {
                            this.executeStructuredAction(result.action);
                        }
                    } else {
                        const error = await response.text();
                        console.error('AI Error:', error);
                        this.addChatMessage('I couldn\'t connect to the AI service. But I can still help with basic commands!', 'ai');
                    }
                } catch (error) {
                    // Chat API error handled
                    console.error('Chat error:', error);
                    if (typingDiv && typingDiv.parentNode) typingDiv.remove();
                    this.addChatMessage('Let me handle that locally instead.', 'ai');
                }
            }
            
            // Execute structured action from AI response
            executeStructuredAction(action) {
                // Executing structured action
                
                const actionType = action.action;
                
                if (actionType === 'add') {
                    // Check if a full date was provided (year, month) and navigate if needed
                    if (action.year && action.month) {
                        const targetDate = new Date(action.year, action.month - 1, action.day || 1);
                        const currentMonth = this.selectedDate.getMonth();
                        const currentYear = this.selectedDate.getFullYear();
                        const targetMonth = targetDate.getMonth();
                        const targetYear = targetDate.getFullYear();

                        // Navigate to the target month if different from current
                        if (currentYear !== targetYear || currentMonth !== targetMonth) {
                            console.log(`📅 Navigating to ${targetYear}-${targetMonth + 1} to add event`);
                            this.selectedDate = new Date(targetYear, targetMonth, 1);
                            updateMonthDisplay();
                            localStorage.setItem('lastSelectedMonth', this.selectedDate.toISOString());
                            this.renderCalendar();
                        }
                    }

                    // Handle campaigns with LLM-extracted names
                    const campaignName = action.campaign_name || action.custom_name;

                    if (action.type === 'custom' && action.custom_name) {
                        this.addCustomEventToDate(action.day, action.custom_name);
                    } else if (campaignName) {
                        // Use the LLM-extracted name
                        this.addCampaignToDate(action.day, action.type, 'email', campaignName);
                    } else {
                        // Fall back to type-based naming
                        this.addCampaignToDate(action.day, action.type);
                    }
                } else if (actionType === 'move') {
                    this.moveCampaign(action.from_day, action.to_day);
                } else if (actionType === 'delete') {
                    this.deleteCampaignOnDay(action.day);
                } else if (actionType === 'clear_all') {
                    this.saveState();
                    this.campaigns = [];
                    this.renderCalendar();
                    this.updateStats();
                    this.saveToCloud();
                    showToast('All campaigns cleared');
                } else if (actionType === 'delete_type') {
                    this.saveState();
                    this.campaigns = this.campaigns.filter(c => c.type !== action.type);
                    this.renderCalendar();
                    this.updateStats();
                    this.saveToCloud();
                    showToast(`All ${action.type} campaigns removed`);
                } else if (actionType === 'list') {
                    // Listing is handled by the response message
                    // List action handled
                } else if (actionType === 'analytics') {
                    // Analytics is handled by the response message
                    // Analytics action handled
                } else if (actionType === 'help') {
                    // Help is handled by the response message
                    // Help action handled
                }
            }
            
            // Parse AI response for commands and execute them (legacy method for backward compatibility)
            parseAndExecuteAICommands(response) {
                const lowerResponse = response.toLowerCase();
                
                // Check for add campaign confirmation
                if (lowerResponse.includes('✅') && lowerResponse.includes('added')) {
                    const dayMatch = response.match(/(\d+)(?:st|nd|rd|th)?/);
                    if (dayMatch) {
                        const day = parseInt(dayMatch[1]);
                        let type = 'promotional';
                        if (lowerResponse.includes('content')) type = 'content';
                        if (lowerResponse.includes('engagement')) type = 'engagement';
                        if (lowerResponse.includes('seasonal')) type = 'seasonal';
                        
                        this.addCampaignToDate(day, type);
                    }
                }
                
                // Check for move campaign confirmation
                if (lowerResponse.includes('moved') || lowerResponse.includes('rescheduled')) {
                    const fromMatch = response.match(/from .*?(\d+)/);
                    const toMatch = response.match(/to .*?(\d+)/);
                    if (fromMatch && toMatch) {
                        const fromDay = parseInt(fromMatch[1]);
                        const toDay = parseInt(toMatch[1]);
                        this.moveCampaign(fromDay, toDay);
                    }
                }
                
                // Check for delete confirmation
                if (lowerResponse.includes('❌') || (lowerResponse.includes('deleted') || lowerResponse.includes('removed'))) {
                    const dayMatch = response.match(/(\d+)(?:st|nd|rd|th)?/);
                    if (dayMatch) {
                        const day = parseInt(dayMatch[1]);
                        this.deleteCampaignOnDay(day);
                    }
                }
            }
            
            // Helper method to add campaign to a specific date
            addCampaignToDate(day, type, channel = 'email', customName = null) {
                const campaign = {
                    id: `ai-${Date.now()}`,
                    // Use custom name if provided, otherwise use type-based name
                    name: customName || `${type.charAt(0).toUpperCase() + type.slice(1)} Campaign`,
                    type: type,
                    channel: channel,  // 'email' or 'sms'
                    date: new Date(this.selectedDate.getFullYear(), this.selectedDate.getMonth(), day),
                    time: '10:00',
                    emoji: this.getTypeEmoji(type),
                    gradient: this.getChannelGradient(type, channel),
                    metrics: { openRate: 0.25, clickRate: 0.05, revenue: 5000 }
                };
                
                this.saveState();
                this.campaigns.push(campaign);
                this.renderCalendar();
                this.updateStats();
                this.saveToCloud();
                showToast(`Added "${campaign.name}" on the ${day}${this.getDaySuffix(day)}`);
            }
            
            // Add multi-day campaign
            addMultiDayCampaign(startDate, endDate, name, type = 'campaign', description = '') {
                const campaign = {
                    id: `multi-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    name: name,
                    type: type,
                    startDate: new Date(startDate),
                    endDate: new Date(endDate),
                    description: description,
                    isMultiDay: true,
                    color: 'multi-day-campaign',
                    emoji: '📅',
                    created_at: new Date().toISOString()
                };
                
                this.saveState();
                this.multiDayCampaigns.push(campaign);
                this.renderCalendar();
                this.updateStats();
                this.saveToCloud();
                
                const duration = Math.ceil((campaign.endDate - campaign.startDate) / (1000 * 60 * 60 * 24)) + 1;
                showToast(`Added ${duration}-day campaign: "${name}"`);
                
                return campaign;
            }
            
            // Helper method to add custom event to a specific date
            addCustomEventToDate(day, customName) {
                const campaign = {
                    id: `custom-${Date.now()}`,
                    name: customName,
                    type: 'special',  // Use special type for custom events
                    date: new Date(this.selectedDate.getFullYear(), this.selectedDate.getMonth(), day),
                    time: '10:00',
                    emoji: '⭐',  // Star emoji for custom events
                    gradient: 'gradient-purple',  // Purple gradient for custom events
                    metrics: { openRate: 0.25, clickRate: 0.05, revenue: 5000 }
                };
                
                this.saveState();
                this.campaigns.push(campaign);
                this.renderCalendar();
                this.updateStats();
                this.saveToCloud();
                showToast(`Event "${customName}" added on the ${day}${this.getDaySuffix(day)}`);
                // Custom event added
            }
            
            // Helper method to move campaign
            moveCampaign(fromDay, toDay) {
                const campaign = this.campaigns.find(c => c.date.getDate() === fromDay);
                if (campaign) {
                    this.saveState();
                    campaign.date.setDate(toDay);
                    this.renderCalendar();
                    this.saveToCloud();
                    showToast(`Campaign moved to the ${toDay}${this.getDaySuffix(toDay)}`);
                }
            }
            
            // Helper method to delete campaign on a day
            deleteCampaignOnDay(day) {
                const index = this.campaigns.findIndex(c => c.date.getDate() === day);
                if (index !== -1) {
                    this.saveState();
                    this.campaigns.splice(index, 1);
                    this.renderCalendar();
                    this.updateStats();
                    this.saveToCloud();
                    showToast(`Campaign deleted from the ${day}${this.getDaySuffix(day)}`);
                }
            }
            
            // Helper to get day suffix
            getDaySuffix(day) {
                if (day >= 11 && day <= 13) return 'th';
                switch (day % 10) {
                    case 1: return 'st';
                    case 2: return 'nd';
                    case 3: return 'rd';
                    default: return 'th';
                }
            }
            
            // Process commands locally for immediate response
            processLocalCommand(message) {
                const msg = message.toLowerCase();
                let handled = true;
                let response = '';
                
                // Add campaign
                if ((msg.includes('add') || msg.includes('create')) && (msg.includes('campaign') || msg.includes('email'))) {
                    const dayMatch = msg.match(/(?:on |the )?(\d+)(?:st|nd|rd|th)?/i);
                    const day = dayMatch ? parseInt(dayMatch[1]) : 15;
                    
                    // Try to extract campaign name
                    let campaignName = null;
                    const nameMatch = message.match(/(?:called|named)\s+([^,\.\n]+)/i) ||
                                      message.match(/["']([^"']+)["']/) ||
                                      message.match(/campaign\s+([^,\.\n]+?)(?:\s+(?:on|for|at)\s+)/i);
                    if (nameMatch) {
                        campaignName = nameMatch[1].trim();
                    }
                    
                    let type = 'promotional';
                    if (msg.includes('content') || msg.includes('newsletter')) type = 'content';
                    if (msg.includes('engagement') || msg.includes('survey')) type = 'engagement';
                    if (msg.includes('seasonal') || msg.includes('holiday')) type = 'seasonal';
                    
                    const campaign = {
                        id: `ai-${Date.now()}`,
                        name: campaignName || `${type.charAt(0).toUpperCase() + type.slice(1)} Campaign`,
                        type: type,
                        channel: 'email',  // Default to email
                        date: new Date(this.selectedDate.getFullYear(), this.selectedDate.getMonth(), day),
                        time: '10:00',
                        emoji: this.getTypeEmoji(type),
                        gradient: this.getTypeGradient(type),
                        metrics: { openRate: 0.25, clickRate: 0.05, revenue: 5000 }
                    };
                    
                    this.saveState();
                    this.campaigns.push(campaign);
                    this.renderCalendar();
                    this.updateStats();
                    this.saveToCloud();
                    
                    response = `✅ Added "${campaign.name}" on ${campaign.date.toLocaleDateString()}`;
                }
                // Move campaign
                else if (msg.includes('move') && msg.includes('from')) {
                    const fromMatch = msg.match(/from (?:the )?(\d+)/i);
                    const toMatch = msg.match(/to (?:the )?(\d+)/i);
                    
                    if (fromMatch && toMatch) {
                        const fromDay = parseInt(fromMatch[1]);
                        const toDay = parseInt(toMatch[1]);
                        const campaign = this.campaigns.find(c => c.date.getDate() === fromDay);
                        
                        if (campaign) {
                            this.saveState();
                            campaign.date.setDate(toDay);
                            this.renderCalendar();
                            this.updateStats();
                            this.saveToCloud();
                            response = `✅ Moved ${campaign.name} from day ${fromDay} to day ${toDay}`;
                        } else {
                            response = `❌ No campaign found on day ${fromDay}`;
                        }
                    } else {
                        response = '❌ Please specify: "Move campaign from the 10th to the 15th"';
                    }
                }
                // Delete campaign
                else if ((msg.includes('delete') || msg.includes('remove')) && msg.includes('campaign')) {
                    const dayMatch = msg.match(/(?:on |the )?(\d+)/i);
                    
                    if (dayMatch) {
                        const day = parseInt(dayMatch[1]);
                        const campaign = this.campaigns.find(c => c.date.getDate() === day);
                        
                        if (campaign) {
                            this.saveState();
                            this.campaigns = this.campaigns.filter(c => c.id !== campaign.id);
                            this.renderCalendar();
                            this.updateStats();
                            this.saveToCloud();
                            response = `✅ Deleted ${campaign.name} from day ${day}`;
                        } else {
                            response = `❌ No campaign found on day ${day}`;
                        }
                    } else if (msg.includes('all')) {
                        const count = this.campaigns.length;
                        this.saveState();
                        this.campaigns = [];
                        this.renderCalendar();
                        this.updateStats();
                        this.saveToCloud();
                        response = `✅ Deleted all ${count} campaigns`;
                    }
                }
                // List campaigns
                else if (msg.includes('what') || msg.includes('show') || msg.includes('list')) {
                    if (this.campaigns.length === 0) {
                        response = 'No campaigns scheduled. Try: "Add a promotional campaign on the 15th"';
                    } else {
                        const list = this.campaigns
                            .sort((a, b) => a.date - b.date)
                            .slice(0, 5)
                            .map(c => `• ${c.emoji} ${c.name} on day ${c.date.getDate()}`)
                            .join('\n');
                        response = `You have ${this.campaigns.length} campaigns:\n${list}`;
                        if (this.campaigns.length > 5) response += `\n... and ${this.campaigns.length - 5} more`;
                    }
                }
                // Stats
                else if (msg.includes('stats') || msg.includes('revenue')) {
                    const revenue = this.campaigns.reduce((sum, c) => sum + (c.metrics?.revenue || 0), 0);
                    response = `📊 Stats: ${this.campaigns.length} campaigns, $${revenue.toLocaleString()} expected revenue`;
                }
                else {
                    handled = false;
                    response = '';
                }
                
                return { handled, response };
            }

            addChatMessage(message, sender, isTyping = false) {
                const chatHistory = document.getElementById('chatHistory');
                if (!chatHistory) {
                    console.error('Chat history element not found');
                    return null;
                }

                // Adding message to chat

                // Convert newlines to <br> tags for proper formatting
                const formattedMessage = message
                    .replace(/\\n/g, '<br>')  // Convert literal \n to <br>
                    .replace(/\n/g, '<br>');   // Convert actual newlines to <br>

                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'user' ? 'user-message' : 'ai-message';

                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="text-sm text-lime-400 mb-1">You</div>
                        <div class="text-black">${formattedMessage}</div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="text-sm text-blue-400 mb-1">Ask EmailPilot</div>
                        <div class="text-white/90">${formattedMessage}</div>
                    `;
                }

                if (isTyping) {
                    messageDiv.innerHTML += '<div class="pulse-loader inline-block ml-2" style="width: 12px; height: 12px;"></div>';
                }

                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;

                return messageDiv;
            }

            async executeAIActions(actions) {
                for (const action of actions) {
                    switch (action.type) {
                        case 'add_campaign':
                            this.saveState();
                            this.campaigns.push({
                                id: 'ai-' + Date.now(),
                                name: action.name,
                                type: action.campaign_type || 'content',
                                date: new Date(action.date),
                                time: action.time || '10:00',
                                gradient: this.getTypeGradient(action.campaign_type),
                                emoji: this.getTypeEmoji(action.campaign_type)
                            });
                            break;
                            
                        case 'move_campaign':
                            this.saveState();
                            const campaign = this.campaigns.find(c => 
                                c.name.toLowerCase().includes(action.campaign_name.toLowerCase())
                            );
                            if (campaign) {
                                campaign.date = new Date(action.new_date);
                            }
                            break;
                            
                        case 'delete_campaigns':
                            this.saveState();
                            this.campaigns = this.campaigns.filter(c => 
                                !action.filter || c.type !== action.filter
                            );
                            break;
                    }
                }
                
                this.renderCalendar();
                this.updateStats();
                showToast('AI actions executed successfully!');
            }

            getTypeEmoji(type) {
                const emojis = {
                    promotional: '🎯',
                    content: '📰',
                    engagement: '💬',
                    seasonal: '🎄'
                };
                return emojis[type] || '📧';
            }

            // Format time to 12-hour format
            formatTimeTo12Hour(time) {
                if (!time) return '10:00 AM';

                // Extract just the numeric time part (handles malformed "13:17 AM")
                const timeMatch = time.match(/(\d{1,2}):(\d{2})/);
                if (!timeMatch) return time;

                const hours = parseInt(timeMatch[1], 10);
                const minutes = timeMatch[2];

                // Always recalculate AM/PM based on hour value
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                return `${displayHours}:${minutes} ${period}`;
            }
        }

        // Global helper function for time formatting
        function formatTimeTo12Hour(time) {
            return calendarManager.formatTimeTo12Hour(time);
        }

        // Theme Management Functions
        function initTheme() {
            const savedTheme = localStorage.getItem('calendarTheme') || 'dark';
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'light') {
                body.classList.add('light-mode');
                if (themeIcon) themeIcon.textContent = '☀️';
            } else {
                body.classList.remove('light-mode');
                if (themeIcon) themeIcon.textContent = '🌙';
            }
        }
        
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const isLight = body.classList.contains('light-mode');
            
            if (isLight) {
                body.classList.remove('light-mode');
                if (themeIcon) themeIcon.textContent = '🌙';
                localStorage.setItem('calendarTheme', 'dark');
                showToast('Switched to Dark Mode 🌙');
            } else {
                body.classList.add('light-mode');
                if (themeIcon) themeIcon.textContent = '☀️';
                localStorage.setItem('calendarTheme', 'light');
                showToast('Switched to Light Mode ☀️');
            }
            
            // Trigger a subtle animation
            body.style.transition = 'background 0.5s ease, color 0.5s ease';
            setTimeout(() => {
                body.style.transition = 'background 0.3s ease, color 0.3s ease';
            }, 500);
        }
        
        // Notification and Changes Management
        let pendingChanges = [];
        let lastApprovalCheck = null;
        
        // Check for pending changes and approval status
        async function checkForChanges() {
            if (!calendarManager.selectedClient) {
                // No client selected - clear everything and hide panels
                pendingChanges = [];
                updateNotificationBadges();
                hideChangesPanel();
                return;
            }
            
            try {
                // Check for change requests
                const year = calendarManager.selectedDate.getFullYear();
                const month = String(calendarManager.selectedDate.getMonth() + 1).padStart(2, '0');
                const clientSlug = calendarManager.selectedClient.client_slug || calendarManager.selectedClient.id;
                const approvalId = `${clientSlug}-${year}-${month}`;
                
                // Check if this is Colorado Hemp Honey - show demo change requests
                if (calendarManager.selectedClient.name && 
                    calendarManager.selectedClient.name.toLowerCase().includes('colorado hemp')) {
                    // Show demo change requests for Colorado Hemp Honey
                    if (pendingChanges.length === 0) {
                        pendingChanges = [
                            { type: 'schedule_change', title: 'Move Labor Day Sale', description: 'Client wants to start the campaign 2 days earlier', date: new Date().toISOString(), completed: false },
                            { type: 'content_update', title: 'Update Product Images', description: 'Use new honey jar photos in September campaigns', date: new Date().toISOString(), completed: false },
                            { type: 'segment_change', title: 'Add VIP Segment', description: 'Include VIP customers in the fall promotion', date: new Date().toISOString(), completed: false }
                        ];
                    }
                } else {
                    // For other clients, start with no changes
                    if (!window.changeRequestsLoaded) {
                        pendingChanges = [];
                    }
                }
                updateNotificationBadges();

                // Note: Approval celebration will be triggered by real-time notifications
                // when actual approval events are received from Firestore

            } catch (error) {
                console.log('No changes found or connection issue:', error.message);
            }
        }
        
        function updateNotificationBadges() {
            const clientBadge = document.getElementById('clientNotificationBadge');
            const fabBadge = document.getElementById('fabNotificationBadge');
            const commandFab = document.getElementById('commandFab');
            
            if (pendingChanges.length > 0) {
                // Show badges
                if (clientBadge) {
                    clientBadge.style.display = 'block';
                    clientBadge.textContent = pendingChanges.length;
                }
                if (fabBadge) {
                    fabBadge.style.display = 'block';
                    fabBadge.textContent = pendingChanges.length;
                }
                if (commandFab) {
                    commandFab.classList.add('has-changes');
                }
            } else {
                // Hide badges
                if (clientBadge) clientBadge.style.display = 'none';
                if (fabBadge) fabBadge.style.display = 'none';
                if (commandFab) commandFab.classList.remove('has-changes');
            }
        }
        
        function showChangesPanel() {
            const panel = document.getElementById('changesPanel');
            const changesList = document.getElementById('changesList');
            
            // Only show panel if there are changes or a client is selected
            if (!calendarManager.selectedClient || pendingChanges.length === 0) {
                hideChangesPanel();
                showToast('No pending changes to show', 'info');
                return;
            }
            
            changesList.innerHTML = pendingChanges.map((change, index) => `
                    <div class="change-item" data-change-id="${index}">
                        <div class="flex items-start gap-3">
                            <input type="checkbox" 
                                   id="change-${index}" 
                                   class="mt-1 cursor-pointer" 
                                   onchange="toggleChangeComplete(${index})"
                                   ${change.completed ? 'checked' : ''}>
                            <span class="text-lg">${getChangeIcon(change.type)}</span>
                            <div class="flex-1">
                                <div class="font-semibold text-sm">${change.title}</div>
                                <div class="text-xs opacity-70 mt-1">${change.description}</div>
                                <div class="text-xs opacity-50 mt-2">${formatDate(change.date)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            
            panel.style.display = 'block';
            panel.classList.add('show');
        }
        
        function hideChangesPanel() {
            const panel = document.getElementById('changesPanel');
            panel.classList.remove('show');
            setTimeout(() => {
                panel.style.display = 'none';
            }, 300); // Wait for animation to complete
        }
        
        function getChangeIcon(type) {
            switch(type) {
                case 'campaign_added': return '➕';
                case 'campaign_modified': return '✏️';
                case 'campaign_removed': return '🗑️';
                case 'date_changed': return '📅';
                case 'budget_updated': return '💰';
                case 'approval_needed': return '⏳';
                default: return '📝';
            }
        }
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function markAllChangesRead() {
            pendingChanges = [];
            updateNotificationBadges();
            hideChangesPanel();
            showToast('📋 All changes marked as read');
        }
        
        function toggleChangeComplete(index) {
            const checkbox = document.getElementById(`change-${index}`);
            const changeItem = document.querySelector(`[data-change-id="${index}"]`);
            
            if (checkbox.checked) {
                changeItem.style.opacity = '0.5';
                changeItem.style.textDecoration = 'line-through';
                pendingChanges[index].completed = true;
                showToast(`✅ "${pendingChanges[index].title}" completed`);
            } else {
                changeItem.style.opacity = '1';
                changeItem.style.textDecoration = 'none';
                pendingChanges[index].completed = false;
            }
            
            // Update badges to show only incomplete items
            const incompleteCount = pendingChanges.filter(change => !change.completed).length;
            const clientBadge = document.getElementById('clientNotificationBadge');
            const fabBadge = document.getElementById('fabNotificationBadge');
            
            if (incompleteCount > 0) {
                if (clientBadge) {
                    clientBadge.style.display = 'block';
                    clientBadge.textContent = incompleteCount;
                }
                if (fabBadge) {
                    fabBadge.style.display = 'block';
                    fabBadge.textContent = incompleteCount;
                }
            } else {
                if (clientBadge) clientBadge.style.display = 'none';
                if (fabBadge) fabBadge.style.display = 'none';
                // All completed - show celebration
                if (pendingChanges.length > 0) {
                    setTimeout(() => {
                        showToast('🎉 All changes completed! Great work!');
                        setTimeout(() => {
                            pendingChanges = [];
                            updateNotificationBadges();
                            hideChangesPanel();
                        }, 2000);
                    }, 500);
                }
            }
        }
        
        function approveAllChanges() {
            showCelebration();
            showToast('🎆 All changes approved! Celebration time!');
            setTimeout(() => {
                pendingChanges = [];
                updateNotificationBadges();
                hideChangesPanel();
            }, 2000);
        }
        
        function showCelebration() {
            const overlay = document.getElementById('celebrationOverlay');
            overlay.classList.add('show');
            
            // Add some extra fireworks dynamically
            setTimeout(() => {
                for (let i = 0; i < 3; i++) {
                    const extraFireworks = document.createElement('div');
                    extraFireworks.className = 'fireworks';
                    const randomTop = Math.random() * 80 + 10;
                    const randomLeft = Math.random() * 80 + 10;
                    const randomDelay = Math.random() * 2;
                    extraFireworks.style.cssText = `top: ${randomTop}%; left: ${randomLeft}%; animation-delay: ${randomDelay}s;`;
                    extraFireworks.textContent = ['🎆', '✨', '🎇'][i % 3];
                    overlay.appendChild(extraFireworks);
                    
                    // Remove after animation
                    setTimeout(() => {
                        if (extraFireworks.parentNode) {
                            extraFireworks.remove();
                        }
                    }, 3000 + randomDelay * 1000);
                }
            }, 500);
            
            // Auto-hide after 8 seconds if user doesn't click
            setTimeout(() => {
                if (overlay.classList.contains('show')) {
                    hideCelebration();
                }
            }, 8000);
        }
        
        function hideCelebration() {
            document.getElementById('celebrationOverlay').classList.remove('show');
        }
        
        // Initialize Calendar Manager (make it global for debugging)
        console.log('Creating CalendarManager instance...');
        const calendarManager = new CalendarManager();
        window.calendarManager = calendarManager; // Make accessible globally
        console.log('CalendarManager created successfully');
        
        // Ensure clean state on initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Start with clean state - no changes panel showing
            pendingChanges = [];
            updateNotificationBadges();
            hideChangesPanel();

            // Initialize file upload drag-and-drop functionality
            initializeFileUpload();

            // Ensure calendar is rendered on load
            if (calendarManager) {
                console.log('Initial calendar render...');
                calendarManager.renderCalendar();
                calendarManager.updateStats();
            }
        });
        
        function initializeFileUpload() {
            const fileUploadArea = document.getElementById('fileUploadArea');

            if (fileUploadArea && !fileUploadArea.dataset.initialized) {
                fileUploadArea.dataset.initialized = 'true';

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, () => fileUploadArea.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    fileUploadArea.addEventListener(eventName, () => fileUploadArea.classList.remove('dragover'), false);
                });

                fileUploadArea.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        document.getElementById('fileInput').files = files;
                        handleFileSelect({ target: { files: files } });
                    }
                }, false);

                // Safari-compatible click handler
                fileUploadArea.addEventListener('click', (e) => {
                    // Don't trigger if clicking the input itself
                    if (e.target.id !== 'fileInput') {
                        const fileInput = document.getElementById('fileInput');
                        if (fileInput) {
                            fileInput.click();
                        }
                    }
                });
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        }
        
        // Calendar Grading System
        let currentGradingData = null;
        let originalCalendarState = null;
        
        // Initialize engaging elements for the grade button
        function initializeGradeEngagement() {
            const gradeCard = document.querySelector('.grade-card');
            const curiosityBadge = document.getElementById('curiosityBadge');
            const hoverHint = document.getElementById('gradeHoverHint');
            const gradeLabel = document.getElementById('gradeLabel');
            
            if (!gradeCard) return;
            
            // Badge message - simplified to just "NEW!"
            const badgeMessage = 'NEW!';
            
            // Array of hover hints
            const hoverHints = [
                'Discover your score!',
                'How good is your calendar?',
                'Get AI-powered insights!',
                'See your optimization score',
                'Unlock performance metrics',
                'Grade your email strategy',
                'Get expert feedback',
                'Analyze campaign performance',
                'Find hidden opportunities'
            ];
            
            // Array of teasing labels
            const teasingLabels = [
                'Mystery Score',
                'Hidden Grade',
                'Secret Rating',
                'Performance',
                'AI Analysis',
                'Score Unknown',
                'Grade Pending'
            ];
            
            let hintIndex = 0;
            let hasBeenClicked = localStorage.getItem('gradeButtonClicked') === 'true';
            
            // If never clicked, make it extra enticing
            if (!hasBeenClicked) {
                // Show the NEW! badge
                if (curiosityBadge) {
                    curiosityBadge.textContent = badgeMessage;
                    curiosityBadge.style.display = 'block';
                }
                
                // Rotate hover hints
                if (hoverHint) {
                    setInterval(() => {
                        hintIndex = (hintIndex + 1) % hoverHints.length;
                        if (!gradeCard.classList.contains('has-grade')) {
                            hoverHint.textContent = hoverHints[hintIndex];
                        }
                    }, 3000);
                }
                
                // Add a random teasing label
                if (gradeLabel && !gradeCard.classList.contains('has-grade')) {
                    const randomLabel = teasingLabels[Math.floor(Math.random() * teasingLabels.length)];
                    gradeLabel.textContent = randomLabel;
                }
                
                // Show a nudge after 5 seconds of inactivity - DISABLED per user request
                // setTimeout(() => {
                //     if (!hasBeenClicked && !gradeCard.classList.contains('has-grade')) {
                //         showGradeNudge();
                //     }
                // }, 5000);
                
                // Add mouse tracking effect
                let mouseNearCount = 0;
                document.addEventListener('mousemove', (e) => {
                    const rect = gradeCard.getBoundingClientRect();
                    const distance = Math.sqrt(
                        Math.pow(e.clientX - (rect.left + rect.width/2), 2) +
                        Math.pow(e.clientY - (rect.top + rect.height/2), 2)
                    );
                    
                    if (distance < 150 && !gradeCard.classList.contains('has-grade')) {
                        mouseNearCount++;
                        if (mouseNearCount === 3) {
                            // After hovering near 3 times, make it pulse more
                            gradeCard.style.animation = 'attention-pulse 1s ease-in-out infinite';
                        }
                    }
                });
            } else {
                // If clicked before, hide the badge
                if (curiosityBadge) {
                    curiosityBadge.style.display = 'none';
                }
            }
            
            // Track when grade button is clicked
            const originalGradeCalendar = window.gradeCalendar;
            window.gradeCalendar = async function() {
                localStorage.setItem('gradeButtonClicked', 'true');
                hasBeenClicked = true;
                
                // Hide curiosity badge when clicked
                if (curiosityBadge) {
                    curiosityBadge.style.display = 'none';
                }
                
                // Call original function
                return originalGradeCalendar.apply(this, arguments);
            };
        }
        
        // Show a nudge tooltip
        function showGradeNudge() {
            const gradeCard = document.querySelector('.grade-card');
            if (!gradeCard || gradeCard.classList.contains('has-grade')) return;
            
            // Create nudge tooltip
            const nudge = document.createElement('div');
            nudge.style.cssText = `
                position: absolute;
                top: -40px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #ff0080, #ff8c00);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 700;
                white-space: nowrap;
                z-index: 100;
                animation: nudge-bounce 2s ease-in-out;
                pointer-events: none;
            `;
            nudge.textContent = '👆 Grade your calendar for AI insights!';
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes nudge-bounce {
                    0%, 100% { transform: translateX(-50%) translateY(0); opacity: 0; }
                    20%, 80% { opacity: 1; }
                    30%, 50%, 70% { transform: translateX(-50%) translateY(-5px); }
                    40%, 60% { transform: translateX(-50%) translateY(0); }
                }
            `;
            document.head.appendChild(style);
            
            gradeCard.appendChild(nudge);
            
            // Remove after animation
            setTimeout(() => {
                nudge.remove();
            }, 2000);
        }
        
        async function gradeCalendar() {
            // Mark that the grade button has been clicked
            localStorage.setItem('gradeButtonClicked', 'true');
            
            // Hide the NEW! badge
            const curiosityBadge = document.getElementById('curiosityBadge');
            if (curiosityBadge) {
                curiosityBadge.style.display = 'none';
            }
            
            if (!calendarManager.selectedClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            if (calendarManager.campaigns.length === 0) {
                showToast('No campaigns to grade. Add some campaigns first!', 'warning');
                return;
            }
            
            // Store original state for comparison
            originalCalendarState = JSON.parse(JSON.stringify(calendarManager.campaigns));
            
            // Show loading state
            document.getElementById('gradingModal').classList.add('show');
            document.getElementById('gradingResults').innerHTML = `
                <div class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-lime-400 border-t-transparent"></div>
                    <p class="mt-4 text-white/60">Analyzing calendar performance...</p>
                </div>
            `;
            
            try {
                // Prepare request data
                const requestData = {
                    campaigns: calendarManager.campaigns,
                    revenue_goal: calendarManager.currentMonthGoal || 50000,
                    client_name: calendarManager.selectedClient.name,
                    client_id: calendarManager.selectedClient.id,
                    industry_type: calendarManager.selectedClient.industry || 'e-commerce',
                    audience_segments: calendarManager.affinitySegments.map(s => s.name)
                };

                // Call grading API
                const response = await authenticatedFetch('/api/calendar/grade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                // Check if endpoint doesn't exist (404) - feature not yet implemented
                if (response.status === 404) {
                    document.getElementById('gradingResults').innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">🚀</div>
                            <p class="text-xl text-white mb-2">Grading Feature Coming Soon!</p>
                            <p class="text-sm text-white/60">We're building an AI-powered calendar grading system.</p>
                            <p class="text-sm text-white/60 mt-2">Check back soon for performance insights and recommendations!</p>
                        </div>
                    `;
                    return;
                }

                if (!response.ok) throw new Error('Failed to grade calendar');

                const gradingData = await response.json();
                currentGradingData = gradingData;

                // Render grading results
                renderGradingResults(gradingData);

                // Update the FAB with the grade
                updateGradeFAB(gradingData.overall_grade, gradingData.score);

            } catch (error) {
                console.debug('Grading feature not available:', error);
                // Show friendly message for any errors
                document.getElementById('gradingResults').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">🚀</div>
                        <p class="text-xl text-white mb-2">Grading Feature Coming Soon!</p>
                        <p class="text-sm text-white/60">We're building an AI-powered calendar grading system.</p>
                        <p class="text-sm text-white/60 mt-2">Check back soon for performance insights and recommendations!</p>
                    </div>
                `;
                // Don't show error toast - just display friendly message
                return;
            }
        }
        
        function renderGradingResults(data) {
            const gradeColors = {
                'A+': '#00FF00',
                'A': '#7FFF00',
                'B': '#FFFF00',
                'C': '#FFA500',
                'D': '#FF4500',
                'F': '#FF0000'
            };
            
            const gradeColor = gradeColors[data.overall_grade] || '#FFFFFF';
            
            let html = `
                <div class="grade-header text-center mb-8">
                    <div class="inline-block">
                        <div class="text-6xl font-black mb-2" style="color: ${gradeColor}; text-shadow: 0 0 20px ${gradeColor};">
                            ${data.overall_grade}
                        </div>
                        <div class="text-2xl text-white/80">${data.score}/100 points</div>
                    </div>
                </div>
                
                <!-- Score Breakdown -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    ${renderScoreSection('📊 Revenue Alignment', data.revenue_score)}
                    ${renderScoreSection('⏰ Timing & Spacing', data.timing_score)}
                    ${renderScoreSection('😴 Audience Fatigue', data.fatigue_score)}
                    ${renderScoreSection('📈 Historical Alignment', data.historical_score)}
                </div>
                
                <!-- Top Recommendations -->
                <div class="glass-card p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4 gradient-text">🎯 Top Recommendations</h3>
                    <div class="space-y-3">
                        ${data.recommendations.map(rec => `
                            <div class="flex items-start gap-3">
                                <span class="text-${rec.impact === 'high' ? 'red' : rec.impact === 'medium' ? 'yellow' : 'blue'}-400">
                                    ${rec.impact === 'high' ? '🔴' : rec.impact === 'medium' ? '🟡' : '🔵'}
                                </span>
                                <div class="flex-1">
                                    <div class="text-sm text-white/60">${rec.category}</div>
                                    <div class="text-white">${rec.recommendation}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- AI Insights -->
                ${data.insights.length > 0 ? `
                    <div class="glass-card p-6">
                        <h3 class="text-xl font-bold mb-4 gradient-text">💡 AI Insights</h3>
                        <div class="space-y-2">
                            ${data.insights.map(insight => `
                                <div class="text-white/80">• ${insight}</div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('gradingResults').innerHTML = html;
        }
        
        function renderScoreSection(title, scoreData) {
            const percentage = (scoreData.points / scoreData.max_points) * 100;
            const barColor = percentage >= 80 ? '#00FF00' : percentage >= 60 ? '#FFFF00' : percentage >= 40 ? '#FFA500' : '#FF0000';
            
            return `
                <div class="glass-card p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">${title}</span>
                        <span class="text-white/60">${scoreData.points}/${scoreData.max_points}</span>
                    </div>
                    <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full transition-all duration-500" style="width: ${percentage}%; background: ${barColor};"></div>
                    </div>
                    ${scoreData.issues && scoreData.issues.length > 0 ? `
                        <div class="mt-2 text-xs text-red-400">
                            ${scoreData.issues[0]}
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function closeGradingModal() {
            document.getElementById('gradingModal').classList.remove('show');
            currentGradingData = null;
        }
        
        // Grade calendar silently (just update the grade card, no modal)
        async function gradeCalendarSilent() {
            if (!calendarManager.selectedClient || calendarManager.campaigns.length === 0) {
                return;
            }
            
            try {
                const requestData = {
                    campaigns: calendarManager.campaigns,
                    revenue_goal: calendarManager.currentMonthGoal || 50000,
                    client_name: calendarManager.selectedClient.name,
                    client_id: calendarManager.selectedClient.id,
                    industry_type: calendarManager.selectedClient.industry || 'e-commerce',
                    audience_segments: calendarManager.affinitySegments.map(s => s.name)
                };
                
                const response = await fetch('/api/calendar/grade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const gradingData = await response.json();
                    // Just update the grade display, no modal
                    updateGradeFAB(gradingData.overall_grade, gradingData.score);
                    showToast(`📊 New grade: ${gradingData.overall_grade} (${gradingData.score}/100)`, 'info');
                }
            } catch (error) {
                console.error('Silent grading error:', error);
            }
        }
        
        // Grade calendar and return full data (for internal use, updates modal)
        async function gradeCalendarFull() {
            if (!calendarManager.selectedClient || calendarManager.campaigns.length === 0) {
                return null;
            }
            
            try {
                const requestData = {
                    campaigns: calendarManager.campaigns,
                    revenue_goal: calendarManager.currentMonthGoal || 50000,
                    client_name: calendarManager.selectedClient.name,
                    client_id: calendarManager.selectedClient.id,
                    industry_type: calendarManager.selectedClient.industry || 'e-commerce',
                    audience_segments: calendarManager.affinitySegments.map(s => s.name),
                    original_campaigns: originalCalendarState // Include for comparison
                };
                
                const response = await fetch('/api/calendar/grade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    const gradingData = await response.json();
                    currentGradingData = gradingData;
                    return gradingData;
                }
            } catch (error) {
                console.error('Grading error:', error);
            }
            return null;
        }
        
        // Update the Grade display with the current grade
        function updateGradeFAB(grade, score) {
            // Update the stat card
            const gradeCard = document.querySelector('.grade-card');
            const gradeDisplay = document.getElementById('gradeDisplay');
            const curiosityBadge = document.getElementById('curiosityBadge');
            const hoverHint = document.getElementById('gradeHoverHint');
            
            // Check if elements exist
            if (!gradeCard || !gradeDisplay) {
                console.error('Grade card elements not found');
                return;
            }
            
            // Remove all grade classes first
            gradeCard.className = gradeCard.className.replace(/grade-[a-f]-?[a-z]*/g, '');
            
            // Remove the needs-grading animation and curiosity badge
            gradeCard.classList.remove('needs-grading');
            if (curiosityBadge) curiosityBadge.style.display = 'none';
            if (hoverHint) hoverHint.textContent = 'Click to re-grade';
            
            // Add the appropriate grade class for background gradient
            const gradeClass = {
                'A+': 'grade-a-plus',
                'A': 'grade-a',
                'B': 'grade-b',
                'B+': 'grade-b',
                'C': 'grade-c',
                'C+': 'grade-c',
                'D': 'grade-d',
                'D+': 'grade-d',
                'F': 'grade-f'
            }[grade] || 'grade-c';
            
            gradeCard.classList.add(gradeClass);
            gradeCard.classList.add('has-grade');
            
            // Show the grade in the gradeDisplay element
            gradeDisplay.innerHTML = `<span class="grade-icon" aria-hidden="true">🧑‍🏫</span><span>${grade}</span>`;
            gradeDisplay.style.fontSize = '36px'; // Match the stat-value size
            
            // Set color based on grade
            const gradeColors = {
                'A+': '#00FF00',
                'A': '#7FFF00',
                'B+': '#9ACD32',
                'B': '#FFFF00',
                'C+': '#FFD700',
                'C': '#FFA500',
                'D+': '#FF8C00',
                'D': '#FF4500',
                'F': '#FF0000'
            };
            
            const color = gradeColors[grade] || '#FFFFFF';
            gradeDisplay.style.color = color;
            gradeDisplay.style.textShadow = `0 0 20px ${color}`;
            
            // Add special border glow based on grade quality
            if (score >= 95) {
                gradeCard.style.borderColor = 'rgba(0, 255, 0, 0.6)';
                gradeCard.style.boxShadow = '0 0 30px rgba(0, 255, 0, 0.4), inset 0 0 20px rgba(0, 255, 0, 0.1)';
            } else if (score >= 90) {
                gradeCard.style.borderColor = 'rgba(127, 255, 0, 0.5)';
                gradeCard.style.boxShadow = '0 0 25px rgba(127, 255, 0, 0.3)';
            } else if (score >= 80) {
                gradeCard.style.borderColor = 'rgba(255, 255, 0, 0.5)';
                gradeCard.style.boxShadow = '0 0 20px rgba(255, 255, 0, 0.3)';
            } else if (score >= 70) {
                gradeCard.style.borderColor = 'rgba(255, 215, 0, 0.5)';
                gradeCard.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.3)';
            } else if (score >= 60) {
                gradeCard.style.borderColor = 'rgba(255, 165, 0, 0.5)';
                gradeCard.style.boxShadow = '0 0 20px rgba(255, 165, 0, 0.3)';
            } else {
                gradeCard.style.borderColor = 'rgba(255, 69, 0, 0.5)';
                gradeCard.style.boxShadow = '0 0 20px rgba(255, 69, 0, 0.3)';
            }
        }
        
        async function applyGradeRecommendations() {
            if (!currentGradingData) return;
            
            showToast('✨ Applying AI recommendations...', 'info');
            
            // Show processing state
            const resultsDiv = document.getElementById('gradingResults');
            const originalContent = resultsDiv.innerHTML;
            
            resultsDiv.innerHTML += `
                <div class="mt-6 p-4 glass-card">
                    <div class="flex items-center gap-3">
                        <div class="animate-spin rounded-full h-6 w-6 border-2 border-lime-400 border-t-transparent"></div>
                        <span class="text-white/80">Optimizing calendar with AI workflow...</span>
                    </div>
                </div>
            `;
            
            try {
                // Call the campaign optimizer workflow
                const optimizationRequest = {
                    grading_data: currentGradingData,
                    current_campaigns: calendarManager.campaigns,
                    revenue_goal: calendarManager.currentMonthGoal || 50000,
                    client_context: {
                        client_id: calendarManager.selectedClient.id,
                        client_name: calendarManager.selectedClient.name,
                        industry: calendarManager.selectedClient.industry || 'e-commerce',
                        segments: calendarManager.affinitySegments
                    },
                    optimization_level: 'balanced' // Can be aggressive, balanced, or conservative
                };
                
                // Execute optimizations directly on the calendar
                const optimizations = await executeOptimizations(currentGradingData);
                
                // Apply each optimization with visual feedback
                let appliedCount = 0;
                for (const optimization of optimizations) {
                    await applyOptimization(optimization);
                    appliedCount++;
                    showToast(`Applied ${appliedCount}/${optimizations.length} optimizations...`, 'info');
                }
                
                // Update calendar display
                calendarManager.renderCalendar();
                calendarManager.updateStats();
                
                // Show success and update grade indicator
                showToast(`✅ Applied ${appliedCount} AI optimizations successfully!`, 'success');
                
                // Re-grade the calendar silently to update the main dashboard
                await gradeCalendarSilent();
                
                // Save changes to Firestore
                calendarManager.saveToCloud();
                
                // Also update the modal to show new grade
                resultsDiv.innerHTML = `
                    <div class="glass-card p-6 text-center">
                        <div class="text-6xl mb-4">🎉</div>
                        <h3 class="text-2xl font-bold text-lime-400 mb-2">Optimizations Applied!</h3>
                        <p class="text-white/60 mb-4">Your calendar has been improved. Recalculating grade...</p>
                        <div class="animate-spin rounded-full h-8 w-8 border-2 border-lime-400 border-t-transparent mx-auto"></div>
                    </div>
                `;
                
                // Re-grade to show improvement in the modal
                setTimeout(async () => {
                    const newGradingData = await gradeCalendarFull();
                    if (newGradingData) {
                        renderGradingResults(newGradingData);
                        // Update the main dashboard again with the final grade
                        updateGradeFAB(newGradingData.overall_grade, newGradingData.score);
                        
                        setTimeout(() => {
                            closeGradingModal();
                        }, 2000);
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Optimization error:', error);
                showToast('Failed to apply optimizations', 'error');
                resultsDiv.innerHTML = originalContent;
            }
        }
        
        // Execute optimizations based on grading data
        async function executeOptimizations(gradingData) {
            const optimizations = [];
            
            // 1. Fix timing issues
            if (gradingData.timing_score.points < 15) {
                optimizations.push(...generateSpacingOptimizations());
            }
            
            // 2. Fix revenue issues
            if (gradingData.revenue_score.points < 30) {
                optimizations.push(...generateRevenueOptimizations(gradingData.revenue_score));
            }
            
            // 3. Fix audience fatigue
            if (gradingData.fatigue_score.points < 15) {
                optimizations.push(...generateFatigueOptimizations(gradingData.fatigue_score));
            }
            
            return optimizations;
        }
        
        // Generate spacing optimizations
        function generateSpacingOptimizations() {
            const optimizations = [];
            const sortedCampaigns = [...calendarManager.campaigns].sort((a, b) => a.date - b.date);
            
            for (let i = 0; i < sortedCampaigns.length - 1; i++) {
                const current = sortedCampaigns[i];
                const next = sortedCampaigns[i + 1];
                const daysDiff = Math.floor((next.date - current.date) / (1000 * 60 * 60 * 24));
                
                // If campaigns are too close, move the second one
                if (daysDiff < 3) {
                    const newDate = new Date(current.date);
                    newDate.setDate(newDate.getDate() + 3);
                    
                    optimizations.push({
                        type: 'move',
                        campaign: next,
                        oldDate: next.date,
                        newDate: newDate,
                        reason: 'Improve campaign spacing'
                    });
                }
            }
            
            return optimizations;
        }
        
        // Generate revenue optimizations
        function generateRevenueOptimizations(revenueScore) {
            const optimizations = [];
            const gap = revenueScore.gap;
            
            if (gap > 0) {
                // Calculate how many campaigns to add
                const campaignsNeeded = Math.min(3, Math.ceil(gap / 8000));
                
                // Find best dates to add campaigns
                const availableDates = findAvailableDates();
                
                for (let i = 0; i < campaignsNeeded && i < availableDates.length; i++) {
                    optimizations.push({
                        type: 'add',
                        campaign: {
                            name: `Revenue Booster ${i + 1}`,
                            type: 'promotional',
                            date: availableDates[i],
                            channel: i % 2 === 0 ? 'email' : 'sms',
                            segment: calendarManager.affinitySegments[i % calendarManager.affinitySegments.length]?.name || 'all',
                            metrics: { revenue: 8000, openRate: 0.28, clickRate: 0.08 }
                        },
                        reason: 'Close revenue gap'
                    });
                }
            }
            
            return optimizations;
        }
        
        // Generate audience fatigue optimizations
        function generateFatigueOptimizations(fatigueScore) {
            const optimizations = [];
            const segmentCounts = fatigueScore.segment_distribution || {};
            
            // Find over-used segments
            for (const [segment, count] of Object.entries(segmentCounts)) {
                if (count > 4) {
                    // Find campaigns using this segment and change some
                    const overusedCampaigns = calendarManager.campaigns
                        .filter(c => c.segment === segment)
                        .slice(2); // Keep first 2, change the rest
                    
                    for (const campaign of overusedCampaigns) {
                        const newSegment = calendarManager.affinitySegments.find(s => s.name !== segment)?.name || 'engaged_users';
                        optimizations.push({
                            type: 'change_segment',
                            campaign: campaign,
                            oldSegment: segment,
                            newSegment: newSegment,
                            reason: 'Reduce audience fatigue'
                        });
                    }
                }
            }
            
            // Add SMS if missing
            const channelCounts = fatigueScore.channel_distribution || {};
            if (channelCounts.sms === 0 && calendarManager.campaigns.length > 4) {
                // Convert some emails to SMS
                const emailCampaigns = calendarManager.campaigns.filter(c => c.channel === 'email').slice(0, 2);
                for (const campaign of emailCampaigns) {
                    optimizations.push({
                        type: 'change_channel',
                        campaign: campaign,
                        oldChannel: 'email',
                        newChannel: 'sms',
                        reason: 'Add channel diversity'
                    });
                }
            }
            
            return optimizations;
        }
        
        // Find available dates for new campaigns
        function findAvailableDates() {
            const occupiedDates = new Set(calendarManager.campaigns.map(c => c.date.toDateString()));
            const availableDates = [];
            const currentMonth = calendarManager.selectedDate.getMonth();
            const currentYear = calendarManager.selectedDate.getFullYear();
            
            // Check each day of the month
            for (let day = 1; day <= 31; day++) {
                const date = new Date(currentYear, currentMonth, day);
                if (date.getMonth() !== currentMonth) break; // Went to next month
                
                // Skip weekends for B2B
                if (date.getDay() === 0 || date.getDay() === 6) continue;
                
                // Check if date is available and has good spacing
                if (!occupiedDates.has(date.toDateString())) {
                    // Check spacing from other campaigns
                    let hasGoodSpacing = true;
                    for (const campaign of calendarManager.campaigns) {
                        const daysDiff = Math.abs(Math.floor((campaign.date - date) / (1000 * 60 * 60 * 24)));
                        if (daysDiff < 3) {
                            hasGoodSpacing = false;
                            break;
                        }
                    }
                    
                    if (hasGoodSpacing) {
                        availableDates.push(date);
                    }
                }
            }
            
            return availableDates;
        }
        
        // Apply a single optimization to the calendar
        async function applyOptimization(optimization) {
            calendarManager.saveState(); // Save for undo
            
            switch (optimization.type) {
                case 'move':
                    // Find the actual campaign in the manager and update its date
                    const moveTarget = calendarManager.campaigns.find(c => c.id === optimization.campaign.id);
                    if (moveTarget) {
                        moveTarget.date = new Date(optimization.newDate);
                        // Campaign moved
                    }
                    break;
                    
                case 'add':
                    const newCampaign = {
                        id: `ai-${Date.now()}`,
                        name: optimization.campaign.name || 'AI Suggested Campaign',
                        type: optimization.campaign.type || 'promotional',
                        segment: optimization.campaign.segment || 'all',
                        channel: optimization.campaign.channel || 'email',
                        date: new Date(optimization.campaign.date),
                        metrics: optimization.campaign.metrics || { revenue: 5000, openRate: 0.25, clickRate: 0.05 },
                        gradient: calendarManager.getTypeGradient(optimization.campaign.type || 'promotional'),
                        emoji: calendarManager.getTypeEmoji(optimization.campaign.type || 'promotional')
                    };
                    calendarManager.campaigns.push(newCampaign);
                    // Campaign added
                    break;
                    
                case 'change_segment':
                    const segmentTarget = calendarManager.campaigns.find(c => c.id === optimization.campaign.id);
                    if (segmentTarget) {
                        segmentTarget.segment = optimization.newSegment;
                        // Segment changed
                    }
                    break;
                    
                case 'change_channel':
                    const channelTarget = calendarManager.campaigns.find(c => c.id === optimization.campaign.id);
                    if (channelTarget) {
                        channelTarget.channel = optimization.newChannel;
                        // Channel changed
                    }
                    break;
                    
                case 'delete':
                    const deleteIndex = calendarManager.campaigns.findIndex(c => c.id === optimization.campaign.id);
                    if (deleteIndex > -1) {
                        const deleted = calendarManager.campaigns.splice(deleteIndex, 1)[0];
                        // Campaign deleted
                    }
                    break;
            }
            
            // Small delay for visual effect
            await new Promise(resolve => setTimeout(resolve, 200));
        }
        
        // Helper Functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showSaveStatus(type, message) {
            // Redirect to showToast for unified notifications
            showToast(message, type);
        }

        // Clear month with loading feedback
        async function clearMonthWithLoading() {
            const modal = document.getElementById('commandPaletteModal');

            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'fixed top-20 right-4 bg-red-500/20 text-red-400 px-4 py-2 rounded-lg border border-red-500/40 z-50';
            loadingIndicator.innerHTML = '🗑️ Deleting campaigns...';
            document.body.appendChild(loadingIndicator);

            try {
                // Wait for the async deletion to complete
                await calendarManager.clearCurrentMonth();

                // Remove loading indicator
                if (loadingIndicator.parentNode) {
                    loadingIndicator.remove();
                }

                // Close modal only after successful deletion
                if (modal) modal.remove();

                showToast('✅ Month cleared successfully', 'success');
            } catch (error) {
                console.error('Clear month error:', error);

                // Remove loading indicator
                if (loadingIndicator.parentNode) {
                    loadingIndicator.remove();
                }

                showToast('⚠️ Failed to clear some campaigns', 'error');

                // Still close modal on error
                setTimeout(() => {
                    if (modal) modal.remove();
                }, 2000);
            }
        }
        
        // Multi-Day Campaign Functions
        function openMultiDayCampaignModal() {
            if (!calendarManager.selectedClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            const modal = document.getElementById('multiDayCampaignModal');
            modal.classList.add('show');
            
            // Set default dates
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            document.getElementById('multiDayStartDate').value = today.toISOString().split('T')[0];
            document.getElementById('multiDayEndDate').value = nextWeek.toISOString().split('T')[0];
            
            updateMultiDayPreview();
        }
        
        function closeMultiDayCampaignModal() {
            const modal = document.getElementById('multiDayCampaignModal');
            modal.classList.remove('show');
            
            // Clear form
            document.getElementById('multiDayCampaignForm').reset();
            document.getElementById('multiDayPreview').textContent = 'Select dates to see duration';
        }
        
        function updateMultiDayPreview() {
            const startDate = document.getElementById('multiDayStartDate').value;
            const endDate = document.getElementById('multiDayEndDate').value;
            const preview = document.getElementById('multiDayPreview');
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                if (end >= start) {
                    const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    
                    preview.innerHTML = `
                        <span class="text-lime-400">${duration} day${duration > 1 ? 's' : ''}</span>
                        <span class="text-white/60 text-sm ml-2">(${startStr} - ${endStr})</span>
                    `;
                } else {
                    preview.innerHTML = '<span class="text-red-400">End date must be after start date</span>';
                }
            } else {
                preview.textContent = 'Select dates to see duration';
            }
        }
        
        function createMultiDayCampaign(event) {
            event.preventDefault();
            
            const name = document.getElementById('multiDayName').value;
            const startDate = document.getElementById('multiDayStartDate').value;
            const endDate = document.getElementById('multiDayEndDate').value;
            const type = document.getElementById('multiDayType').value;
            const description = document.getElementById('multiDayDescription').value;
            
            // Validate dates
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (end < start) {
                showToast('End date must be after start date', 'error');
                return;
            }
            
            // Create the multi-day campaign
            calendarManager.addMultiDayCampaign(startDate, endDate, name, type, description);
            
            // Close modal
            closeMultiDayCampaignModal();
        }

        async function importMultiDayJson() {
            const jsonInput = document.getElementById('multiDayJsonInput');
            const jsonText = jsonInput.value.trim();

            if (!jsonText) {
                showToast('Please enter JSON data', 'warning');
                return;
            }

            try {
                const events = JSON.parse(jsonText);
                await processJsonImport(events);
            } catch (error) {
                console.error('JSON parse error:', error);
                showToast('Invalid JSON format', 'error');
            }
        }

        function uploadMultiDayJsonFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const events = JSON.parse(e.target.result);
                    await processJsonImport(events);
                } catch (error) {
                    console.error('JSON file parse error:', error);
                    showToast('Invalid JSON file', 'error');
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        async function processJsonImport(events) {
            const errorMessages = [];

            if (!Array.isArray(events)) {
                // Check if it's wrapped in an object
                if (events.events && Array.isArray(events.events)) {
                    events = events.events;
                } else {
                    showJsonImportError(['JSON must be an array of reminders or have an "events" property containing an array']);
                    return;
                }
            }

            if (events.length === 0) {
                showJsonImportError(['No reminders found in JSON array']);
                return;
            }

            let imported = 0;
            let errors = 0;

            for (let i = 0; i < events.length; i++) {
                const event = events[i];
                try {
                    // Validate required fields - need either date (single day) or startDate/endDate (multi-day)
                    const hasDate = event.date || (event.startDate && event.endDate);
                    if (!hasDate) {
                        errorMessages.push(`Reminder ${i + 1}: Missing required date fields (need "date" or "startDate"/"endDate")`);
                        errors++;
                        continue;
                    }

                    // Validate date format
                    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;

                    let startDate, endDate;

                    if (event.startDate && event.endDate) {
                        // Multi-day format
                        if (!dateRegex.test(event.startDate)) {
                            errorMessages.push(`Reminder ${i + 1}: Invalid startDate format "${event.startDate}" (use YYYY-MM-DD)`);
                            errors++;
                            continue;
                        }
                        if (!dateRegex.test(event.endDate)) {
                            errorMessages.push(`Reminder ${i + 1}: Invalid endDate format "${event.endDate}" (use YYYY-MM-DD)`);
                            errors++;
                            continue;
                        }
                        startDate = event.startDate;
                        endDate = event.endDate;
                    } else {
                        // Single date - use same date for start and end
                        if (!dateRegex.test(event.date)) {
                            errorMessages.push(`Reminder ${i + 1}: Invalid date format "${event.date}" (use YYYY-MM-DD)`);
                            errors++;
                            continue;
                        }
                        startDate = event.date;
                        endDate = event.date;
                    }

                    // Validate dates are valid
                    const parsedStart = new Date(startDate);
                    const parsedEnd = new Date(endDate);
                    if (isNaN(parsedStart.getTime())) {
                        errorMessages.push(`Reminder ${i + 1}: Invalid start date "${startDate}"`);
                        errors++;
                        continue;
                    }
                    if (isNaN(parsedEnd.getTime())) {
                        errorMessages.push(`Reminder ${i + 1}: Invalid end date "${endDate}"`);
                        errors++;
                        continue;
                    }

                    // Validate end date is not before start date
                    if (parsedEnd < parsedStart) {
                        errorMessages.push(`Reminder ${i + 1}: End date cannot be before start date`);
                        errors++;
                        continue;
                    }

                    // Warn if missing title
                    if (!event.title && !event.name) {
                        errorMessages.push(`Reminder ${i + 1} (${startDate}): No title provided, using "Imported Reminder"`);
                    }

                    // Create multi-day campaign (reminder) matching the format used by addMultiDayCampaign
                    const multiDayCampaign = {
                        id: `imported_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        name: event.title || event.name || 'Imported Reminder',
                        startDate: startDate,
                        endDate: endDate,
                        type: event.type || 'promotional',
                        description: event.description || '',
                        isMultiDay: true,
                        color: 'multi-day-campaign',
                        emoji: '📅',
                        created_at: new Date().toISOString()
                    };

                    // Add to multiDayCampaigns array (reminders like holidays)
                    calendarManager.multiDayCampaigns.push(multiDayCampaign);

                    // Immediately save to Firestore
                    const clientId = calendarManager.selectedClient?.slug || calendarManager.selectedClient?.id;
                    if (clientId) {
                        authenticatedFetch('/api/calendar/multiday-events', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                client_id: clientId,
                                name: multiDayCampaign.name,
                                start_date: multiDayCampaign.startDate,
                                end_date: multiDayCampaign.endDate,
                                event_type: multiDayCampaign.type,
                                emoji: multiDayCampaign.emoji,
                                description: multiDayCampaign.description,
                                color: multiDayCampaign.color
                            })
                        }).then(async (response) => {
                            if (response.ok) {
                                const created = await response.json();
                                // Update local ID with Firestore ID
                                multiDayCampaign.id = created.id;
                            }
                        }).catch(err => console.warn('Failed to save imported reminder:', err));
                    }

                    imported++;
                } catch (error) {
                    console.error('Error importing reminder:', event, error);
                    errorMessages.push(`Reminder ${i + 1}: ${error.message}`);
                    errors++;
                }
            }

            // Update calendar display if any imports succeeded
            // Note: Individual saves happen during import, no need for full saveToCloud
            if (imported > 0) {
                calendarManager.renderCalendar();
            }

            // Show results
            if (errors > 0 && imported === 0) {
                showJsonImportError(errorMessages);
            } else if (errors > 0) {
                // Partial success - show warnings but close modal
                closeMultiDayCampaignModal();
                showToast(`Imported ${imported} reminders (${errors} errors - check console)`, 'warning');
                console.warn('Import errors:', errorMessages);
            } else {
                closeMultiDayCampaignModal();
                showToast(`Successfully imported ${imported} reminders`, 'success');
            }

            // Clear the JSON input on success
            if (imported > 0) {
                document.getElementById('multiDayJsonInput').value = '';
            }
        }

        function showJsonImportError(messages) {
            const jsonInput = document.getElementById('multiDayJsonInput');

            // Create or update error display
            let errorDiv = document.getElementById('jsonImportErrors');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'jsonImportErrors';
                errorDiv.className = 'mt-3 p-3 bg-red-500/20 border border-red-500/40 rounded-lg text-sm';
                jsonInput.parentNode.insertBefore(errorDiv, jsonInput.nextSibling);
            }

            errorDiv.innerHTML = `
                <div class="font-semibold text-red-400 mb-2">❌ Import Failed</div>
                <ul class="list-disc list-inside text-red-300 space-y-1">
                    ${messages.map(msg => `<li>${msg}</li>`).join('')}
                </ul>
                <div class="mt-2 text-white/50 text-xs">
                    Expected format: [{"date": "YYYY-MM-DD", "title": "...", "type": "...", ...}]
                </div>
            `;

            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 10000);
        }

        function showMultiDayCampaignDetails(campaignId) {
            const campaign = calendarManager.multiDayCampaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            // Populate edit modal fields
            document.getElementById('editMultiDayId').value = campaign.id;
            document.getElementById('editMultiDayName').value = campaign.name || '';
            document.getElementById('editMultiDayEmoji').value = campaign.emoji || '📅';
            document.getElementById('editMultiDayStartDate').value = campaign.startDate;
            document.getElementById('editMultiDayEndDate').value = campaign.endDate;
            document.getElementById('editMultiDayDescription').value = campaign.description || '';

            // Update duration preview
            updateEditMultiDayPreview();

            // Show edit modal
            document.getElementById('editMultiDayModal').classList.add('show');
        }

        function closeEditMultiDayModal() {
            document.getElementById('editMultiDayModal').classList.remove('show');
        }

        function updateEditMultiDayPreview() {
            const startDate = document.getElementById('editMultiDayStartDate').value;
            const endDate = document.getElementById('editMultiDayEndDate').value;
            const preview = document.getElementById('editMultiDayPreview');

            if (startDate && endDate) {
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T00:00:00');

                if (end >= start) {
                    const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    const startStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const endStr = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                    preview.innerHTML = `
                        <span class="text-lime-400">${duration} day${duration > 1 ? 's' : ''}</span>
                        <span class="text-white/60 text-sm ml-2">(${startStr} - ${endStr})</span>
                    `;
                } else {
                    preview.innerHTML = '<span class="text-red-400">End date must be after start date</span>';
                }
            } else {
                preview.textContent = 'Select dates to see duration';
            }
        }

        async function saveMultiDayEdit(event) {
            event.preventDefault();

            const eventId = document.getElementById('editMultiDayId').value;
            const name = document.getElementById('editMultiDayName').value;
            const emoji = document.getElementById('editMultiDayEmoji').value;
            const startDate = document.getElementById('editMultiDayStartDate').value;
            const endDate = document.getElementById('editMultiDayEndDate').value;
            const description = document.getElementById('editMultiDayDescription').value;

            // Validate dates
            const start = new Date(startDate + 'T00:00:00');
            const end = new Date(endDate + 'T00:00:00');

            if (end < start) {
                showToast('End date must be after start date', 'error');
                return;
            }

            // Update local array
            const campaignIndex = calendarManager.multiDayCampaigns.findIndex(c => c.id === eventId);
            if (campaignIndex === -1) {
                showToast('Event not found', 'error');
                return;
            }

            const updatedCampaign = {
                ...calendarManager.multiDayCampaigns[campaignIndex],
                name: name,
                emoji: emoji,
                startDate: startDate,
                endDate: endDate,
                description: description
            };

            // Save to backend
            try {
                const response = await authenticatedFetch(`/api/calendar/multiday-events/${eventId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        start_date: startDate,
                        end_date: endDate,
                        emoji: emoji,
                        description: description
                    })
                });

                if (response.ok) {
                    // Update local array
                    calendarManager.multiDayCampaigns[campaignIndex] = updatedCampaign;
                    calendarManager.renderCalendar();
                    closeEditMultiDayModal();
                    showToast('Multi-day event updated', 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showToast(errorData.detail || 'Failed to update event', 'error');
                }
            } catch (err) {
                console.error('Failed to update multi-day event:', err);
                showToast('Failed to update event', 'error');
            }
        }

        function confirmDeleteMultiDayEvent() {
            const eventId = document.getElementById('editMultiDayId').value;
            if (confirm('Are you sure you want to delete this multi-day event?')) {
                deleteMultiDayEvent(eventId);
            }
        }

        async function deleteMultiDayEvent(eventId) {
            // Remove from local array
            calendarManager.multiDayCampaigns = calendarManager.multiDayCampaigns.filter(c => c.id !== eventId);
            calendarManager.renderCalendar();
            closeEditMultiDayModal();

            // Delete from Firestore
            try {
                const response = await authenticatedFetch(`/api/calendar/multiday-events/${eventId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Multi-day event deleted', 'success');
                } else {
                    showToast('Failed to delete from cloud', 'error');
                }
            } catch (err) {
                console.warn('Failed to delete multi-day event:', err);
                showToast('Failed to delete from cloud', 'error');
            }
        }

        // Legacy function for backwards compatibility
        function deleteMultiDayCampaign(campaignId) {
            if (confirm('Are you sure you want to delete this multi-day campaign?')) {
                deleteMultiDayEvent(campaignId);
                closeCampaignModal();
            }
        }
        
        function showClientModal() {
            document.getElementById('clientModal').classList.add('show');
        }
        
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('show');
        }
        
        // Global wrapper function for client selection (for backward compatibility)
        function selectClient(clientId) {
            if (window.calendarManager) {
                calendarManager.selectClient(clientId);
                // Load strategy summary for the selected client
                loadStrategySummary(clientId);
            } else {
                console.error('CalendarManager not initialized');
            }
        }
        
        function generateWithAI() {
            // Show context modal first
            const modal = document.getElementById('contextModal');
            if (modal) {
                modal.classList.add('show');
                setTimeout(() => {
                    const contextInput = document.getElementById('additionalContext');
                    if (contextInput) contextInput.focus();
                }, 100);
            } else {
                // Fallback to direct generation if modal not found
                console.warn('Context modal not found, generating directly');
                calendarManager.generateWithAI();
            }
        }
        
        function createSingleCampaign() {
            // Placeholder for future functionality
            if (!calendarManager.selectedClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            
            // For now, just open the create campaign modal
            // In the future, this will integrate with a campaign creation workflow
            showToast('Campaign creation coming soon!', 'info');
            
            // You can uncomment this to open the modal for a specific day
            // calendarManager.openCreateCampaignModal(new Date().getDate());
        }
        
        function closeContextModal() {
            const modal = document.getElementById('contextModal');
            if (modal) {
                modal.classList.remove('show');
                const contextInput = document.getElementById('additionalContext');
                if (contextInput) contextInput.value = '';
            }
        }
        
        // AI Generation Overlay Management
        let aiGenerationStartTime = null;
        let aiGenerationTimer = null;

        function showAIGenerationOverlay() {
            const overlay = document.getElementById('aiGenerationOverlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                aiGenerationStartTime = Date.now();
                // Start timer to update elapsed time
                aiGenerationTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - aiGenerationStartTime) / 1000);
                    const timeEl = document.getElementById('aiOverlayTime');
                    if (timeEl) {
                        timeEl.textContent = `Elapsed: ${elapsed}s`;
                    }
                }, 1000);
            }
        }

        function hideAIGenerationOverlay() {
            const overlay = document.getElementById('aiGenerationOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
            if (aiGenerationTimer) {
                clearInterval(aiGenerationTimer);
                aiGenerationTimer = null;
            }
        }

        // Get workflow base URL - localhost for local dev, production for deployed
        function getWorkflowBaseUrl() {
            return window.location.hostname === 'localhost'
                ? 'http://localhost:9000'
                : 'https://emailpilot-simple-p3cxgvcsla-uc.a.run.app';
        }

        async function terminateWorkflow() {
            try {
                console.log('🛑 Terminating workflow...');
                const response = await fetch(`${getWorkflowBaseUrl()}/api/system/terminate`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showToast('Workflow terminated', 'warning');
                } else {
                    showToast('Failed to terminate workflow', 'error');
                }
            } catch (error) {
                console.error('Terminate error:', error);
                showToast('Error terminating workflow', 'error');
            } finally {
                hideAIGenerationOverlay();
            }
        }

        function updateAIOverlayStatus(status, stage = null) {
            const statusEl = document.getElementById('aiOverlayStatus');
            if (statusEl) {
                statusEl.textContent = status;
            }

            // Update stage indicators if provided
            if (stage !== null) {
                const stagesEl = document.getElementById('aiOverlayStages');
                if (stagesEl) {
                    const stages = stagesEl.querySelectorAll('div');
                    stages.forEach((stageDiv, index) => {
                        const icon = stageDiv.querySelector('span:first-child');
                        if (index < stage) {
                            // Completed
                            stageDiv.classList.remove('text-white/50');
                            stageDiv.classList.add('text-green-400');
                            if (icon) icon.textContent = '✓';
                        } else if (index === stage) {
                            // Current
                            stageDiv.classList.remove('text-white/50');
                            stageDiv.classList.add('text-purple-400');
                            if (icon) icon.textContent = '>';
                        } else {
                            // Pending
                            stageDiv.classList.remove('text-green-400', 'text-purple-400');
                            stageDiv.classList.add('text-white/50');
                            if (icon) icon.textContent = '-';
                        }
                    });
                }
            }
        }

        async function pollWorkflowStatus(jobId) {
            const pollInterval = 3000; // 3 seconds
            const maxAttempts = 120; // 6 minutes max
            let attempts = 0;

            return new Promise((resolve, reject) => {
                const poll = async () => {
                    attempts++;
                    if (attempts > maxAttempts) {
                        reject(new Error('Workflow timed out'));
                        return;
                    }

                    try {
                        const response = await fetch(`${getWorkflowBaseUrl()}/api/jobs/${jobId}`);
                        if (!response.ok) {
                            throw new Error(`Status check failed: ${response.status}`);
                        }

                        const data = await response.json();
                        const status = data.status;
                        console.log(`📊 Poll #${attempts}: status=${status}`, data);

                        // Update overlay based on status
                        if (status === 'analyzing') {
                            updateAIOverlayStatus('Analyzing client data...', 0);
                        } else if (status === 'generating') {
                            updateAIOverlayStatus('Generating campaign strategy...', 1);
                        } else if (status === 'creating') {
                            updateAIOverlayStatus('Creating calendar events...', 2);
                        } else if (status === 'pending_review') {
                            updateAIOverlayStatus('Calendar generated successfully!', 3);
                            resolve(data);
                            return;
                        } else if (status === 'failed') {
                            reject(new Error(data.error || 'Workflow failed'));
                            return;
                        }

                        // Continue polling
                        setTimeout(poll, pollInterval);
                    } catch (error) {
                        reject(error);
                    }
                };

                poll();
            });
        }

        async function submitContextAndGenerate() {
            const contextInput = document.getElementById('additionalContext');
            const additionalContext = contextInput ? contextInput.value.trim() : '';

            // Close the modal
            closeContextModal();

            // Validate client selection
            if (!calendarManager.selectedClient) {
                showToast('Please select a client first', 'warning');
                return;
            }

            // Get client slug
            const clientSlug = calendarManager.selectedClient.client_slug ||
                             calendarManager.selectedClient.slug ||
                             calendarManager.selectedClient.id;

            // Get date range from current calendar view
            const selectedDate = calendarManager.selectedDate;
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();

            // Start of month
            const startDate = new Date(year, month, 1);
            const startDateStr = startDate.toISOString().split('T')[0];

            // End of month
            const endDate = new Date(year, month + 1, 0);
            const endDateStr = endDate.toISOString().split('T')[0];

            // Show processing overlay
            showAIGenerationOverlay();
            updateAIOverlayStatus('Starting workflow...', 0);

            try {
                // Gather multi-day campaigns that overlap with the date range
                const multiDayCampaigns = (calendarManager.multiDayCampaigns || [])
                    .filter(campaign => {
                        const campStart = new Date(campaign.startDate);
                        const campEnd = new Date(campaign.endDate);
                        return campEnd >= startDate && campStart <= endDate;
                    })
                    .map(campaign => ({
                        name: campaign.name,
                        startDate: campaign.startDate,
                        endDate: campaign.endDate,
                        type: campaign.type,
                        description: campaign.description || ''
                    }));

                // Gather affinity segments
                const affinitySegments = (calendarManager.affinitySegments || [])
                    .map(seg => ({
                        name: seg.name,
                        definition: seg.definition || ''
                    }));

                // Call the workflow checkpoint API
                const payload = {
                    clientName: clientSlug,
                    startDate: startDateStr,
                    endDate: endDateStr,
                    stage: 'full',
                    userInstructions: additionalContext,
                    multiDayCampaigns: multiDayCampaigns,
                    affinitySegments: affinitySegments
                };
                console.log('📤 Sending workflow payload:', JSON.stringify(payload, null, 2));
                console.log('📤 Selected client object:', calendarManager.selectedClient);
                console.log('📤 Multi-day campaigns:', multiDayCampaigns);
                console.log('📤 Affinity segments:', affinitySegments);

                const response = await fetch(`${getWorkflowBaseUrl()}/api/workflow/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to start workflow: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('📥 Workflow response:', JSON.stringify(result, null, 2));

                // Handle both response formats: {jobId: ...} or {data: {job_id: ...}}
                const jobId = result.jobId || result.job_id || result.data?.job_id;

                if (!jobId) {
                    console.error('❌ Could not find job_id in response:', result);
                    throw new Error('No job ID returned from workflow');
                }

                console.log('✅ Got job ID:', jobId);

                // Poll for completion
                updateAIOverlayStatus('Processing workflow...', 0);
                const finalResult = await pollWorkflowStatus(jobId);

                // Fetch the generated calendar
                if (finalResult.calendarId || finalResult.calendar) {
                    // If calendar data is included in the response
                    if (finalResult.calendar && finalResult.calendar.campaigns) {
                        calendarManager.processCampaigns(finalResult.calendar.campaigns);
                        showToast(`Generated ${finalResult.calendar.campaigns.length} campaigns!`, 'success');
                    } else {
                        // Reload calendar from cloud
                        await calendarManager.loadFromCloud();
                        showToast('Calendar generated successfully!', 'success');
                    }
                    calendarManager.updateStats();
                }

                hideAIGenerationOverlay();

            } catch (error) {
                console.error('AI generation workflow failed:', error);
                hideAIGenerationOverlay();
                showToast(`Generation failed: ${error.message}`, 'error');
            }
        }

        // New CRUD Functions
        function duplicateCampaign(campaignId) {
            calendarManager.duplicateCampaign(campaignId);
        }

        function editCampaign(campaignId) {
            calendarManager.editCampaign(campaignId);
        }

        function confirmDeleteCampaign(campaignId) {
            calendarManager.confirmDeleteCampaign(campaignId);
        }

        // Handle list view button actions with proper event handling
        function handleListAction(event, action, campaignId) {
            // Prevent event from bubbling up to parent elements
            event.stopPropagation();
            event.preventDefault();

            // Execute the appropriate action
            switch(action) {
                case 'details':
                    toggleCampaignDetails(campaignId);
                    break;
                case 'duplicate':
                    duplicateCampaign(campaignId);
                    break;
                case 'edit':
                    editCampaign(campaignId);
                    break;
                case 'delete':
                    confirmDeleteCampaign(campaignId);
                    break;
                default:
                    console.error('Unknown action:', action);
            }
            
            // Prevent any default behavior
            return false;
        }

        async function createApprovalPage() {
            if (!calendarManager.selectedClient) {
                showToast('Please select a client first', 'warning');
                return;
            }

            if (calendarManager.campaigns.length === 0) {
                showToast('No campaigns to share. Add some campaigns first!', 'warning');
                return;
            }

            // Validate that client has Asana project link configured
            const client = calendarManager.selectedClient;
            if (!client.asana_project_link) {
                showToast(`⚠️ ${client.name} does not have an Asana project link configured. Please add it in the orchestrator before creating approval.`, 'error', 8000);
                return;
            }

            // Show the aviation loading animation
            showAviationLoader();

            // BUGFIX: Removed saveToCloud() call that was creating duplicates (line 9868)
            // Creating an approval page should only READ campaign data, not save it.
            // The campaigns are already saved when edited in the calendar.
            // This was causing 521 duplicate documents (24 campaigns × ~22 saves = 521 total)

            // client is already declared above at line 6477
            const date = calendarManager.selectedDate;
            const year = date.getFullYear();
            const monthInt = date.getMonth() + 1;  // Integer month (1-12)
            const monthStr = String(monthInt).padStart(2, '0');  // String month with padding ("01"-"12")
            const monthName = date.toLocaleDateString('en-US', { month: 'long' });

            // Generate approval page ID and URL (use padded string for ID)
            const approvalId = `${client.client_slug || client.id}-${year}-${monthStr}`;
            // Public approval URL (works in both local and production)
            const approvalUrl = `${window.location.origin}/calendar-approval/${approvalId}`;
            
            try {
                // Store approval page data in Firestore
                const requestData = {
                    approval_id: approvalId,
                    client_id: client.id || client.slug || client.client_slug,  // Use slug as fallback if id is undefined
                    client_name: client.name,
                    client_slug: client.client_slug || client.slug || null,
                    year: year,
                    month: monthInt,  // Send as integer for Pydantic validation
                    month_name: monthName,
                    campaigns: calendarManager.campaigns.map(c => {
                        // Ensure date is ISO string
                        const campaignCopy = { ...c };
                        if (campaignCopy.date instanceof Date) {
                            campaignCopy.date = campaignCopy.date.toISOString();
                        }
                        // Remove any non-serializable fields
                        delete campaignCopy.$$hashKey;  // Angular artifacts
                        return campaignCopy;
                    }),
                    created_at: new Date().toISOString(),
                    status: 'pending',
                    editable: true
                };

                console.log('[Approval Debug] Request data:', JSON.stringify(requestData, null, 2));

                const response = await authenticatedFetch('/api/calendar/approval/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Approval Error] Status:', response.status, 'Body:', errorText);
                    throw new Error(`Failed to create approval page: ${response.status} - ${errorText}`);
                }

                const result = await response.json();

                // Create Asana task with approval link (don't block on this)
                try {
                    const asanaResponse = await authenticatedFetch('/api/calendar/approval/create-asana-task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            client_id: client.id || client.slug || client.client_slug,  // Use slug as fallback
                            client_name: client.name,
                            approval_url: approvalUrl,
                            month: monthName,
                            year: year
                        })
                    });

                    if (asanaResponse.ok) {
                        const asanaResult = await asanaResponse.json();
                        console.log('✅ Created Asana approval task:', asanaResult.task_url);
                        showToast(`✅ Created approval task in Asana`, 'success');
                    } else {
                        const errorData = await asanaResponse.json().catch(() => ({detail: 'Unknown error'}));
                        console.warn('⚠️ Could not create Asana task:', errorData.detail);
                        showToast(`⚠️ Approval created but Asana task failed: ${errorData.detail}`, 'warning');
                    }
                } catch (asanaError) {
                    console.error('Error creating Asana task:', asanaError);
                    // Don't block the main flow - approval page was still created
                }

                // Hide loader and show success modal with the URL
                hideAviationLoader();
                showApprovalPageModal(approvalUrl, client.name, monthName, year);
                
                // Update approval status badge immediately
                checkApprovalStatus();
                
            } catch (error) {
                console.error('Error creating approval page:', error);
                hideAviationLoader();
                showToast('Failed to create approval page', 'error');
            }
        }
        
        // Track previous approval status for change notifications
        let previousApprovalStatus = null;
        let approvalRefreshInterval = null;

        // Check and display approval status
        async function checkApprovalStatus() {
            if (!calendarManager.selectedClient) return;

            const client = calendarManager.selectedClient;

            // Ensure client has required identifiers
            const clientId = client.client_slug || client.slug || client.id;
            if (!clientId) {
                console.debug('Client missing required identifier (client_slug, slug, or id)');
                return;
            }

            const date = calendarManager.selectedDate;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const approvalId = `${clientId}-${year}-${month}`;

            try {
                const response = await authenticatedFetch(`/api/calendar/approval/${approvalId}`);

                if (response.ok) {
                    const result = await response.json();
                    const status = result.data.status || 'pending';

                    // Detect status change and notify user
                    if (previousApprovalStatus && previousApprovalStatus !== status && previousApprovalStatus !== 'pending') {
                        const statusMessages = {
                            'approved': '✅ Calendar approved!',
                            'changes_requested': '📝 Changes requested',
                            'rejected': '❌ Calendar rejected'
                        };
                        const message = statusMessages[status] || `Status changed to ${status}`;
                        showToast(message, status === 'approved' ? 'success' : 'warning', 5000);

                        // Request desktop notification permission and show notification
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification('EmailPilot Calendar', {
                                body: message,
                                icon: '/favicon.ico'
                            });
                        } else if ('Notification' in window && Notification.permission !== 'denied') {
                            Notification.requestPermission().then(permission => {
                                if (permission === 'granted') {
                                    new Notification('EmailPilot Calendar', {
                                        body: message,
                                        icon: '/favicon.ico'
                                    });
                                }
                            });
                        }
                    }

                    previousApprovalStatus = status;
                    updateApprovalStatusBadge(status, result.data);
                } else if (response.status === 404 || response.status === 500) {
                    // Expected: No approval exists yet, or server not configured - this is normal
                    console.debug(`No approval found for ${approvalId} (${response.status}) - this is expected`);
                    previousApprovalStatus = null;
                    hideApprovalStatusBadge();
                } else {
                    // Unexpected error
                    console.warn(`Unexpected response checking approval status: ${response.status}`);
                    hideApprovalStatusBadge();
                }
            } catch (error) {
                // Network or other errors - expected if backend is not running
                console.debug('Approval check unavailable:', error.message);
                hideApprovalStatusBadge();
            }
        }

        // Start auto-refresh for approval status (every 30 seconds)
        function startApprovalAutoRefresh() {
            // Clear any existing interval
            stopApprovalAutoRefresh();

            // Check immediately
            checkApprovalStatus();

            // Then check every 30 seconds
            approvalRefreshInterval = setInterval(() => {
                checkApprovalStatus();
            }, 30000); // 30 seconds

            console.log('✅ Auto-refresh enabled for approval status (every 30 seconds)');
        }

        // Stop auto-refresh
        function stopApprovalAutoRefresh() {
            if (approvalRefreshInterval) {
                clearInterval(approvalRefreshInterval);
                approvalRefreshInterval = null;
                console.log('⏹️ Auto-refresh stopped for approval status');
            }
        }
        
        function updateApprovalStatusBadge(status, approvalData) {
            const statusBar = document.getElementById('approvalStatusBar');
            const statusText = document.getElementById('approvalStatusText');
            const unapproveBtn = document.getElementById('unapproveBtn');
            const generateBriefsBtn = document.getElementById('generateBriefsBtn');

            if (!statusBar || !statusText) return;

            // Hide for pending status only
            if (status === 'pending') {
                statusBar.classList.add('hidden');
                if (generateBriefsBtn) generateBriefsBtn.classList.add('hidden');
                return;
            }

            // Show the status bar
            statusBar.classList.remove('hidden');

            // Format dates
            let statusDate = '';
            if (status === 'approved' && approvalData?.approved_at) {
                const date = new Date(approvalData.approved_at.seconds * 1000);
                statusDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            } else if (status === 'changes_requested' && approvalData?.updated_at) {
                const date = new Date(approvalData.updated_at.seconds * 1000);
                statusDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }

            // Update content based on status
            if (status === 'approved') {
                // Approved status - green and prominent
                statusText.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30">
                        <span class="text-base mr-1">✓</span>
                        <span class="font-semibold">Client Approved</span>
                        ${statusDate ? `<span class="text-green-300/70 ml-2 text-xs">${statusDate}</span>` : ''}
                    </span>
                `;
                // Show unapprove button for approved status
                if (unapproveBtn) {
                    unapproveBtn.style.display = 'inline';
                }
                // Show Generate Briefs button for approved calendars
                if (generateBriefsBtn) {
                    generateBriefsBtn.classList.remove('hidden');
                    generateBriefsBtn.dataset.approvalId = approvalData?.id || '';
                }
            } else if (status === 'changes_requested') {
                // Changes requested - orange and prominent
                statusText.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-orange-500/20 text-orange-400 border border-orange-500/30">
                        <span class="text-base mr-1">⚠</span>
                        <span class="font-semibold">Changes Requested</span>
                        ${statusDate ? `<span class="text-orange-300/70 ml-2 text-xs">${statusDate}</span>` : ''}
                    </span>
                `;
                // Hide unapprove button for changes requested
                if (unapproveBtn) {
                    unapproveBtn.style.display = 'none';
                }
                // Hide Generate Briefs button for non-approved calendars
                if (generateBriefsBtn) {
                    generateBriefsBtn.classList.add('hidden');
                }
            }

            // Store approval data for unapprove function
            if (unapproveBtn) {
                unapproveBtn.dataset.approvalId = approvalData?.id || '';
            }
        }
        
        function hideApprovalStatusBadge() {
            const statusBar = document.getElementById('approvalStatusBar');
            if (statusBar) statusBar.classList.add('hidden');
        }
        
        // New function to unapprove calendar (global)
        window.unapproveCalendar = async function() {
            if (!confirm('Remove approval status from this calendar?')) return;
            
            const client = calendarManager.selectedClient;
            const date = calendarManager.selectedDate;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const approvalId = `${client.client_slug || client.id}-${year}-${month}`;
            
            try {
                // Update the approval document to remove approved status
                const response = await authenticatedFetch(`/api/calendar/approval/${approvalId}/unapprove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    hideApprovalStatusBadge();
                    showToast('Approval status removed');
                    // Refresh approval status
                    checkApprovalStatus();
                } else if (response.status === 404) {
                    // Approval doesn't exist or already removed
                    console.debug('Approval not found or already removed');
                    hideApprovalStatusBadge();
                    showToast('Approval already removed');
                } else {
                    showToast('Failed to remove approval', 'error');
                }
            } catch (error) {
                // Network or other errors
                console.debug('Error removing approval:', error.message);
                showToast('Failed to remove approval - backend may be unavailable', 'error');
            }
        }

        // Generate Briefs function - triggers brief generation workflow
        window.generateBriefs = async function() {
            const generateBriefsBtn = document.getElementById('generateBriefsBtn');
            const approvalId = generateBriefsBtn?.dataset.approvalId;

            if (!approvalId) {
                // Construct approval ID from current context
                const client = calendarManager.selectedClient;
                const date = calendarManager.selectedDate;
                if (!client) {
                    showToast('Please select a client first', 'warning');
                    return;
                }
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                var workflowId = `${client.client_slug || client.id}-${year}-${month}`;
            } else {
                var workflowId = approvalId;
            }

            // Confirm with user
            const totalCampaigns = calendarManager.campaigns.length;
            if (!confirm(`Generate briefs for ${totalCampaigns} campaigns?\n\nThis will create detailed campaign briefs based on the approved calendar.`)) {
                return;
            }

            // Update button state
            if (generateBriefsBtn) {
                generateBriefsBtn.disabled = true;
                generateBriefsBtn.innerHTML = '⏳ Generating...';
            }

            try {
                // Step 1: Approve workflow for brief generation
                const approveResponse = await authenticatedFetch(`/api/calendar/workflow/${workflowId}/approve-for-briefs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!approveResponse.ok) {
                    const errorData = await approveResponse.json();
                    throw new Error(errorData.detail || 'Failed to approve for brief generation');
                }

                // Step 2: Trigger brief generation
                const generateResponse = await authenticatedFetch(`/api/calendar/workflow/${workflowId}/generate-briefs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!generateResponse.ok) {
                    const errorData = await generateResponse.json();
                    throw new Error(errorData.detail || 'Failed to start brief generation');
                }

                const result = await generateResponse.json();

                // Show success message
                showToast(`📝 Brief generation started for ${result.total_campaigns} campaigns!`, 'success', 5000);

                // Update button to show in-progress state
                if (generateBriefsBtn) {
                    generateBriefsBtn.innerHTML = '✅ Briefs Generating...';
                    generateBriefsBtn.disabled = true;
                }

                // Poll for completion (optional - could use WebSocket instead)
                pollBriefGenerationStatus(workflowId);

            } catch (error) {
                console.error('Error generating briefs:', error);
                showToast(`Failed to generate briefs: ${error.message}`, 'error', 5000);

                // Reset button state
                if (generateBriefsBtn) {
                    generateBriefsBtn.disabled = false;
                    generateBriefsBtn.innerHTML = '📝 Generate Briefs';
                }
            }
        }

        // TEST FUNCTION: Override to simulate briefs complete state
        window.testBriefsCompleteOverride = function() {
            const statusBar = document.getElementById('approvalStatusBar');
            const statusText = document.getElementById('approvalStatusText');
            const unapproveBtn = document.getElementById('unapproveBtn');
            const generateBriefsBtn = document.getElementById('generateBriefsBtn');

            // Show approval status bar
            if (statusBar) statusBar.classList.remove('hidden');

            // Set to approved state
            if (statusText) {
                statusText.innerHTML = `
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30">
                        <span class="text-base mr-1">✓</span>
                        <span class="font-semibold">Client Approved</span>
                        <span class="text-green-300/70 ml-2 text-xs">[TEST MODE]</span>
                    </span>
                `;
            }

            // Show unapprove button
            if (unapproveBtn) unapproveBtn.style.display = 'inline';

            // Show Generate Briefs button in complete state
            if (generateBriefsBtn) {
                generateBriefsBtn.classList.remove('hidden');
                generateBriefsBtn.innerHTML = '✅ Briefs Complete';
                generateBriefsBtn.disabled = true;

                // Set a test approval ID
                const client = calendarManager.selectedClient;
                const date = calendarManager.selectedDate;
                if (client) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    generateBriefsBtn.dataset.approvalId = `${client.client_slug || client.id}-${year}-${month}`;
                }
            }

            showToast('🧪 TEST MODE: Simulated briefs complete state', 'warning', 3000);
        }

        // Poll for brief generation completion
        async function pollBriefGenerationStatus(workflowId) {
            const generateBriefsBtn = document.getElementById('generateBriefsBtn');
            let attempts = 0;
            const maxAttempts = 30; // 30 attempts * 2 seconds = 60 seconds max

            const pollInterval = setInterval(async () => {
                attempts++;

                try {
                    const response = await authenticatedFetch(`/api/calendar/workflow/${workflowId}/status`, {
                        method: 'GET'
                    });

                    if (response.ok) {
                        const status = await response.json();

                        if (status.brief_generation_status === 'complete') {
                            clearInterval(pollInterval);
                            showToast(`✅ ${status.total_briefs} briefs generated successfully!`, 'success', 5000);

                            // Update button
                            if (generateBriefsBtn) {
                                generateBriefsBtn.innerHTML = '✅ Briefs Complete';
                                generateBriefsBtn.disabled = true;
                            }
                        } else if (status.brief_generation_status === 'error') {
                            clearInterval(pollInterval);
                            showToast('Brief generation failed. Please try again.', 'error', 5000);

                            // Reset button
                            if (generateBriefsBtn) {
                                generateBriefsBtn.disabled = false;
                                generateBriefsBtn.innerHTML = '📝 Generate Briefs';
                            }
                        }
                    }
                } catch (error) {
                    console.debug('Error polling brief status:', error.message);
                }

                // Stop polling after max attempts
                if (attempts >= maxAttempts) {
                    clearInterval(pollInterval);
                    showToast('Brief generation is taking longer than expected. Check status later.', 'warning', 5000);

                    // Update button
                    if (generateBriefsBtn) {
                        generateBriefsBtn.disabled = false;
                        generateBriefsBtn.innerHTML = '📝 Generate Briefs';
                    }
                }
            }, 2000); // Poll every 2 seconds
        }

        function showApprovalStatusModal(status, approvalData) {
            const client = calendarManager.selectedClient;
            const date = calendarManager.selectedDate;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const monthName = date.toLocaleDateString('en-US', { month: 'long' });
            const approvalId = `${client.client_slug || client.id}-${year}-${month}`;
            const approvalUrl = `${window.location.origin}/calendar-approval/${approvalId}`;
            
            let statusInfo = '';
            let statusColor = '';
            
            switch (status) {
                case 'approved':
                    statusInfo = 'Your calendar has been approved by the client and is ready for execution.';
                    statusColor = 'text-green-400';
                    break;
                case 'pending':
                    statusInfo = 'The calendar has been shared with the client and is awaiting their review and approval.';
                    statusColor = 'text-yellow-400';
                    break;
                case 'changes_requested':
                    statusInfo = 'The client has requested changes to the calendar. Check the approval page for details.';
                    statusColor = 'text-orange-400';
                    break;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.innerHTML = `
                <div class="modal-content max-w-2xl">
                    <div class="modal-header">
                        <h2 class="text-2xl font-bold ${statusColor}">
                            ${status === 'approved' ? '✅' : status === 'pending' ? '⏳' : '🔧'} 
                            Calendar ${status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ')}
                        </h2>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <div class="text-white/80">${statusInfo}</div>
                        
                        ${approvalData.approved_at ? `
                            <div class="glass-card p-4">
                                <div class="text-sm text-white/50">Approved At</div>
                                <div class="font-semibold">${new Date(approvalData.approved_at.seconds * 1000).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        
                        ${approvalData.has_change_requests ? `
                            <div class="glass-card p-4 border-orange-500/30">
                                <div class="text-sm text-orange-400 font-semibold">⚠️ Client has requested changes</div>
                                <div class="text-white/70 mt-1">Check the approval page for details</div>
                            </div>
                        ` : ''}
                        
                        <div class="glass-card p-4">
                            <div class="text-sm text-white/50 mb-2">Public Approval URL</div>
                            <div class="flex items-center gap-2">
                                <input type="text" value="${approvalUrl}" readonly 
                                    class="flex-1 bg-black/30 text-white/80 px-3 py-2 rounded text-sm border border-white/10 focus:outline-none">
                                <button onclick="copyToClipboard('${approvalUrl}'); showToast('URL copied to clipboard!', 'success');" 
                                    class="glow-button text-sm px-4 py-2">
                                    📋 Copy
                                </button>
                                <button onclick="window.open('${approvalUrl}', '_blank')" 
                                    class="glow-button primary text-sm px-4 py-2">
                                    🔗 Open
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button onclick="this.closest('.modal-backdrop').remove()" class="glow-button w-full">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        }
        
        // Show change requests for the current selected month
        async function showCurrentMonthChangeRequests() {
            if (!calendarManager.selectedClient) {
                showToast('Please select a client first', 'error');
                return;
            }
            
            // Load change requests for the current month
            await calendarManager.loadChangeRequests();
            
            // Check if the change requests section is visible
            const section = document.getElementById('changeRequestsSection');
            if (section && !section.classList.contains('hidden')) {
                // Scroll to the change requests section
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                showToast('Change requests displayed above', 'info');
            } else {
                showToast('No change requests for this month', 'info');
            }
        }
        
        // Change Requests Management (Admin Panel)
        async function showChangeRequestsPanel() {
            try {
                const response = await authenticatedFetch('/api/calendar/admin/change-requests?status=all&limit=100');
                if (!response.ok) throw new Error('Failed to load change requests');
                
                const result = await response.json();
                const requests = result.change_requests || [];
                
                const modal = document.createElement('div');
                modal.className = 'modal-backdrop';
                modal.id = 'changeRequestsModal';
                
                const pendingRequests = requests.filter(r => r.status === 'pending');
                const inProgressRequests = requests.filter(r => r.status === 'in_progress');
                const completedRequests = requests.filter(r => r.status === 'completed');
                const rejectedRequests = requests.filter(r => r.status === 'rejected');
                
                modal.innerHTML = `
                    <div class="modal-content max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
                        <div class="modal-header">
                            <h2 class="text-3xl font-bold">
                                <span class="text-2xl mr-2">🔧</span>
                                Change Requests Management
                            </h2>
                            <div class="flex items-center gap-4 text-sm">
                                <span class="bg-orange-500/20 text-orange-400 px-3 py-1 rounded-full">
                                    ${pendingRequests.length} Pending
                                </span>
                                <span class="bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full">
                                    ${inProgressRequests.length} In Progress
                                </span>
                                <span class="bg-green-500/20 text-green-400 px-3 py-1 rounded-full">
                                    ${completedRequests.length} Completed
                                </span>
                            </div>
                        </div>
                        
                        <div class="p-6 flex-1 overflow-y-auto">
                            ${requests.length === 0 ? `
                                <div class="text-center py-12">
                                    <div class="text-6xl mb-4">📭</div>
                                    <div class="text-xl text-white/60">No change requests yet</div>
                                    <div class="text-sm text-white/40 mt-2">Clients can request changes through approval pages</div>
                                </div>
                            ` : `
                                <!-- Pending Requests -->
                                ${pendingRequests.length > 0 ? `
                                    <div class="mb-8">
                                        <h3 class="text-xl font-bold text-orange-400 mb-4 flex items-center gap-2">
                                            <span>⏳</span> Pending Requests (${pendingRequests.length})
                                        </h3>
                                        <div class="grid gap-4">
                                            ${pendingRequests.map(request => renderChangeRequest(request)).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- In Progress Requests -->
                                ${inProgressRequests.length > 0 ? `
                                    <div class="mb-8">
                                        <h3 class="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2">
                                            <span>🔄</span> In Progress (${inProgressRequests.length})
                                        </h3>
                                        <div class="grid gap-4">
                                            ${inProgressRequests.map(request => renderChangeRequest(request)).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Completed Requests -->
                                ${completedRequests.length > 0 ? `
                                    <div class="mb-8">
                                        <h3 class="text-xl font-bold text-green-400 mb-4 flex items-center gap-2">
                                            <span>✅</span> Completed (${completedRequests.length})
                                        </h3>
                                        <div class="grid gap-4">
                                            ${completedRequests.map(request => renderChangeRequest(request)).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Rejected Requests -->
                                ${rejectedRequests.length > 0 ? `
                                    <div class="mb-8">
                                        <h3 class="text-xl font-bold text-red-400 mb-4 flex items-center gap-2">
                                            <span>❌</span> Rejected (${rejectedRequests.length})
                                        </h3>
                                        <div class="grid gap-4">
                                            ${rejectedRequests.map(request => renderChangeRequest(request)).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            `}
                        </div>
                        
                        <div class="modal-footer">
                            <button onclick="document.getElementById('changeRequestsModal').remove()" class="glow-button w-full">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                modal.onclick = (e) => {
                    if (e.target === modal) modal.remove();
                };
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading change requests:', error);
                showToast('Failed to load change requests', 'error');
            }
        }
        
        function renderChangeRequest(request) {
            const createdDate = new Date(request.created_at).toLocaleString();
            const requestedDate = request.requested_at ? new Date(request.requested_at).toLocaleString() : 'N/A';
            
            const statusColors = {
                'pending': 'border-orange-500/30 bg-orange-500/10',
                'in_progress': 'border-blue-500/30 bg-blue-500/10', 
                'completed': 'border-green-500/30 bg-green-500/10',
                'rejected': 'border-red-500/30 bg-red-500/10'
            };
            
            const statusIcons = {
                'pending': '⏳',
                'in_progress': '🔄',
                'completed': '✅', 
                'rejected': '❌'
            };
            
            return `
                <div class="glass-card p-6 border ${statusColors[request.status] || statusColors.pending}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="text-lg font-bold text-white">
                                ${request.client_name || 'Unknown Client'}
                            </div>
                            <div class="text-sm text-white/60">
                                Approval ID: ${request.approval_id}
                            </div>
                            <div class="text-sm text-white/50">
                                Requested: ${requestedDate} • Created: ${createdDate}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${statusIcons[request.status]}</span>
                            <select onchange="updateChangeRequestStatus('${request.id}', this.value)" 
                                class="bg-black/30 text-white px-3 py-1 rounded border border-white/20 text-sm">
                                <option value="pending" ${request.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="in_progress" ${request.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${request.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="rejected" ${request.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="text-sm text-white/50 mb-2">Client Request:</div>
                        <div class="bg-black/20 p-4 rounded-lg text-white/90 whitespace-pre-wrap">
                            ${request.change_request || 'No description provided'}
                        </div>
                    </div>
                    
                    ${request.tasks && request.tasks.length > 0 ? `
                        <div class="mb-4">
                            <div class="text-sm text-white/50 mb-2">Parsed Tasks:</div>
                            <div class="space-y-2">
                                ${request.tasks.map((task, index) => `
                                    <div class="flex items-center gap-2 text-sm">
                                        <span class="w-6 h-6 bg-white/10 rounded-full flex items-center justify-center text-xs">
                                            ${index + 1}
                                        </span>
                                        <span class="flex-1">${task.description}</span>
                                        <span class="text-xs text-white/50 bg-white/10 px-2 py-1 rounded">
                                            ${task.type}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2">
                        <button onclick="viewApprovalPage('${request.approval_id}')" 
                            class="glow-button text-sm px-4 py-2">
                            🔗 View Approval Page
                        </button>
                        <button onclick="copyToClipboard('${window.location.origin}/calendar-approval/${request.approval_id}'); showToast('URL copied!', 'success');"
                            class="glow-button text-sm px-4 py-2">
                            📋 Copy URL
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function updateChangeRequestStatus(requestId, newStatus) {
            try {
                const response = await authenticatedFetch(`/api/calendar/admin/change-requests/${requestId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('Failed to update status');
                
                showToast(`Status updated to ${newStatus}`, 'success');
                
                // Refresh the panel
                document.getElementById('changeRequestsModal').remove();
                showChangeRequestsPanel();
                
            } catch (error) {
                console.error('Error updating change request status:', error);
                showToast('Failed to update status', 'error');
            }
        }
        
        function viewApprovalPage(approvalId) {
            const url = `${window.location.origin}/calendar-approval/${approvalId}`;
            window.open(url, '_blank');
        }
        
        function showAviationLoader() {
            const loader = document.createElement('div');
            loader.id = 'aviationLoader';
            loader.className = 'modal-backdrop';
            loader.style.cssText = 'display: flex; z-index: 10000; background: radial-gradient(ellipse at center, rgba(15, 15, 30, 0.95) 0%, rgba(0, 0, 0, 0.98) 100%);';
            
            loader.innerHTML = `
                <div class="modal-content" style="max-width: 500px; background: transparent; border: none; overflow: visible;">
                    <div class="text-center" style="position: relative;">
                        <!-- Sky and clouds background -->
                        <div style="position: absolute; inset: -100px; pointer-events: none;">
                            <div class="cloud cloud-1">☁️</div>
                            <div class="cloud cloud-2">☁️</div>
                            <div class="cloud cloud-3">☁️</div>
                            <div class="stars">✨</div>
                            <div class="stars stars-2">⭐</div>
                            <div class="stars stars-3">🌟</div>
                        </div>
                        
                        <!-- Main animation container -->
                        <div style="position: relative; z-index: 10;">
                            <!-- Rocket/Plane animation -->
                            <div class="rocket-container">
                                <div class="rocket">🚀</div>
                                <div class="trail">
                                    <span>📅</span>
                                    <span>📊</span>
                                    <span>📈</span>
                                    <span>💰</span>
                                </div>
                            </div>
                            
                            <!-- EmailPilot branding -->
                            <h2 class="text-4xl font-black gradient-text mb-4 mt-8">EmailPilot</h2>
                            <p class="text-xl text-white/80 mb-2">Preparing for Takeoff!</p>
                            
                            <!-- Loading messages that cycle -->
                            <div class="loading-messages" id="loadingMessage">
                                <p class="text-white/60">✈️ Fueling up your calendar...</p>
                            </div>
                            
                            <!-- Progress bar -->
                            <div class="mt-6 bg-white/10 rounded-full h-2 overflow-hidden">
                                <div class="progress-bar bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 h-full rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes fly {
                        0% {
                            transform: translateX(-50px) translateY(0) rotate(-5deg);
                        }
                        25% {
                            transform: translateX(0) translateY(-30px) rotate(0deg);
                        }
                        50% {
                            transform: translateX(50px) translateY(-60px) rotate(5deg);
                        }
                        75% {
                            transform: translateX(0) translateY(-90px) rotate(0deg);
                        }
                        100% {
                            transform: translateX(-50px) translateY(-120px) rotate(-5deg) scale(0.5);
                            opacity: 0;
                        }
                    }
                    
                    @keyframes float-cloud {
                        0% { transform: translateX(-100px); opacity: 0; }
                        10% { opacity: 1; }
                        90% { opacity: 1; }
                        100% { transform: translateX(600px); opacity: 0; }
                    }
                    
                    @keyframes twinkle {
                        0%, 100% { opacity: 0; transform: scale(0.5); }
                        50% { opacity: 1; transform: scale(1); }
                    }
                    
                    @keyframes trail {
                        0% { opacity: 0; transform: translateY(0) scale(1); }
                        50% { opacity: 1; transform: translateY(10px) scale(0.8); }
                        100% { opacity: 0; transform: translateY(30px) scale(0.5); }
                    }
                    
                    @keyframes progress {
                        0% { width: 0%; }
                        100% { width: 100%; }
                    }
                    
                    .rocket-container {
                        position: relative;
                        height: 150px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .rocket {
                        font-size: 64px;
                        animation: fly 3s ease-in-out infinite;
                        filter: drop-shadow(0 0 20px rgba(138, 108, 247, 0.8));
                    }
                    
                    .trail {
                        position: absolute;
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        top: 80px;
                        left: 50%;
                        transform: translateX(-50%);
                    }
                    
                    .trail span {
                        font-size: 20px;
                        animation: trail 1s ease-in-out infinite;
                        animation-delay: calc(var(--i) * 0.1s);
                    }
                    
                    .trail span:nth-child(1) { --i: 0; }
                    .trail span:nth-child(2) { --i: 1; }
                    .trail span:nth-child(3) { --i: 2; }
                    .trail span:nth-child(4) { --i: 3; }
                    
                    .cloud {
                        position: absolute;
                        font-size: 48px;
                        opacity: 0.6;
                        animation: float-cloud 15s linear infinite;
                    }
                    
                    .cloud-1 {
                        top: 20px;
                        animation-delay: 0s;
                    }
                    
                    .cloud-2 {
                        top: 80px;
                        animation-delay: 5s;
                        font-size: 36px;
                    }
                    
                    .cloud-3 {
                        top: 140px;
                        animation-delay: 10s;
                        font-size: 42px;
                    }
                    
                    .stars {
                        position: absolute;
                        font-size: 24px;
                        animation: twinkle 2s ease-in-out infinite;
                    }
                    
                    .stars {
                        top: 10px;
                        right: 50px;
                        animation-delay: 0s;
                    }
                    
                    .stars-2 {
                        top: 60px;
                        left: 40px;
                        animation-delay: 0.5s;
                    }
                    
                    .stars-3 {
                        top: 100px;
                        right: 80px;
                        animation-delay: 1s;
                    }
                    
                    .progress-bar {
                        animation: progress 3s ease-out forwards;
                    }
                    
                    .loading-messages {
                        min-height: 24px;
                        margin: 16px 0;
                    }
            
        /* Resend campaign styling */
        .campaign-pill.is-resend {
            border: 2px dashed #fbbf24 !important;  /* Amber dashed border all around */
            border-left: 4px solid #fbbf24 !important;  /* Solid left accent */
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05));
        }

        .resend-badge {
            background: #fbbf24;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-left: 4px;
        }

        /* NEW: Modified campaign badge for EmailPilot Simple workflow */
        .modified-badge {
            background: #3b82f6;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-left: 4px;
            cursor: help;
        }

        .modified-badge:hover {
            background: #2563eb;
        }

        .campaign-pill.is-modified {
            border-left: 4px solid #3b82f6 !important;
        }

        /* Campaign pill hover actions */
        .pill-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .campaign-pill:hover .pill-actions {
            opacity: 1;
        }

        .pill-action {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pill-action:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.1);
        }

        /* Search input styling */
        #searchInput {
            transition: all 0.3s;
        }

        #searchInput:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* Week view improvements */
        .week-timeline-container {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Better scrollbar */
        .week-timeline-container::-webkit-scrollbar {
            width: 8px;
        }

        .week-timeline-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .week-timeline-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .week-timeline-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Week navigation buttons */
        .week-nav-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Keyboard shortcuts help modal */
        .shortcuts-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2rem;
            z-index: 10000;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }

        .shortcuts-modal.show {
            display: block;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
            margin-top: 1rem;
        }

        .shortcut-key {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
            `;
            
            document.body.appendChild(loader);
            
            // Cycle through fun loading messages
            const messages = [
                "✈️ Fueling up your calendar...",
                "🚁 Loading campaign cargo...",
                "🛸 Engaging hyperdrive...",
                "🎯 Calibrating email trajectories...",
                "📡 Establishing cloud connection...",
                "🌤️ Clearing the runway...",
                "🚀 Initiating launch sequence...",
                "⭐ Navigating to the cloud...",
                "🛩️ EmailPilot ready for departure!"
            ];
            
            let messageIndex = 0;
            const messageElement = document.getElementById('loadingMessage');
            
            const messageInterval = setInterval(() => {
                messageIndex = (messageIndex + 1) % messages.length;
                if (messageElement) {
                    messageElement.innerHTML = `<p class="text-white/60">${messages[messageIndex]}</p>`;
                }
            }, 800);
            
            // Store interval ID for cleanup
            loader.messageInterval = messageInterval;
        }
        
        function hideAviationLoader() {
            const loader = document.getElementById('aviationLoader');
            if (loader) {
                // Clear the message interval
                if (loader.messageInterval) {
                    clearInterval(loader.messageInterval);
                }
                
                // Add fade out animation
                loader.style.animation = 'fadeOut 0.5s ease';
                setTimeout(() => {
                    loader.remove();
                }, 500);
            }
        }
        
        function showApprovalPageModal(url, clientName, monthName, year) {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'approvalPageModal';
            modal.style.cssText = 'display: flex; z-index: 10000;';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="text-center">
                        <div class="text-6xl mb-4">✅</div>
                        <h2 class="text-3xl font-black gradient-text mb-4">Approval Page Created!</h2>
                        <p class="text-white/80 mb-6">
                            The calendar for <strong>${clientName}</strong> - ${monthName} ${year} 
                            is now available for client review and approval.
                        </p>
                        
                        <div class="glass-card p-4 mb-6">
                            <div class="text-sm text-white/60 mb-2">Shareable Link:</div>
                            <div class="flex items-center gap-2">
                                <input type="text" id="approvalUrlInput" value="${url}" 
                                       class="flex-1 bg-black/30 text-white px-3 py-2 rounded-lg" readonly>
                                <button onclick="copyApprovalUrl('${url}')" class="glow-button primary px-4">
                                    📋 Copy
                                </button>
                            </div>
                        </div>
                        
                        <div class="text-sm text-white/60 mb-6">
                            <p>✓ Client can view the full calendar</p>
                            <p>✓ Client can make edit requests</p>
                            <p>✓ Client can approve with one click</p>
                        </div>
                        
                        <div class="flex gap-3 justify-center">
                            <button onclick="window.open('${url}', '_blank')" class="glow-button primary">
                                🔗 Open Preview
                            </button>
                            <button onclick="closeApprovalModal()" class="glow-button">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function copyApprovalUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showToast('URL copied to clipboard!', 'success');
            });
        }
        
        function closeApprovalModal() {
            const modal = document.getElementById('approvalPageModal');
            if (modal) modal.remove();
        }
        
        function saveToCloud() {
            calendarManager.saveToCloud();
        }
        
        // Dismiss change requests section
        function dismissChangeRequests() {
            document.getElementById('changeRequestsSection').classList.add('hidden');
        }
        
        // Update individual task status
        async function updateTaskStatus(requestId, taskIndex, completed) {
            // This would update the task status in Firestore
            // For now, just update the UI
            const checkbox = document.getElementById(`task-${requestId}-${taskIndex}`);
            const label = checkbox.nextElementSibling;
            
            if (completed) {
                label.classList.add('line-through', 'opacity-50');
            } else {
                label.classList.remove('line-through', 'opacity-50');
            }
            
            showToast(completed ? 'Task marked as complete' : 'Task marked as pending', 'success');
        }
        
        // Update task status (global) - called from checkbox onchange
        window.updateTaskStatus = function(requestId, taskIndex, completed) {
            // Update visual state
            const label = document.querySelector(`label[for="task-${requestId}-${taskIndex}"]`);
            if (label) {
                if (completed) {
                    label.classList.add('line-through', 'opacity-50');
                } else {
                    label.classList.remove('line-through', 'opacity-50');
                }
            }
            
            // Store the completion state (could be saved to Firestore if needed)
            const taskKey = `task_${requestId}_${taskIndex}`;
            localStorage.setItem(taskKey, completed ? 'completed' : 'pending');
            
            showToast(completed ? 'Task marked as complete' : 'Task marked as pending', 'success');
        }
        
        // Mark all tasks as complete (global)
        window.markAllTasksComplete = function() {
            const checkboxes = document.querySelectorAll('#changeRequestsList input[type="checkbox"]:not(:checked)');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                
                // Get the label using the checkbox ID
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                if (label) {
                    label.classList.add('line-through', 'opacity-50');
                }
                
                // Store completion state using data attributes or parse from ID
                const idParts = checkbox.id.split('-');
                if (idParts.length >= 3) {
                    const requestId = idParts.slice(1, -1).join('-'); // Handle IDs with dashes
                    const taskIndex = idParts[idParts.length - 1];
                    const taskKey = `task_${requestId}_${taskIndex}`;
                    localStorage.setItem(taskKey, 'completed');
                }
            });
            showToast('All tasks marked as complete', 'success');
        }

        function undoLastChange() {
            calendarManager.undoLastChange();
        }
        
        // Fullscreen toggle functionality
        let isFullscreen = false;
        
        function toggleFullscreen() {
            const calendarSection = document.querySelector('.glass-card.p-6.mb-8.fade-in');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const body = document.body;
            
            if (!calendarSection) {
                console.error('Calendar section not found');
                return;
            }
            
            isFullscreen = !isFullscreen;
            
            if (isFullscreen) {
                // Enter fullscreen
                calendarSection.classList.add('calendar-fullscreen');
                body.classList.add('calendar-is-fullscreen');
                fullscreenBtn.innerHTML = '⤦'; // Reduce icon
                fullscreenBtn.title = 'Exit Fullscreen';
                
                // Store scroll position
                window.calendarScrollPosition = window.scrollY;
                
                // Focus on calendar
                calendarSection.scrollIntoView({ behavior: 'smooth' });
                
                // Add ESC key listener
                document.addEventListener('keydown', handleFullscreenEsc);
                
                showToast('Press ESC to exit fullscreen', 'info');
            } else {
                // Exit fullscreen
                calendarSection.classList.remove('calendar-fullscreen');
                body.classList.remove('calendar-is-fullscreen');
                fullscreenBtn.innerHTML = '⛶'; // Expand icon
                fullscreenBtn.title = 'Fullscreen';
                
                // Restore scroll position
                if (window.calendarScrollPosition !== undefined) {
                    window.scrollTo(0, window.calendarScrollPosition);
                }
                
                // Remove ESC key listener
                document.removeEventListener('keydown', handleFullscreenEsc);
            }
            
            // Re-render calendar to adjust to new dimensions
            if (calendarManager) {
                setTimeout(() => {
                    calendarManager.renderCalendar();
                    // Also re-render week/list view if active
                    const activeView = document.querySelector('.view-btn.active');
                    if (activeView && activeView.dataset.view !== 'month') {
                        setView(activeView.dataset.view);
                    }
                }, 100);
            }
        }
        
        function handleFullscreenEsc(e) {
            if (e.key === 'Escape' && isFullscreen) {
                e.preventDefault();
                toggleFullscreen();
            }
        }

        // Campaign Creation Functions
        function closeCreateCampaignModal() {
            document.getElementById('createCampaignModal').classList.remove('show');
            document.getElementById('campaignForm').reset();
            delete document.getElementById('campaignForm').dataset.editingId;

            // Reset modal title and button text for create mode
            const modalTitle = document.querySelector('#createCampaignModal h3');
            if (modalTitle) {
                modalTitle.textContent = 'New Campaign';
            }

            const submitButton = document.querySelector('#campaignForm button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = 'Create';
            }
        }

        // Update campaign type based on channel and message type selections
        function updateCampaignType() {
            const channel = document.getElementById('campaignChannel')?.value || '';
            const messageType = document.getElementById('campaignMessageType')?.value || '';

            // Set the campaign type to the message type (promotional, content, or resend)
            // The channel is tracked separately but message type determines the pill/filter
            if (messageType) {
                document.getElementById('campaignType').value = messageType;
            }
        }

        async function createCampaign(event) {
            event.preventDefault();

            const form = event.target;
            const isEditing = form.dataset.editingId;

            const campaignType = document.getElementById('campaignType').value;

            // Parse date correctly to avoid timezone issues
            const dateInputValue = document.getElementById('campaignDate').value; // Format: "YYYY-MM-DD"
            const [year, month, day] = dateInputValue.split('-').map(Number);
            const campaignDate = new Date(year, month - 1, day); // month is 0-indexed

            const campaignData = {
                id: isEditing || 'campaign-' + Date.now(),
                name: document.getElementById('campaignName').value,
                type: campaignType,
                date: campaignDate,
                time: document.getElementById('campaignTime').value,
                subject_lines: document.getElementById('campaignSubjects').value
                    .split(',').map(s => s.trim()).filter(s => s),
                target_segment: document.getElementById('campaignSegment').value,
                gradient: calendarManager.getTypeGradient(campaignType),
                emoji: calendarManager.getTypeEmoji(campaignType),
                is_resend: campaignType === 'resend'  // Mark as resend for styling
            };

            let monthChanged = false;
            let originalMonth = null;
            let originalYear = null;

            if (isEditing) {
                // Update existing campaign
                calendarManager.saveState();
                const index = calendarManager.campaigns.findIndex(c => c.id === isEditing);
                if (index !== -1) {
                    // Store original date to detect month change
                    const originalCampaign = calendarManager.campaigns[index];
                    originalMonth = originalCampaign.date.getMonth();
                    originalYear = originalCampaign.date.getFullYear();

                    // Check if month changed
                    const newMonth = campaignData.date.getMonth();
                    const newYear = campaignData.date.getFullYear();
                    monthChanged = (originalMonth !== newMonth || originalYear !== newYear);

                    // NEW: Track modifications for EmailPilot Simple workflow
                    const modifiedFields = [];

                    // Compare editable fields to detect changes
                    if (originalCampaign.name !== campaignData.name) modifiedFields.push('name');
                    if (originalCampaign.type !== campaignData.type) modifiedFields.push('type');
                    if (originalCampaign.date.getTime() !== campaignData.date.getTime()) modifiedFields.push('date');
                    if (originalCampaign.time !== campaignData.time) modifiedFields.push('time');
                    if (originalCampaign.target_segment !== campaignData.target_segment) modifiedFields.push('segment');

                    // Check if subject_lines array changed
                    const oldSubjects = originalCampaign.subject_lines?.join(',') || '';
                    const newSubjects = campaignData.subject_lines?.join(',') || '';
                    if (oldSubjects !== newSubjects) modifiedFields.push('subject_lines');

                    // Preserve workflow-critical fields from original campaign
                    campaignData.custom_fields = originalCampaign.custom_fields || originalCampaign.originalData || {};
                    campaignData.original_id = originalCampaign.original_id || originalCampaign.id;
                    campaignData.import_metadata = originalCampaign.import_metadata || null;
                    campaignData.created_at = originalCampaign.created_at || new Date().toISOString();

                    // Update modification tracking
                    if (modifiedFields.length > 0) {
                        // This campaign was modified by the user
                        campaignData.modified = true;

                        // Merge with previously modified fields (avoid duplicates)
                        const existingModifiedFields = originalCampaign.modified_fields || [];
                        campaignData.modified_fields = [...new Set([...existingModifiedFields, ...modifiedFields])];

                        campaignData.updated_at = new Date().toISOString();

                        console.log('✏️ Campaign modified:', {
                            id: campaignData.id,
                            modified_fields: modifiedFields,
                            total_modifications: campaignData.modified_fields.length
                        });
                    } else {
                        // No changes detected, preserve existing modification status
                        campaignData.modified = originalCampaign.modified || false;
                        campaignData.modified_fields = originalCampaign.modified_fields || [];
                        campaignData.updated_at = originalCampaign.updated_at || new Date().toISOString();
                    }

                    calendarManager.campaigns[index] = campaignData;

                    // Fast-path update (single PUT request) - AWAIT to ensure completion
                    console.log('💾 Saving campaign update:', {
                        id: campaignData.id,
                        type: campaignData.type,
                        time: campaignData.time,
                        is_resend: campaignData.is_resend,
                        messageTypeDropdown: document.getElementById('campaignMessageType').value,
                        hiddenTypeField: document.getElementById('campaignType').value
                    });
                    const saveSuccess = await calendarManager.quickUpdate(campaignData);

                    if (saveSuccess) {
                        showToast('Campaign updated successfully!');
                    } else {
                        showToast('Failed to save changes - please try again', 'error');
                        // Revert local change if save failed
                        calendarManager.campaigns[index] = originalCampaign;
                        return; // Don't close modal or proceed
                    }
                }
            } else {
                // Add new campaign
                calendarManager.saveState();
                calendarManager.campaigns.push(campaignData);

                // Fast-path create (single POST request) - AWAIT to ensure completion
                console.log('💾 Creating campaign:', { id: campaignData.id, type: campaignData.type, time: campaignData.time });
                const createSuccess = await calendarManager.quickCreate(campaignData);

                if (createSuccess) {
                    showToast('Campaign created successfully!');
                } else {
                    showToast('Failed to create campaign - please try again', 'error');
                    // Remove from local array if create failed
                    calendarManager.campaigns.pop();
                    return; // Don't close modal or proceed
                }
            }

            // If month changed during edit, navigate to the new month
            if (monthChanged) {
                calendarManager.selectedDate = new Date(campaignData.date);
                updateMonthDisplay();
                localStorage.setItem('lastSelectedMonth', calendarManager.selectedDate.toISOString());
            }

            calendarManager.renderCalendar();
            calendarManager.updateStats();

            closeCreateCampaignModal();
        }

        // Confirmation Modal Functions
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
            calendarManager.pendingAction = null;
        }
        
        // File Import Functions
        function openFileImportModal() {
            if (!calendarManager.selectedClient) {
                showToast('Please select a client first', 'warning');
                return;
            }
            document.getElementById('fileImportModal').classList.add('show');
            initializeFileUpload();
        }
        
        function closeFileImportModal() {
            document.getElementById('fileImportModal').classList.remove('show');
            clearSelectedFile();
            document.getElementById('fileType').value = 'json';
            updateFileInputAccept();
        }
        
        function updateFileInputAccept() {
            const fileType = document.getElementById('fileType').value;
            const fileInput = document.getElementById('fileInput');
            const acceptMap = {
                'json': '.json',
                'csv': '.csv',
                'xlsx': '.xlsx,.xls',
                'ics': '.ics'
            };
            fileInput.accept = acceptMap[fileType] || '.json';
            document.getElementById('csvPreview').classList.toggle('hidden', fileType !== 'csv' && fileType !== 'xlsx');
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('selectedFile').classList.remove('hidden');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('importBtn').disabled = false;
            previewFile(file);
        }
        
        function clearSelectedFile() {
            document.getElementById('selectedFile').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            document.getElementById('importBtn').disabled = true;
            document.getElementById('filePreview').classList.add('hidden');
            document.getElementById('csvPreview').classList.add('hidden');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function previewFile(file) {
            const fileType = document.getElementById('fileType').value;
            const reader = new FileReader();

            reader.onload = function(e) {
                const content = e.target.result;

                try {
                    if (fileType === 'json') {
                        const jsonData = JSON.parse(content);
                        document.getElementById('previewContent').textContent = JSON.stringify(jsonData, null, 2);
                        document.getElementById('filePreview').classList.remove('hidden');
                    } else if (fileType === 'csv') {
                        const lines = content.split('\n').filter(line => line.trim());
                        if (lines.length > 0) {
                            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                            populateColumnMappings(headers);
                            document.getElementById('previewContent').textContent = lines.slice(0, 6).join('\n');
                            document.getElementById('filePreview').classList.remove('hidden');
                            document.getElementById('csvPreview').classList.remove('hidden');
                        }
                    } else if (fileType === 'ics') {
                        document.getElementById('previewContent').textContent = content.substring(0, 1000) + (content.length > 1000 ? '...' : '');
                        document.getElementById('filePreview').classList.remove('hidden');
                    }
                } catch (error) {
                    showToast('Error reading file: ' + error.message, 'error');
                }
            };

            reader.readAsText(file);
        }
        
        function populateColumnMappings(headers) {
            const mappingSelects = ['titleColumn', 'dateColumn', 'typeColumn', 'contentColumn'];
            
            mappingSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- Select Column --</option>';
                headers.forEach((header, index) => {
                    select.innerHTML += `<option value="${index}">${header}</option>`;
                });
            });
            
            // Auto-detect common column mappings
            headers.forEach((header, index) => {
                const headerLower = header.toLowerCase();
                if (headerLower.includes('title') || headerLower.includes('name') || headerLower.includes('campaign')) {
                    document.getElementById('titleColumn').value = index;
                } else if (headerLower.includes('date') || headerLower.includes('time')) {
                    document.getElementById('dateColumn').value = index;
                } else if (headerLower.includes('type') || headerLower.includes('category')) {
                    document.getElementById('typeColumn').value = index;
                } else if (headerLower.includes('description') || headerLower.includes('content') || headerLower.includes('note')) {
                    document.getElementById('contentColumn').value = index;
                }
            });
        }
        
        async function processFileImport() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const fileType = document.getElementById('fileType').value;
            const importBtn = document.getElementById('importBtn');

            importBtn.disabled = true;
            importBtn.innerHTML = '<span class="mr-2">⏳</span>Processing...';

            const reader = new FileReader();

            reader.onload = async function(e) {
                const content = e.target.result;

                try {
                    let events = [];

                    if (fileType === 'json') {
                        const data = JSON.parse(content);

                        // NEW: Capture import metadata for EmailPilot Simple workflow
                        let importMetadata = null;
                        if (data.metadata) {
                            importMetadata = {
                                source: data.metadata.source || 'unknown',
                                version: data.metadata.version || '1.0',
                                generated_at: data.metadata.generated_at || new Date().toISOString(),
                                client_id: data.metadata.client_id || null,
                                client_name: data.metadata.client_name || null,
                                enriched_context_available: data.metadata.enriched_context_available || false,
                                enriched_context_key: data.metadata.enriched_context_key || null,
                                enriched_context_url: data.metadata.enriched_context_url || null,
                                batch_id: 'import-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                            };

                            // Store metadata in sessionStorage for export
                            sessionStorage.setItem('calendar_import_metadata', JSON.stringify(importMetadata));

                            console.log('📦 Import metadata captured:', importMetadata);
                            if (importMetadata.enriched_context_available) {
                                console.log('✨ Enriched context available:', importMetadata.enriched_context_key);
                            }
                        }

                        events = Array.isArray(data) ? data : (data.events || data.calendar || []);

                        // NEW: Attach import metadata to each event
                        events = events.map(event => normalizeEventData(event, importMetadata));
                    } else if (fileType === 'csv') {
                        const lines = content.split('\n').filter(line => line.trim());
                        const titleCol = parseInt(document.getElementById('titleColumn').value);
                        const dateCol = parseInt(document.getElementById('dateColumn').value);
                        const typeCol = parseInt(document.getElementById('typeColumn').value);
                        const contentCol = parseInt(document.getElementById('contentColumn').value);

                        if (isNaN(titleCol) || isNaN(dateCol)) throw new Error('Title and Date columns required');

                        for (let i = 1; i < lines.length; i++) {
                            const cells = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
                            if (cells[titleCol] && cells[dateCol]) {
                                events.push(normalizeEventData({
                                    title: cells[titleCol],
                                    date: cells[dateCol],
                                    event_type: !isNaN(typeCol) ? cells[typeCol] : 'email',
                                    content: !isNaN(contentCol) ? cells[contentCol] : ''
                                }));
                            }
                        }
                    } else if (fileType === 'ics') {
                        const lines = content.split('\n');
                        let currentEvent = null;

                        for (let line of lines) {
                            line = line.trim();
                            if (line === 'BEGIN:VEVENT') currentEvent = {};
                            else if (line === 'END:VEVENT' && currentEvent) {
                                if (currentEvent.summary && currentEvent.dtstart) {
                                    events.push(normalizeEventData({
                                        title: currentEvent.summary,
                                        date: currentEvent.dtstart,
                                        content: currentEvent.description || ''
                                    }));
                                }
                                currentEvent = null;
                            } else if (currentEvent && line.includes(':')) {
                                const [key, ...valueParts] = line.split(':');
                                const value = valueParts.join(':');

                                if (key === 'SUMMARY') currentEvent.summary = value;
                                else if (key.startsWith('DTSTART')) {
                                    const dateStr = value.replace(/T.*/, '');
                                    currentEvent.dtstart = `${dateStr.substring(0,4)}-${dateStr.substring(4,6)}-${dateStr.substring(6,8)}`;
                                } else if (key === 'DESCRIPTION') currentEvent.description = value.replace(/\\n/g, '\n');
                            }
                        }
                    }

                    if (events.length === 0) {
                        showToast('No valid events found', 'warning');
                        return;
                    }

                    events.forEach(event => calendarManager.campaigns.push(event));
                    await calendarManager.saveToCloud();
                    calendarManager.renderCalendar();
                    calendarManager.updateStats();
                    calendarManager.saveState();

                    showToast(`Successfully imported ${events.length} events`, 'success');
                    closeFileImportModal();

                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Error importing file: ' + error.message, 'error');
                } finally {
                    importBtn.disabled = false;
                    importBtn.innerHTML = '<span class="mr-2">📥</span>Import Events';
                }
            };

            reader.readAsText(file);
        }
        
        async function parseJsonFile(content) {
            const data = JSON.parse(content);
            
            // Handle different JSON structures
            if (Array.isArray(data)) {
                return data.map(event => normalizeEventData(event));
            } else if (data.events && Array.isArray(data.events)) {
                return data.events.map(event => normalizeEventData(event));
            } else if (data.calendar && Array.isArray(data.calendar)) {
                return data.calendar.map(event => normalizeEventData(event));
            } else {
                throw new Error('Unrecognized JSON format. Expected array or object with events/calendar property.');
            }
        }
        
        async function parseCsvFile(content) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length <= 1) throw new Error('CSV file must contain headers and data');
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const titleCol = parseInt(document.getElementById('titleColumn').value);
            const dateCol = parseInt(document.getElementById('dateColumn').value);
            const typeCol = parseInt(document.getElementById('typeColumn').value);
            const contentCol = parseInt(document.getElementById('contentColumn').value);
            
            if (isNaN(titleCol) || isNaN(dateCol)) {
                throw new Error('Title and Date columns must be selected');
            }
            
            const events = [];
            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
                
                if (cells[titleCol] && cells[dateCol]) {
                    const event = {
                        title: cells[titleCol],
                        date: cells[dateCol],
                        event_type: !isNaN(typeCol) ? cells[typeCol] : 'email',
                        content: !isNaN(contentCol) ? cells[contentCol] : ''
                    };
                    events.push(normalizeEventData(event));
                }
            }
            
            return events;
        }
        
        async function parseIcsFile(content) {
            const events = [];
            const lines = content.split('\n');
            let currentEvent = null;
            
            for (let line of lines) {
                line = line.trim();
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.summary && currentEvent.dtstart) {
                        events.push(normalizeEventData({
                            title: currentEvent.summary,
                            date: currentEvent.dtstart,
                            content: currentEvent.description || '',
                            event_type: 'email'
                        }));
                    }
                    currentEvent = null;
                } else if (currentEvent && line.includes(':')) {
                    const [key, ...valueParts] = line.split(':');
                    const value = valueParts.join(':');
                    
                    if (key === 'SUMMARY') {
                        currentEvent.summary = value;
                    } else if (key.startsWith('DTSTART')) {
                        // Parse iCal date format (YYYYMMDDTHHMMSS)
                        const dateStr = value.replace(/T.*/, ''); // Remove time part
                        const year = dateStr.substring(0, 4);
                        const month = dateStr.substring(4, 6);
                        const day = dateStr.substring(6, 8);
                        currentEvent.dtstart = `${year}-${month}-${day}`;
                    } else if (key === 'DESCRIPTION') {
                        currentEvent.description = value.replace(/\\n/g, '\n');
                    }
                }
            }
            
            return events;
        }

        // Helper function to convert 24-hour time to 12-hour format with AM/PM
        function convertTo12HourFormat(timeString) {
            if (!timeString) return '10:00 AM'; // Default time

            // Already in 12-hour format (contains AM/PM)
            if (timeString.includes('AM') || timeString.includes('PM') ||
                timeString.includes('am') || timeString.includes('pm')) {
                return timeString;
            }

            // Parse 24-hour format (e.g., "13:52" or "13:52:00")
            const parts = timeString.split(':');
            if (parts.length < 2) return '10:00 AM';

            let hours = parseInt(parts[0]);
            const minutes = parts[1].padStart(2, '0');

            if (isNaN(hours) || hours < 0 || hours > 23) return '10:00 AM';

            const isPM = hours >= 12;
            const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;

            return `${displayHours}:${minutes} ${isPM ? 'PM' : 'AM'}`;
        }

        function normalizeEventData(event, importMetadata = null) {
            // Normalize date format
            let date = event.date || event.event_date || event.send_date || event.dtstart;
            let parsedDate = null;

            if (date) {
                // FIX: Parse date in local timezone to avoid UTC shift
                if (typeof date === 'string' && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // Already in YYYY-MM-DD format - parse locally
                    const parts = date.split('-');
                    parsedDate = new Date(
                        parseInt(parts[0]),      // year
                        parseInt(parts[1]) - 1,  // month (0-indexed)
                        parseInt(parts[2])       // day
                    );
                } else {
                    // Other formats - try parsing
                    const dateObj = new Date(date);
                    if (!isNaN(dateObj.getTime())) {
                        parsedDate = dateObj;
                    }
                }
            }

            // Extract and normalize channel field (Email, SMS, Push, etc.)
            let channel = event.channel || event.Channel || '';
            if (channel) {
                // Normalize to lowercase for consistency
                channel = channel.toLowerCase();
                // Map common variations
                if (channel.includes('email') || channel.includes('e-mail')) {
                    channel = 'email';
                } else if (channel.includes('sms') || channel.includes('text')) {
                    channel = 'sms';
                } else if (channel.includes('push')) {
                    channel = 'push';
                }
            }

            // Determine type and add emoji
            let type = event.event_type || event.type || event.category || 'email';

            // If channel wasn't explicitly set, infer from type
            if (!channel) {
                if (type.toLowerCase().includes('sms')) {
                    channel = 'sms';
                } else if (type.toLowerCase().includes('push')) {
                    channel = 'push';
                } else {
                    channel = 'email';
                }
            }

            // Add emoji based on channel (matching renderCalendar emoji expectations)
            let emoji = '';
            if (channel === 'sms') {
                emoji = '📱 ';  // Phone for SMS (matches renderCalendar)
            } else if (channel === 'push') {
                emoji = '💻 ';  // Computer for Push (matches renderCalendar)
            } else {
                emoji = '📧 ';  // Email envelope (matches renderCalendar)
            }

            // Build enhanced title with emoji
            let title = event.title || event.name || event.summary || event.subject_line_a || 'Imported Event';
            if (emoji) {
                title = emoji + title;
            }

            // Build comprehensive description
            let description = event.description || event.content || '';

            // Add all the extra fields if they exist
            const extraFields = [];
            if (event.week_number) extraFields.push(`Week #${event.week_number}`);
            if (event.send_time) extraFields.push(`Send Time: ${formatTimeTo12Hour(event.send_time)}`);
            if (event.segments || event.segment) extraFields.push(`Segment: ${event.segments || event.segment}`);
            if (event.subject_line_a) extraFields.push(`Subject A: ${event.subject_line_a}`);
            if (event.subject_line_b) extraFields.push(`Subject B: ${event.subject_line_b}`);
            if (event.preview_text) extraFields.push(`Preview: ${event.preview_text}`);
            if (event.hero_h1) extraFields.push(`H1: ${event.hero_h1}`);
            if (event.sub_head) extraFields.push(`Subhead: ${event.sub_head}`);
            if (event.hero_image) extraFields.push(`Hero Image: ${event.hero_image}`);
            if (event.cta_copy) extraFields.push(`CTA: ${event.cta_copy}`);
            if (event.offer) extraFields.push(`Offer: ${event.offer}`);
            if (event.ab_test_idea) extraFields.push(`A/B Test: ${event.ab_test_idea}`);
            if (event.secondary_message || event.sms_variant) {
                extraFields.push(`Secondary/SMS: ${event.secondary_message || event.sms_variant}`);
            }

            // Append extra fields to description
            if (extraFields.length > 0) {
                if (description) description += '\n\n';
                description += extraFields.join('\n');
            }

            // Convert time to 12-hour format if needed
            const normalizedTime = convertTo12HourFormat(event.send_time || event.time);

            // Build comprehensive custom_fields object to preserve ALL enriched data
            const custom_fields = {
                week_number: event.week_number,
                send_time: event.send_time,
                subject_line_a: event.subject_line_a,
                subject_line_b: event.subject_line_b,
                preview_text: event.preview_text,
                hero_h1: event.hero_h1,
                sub_head: event.sub_head,
                hero_image: event.hero_image,
                cta_copy: event.cta_copy,
                offer: event.offer,
                ab_test_idea: event.ab_test_idea,
                secondary_message: event.secondary_message,
                sms_variant: event.sms_variant,
                original_channel: event.channel || event.Channel,
                // Include any other custom fields from the event that aren't standard calendar fields
                ...Object.keys(event).reduce((acc, key) => {
                    const standardFields = ['id', 'name', 'title', 'type', 'channel', 'date', 'event_date',
                        'send_date', 'dtstart', 'time', 'description', 'content', 'color', 'segment', 'segments'];
                    if (!standardFields.includes(key) && !acc.hasOwnProperty(key)) {
                        acc[key] = event[key];
                    }
                    return acc;
                }, {})
            };

            return {
                id: event.id || 'imported-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                name: title,
                type: type,
                channel: channel,  // ✅ NOW INCLUDES CHANNEL
                emoji: emoji.trim(),  // ✅ Store emoji separately for rendering
                date: parsedDate || new Date(),  // FIX: Use locally-parsed date
                time: normalizedTime,  // ✅ NOW INCLUDES TIME IN 12-HOUR FORMAT
                send_time: normalizedTime,  // ✅ ALSO SET send_time FOR WEEK VIEW
                description: description,
                color: event.color || getColorForType(type),
                segment: event.segments || event.segment || '',
                imported: true,

                // NEW: EmailPilot Simple workflow support - preserve ALL enriched data
                custom_fields: custom_fields,
                original_id: event.original_id || event.id,
                import_metadata: importMetadata,

                // NEW: Modification tracking (initialized on import, updated on edits)
                created_at: event.created_at || new Date().toISOString(),
                modified: false,
                modified_fields: [],

                // Legacy: Keep originalData for backwards compatibility
                originalData: custom_fields
            };
        }
        
        function getColorForType(type) {
            const colorMap = {
                'email': 'bg-blue-200 text-blue-800',
                'sms': 'bg-orange-200 text-orange-800',
                'flash sale': 'bg-red-300 text-red-800',
                'promotional': 'bg-red-300 text-red-800',
                'nurturing': 'bg-green-100 text-green-800',
                'cheese club': 'bg-green-200 text-green-800',
                'rrb': 'bg-red-300 text-red-800',
                'seasonal': 'bg-purple-200 text-purple-800'
            };
            return colorMap[type.toLowerCase()] || 'bg-gray-200 text-gray-800';
        }

        /**
         * NEW: Export calendar for EmailPilot Brief Generation
         * Exports reviewed calendar with all custom fields, modifications, and metadata
         * for integration with EmailPilot Simple workflow
         */
        async function exportForBriefGeneration() {
            try {
                const clientId = calendarManager.selectedClient;
                if (!clientId) {
                    showToast('Please select a client first', 'error');
                    return;
                }

                // Get current client info
                const client = calendarManager.clients.find(c => c.id === clientId);
                const clientName = client ? client.name : 'Unknown Client';

                // Retrieve import metadata from sessionStorage (if available)
                let originalImportMetadata = null;
                try {
                    const storedMetadata = sessionStorage.getItem('calendar_import_metadata');
                    if (storedMetadata) {
                        originalImportMetadata = JSON.parse(storedMetadata);
                    }
                } catch (e) {
                    console.warn('No import metadata found in sessionStorage');
                }

                // Get all campaigns for this client
                const campaigns = calendarManager.campaigns || [];

                // Count modifications
                const modifiedEvents = campaigns.filter(c => c.modified === true).length;
                const unmodifiedEvents = campaigns.length - modifiedEvents;

                // Build export metadata
                const exportMetadata = {
                    source: 'EmailPilot Calendar',
                    version: '2.0',
                    exported_at: new Date().toISOString(),
                    client_id: clientId,
                    client_name: clientName,

                    // Include original import metadata if available
                    import_metadata: originalImportMetadata ? {
                        enriched_context_key: originalImportMetadata.enriched_context_key || null,
                        enriched_context_url: originalImportMetadata.enriched_context_url || null,
                        enriched_context_available: originalImportMetadata.enriched_context_available || false,
                        original_source: originalImportMetadata.source || 'unknown',
                        original_import_batch_id: originalImportMetadata.batch_id || null,
                        imported_at: originalImportMetadata.generated_at || null
                    } : null,

                    // Export summary
                    export_summary: {
                        total_events: campaigns.length,
                        modified_events: modifiedEvents,
                        unmodified_events: unmodifiedEvents,
                        export_purpose: 'brief_generation'
                    }
                };

                // Format events for export (preserve ALL data)
                const exportEvents = campaigns.map(campaign => {
                    // Format date as YYYY-MM-DD
                    const eventDate = campaign.date instanceof Date
                        ? `${campaign.date.getFullYear()}-${String(campaign.date.getMonth() + 1).padStart(2, '0')}-${String(campaign.date.getDate()).padStart(2, '0')}`
                        : campaign.event_date;

                    return {
                        // Standard calendar fields
                        id: campaign.id,
                        original_id: campaign.original_id || campaign.id,
                        name: campaign.name,
                        event_date: eventDate,
                        type: campaign.type,
                        channel: campaign.channel,
                        time: campaign.time || campaign.send_time,
                        send_time: campaign.send_time || campaign.time,
                        segment: campaign.segment,
                        description: campaign.description || campaign.content || '',

                        // NEW: Preserve all custom fields from import
                        custom_fields: campaign.custom_fields || campaign.originalData || {},

                        // NEW: Import metadata (linkage to enriched context)
                        import_metadata: campaign.import_metadata || null,

                        // NEW: Modification tracking
                        created_at: campaign.created_at || null,
                        updated_at: campaign.updated_at || new Date().toISOString(),
                        modified: campaign.modified || false,
                        modified_fields: campaign.modified_fields || [],

                        // Additional calendar-specific fields
                        color: campaign.color,
                        gradient: campaign.gradient,
                        emoji: campaign.emoji,
                        is_resend: campaign.is_resend || false,
                        campaignMessageType: campaign.campaignMessageType || null,
                        expected_metrics: campaign.expected_metrics || {}
                    };
                });

                // Build final export structure
                const exportData = {
                    metadata: exportMetadata,
                    events: exportEvents
                };

                // Generate filename
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `${clientName.replace(/\s+/g, '-')}-calendar-reviewed-${timestamp}.json`;

                // Trigger download
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                console.log('✅ Exported calendar for brief generation:', {
                    total_events: campaigns.length,
                    modified_events: modifiedEvents,
                    filename: filename,
                    has_enriched_context: exportMetadata.import_metadata?.enriched_context_available || false
                });

                showToast(`Calendar exported: ${filename}`, 'success');

            } catch (error) {
                console.error('Export failed:', error);
                showToast('Failed to export calendar', 'error');
            }
        }

        async function importEventsToCalendar(events) {
            // Track imported campaign IDs for undo functionality
            const importedIds = events.map(e => e.id);

            // Store previous state before import
            const previousCampaignsCount = calendarManager.campaigns.length;

            // Add events to the calendar manager
            events.forEach(event => {
                calendarManager.campaigns.push(event);
            });

            // Auto-save to cloud after import
            await calendarManager.saveToCloud();

            // Refresh the calendar display
            calendarManager.renderCalendar();
            calendarManager.updateStats();

            // Show success message with undo option
            const importCount = events.length;
            const channelBreakdown = {};
            events.forEach(e => {
                const ch = e.channel || 'email';
                channelBreakdown[ch] = (channelBreakdown[ch] || 0) + 1;
            });

            const channelSummary = Object.entries(channelBreakdown)
                .map(([ch, count]) => `${count} ${ch.toUpperCase()}`)
                .join(', ');

            showToast(
                `✅ Imported ${importCount} campaign(s) (${channelSummary}) and auto-saved to cloud`,
                'success',
                7000
            );

            // Store undo handler for this import
            window.lastImportUndoHandler = async function() {
                // Remove imported campaigns
                calendarManager.campaigns = calendarManager.campaigns.filter(
                    c => !importedIds.includes(c.id)
                );

                // Re-save to cloud after removal
                await calendarManager.saveToCloud();

                // Refresh display
                calendarManager.renderCalendar();
                calendarManager.updateStats();

                showToast(`⏪ Undid import of ${importCount} campaign(s) and removed from cloud`, 'info');

                // Clear the undo handler
                window.lastImportUndoHandler = null;
            };
        }

        function confirmAction() {
            if (calendarManager.pendingAction) {
                calendarManager.pendingAction();
                calendarManager.pendingAction = null;
            }
            closeConfirmModal();
        }

        // AI Chat Functions
        async function sendChatMessage() {
            // Check if a client is selected first
            if (!window.calendarManager || !window.calendarManager.selectedClient) {
                showToast('Please select a client first before using Ask EmailPilot', 'warning');
                return;
            }
            
            const input = document.getElementById('chatInput');
            if (!input) {
                console.error('Chat input not found');
                alert('Chat input not found. Please refresh the page.');
                return;
            }
            
            const message = input.value.trim();
            if (!message) {
                console.log('Empty message, skipping');
                return;
            }
            
            console.log('Sending message:', message);
            
            // Clear input immediately
            input.value = '';
            
            // Add user message to chat
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory) {
                const userMsg = document.createElement('div');
                userMsg.className = 'user-message';
                userMsg.innerHTML = `
                    <div class="text-sm text-lime-400 mb-1">You</div>
                    <div class="text-white/90">${message}</div>
                `;
                chatHistory.appendChild(userMsg);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            
            // Send to AI if calendar manager exists
            if (window.calendarManager && typeof calendarManager.sendChatMessage === 'function') {
                await calendarManager.sendChatMessage(message);
            } else {
                console.error('Calendar manager not initialized or sendChatMessage not found');
            }
        }
        
        function showCampaignDetails(campaignId) {
            const campaign = calendarManager.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            const modal = document.getElementById('campaignModal');
            const details = document.getElementById('campaignDetails');

            // Get channel emoji
            let channelEmoji = '📧';
            if (campaign.channel === 'sms') channelEmoji = '📱';
            else if (campaign.channel === 'push') channelEmoji = '💻';
            else if (campaign.emoji) channelEmoji = campaign.emoji;

            // Format audience/segments
            const segments = campaign.segments || campaign.segment || campaign.audience || [];
            const segmentsList = Array.isArray(segments) ? segments : [segments];
            const audienceDisplay = segmentsList.filter(s => s).join(', ') || 'All Subscribers';

            details.innerHTML = `
                <h3 class="text-2xl font-black gradient-text mb-4">${channelEmoji} ${campaign.name}</h3>

                <!-- Campaign Status Bar -->
                ${campaign.status ? `
                <div class="glass-card p-3 mb-4 border-l-4 ${
                    campaign.status === 'sent' ? 'border-green-500' :
                    campaign.status === 'scheduled' ? 'border-blue-500' :
                    campaign.status === 'draft' ? 'border-yellow-500' : 'border-gray-500'
                }">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold ${
                            campaign.status === 'sent' ? 'text-green-400' :
                            campaign.status === 'scheduled' ? 'text-blue-400' :
                            campaign.status === 'draft' ? 'text-yellow-400' : 'text-gray-400'
                        }">
                            ${campaign.status.toUpperCase()}
                        </span>
                        ${campaign.sentAt ? `<span class="text-xs text-white/50">Sent: ${new Date(campaign.sentAt).toLocaleString()}</span>` : ''}
                    </div>
                </div>
                ` : ''}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Core Details -->
                    <div class="glass-card p-4">
                        <div class="text-xs text-purple-400 font-semibold mb-3 uppercase tracking-wider">Campaign Details</div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-white/50">Date</span>
                                <span class="font-semibold">${campaign.date.toLocaleDateString('en-US', {
                                    weekday: 'short',
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric'
                                })}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-white/50">Time</span>
                                <span class="font-semibold">${formatTimeTo12Hour(campaign.time || campaign.send_time)}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-white/50">Channel</span>
                                <span class="font-semibold capitalize">${campaign.channel || 'Email'}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-white/50">Type</span>
                                <span class="font-semibold capitalize">${
                                    campaign.type === 'promotional' ? '🎯 Promotional' :
                                    campaign.type === 'content' ? '📰 Content' :
                                    campaign.type === 'engagement' ? '💬 Engagement' :
                                    campaign.type === 'seasonal' ? '🎄 Seasonal' :
                                    campaign.type === 'transactional' ? '📦 Transactional' :
                                    campaign.type || 'Unknown'
                                }</span>
                            </div>
                        </div>
                    </div>

                    <!-- Audience & Targeting -->
                    <div class="glass-card p-4">
                        <div class="text-xs text-green-400 font-semibold mb-3 uppercase tracking-wider">Audience & Targeting</div>
                        <div class="space-y-3">
                            <div>
                                <span class="text-sm text-white/50 block mb-1">Target Segments</span>
                                <div class="flex flex-wrap gap-2">
                                    ${segmentsList.filter(s => s).map(seg => `
                                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-white/10 rounded-md text-xs">
                                            🎯 ${seg}
                                        </span>
                                    `).join('') || '<span class="text-xs text-white/50">All Subscribers</span>'}
                                </div>
                            </div>
                            ${campaign.audience_size ? `
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-white/50">Audience Size</span>
                                <span class="font-semibold">${campaign.audience_size.toLocaleString()}</span>
                            </div>
                            ` : ''}
                            ${campaign.location ? `
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-white/50">Location</span>
                                <span class="font-semibold">${campaign.location}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics (compact) -->
                <div class="glass-card p-3 mt-3">
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-cyan-400 font-semibold uppercase tracking-wider">Expected Performance</div>
                        <div class="flex gap-4 text-xs">
                            <span><span class="text-white/50">Open:</span> <span class="font-bold">${((campaign.metrics?.openRate || campaign.strategy?.performance_forecast?.predicted_open_rate || campaign.expected_metrics?.open_rate || 20)).toFixed(1)}%</span></span>
                            <span><span class="text-white/50">Click:</span> <span class="font-bold">${((campaign.metrics?.clickRate || campaign.strategy?.performance_forecast?.predicted_click_rate || campaign.expected_metrics?.click_rate || 3)).toFixed(1)}%</span></span>
                            <span><span class="text-white/50">Revenue:</span> <span class="font-bold text-green-400">$${Math.round(campaign.metrics?.revenue || campaign.strategy?.performance_forecast?.estimated_revenue || campaign.expected_metrics?.revenue || 5000).toLocaleString()}</span></span>
                        </div>
                    </div>
                </div>

                <!-- Campaign Content -->
                ${campaign.description || campaign.subject_line || campaign.subject_a || campaign.preview_text ? `
                <div class="glass-card p-4 mt-4">
                    <div class="text-xs text-yellow-400 font-semibold mb-3 uppercase tracking-wider">Content Preview</div>
                    <div class="space-y-3">
                        ${campaign.subject_a || campaign.subject_line ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Subject Line A</span>
                            <div class="font-semibold">${campaign.subject_a || campaign.subject_line}</div>
                        </div>
                        ` : ''}
                        ${campaign.subject_b ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Subject Line B (A/B Test)</span>
                            <div class="font-semibold">${campaign.subject_b}</div>
                        </div>
                        ` : ''}
                        ${campaign.preview_text ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Preview Text</span>
                            <div class="text-sm">${campaign.preview_text}</div>
                        </div>
                        ` : ''}
                        ${campaign.main_cta ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Call-to-Action</span>
                            <div class="inline-block px-3 py-1 bg-purple-500/30 rounded-md text-sm font-semibold">${campaign.main_cta}</div>
                        </div>
                        ` : ''}
                        ${campaign.offer ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Offer</span>
                            <div class="text-sm font-semibold text-green-400">${campaign.offer}</div>
                        </div>
                        ` : ''}
                        ${campaign.content_brief ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Content Brief</span>
                            <div class="text-sm leading-relaxed">${campaign.content_brief}</div>
                        </div>
                        ` : ''}
                        ${campaign.template_type ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Template Type</span>
                            <div class="text-sm capitalize">${campaign.template_type}</div>
                        </div>
                        ` : ''}
                        ${campaign.description && !campaign.content_brief ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Description</span>
                            <div class="text-sm leading-relaxed">${campaign.description}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Strategy Details -->
                ${campaign.strategy ? `
                <div class="glass-card p-4 mt-4">
                    <div class="text-xs text-orange-400 font-semibold mb-3 uppercase tracking-wider">AI Strategy</div>
                    <div class="space-y-3">
                        ${campaign.strategy.send_time_rationale ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Send Time Rationale</span>
                            <div class="text-sm leading-relaxed">${campaign.strategy.send_time_rationale}</div>
                        </div>
                        ` : ''}
                        ${campaign.strategy.targeting_rationale ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Targeting Rationale</span>
                            <div class="text-sm leading-relaxed">${campaign.strategy.targeting_rationale}</div>
                        </div>
                        ` : ''}
                        ${campaign.strategy.ab_test ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">A/B Test Plan</span>
                            <div class="text-xs space-y-1">
                                <div><span class="text-white/50">Element:</span> ${campaign.strategy.ab_test.element || 'N/A'}</div>
                                <div><span class="text-white/50">Hypothesis:</span> ${campaign.strategy.ab_test.hypothesis || 'N/A'}</div>
                                <div><span class="text-white/50">Expected Impact:</span> ${campaign.strategy.ab_test.expected_impact || 'N/A'}</div>
                            </div>
                        </div>
                        ` : ''}
                        ${campaign.strategy.offer_strategy ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Offer Strategy</span>
                            <div class="text-xs space-y-1">
                                ${campaign.strategy.offer_strategy.details ? `<div>${campaign.strategy.offer_strategy.details}</div>` : ''}
                                ${campaign.strategy.offer_strategy.urgency ? `<div class="text-yellow-400">${campaign.strategy.offer_strategy.urgency}</div>` : ''}
                                ${campaign.strategy.offer_strategy.expected_lift ? `<div class="text-green-400">Expected lift: ${campaign.strategy.offer_strategy.expected_lift}</div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        ${campaign.strategy.mcp_evidence ? `
                        <div>
                            <span class="text-sm text-white/50 block mb-1">Historical Evidence</span>
                            <div class="text-xs space-y-1 text-white/70">
                                ${campaign.strategy.mcp_evidence.historical_performance ? `<div>${campaign.strategy.mcp_evidence.historical_performance}</div>` : ''}
                                ${campaign.strategy.mcp_evidence.segment_insights ? `<div>${campaign.strategy.mcp_evidence.segment_insights}</div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Goals & KPIs -->
                ${campaign.goals || campaign.kpis ? `
                <div class="glass-card p-4 mt-4">
                    <div class="text-xs text-indigo-400 font-semibold mb-3 uppercase tracking-wider">Goals & KPIs</div>
                    <div class="space-y-2">
                        ${campaign.goals ? campaign.goals.map(goal => `
                            <div class="flex items-center gap-2">
                                <span class="text-green-400">✓</span>
                                <span class="text-sm">${goal}</span>
                            </div>
                        `).join('') : ''}
                        ${campaign.kpis ? `
                            <div class="grid grid-cols-2 gap-2 mt-3">
                                ${Object.entries(campaign.kpis).map(([key, value]) => `
                                    <div class="flex justify-between p-2 bg-white/5 rounded">
                                        <span class="text-xs text-white/50">${key}</span>
                                        <span class="text-xs font-bold">${value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Tags & Labels -->
                ${campaign.tags || campaign.labels ? `
                <div class="glass-card p-4 mt-4">
                    <div class="text-xs text-pink-400 font-semibold mb-3 uppercase tracking-wider">Tags & Labels</div>
                    <div class="flex flex-wrap gap-2">
                        ${(campaign.tags || campaign.labels || []).map(tag => `
                            <span class="inline-flex items-center px-2 py-1 bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-full text-xs">
                                #${tag}
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Action Buttons -->
                <div class="flex gap-3 mt-6">
                    <button onclick="calendarManager.editCampaign('${campaignId}'); closeCampaignModal();"
                            class="glow-button flex-1">
                        ✏️ Edit Campaign
                    </button>
                    <button onclick="calendarManager.duplicateCampaign('${campaignId}'); closeCampaignModal();"
                            class="glow-button flex-1">
                        📋 Duplicate
                    </button>
                    <button onclick="if(confirm('Delete this campaign?')) { calendarManager.deleteCampaign('${campaignId}'); closeCampaignModal(); }"
                            class="glow-button flex-1 bg-red-500/20 border-red-500/50 hover:bg-red-500/30">
                        🗑️ Delete
                    </button>
                </div>
            `;

            modal.classList.add('show');
        }

        function updateCampaignTypeById(campaignId, newType) {
            const campaign = calendarManager.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;

            // Update the campaign type
            campaign.type = newType;

            // Save to cloud
            calendarManager.saveToCloud();

            // Re-render the calendar
            if (calendarManager.currentView === 'list') {
                renderListView();
            } else if (calendarManager.currentView === 'week') {
                renderWeekView();
            } else {
                calendarManager.renderCalendar();
            }

            showToast(`Campaign type updated to ${newType}`, 'success');
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').classList.remove('show');
        }

        // Section Toggle for Pills
        function toggleSection(section) {
            const panels = {
                strategy: document.getElementById('strategyPanel'),
                performance: document.getElementById('statsRow'),
                search: document.getElementById('searchPanel')
            };
            const pills = {
                strategy: document.getElementById('strategyPill'),
                performance: document.getElementById('performancePill'),
                search: document.getElementById('searchPill')
            };

            const panel = panels[section];
            const pill = pills[section];

            if (!panel || !pill) {
                console.warn('toggleSection: panel or pill not found for', section);
                return;
            }

            const isActive = pill.classList.contains('active');
            console.log(`toggleSection(${section}): isActive=${isActive}`);

            if (isActive) {
                // Hide - remove client-selected to let CSS hide it
                panel.classList.remove('client-selected');
                panel.style.display = 'none';
                pill.classList.remove('active');
            } else {
                // Show - add client-selected and grid class for statsRow
                panel.classList.add('client-selected');
                if (section === 'performance') {
                    panel.classList.add('grid');
                }
                panel.style.display = '';
                pill.classList.add('active');

                // Focus search input if search
                if (section === 'search') {
                    setTimeout(() => {
                        const input = document.getElementById('campaignSearch');
                        if (input) input.focus();
                    }, 100);
                }
            }
        }

        // Search campaigns
        function searchCampaigns(query) {
            if (!window.calendarManager) return;

            const campaigns = calendarManager.campaigns || [];
            const q = query.toLowerCase().trim();

            if (!q) {
                // Reset - show all
                calendarManager.renderCalendar();
                return;
            }

            // Filter campaigns
            const filtered = campaigns.filter(c =>
                c.name?.toLowerCase().includes(q) ||
                c.subject_a?.toLowerCase().includes(q) ||
                c.subject_b?.toLowerCase().includes(q) ||
                c.type?.toLowerCase().includes(q) ||
                c.description?.toLowerCase().includes(q)
            );

            // Highlight matching campaigns (simple approach - just log for now)
            console.log(`Found ${filtered.length} campaigns matching "${query}"`);
            showToast(`Found ${filtered.length} campaigns`, 'info');
        }

        // Load Strategy Summary for current client
        async function loadStrategySummary(clientId) {
            const panel = document.getElementById('strategyPanel');
            const content = document.getElementById('strategyContent');

            if (!clientId) {
                panel.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/calendar/strategy-summary/${clientId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.strategy) {
                        const strategy = data.strategy;
                        content.innerHTML = `
                            ${strategy.period_overview ? `
                            <div>
                                <span class="text-white/50 text-xs uppercase">Period Overview</span>
                                <div class="text-white/90">${strategy.period_overview}</div>
                            </div>
                            ` : ''}
                            ${strategy.key_objectives ? `
                            <div>
                                <span class="text-white/50 text-xs uppercase">Key Objectives</span>
                                <ul class="list-disc list-inside text-white/90">
                                    ${Array.isArray(strategy.key_objectives)
                                        ? strategy.key_objectives.map(obj => `<li>${obj}</li>`).join('')
                                        : `<li>${strategy.key_objectives}</li>`
                                    }
                                </ul>
                            </div>
                            ` : ''}
                            ${strategy.cadence_strategy ? `
                            <div>
                                <span class="text-white/50 text-xs uppercase">Cadence Strategy</span>
                                <div class="text-white/90">${strategy.cadence_strategy}</div>
                            </div>
                            ` : ''}
                            ${strategy.audience_strategy ? `
                            <div>
                                <span class="text-white/50 text-xs uppercase">Audience Strategy</span>
                                <div class="text-white/90">${strategy.audience_strategy}</div>
                            </div>
                            ` : ''}
                            ${strategy.performance_goals ? `
                            <div>
                                <span class="text-white/50 text-xs uppercase">Performance Goals</span>
                                <div class="text-white/90">${strategy.performance_goals}</div>
                            </div>
                            ` : ''}
                        `;
                    } else {
                        content.innerHTML = '<p class="text-white/50 text-sm">No strategy data available for this client.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading strategy summary:', error);
                content.innerHTML = '<p class="text-white/50 text-sm">Unable to load strategy.</p>';
            }
        }


        let isAnimating = false; // Prevent rapid clicking during animation
        
        async function previousMonth() {
            if (isAnimating) return;
            isAnimating = true;
            
            const container = document.getElementById('calendarContainer');
            if (!container) {
                isAnimating = false;
                return;
            }
            
            // Create wrapper for transition if it doesn't exist
            if (!container.classList.contains('calendar-transition-container')) {
                container.classList.add('calendar-transition-container');
            }
            
            // Clone current calendar
            const currentCalendar = container.innerHTML;
            const currentWrapper = document.createElement('div');
            currentWrapper.className = 'calendar-grid-wrapper calendar-slide-out-right';
            currentWrapper.innerHTML = currentCalendar;
            
            // Update date and render new calendar
            calendarManager.selectedDate.setMonth(calendarManager.selectedDate.getMonth() - 1);
            updateMonthDisplay();

            // Save current month to localStorage
            localStorage.setItem('lastSelectedMonth', calendarManager.selectedDate.toISOString());
            
            // Create new calendar off-screen
            const newWrapper = document.createElement('div');
            newWrapper.className = 'calendar-grid-wrapper calendar-slide-in-left';
            
            // Temporarily render new calendar
            container.style.visibility = 'hidden';
            calendarManager.renderCalendar();
            newWrapper.innerHTML = container.innerHTML;
            container.style.visibility = 'visible';
            
            // Clear container and add both calendars
            container.innerHTML = '';
            container.appendChild(currentWrapper);
            container.appendChild(newWrapper);
            container.classList.add('calendar-animating');
            
            // Clean up after animation
            setTimeout(async () => {
                container.innerHTML = newWrapper.innerHTML;
                container.classList.remove('calendar-animating');
                isAnimating = false;

                // Load events for the new month from Firestore
                await calendarManager.loadFromCloud();
                // Restart Firestore listener for the new month range
                calendarManager.startSyncPolling();
                // Check approval status for the new month
                checkApprovalStatus();
            }, 400);
        }
        
        async function nextMonth() {
            if (isAnimating) return;
            isAnimating = true;
            
            const container = document.getElementById('calendarContainer');
            if (!container) {
                isAnimating = false;
                return;
            }
            
            // Create wrapper for transition if it doesn't exist
            if (!container.classList.contains('calendar-transition-container')) {
                container.classList.add('calendar-transition-container');
            }
            
            // Clone current calendar
            const currentCalendar = container.innerHTML;
            const currentWrapper = document.createElement('div');
            currentWrapper.className = 'calendar-grid-wrapper calendar-slide-out-left';
            currentWrapper.innerHTML = currentCalendar;
            
            // Update date and render new calendar
            calendarManager.selectedDate.setMonth(calendarManager.selectedDate.getMonth() + 1);
            updateMonthDisplay();

            // Save current month to localStorage
            localStorage.setItem('lastSelectedMonth', calendarManager.selectedDate.toISOString());
            
            // Create new calendar off-screen
            const newWrapper = document.createElement('div');
            newWrapper.className = 'calendar-grid-wrapper calendar-slide-in-right';
            
            // Temporarily render new calendar
            container.style.visibility = 'hidden';
            calendarManager.renderCalendar();
            newWrapper.innerHTML = container.innerHTML;
            container.style.visibility = 'visible';
            
            // Clear container and add both calendars
            container.innerHTML = '';
            container.appendChild(currentWrapper);
            container.appendChild(newWrapper);
            container.classList.add('calendar-animating');
            
            // Clean up after animation
            setTimeout(async () => {
                container.innerHTML = newWrapper.innerHTML;
                container.classList.remove('calendar-animating');
                isAnimating = false;

                // Load events for the new month from Firestore
                await calendarManager.loadFromCloud();
                // Restart Firestore listener for the new month range
                calendarManager.startSyncPolling();
                // Check approval status for the new month
                checkApprovalStatus();
            }, 400);
        }
        
        function updateMonthDisplay() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
            const month = calendarManager.selectedDate.getMonth();
            const year = calendarManager.selectedDate.getFullYear();
            document.getElementById('currentMonth').textContent = `${months[month]} ${year}`;
        }
        
        function setView(view) {
            calendarManager.currentView = view;
            
            // Update active button
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('primary');
                btn.classList.remove('active');
                if (btn.dataset.view === view) {
                    btn.classList.add('primary');
                    btn.classList.add('active');
                }
            });
            
            // Re-render based on view
            if (view === 'list') {
                renderListView();
            } else if (view === 'week') {
                renderWeekView();
            } else if (view === 'month') {
                calendarManager.renderCalendar();
            } else {
                // Default to month view
                calendarManager.renderCalendar();
            }
        }

        // Campaign type filter state
        const campaignTypeFilters = {
            email: true,
            sms: true,
            promotional: true,
            content: true,
            resend: true
        };

        function toggleCampaignTypeFilter(filterType) {
            // Toggle the filter state
            campaignTypeFilters[filterType] = !campaignTypeFilters[filterType];

            // Update button appearance
            const button = document.querySelector(`[data-filter="${filterType}"]`);
            if (button) {
                if (campaignTypeFilters[filterType]) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }

            // Re-render the current view with filtered campaigns
            if (calendarManager.currentView === 'list') {
                renderListView();
            } else if (calendarManager.currentView === 'week') {
                renderWeekView();
            } else {
                calendarManager.renderCalendar();
            }
        }

        function shouldShowCampaign(campaign) {
            // Check channel filter (email vs sms vs push)
            // Use 'channel' field first (primary), fallback to 'message_type', default to 'email'
            const channel = (campaign.channel || campaign.message_type || 'email').toLowerCase();

            // Filter by channel - if the campaign's channel filter is OFF, hide it
            if (channel === 'sms' && !campaignTypeFilters.sms) return false;
            if (channel === 'email' && !campaignTypeFilters.email) return false;
            if (channel === 'push' && !campaignTypeFilters.email) return false;  // Push uses email filter for now

            // Check campaign type filter (promotional, content, resend)
            const campaignType = (campaign.type || 'promotional').toLowerCase();

            // Check for resend campaigns (comprehensive check)
            const isResend = campaign.is_resend || campaign.type === 'resend' || campaign.campaignMessageType === 'Resend' || campaign.name.toLowerCase().includes('resend');
            if (isResend && !campaignTypeFilters.resend) return false;

            // Check other types
            if (campaignType === 'promotional' && !campaignTypeFilters.promotional) return false;
            if (campaignType === 'content' && !campaignTypeFilters.content) return false;

            return true;
        }

        function renderListView() {
            const container = document.getElementById('calendarContainer');
            container.className = 'calendar-list-view glass-card p-6';

            const sortedCampaigns = [...calendarManager.campaigns].sort((a, b) => a.date - b.date);

            // Group campaigns by week
            const weeks = {};
            sortedCampaigns.forEach(c => {
                const campaignDate = new Date(c.date);
                // Calculate week start without timezone shift
                const weekStart = new Date(
                    campaignDate.getFullYear(),
                    campaignDate.getMonth(),
                    campaignDate.getDate() - campaignDate.getDay()
                );
                const weekKey = weekStart.toISOString().split('T')[0];
                if (!weeks[weekKey]) weeks[weekKey] = [];
                weeks[weekKey].push(c);
            });

            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black gradient-text">📋 Campaign List View</h3>
                    <div class="flex gap-3 items-center">
                        <select id="listViewSort" class="glass-card px-3 py-2 text-sm rounded-lg border border-white/10 focus:border-purple-500/50 outline-none transition-all cursor-pointer">
                            <option value="date">Sort by Date</option>
                            <option value="name">Sort by Name</option>
                            <option value="revenue">Sort by Revenue</option>
                            <option value="type">Sort by Type</option>
                        </select>
                        <select id="listViewFilter" class="glass-card px-3 py-2 text-sm rounded-lg border border-white/10 focus:border-purple-500/50 outline-none transition-all cursor-pointer">
                            <option value="all">All Campaigns</option>
                            <option value="email">Email Only</option>
                            <option value="sms">SMS Only</option>
                            <option value="push">Push Only</option>
                            <option value="promotional">Promotional</option>
                            <option value="content">Content</option>
                            <option value="engagement">Engagement</option>
                        </select>
                    </div>
                </div>
                <div class="space-y-4" id="listViewWeeksContainer">
                    ${Object.entries(weeks).map(([weekStart, campaigns]) => {
                        const weekDate = new Date(weekStart);
                        const weekEnd = new Date(weekDate);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        const totalRevenue = campaigns.reduce((sum, c) => sum + (c.metrics?.revenue || c.expected_metrics?.revenue || 0), 0);
                        const weekKey = weekStart;

                        return `
                            <div class="glass-card p-4 week-container" data-week="${weekKey}">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="flex items-center gap-3">
                                        <span class="font-semibold text-white/80 text-sm">Week of ${weekDate.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}</span>
                                        <span class="text-xs text-white/40">${campaigns.length} campaign${campaigns.length !== 1 ? 's' : ''}</span>
                                    </div>
                                    <span class="text-lime-400 font-bold text-sm">$${totalRevenue.toLocaleString()} expected</span>
                                </div>
                                <div class="list-view-drop-zone"
                                     data-week="${weekKey}"
                                     ondragover="handleListViewDragOver(event)"
                                     ondrop="handleListViewDrop(event, '${weekKey}')"
                                     ondragleave="handleListViewDragLeave(event)"
                                     style="min-height: 60px; border: 2px dashed transparent; border-radius: 8px; transition: all 0.3s;">
                                    <div class="space-y-2">
                                        ${campaigns.map((c, index) => {
                                            const revenue = c.metrics?.revenue || c.expected_metrics?.revenue || 0;
                                            const openRate = (c.metrics?.openRate || c.expected_metrics?.open_rate || 0.2) * 100;
                                            const clickRate = (c.metrics?.clickRate || c.expected_metrics?.click_rate || 0.05) * 100;
                                            const audienceSize = c.audience_size || c.expected_metrics?.audience_size || 0;

                                            // Get audience/segments to display
                                            const segments = c.segments || c.segment || c.audience || [];
                                            const segmentsList = Array.isArray(segments) ? segments : [segments];
                                            const excludeLabels = ['email', 'sms', 'push', 'EMAIL', 'SMS', 'PUSH'];
                                            const audienceList = segmentsList
                                                .filter(s => s && !excludeLabels.includes(s))
                                                .map(s => {
                                                    return s.split(' ')
                                                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                                        .join(' ');
                                                });

                                            // Determine channel emoji and type
                                            let channelEmoji = '📧';
                                            let channelLabel = 'Email';
                                            if (c.channel === 'sms') {
                                                channelEmoji = '📱';
                                                channelLabel = 'SMS';
                                            } else if (c.channel === 'push') {
                                                channelEmoji = '💻';
                                                channelLabel = 'Push';
                                            } else if (c.emoji) {
                                                channelEmoji = c.emoji;
                                            }

                                            // Get campaign type/gradient class
                                            const typeClass = c.gradient || c.type || 'promotional';
                                            const typeLabel = typeClass.replace('sms-', '').replace(/-/g, ' ').split(' ')
                                                .map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

                                            // Status indicator
                                            const status = c.status || 'draft';
                                            const statusColors = {
                                                'sent': 'text-green-400',
                                                'scheduled': 'text-blue-400',
                                                'draft': 'text-yellow-400'
                                            };

                                            // Check if this is a resend campaign (comprehensive check)
                                            const isResend = c.is_resend || c.type === 'resend' || c.campaignMessageType === 'Resend' || c.name.toLowerCase().includes('resend');

                                            return `
                                                <div class="list-view-campaign-card glass-card p-4 hover:border-purple-500/50 transition-all campaign-${typeClass} ${isResend ? 'is-resend' : ''}"
                                                     data-campaign-id="${c.id}"
                                                     data-week="${weekKey}"
                                                     data-index="${index}"
                                                     style="border-left: 4px solid; position: relative;">
                                                    <div class="flex justify-between items-start gap-4">
                                                        <div class="flex-1">
                                                            <div class="flex items-start justify-between mb-2 cursor-grab active:cursor-grabbing"
                                                                 draggable="true"
                                                                 ondragstart="handleListViewDragStart(event, '${c.id}')"
                                                                 ondragend="handleListViewDragEnd(event)"
                                                                 title="Drag to move campaign">
                                                                <div class="flex items-center gap-2 flex-wrap">
                                                                    <span class="text-2xl">${channelEmoji}</span>
                                                                    <span class="font-bold text-lg cursor-pointer" onclick="showCampaignDetails('${c.id}')" draggable="false">${c.name}</span>
                                                                    <span class="campaign-pill-meta-badge" style="background: rgba(197, 255, 117, 0.2); border: 1px solid rgba(197, 255, 117, 0.4); padding: 3px 8px; border-radius: 8px; font-size: 10px;" draggable="false">${typeLabel}</span>
                                                                    <span class="campaign-pill-meta-badge ${statusColors[status]}" style="padding: 3px 8px; border-radius: 8px; font-size: 10px; text-transform: uppercase; font-weight: 600;" draggable="false">⬤ ${status}</span>
                                                                    ${c.approval_status ? `<span class="approval-badge ${c.approval_status === 'pending_approval' ? 'pending' : c.approval_status}" draggable="false">${c.approval_status === 'pending_approval' ? '⏳ Pending' : c.approval_status === 'approved' ? '✅ Approved' : '❌ Rejected'}</span>` : ''}
                                                                </div>
                                                            </div>

                                                            <div class="text-sm text-white/50 mb-2 flex items-center gap-3" draggable="false">
                                                                <span class="font-medium">📅 ${c.date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' })}</span>
                                                                ${audienceSize > 0 ? `<span>👥 ${audienceSize.toLocaleString()} recipients</span>` : ''}
                                                            </div>

                                                            ${audienceList.length > 0 ? `
                                                            <div class="flex flex-wrap gap-2 mb-3" draggable="false">
                                                                ${audienceList.map(aud => `
                                                                    <span class="campaign-pill-meta-badge" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); padding: 4px 10px; border-radius: 12px; font-size: 11px;" draggable="false">🎯 ${aud}</span>
                                                                `).join('')}
                                                            </div>
                                                            ` : `
                                                            <div class="flex flex-wrap gap-2 mb-3" draggable="false">
                                                                <span class="campaign-pill-meta-badge" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); padding: 4px 10px; border-radius: 12px; font-size: 11px;" draggable="false">🎯 All Subscribers</span>
                                                            </div>
                                                            `}

                                                            <div class="list-view-campaign-details" id="details-${c.id}" style="display: none;" draggable="false">
                                                                <div class="grid grid-cols-2 gap-4 mb-3 p-3 glass-card">
                                                                    ${c.subject ? `
                                                                        <div class="col-span-2">
                                                                            <div class="text-xs text-white/40 mb-1">Subject Line</div>
                                                                            <div class="text-sm text-white/90 font-medium">${c.subject}</div>
                                                                        </div>
                                                                    ` : ''}
                                                                    ${c.preview_text ? `
                                                                        <div class="col-span-2">
                                                                            <div class="text-xs text-white/40 mb-1">Preview Text</div>
                                                                            <div class="text-sm text-white/70">${c.preview_text}</div>
                                                                        </div>
                                                                    ` : ''}
                                                                    ${c.description ? `
                                                                        <div class="col-span-2">
                                                                            <div class="text-xs text-white/40 mb-1">Description</div>
                                                                            <div class="text-sm text-white/70">${c.description}</div>
                                                                        </div>
                                                                    ` : ''}
                                                                    ${c.goals ? `
                                                                        <div class="col-span-2">
                                                                            <div class="text-xs text-white/40 mb-1">Campaign Goals</div>
                                                                            <div class="text-sm text-white/70">${c.goals}</div>
                                                                        </div>
                                                                    ` : ''}
                                                                    ${c.tags && c.tags.length > 0 ? `
                                                                        <div class="col-span-2">
                                                                            <div class="text-xs text-white/40 mb-1">Tags</div>
                                                                            <div class="flex flex-wrap gap-2">
                                                                                ${c.tags.map(tag => `
                                                                                    <span class="campaign-pill-meta-badge" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); padding: 4px 10px; border-radius: 12px; font-size: 11px;">🏷️ ${tag}</span>
                                                                                `).join('')}
                                                                            </div>
                                                                        </div>
                                                                    ` : ''}
                                                                </div>
                                                            </div>

                                                            <div class="flex gap-6 text-xs" draggable="false">
                                                                <span class="text-green-400 font-semibold">💰 $${revenue.toLocaleString()}</span>
                                                                <span class="text-blue-400">📧 ${openRate.toFixed(1)}% open</span>
                                                                <span class="text-purple-400">🖱️ ${clickRate.toFixed(1)}% click</span>
                                                                ${c.expected_metrics?.conversion_rate ? `
                                                                    <span class="text-lime-400">✅ ${(c.expected_metrics.conversion_rate * 100).toFixed(1)}% conv</span>
                                                                ` : ''}
                                                            </div>

                                                            ${(() => {
                                                                const dateStr = `${c.date.getFullYear()}-${String(c.date.getMonth() + 1).padStart(2, '0')}-${String(c.date.getDate()).padStart(2, '0')}`;
                                                                const holidays = calendarManager.holidays[dateStr] || [];
                                                                const klaviyoEvents = calendarManager.klaviyoEvents[dateStr] || [];
                                                                const allEvents = [...holidays, ...klaviyoEvents];
                                                                if (calendarManager.showHolidays && allEvents.length > 0) {
                                                                    return `
                                                                        <div class="mt-3 flex flex-wrap gap-2">
                                                                            ${allEvents.map(h => `
                                                                                <span class="holiday-indicator ${h.category || h.type}" style="font-size: 10px; padding: 3px 8px;" title="${h.name}">
                                                                                    ${h.emoji || '📅'} ${h.name}
                                                                                </span>
                                                                            `).join('')}
                                                                        </div>
                                                                    `;
                                                                }
                                                                return '';
                                                            })()}
                                                        </div>

                                                        <div class="list-view-actions" style="z-index: 10; position: relative;" draggable="false" ondragstart="event.preventDefault(); return false;">
                                                            <button type="button" draggable="false" class="pill-action info" onclick="handleListAction(event, 'details', '${c.id}')" onmousedown="event.stopPropagation()" ondragstart="event.preventDefault(); return false;" title="Toggle Details">
                                                                <i class="fas fa-info-circle"></i>
                                                            </button>
                                                            <button type="button" draggable="false" class="pill-action copy" onclick="handleListAction(event, 'duplicate', '${c.id}')" onmousedown="event.stopPropagation()" ondragstart="event.preventDefault(); return false;" title="Duplicate Campaign">
                                                                <i class="fas fa-copy"></i>
                                                            </button>
                                                            <button type="button" draggable="false" class="pill-action edit" onclick="handleListAction(event, 'edit', '${c.id}')" onmousedown="event.stopPropagation()" ondragstart="event.preventDefault(); return false;" title="Edit Campaign">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button type="button" draggable="false" class="pill-action delete" onclick="handleListAction(event, 'delete', '${c.id}')" onmousedown="event.stopPropagation()" ondragstart="event.preventDefault(); return false;" title="Delete Campaign">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    ${sortedCampaigns.length === 0 ? '<div class="text-center text-white/50 py-8">No campaigns scheduled</div>' : ''}
                </div>
            `;

            // Attach event listeners for sorting and filtering
            setTimeout(() => {
                const sortSelect = document.getElementById('listViewSort');
                const filterSelect = document.getElementById('listViewFilter');

                if (sortSelect) {
                    sortSelect.addEventListener('change', () => applyListViewSortAndFilter());
                }
                if (filterSelect) {
                    filterSelect.addEventListener('change', () => applyListViewSortAndFilter());
                }
            }, 100);
        }

        // Toggle campaign details expansion
        function toggleCampaignDetails(campaignId) {
            const detailsDiv = document.getElementById(`details-${campaignId}`);

            if (detailsDiv) {
                if (detailsDiv.style.display === 'none') {
                    detailsDiv.style.display = 'block';
                } else {
                    detailsDiv.style.display = 'none';
                }
            }
        }

        // Handle list view action buttons
        function handleListAction(event, action, campaignId) {
            event.stopPropagation();
            event.preventDefault();

            switch(action) {
                case 'details':
                    toggleCampaignDetails(campaignId);
                    break;
                case 'duplicate':
                    calendarManager.duplicateCampaign(campaignId);
                    break;
                case 'edit':
                    calendarManager.editCampaign(campaignId);
                    break;
                case 'delete':
                    calendarManager.confirmDeleteCampaign(campaignId);
                    break;
            }
        }

        // Apply sorting and filtering
        function applyListViewSortAndFilter() {
            const sortSelect = document.getElementById('listViewSort');
            const filterSelect = document.getElementById('listViewFilter');

            if (!sortSelect || !filterSelect) return;

            const sortBy = sortSelect.value;
            const filterBy = filterSelect.value;

            let campaigns = [...calendarManager.campaigns];

            // Apply filter
            if (filterBy !== 'all') {
                if (['email', 'sms', 'push'].includes(filterBy)) {
                    campaigns = campaigns.filter(c => c.channel === filterBy);
                } else {
                    campaigns = campaigns.filter(c => {
                        const typeClass = c.gradient || c.type || 'promotional';
                        return typeClass.includes(filterBy);
                    });
                }
            }

            // Apply sort
            campaigns.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'revenue':
                        const revA = a.metrics?.revenue || a.expected_metrics?.revenue || 0;
                        const revB = b.metrics?.revenue || b.expected_metrics?.revenue || 0;
                        return revB - revA;
                    case 'type':
                        const typeA = a.gradient || a.type || 'promotional';
                        const typeB = b.gradient || b.type || 'promotional';
                        return typeA.localeCompare(typeB);
                    case 'date':
                    default:
                        return a.date - b.date;
                }
            });

            // Update calendarManager campaigns temporarily for re-render
            const originalCampaigns = calendarManager.campaigns;
            calendarManager.campaigns = campaigns;
            renderListView();
            calendarManager.campaigns = originalCampaigns;
        }

        // Drag and drop handlers for list view
        let listViewDraggedCampaignId = null;

        function handleListViewDragStart(event, campaignId) {
            listViewDraggedCampaignId = campaignId;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.4';
            event.target.style.transform = 'scale(0.95)';
        }

        function handleListViewDragEnd(event) {
            event.target.style.opacity = '1';
            event.target.style.transform = 'scale(1)';

            // Remove all drop zone highlights
            document.querySelectorAll('.list-view-drop-zone').forEach(zone => {
                zone.style.borderColor = 'transparent';
                zone.style.backgroundColor = 'transparent';
            });
        }

        function handleListViewDragOver(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';

            // Highlight drop zone
            const dropZone = event.currentTarget;
            dropZone.style.borderColor = 'rgba(197, 255, 117, 0.5)';
            dropZone.style.backgroundColor = 'rgba(197, 255, 117, 0.05)';

            return false;
        }

        function handleListViewDragLeave(event) {
            const dropZone = event.currentTarget;
            dropZone.style.borderColor = 'transparent';
            dropZone.style.backgroundColor = 'transparent';
        }

        async function handleListViewDrop(event, targetWeekKey) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }

            // Remove highlight
            const dropZone = event.currentTarget;
            dropZone.style.borderColor = 'transparent';
            dropZone.style.backgroundColor = 'transparent';

            if (listViewDraggedCampaignId) {
                const campaign = calendarManager.campaigns.find(c => c.id === listViewDraggedCampaignId);
                if (!campaign) return;

                // Calculate new date from target week
                const targetDate = new Date(targetWeekKey);
                const currentDayOfWeek = campaign.date.getDay();

                // Set to same day of week in target week
                const newDate = new Date(targetDate);
                newDate.setDate(newDate.getDate() + currentDayOfWeek);

                // Update campaign date
                campaign.date = newDate;

                // Save to cloud
                await calendarManager.saveToCloud();

                // Re-render list view
                renderListView();

                // Show success message
                showToast(`Campaign moved to ${newDate.toLocaleDateString()}`, 'success');
            }

            listViewDraggedCampaignId = null;
            return false;
        }
        // PHASE 1.2: Week View Navigation - Track current week offset
        let currentWeekOffset = 0;

        function previousWeek() {
            currentWeekOffset--;
            renderWeekView();
        }

        function nextWeek() {
            currentWeekOffset++;
            renderWeekView();
        }

        function goToCurrentWeek() {
            currentWeekOffset = 0;
            renderWeekView();
        }

        
        function renderWeekView() {
            const container = document.getElementById('calendarContainer');

            // Save current scroll position before re-rendering
            const existingGrid = container.querySelector('.week-timeline-grid');
            const savedScrollTop = existingGrid ? existingGrid.scrollTop : null;

            container.className = 'calendar-week-timeline';

            // Define today for comparison
            const today = new Date();

            // Get the selected date from calendar manager
            const selectedDate = new Date(calendarManager.selectedDate);
            // Find the start of the week (Sunday)
            const weekStart = new Date(selectedDate);
            weekStart.setDate(selectedDate.getDate() - selectedDate.getDay() + (currentWeekOffset * 7));

            // Create 7 days (Sunday - Saturday)
            const weekDays = [];
            for (let d = 0; d < 7; d++) {
                const day = new Date(weekStart);
                day.setDate(day.getDate() + d);

                const dayCampaigns = calendarManager.campaigns.filter(c => {
                    const matchesDate = c.date.getFullYear() === day.getFullYear() &&
                        c.date.getMonth() === day.getMonth() &&
                        c.date.getDate() === day.getDate();

                    // Apply campaign type filters
                    return matchesDate && shouldShowCampaign(c);
                });

                weekDays.push({
                    date: new Date(day),
                    campaigns: dayCampaigns,
                    isToday: day.toDateString() === today.toDateString()
                });
            }

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            // Calculate total revenue for the week
            const weekRevenue = weekDays.reduce((sum, day) =>
                sum + day.campaigns.reduce((s, c) => s + (c.metrics?.revenue || c.expected_metrics?.revenue || 0), 0), 0
            );

            // Create hourly timeline
            const hours = [];
            for (let h = 0; h < 24; h++) {
                hours.push({
                    hour: h,
                    label: h === 0 ? '12 AM' : h < 12 ? `${h} AM` : h === 12 ? '12 PM' : `${h - 12} PM`
                });
            }

            container.innerHTML = `
                <div class="week-timeline-header">
                    <h3 class="text-xl font-bold gradient-text mb-2">📅 Week View</h3>
                    <div class="week-nav-container">
                        <button onclick="previousWeek()" class="glow-button">← Prev Week</button>
                        <button onclick="goToCurrentWeek()" class="glow-button">Today</button>
                        <button onclick="nextWeek()" class="glow-button">Next Week →</button>
                    </div>
                    <div class="text-sm text-white/60 mb-4">
                        ${weekDays[0].date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} -
                        ${weekDays[6].date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                        <span class="text-lime-400 ml-4">$${weekRevenue.toLocaleString()} expected</span>
                    </div>
                </div>

                <div class="week-timeline-container">
                    <!-- Time labels column -->
                    <div class="week-timeline-times">
                        <div class="week-timeline-corner"></div>
                        ${hours.map(h => `
                            <div class="week-timeline-time-label">${h.label}</div>
                        `).join('')}
                    </div>

                    <!-- Days grid -->
                    <div class="week-timeline-grid">
                        <!-- Day headers -->
                        <div class="week-timeline-days-header">
                            ${weekDays.map((day, idx) => `
                                <div class="week-timeline-day-header ${day.isToday ? 'is-today' : ''}">
                                    <div class="day-name">${dayNames[idx]}</div>
                                    <div class="day-date">${monthNames[day.date.getMonth()]} ${day.date.getDate()}</div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Hour rows -->
                        ${hours.map(hour => `
                            <div class="week-timeline-hour-row">
                                ${weekDays.map((day, dayIdx) => {
                                    const dayKey = `${day.date.getFullYear()}-${day.date.getMonth()}-${day.date.getDate()}`;
                                    return `
                                        <div class="week-timeline-cell ${day.isToday ? 'is-today-col' : ''}"
                                             data-day="${dayIdx}"
                                             data-hour="${hour.hour}"
                                             data-date="${dayKey}"
                                             ondrop="handleTimelineDrop(event)"
                                             ondragover="handleTimelineDragOver(event)">
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}

                        <!-- Campaign blocks (positioned absolutely) -->
                        <div class="week-timeline-campaigns">
                            ${weekDays.map((day, dayIdx) =>
                                day.campaigns.map(campaign => {
                                    // Parse send time - FIXED: Robust parsing for all time formats
                                    const sendTime = campaign.send_time || campaign.time || '10:00 AM';

                                    // Remove any extra whitespace and split by colon
                                    const cleanTime = sendTime.trim();
                                    const parts = cleanTime.split(':');
                                    const hourStr = parts[0];
                                    const minStr = parts[1] || '00';

                                    // Parse hour (before AM/PM)
                                    let hour = parseInt(hourStr);

                                    // Parse minute (extract digits only, ignore AM/PM)
                                    let minute = parseInt(minStr.replace(/[^0-9]/g, '')) || 0;

                                    // Determine AM/PM from the time string (check ENTIRE string, not just minute part)
                                    const isPM = cleanTime.toLowerCase().includes('pm');
                                    const isAM = cleanTime.toLowerCase().includes('am');

                                    // Convert to 24-hour format
                                    if (isPM && hour !== 12) {
                                        hour = hour + 12;
                                    } else if (isAM && hour === 12) {
                                        hour = 0;
                                    }
                                    // For times without AM/PM, hours 13-23 are assumed to be 24-hour format

                                    // Calculate position (percentage of day)
                                    const topPosition = (hour * 60 + minute) / (24 * 60) * 100;
                                    const leftPosition = dayIdx * (100 / 7);
                                    const width = 100 / 7;

                                    const revenue = campaign.metrics?.revenue || campaign.expected_metrics?.revenue || 0;
                                    // Check if this is a resend campaign (comprehensive check)
                                    const isResend = campaign.is_resend || campaign.type === 'resend' || campaign.campaignMessageType === 'Resend' || campaign.name.toLowerCase().includes('resend');

                                    return `
                                        <div class="week-timeline-campaign ${campaign.gradient || campaign.type} ${isResend ? 'is-resend' : ''}"
                                             data-campaign-id="${campaign.id}"
                                             style="top: ${topPosition}%; left: ${leftPosition}%; width: calc(${width}% - 4px);"
                                             draggable="true"
                                             ondragstart="handleCampaignDragStart(event, '${campaign.id}')"
                                             onclick="showCampaignDetails('${campaign.id}')">
                                            <div class="campaign-time">${formatTimeTo12Hour(sendTime)}</div>
                                            <div class="campaign-name">${campaign.emoji || '📧'} ${campaign.name}</div>
                                            ${revenue > 0 ? `<div class="campaign-revenue">$${revenue.toLocaleString()}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;

            // Add current time indicator if today is in view
            const todayIdx = weekDays.findIndex(d => d.isToday);
            if (todayIdx !== -1) {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const topPosition = (currentHour * 60 + currentMinute) / (24 * 60) * 100;

                const indicator = document.createElement('div');
                indicator.className = 'week-timeline-now-indicator';
                indicator.style.top = `${topPosition}%`;
                indicator.innerHTML = `<div class="now-line"></div><div class="now-dot"></div>`;

                const campaignsContainer = container.querySelector('.week-timeline-campaigns');
                if (campaignsContainer) {
                    campaignsContainer.appendChild(indicator);
                }
            }

            // Synchronize scroll between timeline grid and time labels
            const timelineGrid = container.querySelector('.week-timeline-grid');
            const timeLabels = container.querySelector('.week-timeline-times');

            if (timelineGrid && timeLabels) {
                // Remove any existing scroll listeners to prevent duplicates
                timelineGrid.removeEventListener('scroll', syncTimeLabelsScroll);

                // Add new scroll listener
                timelineGrid.addEventListener('scroll', syncTimeLabelsScroll);
            }

            // Restore scroll position or auto-scroll to first event on initial load
            requestAnimationFrame(() => {
                if (!timelineGrid) return;

                if (savedScrollTop !== null) {
                    // Restore previous scroll position (re-render)
                    timelineGrid.scrollTop = savedScrollTop;
                } else {
                    // Initial load: auto-scroll to first event (if any)
                    const firstCampaign = container.querySelector('.week-timeline-campaign');
                    if (firstCampaign) {
                        const campaignTop = parseFloat(firstCampaign.style.top);
                        // Scroll so the first event is visible, with some padding (200px above it)
                        const scrollPosition = (campaignTop / 100) * 1440 - 200; // 1440px = 24 hours * 60px
                        timelineGrid.scrollTop = Math.max(0, scrollPosition);
                    }
                }
            });
        }

        // Scroll synchronization function (defined once to avoid duplicates)
        function syncTimeLabelsScroll(event) {
            const grid = event.target;
            const container = grid.closest('.week-timeline-container');
            const timeLabels = container?.querySelector('.week-timeline-times');

            if (timeLabels) {
                // Sync vertical scroll only
                timeLabels.scrollTop = grid.scrollTop;
            }
        }

        // Drag and drop handlers for week timeline
        let draggedCampaignId = null;

        function handleCampaignDragStart(event, campaignId) {
            draggedCampaignId = campaignId;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.5';
        }

        function handleTimelineDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');

            // Show real-time time feedback during drag
            if (draggedCampaignId) {
                const cell = event.currentTarget;
                const hour = parseInt(cell.dataset.hour);

                // Calculate minute based on mouse position
                const cellRect = cell.getBoundingClientRect();
                const relativeY = event.clientY - cellRect.top;
                const cellHeight = cellRect.height;
                const minuteFraction = relativeY / cellHeight;
                const minute = Math.max(0, Math.min(59, Math.round(minuteFraction * 60)));

                // Format time for display
                const isPM = hour >= 12;
                const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
                const minuteStr = minute.toString().padStart(2, '0');
                const timeStr = `${displayHour}:${minuteStr} ${isPM ? 'PM' : 'AM'}`;

                // Update or create time indicator tooltip
                let tooltip = document.getElementById('drag-time-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'drag-time-tooltip';
                    tooltip.style.cssText = `
                        position: fixed;
                        background: linear-gradient(135deg, rgba(138, 108, 247, 0.98), rgba(123, 95, 238, 0.98));
                        color: white;
                        padding: 12px 20px;
                        border-radius: 12px;
                        font-size: 16px;
                        font-weight: 800;
                        pointer-events: none;
                        z-index: 999999;
                        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(197, 255, 117, 0.6);
                        border: 2px solid rgba(197, 255, 117, 0.8);
                        letter-spacing: 0.5px;
                        transform: translateY(-100%);
                        backdrop-filter: blur(8px);
                    `;
                    document.body.appendChild(tooltip);
                }

                tooltip.innerHTML = `<span style="font-size: 18px; margin-right: 6px;">🕐</span>${timeStr}`;
                tooltip.style.left = `${event.clientX - 50}px`;
                tooltip.style.top = `${event.clientY - 70}px`;
                tooltip.style.display = 'block';
            }
        }

        function handleTimelineDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            if (!draggedCampaignId) return;

            const cell = event.currentTarget;
            const dayIdx = parseInt(cell.dataset.day);
            const hour = parseInt(cell.dataset.hour);

            console.log(`[Drop Debug] Cell: day=${dayIdx}, hour=${hour}`);

            // Find the campaign
            const campaign = calendarManager.campaigns.find(c => c.id === draggedCampaignId);
            if (!campaign) {
                console.error(`[Drop Debug] Campaign not found: ${draggedCampaignId}`);
                return;
            }

            console.log(`[Drop Debug] Campaign found: ${campaign.name}, current time: ${campaign.send_time || campaign.time}`);

            // Calculate minute precision based on mouse position within the cell
            const cellRect = cell.getBoundingClientRect();
            const relativeY = event.clientY - cellRect.top;
            const cellHeight = cellRect.height;
            const minuteFraction = relativeY / cellHeight;
            const minute = Math.round(minuteFraction * 60);

            // Clamp minutes to 0-59 range
            const finalMinute = Math.max(0, Math.min(59, minute));

            console.log(`[Drop Debug] Position in cell: relativeY=${relativeY.toFixed(2)}, cellHeight=${cellHeight.toFixed(2)}, minute=${finalMinute}`);

            // Calculate new date - CRITICAL: Use the WEEK VIEW's week start, not the calendar's selected date
            const selectedDate = new Date(calendarManager.selectedDate);
            const weekStart = new Date(selectedDate);
            // Set to start of week (Sunday)
            weekStart.setDate(selectedDate.getDate() - selectedDate.getDay() + (currentWeekOffset * 7));
            weekStart.setHours(0, 0, 0, 0); // Reset time to midnight

            const newDate = new Date(weekStart);
            newDate.setDate(newDate.getDate() + dayIdx);
            newDate.setHours(hour, finalMinute, 0, 0); // Set the actual time on the date object

            console.log(`[Drop Debug] Week start: ${weekStart.toLocaleDateString()}, New date: ${newDate.toLocaleString()}`);

            // Format new time with minute precision
            const isPM = hour >= 12;
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            const minuteStr = finalMinute.toString().padStart(2, '0');
            const newTime = `${displayHour}:${minuteStr} ${isPM ? 'PM' : 'AM'}`;

            console.log(`[Drop Debug] Formatted time: ${newTime} (hour=${hour}, isPM=${isPM}, displayHour=${displayHour})`);

            // Update campaign
            const oldDate = campaign.date;
            const oldTime = campaign.send_time || campaign.time || '10:00 AM';

            campaign.date = newDate;
            campaign.send_time = newTime;
            campaign.time = newTime;

            console.log(`[Drop Debug] Campaign updated: date=${newDate.toLocaleString()}, send_time=${newTime}, time=${newTime}`);

            // Track change
            pendingChanges.push({
                id: Date.now(),
                type: 'time_change',
                campaignId: campaign.id,
                campaignName: campaign.name,
                field: 'Send Time & Date',
                oldValue: `${oldDate.toLocaleDateString()} at ${oldTime}`,
                newValue: `${newDate.toLocaleDateString()} at ${newTime}`,
                timestamp: new Date()
            });

            // Immediate save to Firestore to prevent state conflicts
            calendarManager.quickUpdate(campaign).catch(err => {
                console.warn('Failed to save drag update:', err);
                showToast('⚠️ Failed to save changes', 'error');
            });

            // Save scroll position before re-rendering
            const grid = document.querySelector('.week-timeline-grid');
            const savedScrollTop = grid ? grid.scrollTop : 0;
            const savedScrollLeft = grid ? grid.scrollLeft : 0;

            // Re-render week view
            renderWeekView();

            // Restore scroll position after re-rendering
            requestAnimationFrame(() => {
                const newGrid = document.querySelector('.week-timeline-grid');
                if (newGrid) {
                    newGrid.scrollTop = savedScrollTop;
                    newGrid.scrollLeft = savedScrollLeft;
                }
            });

            // Show toast
            showToast(`📅 ${campaign.name} moved to ${newDate.toLocaleDateString()} at ${newTime}`);

            // Hide the time tooltip immediately
            const tooltip = document.getElementById('drag-time-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }

            // Clear drag state
            draggedCampaignId = null;
        }

        // Clean up drag state on drag end
        document.addEventListener('dragend', (event) => {
            if (event.target.classList.contains('week-timeline-campaign')) {
                event.target.style.opacity = '1';
            }
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });

            // Remove time tooltip
            const tooltip = document.getElementById('drag-time-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        });
        
        function openCommandPalette() {
            // Create modal for command palette
            const existingModal = document.getElementById('commandPaletteModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'commandPaletteModal';
            modal.className = 'modal-backdrop';
            const isLight = document.body.classList.contains('light-mode');
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 420px;">
                    <h3 class="text-2xl font-black gradient-text mb-6">Quick Actions ${pendingChanges.length > 0 ? '<span class="text-orange-400">(' + pendingChanges.length + ' changes)</span>' : ''}</h3>
                    <div class="space-y-2">
                        ${pendingChanges.length > 0 ? `<button onclick="showChangesPanel(); document.getElementById('commandPaletteModal').remove();" class="w-full glass-card p-4 text-left hover:border-orange-500/50 transition-all flex items-center gap-3" style="background: linear-gradient(135deg, rgba(255, 140, 0, 0.2), rgba(255, 0, 128, 0.2)); border-color: rgba(255, 140, 0, 0.5);">
                            <span class="text-2xl">📋</span>
                            <div class="flex-1">
                                <div class="font-semibold">View Pending Changes</div>
                                <div class="text-xs opacity-70">${pendingChanges.length} items need your attention</div>
                            </div>
                            <div class="notification-badge" style="position: static; margin: 0;">${pendingChanges.length}</div>
                        </button>` : ''}
                        <button onclick="toggleTheme(); document.getElementById('commandPaletteModal').remove();" class="w-full glass-card p-4 text-left hover:border-yellow-500/50 transition-all flex items-center gap-3" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1)); border-color: rgba(255, 215, 0, 0.3); position: relative;">
                            <span class="text-2xl">${isLight ? '☀️' : '🌙'}</span>
                            <div class="flex-1">
                                <div class="font-semibold">Toggle Theme</div>
                                <div class="text-xs opacity-70">Switch to ${isLight ? 'Dark' : 'Light'} Mode</div>
                            </div>
                            <div class="text-xs opacity-50 bg-black/20 px-2 py-1 rounded">⌘T</div>
                        </button>
                        <button onclick="createApprovalPage(); document.getElementById('commandPaletteModal').remove();" class="w-full glass-card p-4 text-left hover:border-purple-500/50 transition-all flex items-center gap-3">
                            <span class="text-2xl">📄</span>
                            <span class="font-semibold">Create Client Approval Page</span>
                        </button>
                        <button onclick="showCurrentMonthChangeRequests(); document.getElementById('commandPaletteModal').remove();" class="w-full glass-card p-4 text-left hover:border-orange-500/50 transition-all flex items-center gap-3" style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 193, 7, 0.1)); border-color: rgba(255, 152, 0, 0.3);">
                            <span class="text-2xl">🔧</span>
                            <span class="font-semibold">View Change Requests</span>
                        </button>
                        <button onclick="calendarManager.undo(); document.getElementById('commandPaletteModal').remove();" class="w-full glass-card p-4 text-left hover:border-purple-500/50 transition-all flex items-center gap-3">
                            <span class="text-2xl">↶</span>
                            <span class="font-semibold">Undo Last Change</span>
                        </button>
                        <button onclick="openHolidayManager(); document.getElementById('commandPaletteModal').remove();" class="w-full glass-card p-4 text-left hover:border-yellow-500/50 transition-all flex items-center gap-3">
                            <span class="text-2xl">📅</span>
                            <span class="font-semibold">Holiday & Event Management</span>
                        </button>
                        <button onclick="showToast('${calendarManager.campaigns.length} campaigns, $' + Math.round(calendarManager.campaigns.reduce((s,c) => s + (c.metrics?.revenue || c.expected_metrics?.revenue || 0), 0)).toLocaleString() + ' expected revenue'); document.getElementById('commandPaletteModal').remove();" class="w-full glass-card p-4 text-left hover:border-green-500/50 transition-all flex items-center gap-3">
                            <span class="text-2xl">📊</span>
                            <span class="font-semibold">View Stats</span>
                        </button>
                        ${pendingChanges.length > 0 ? `<button onclick="approveAllChanges(); document.getElementById('commandPaletteModal').remove();" class="w-full glass-card p-4 text-left hover:border-green-500/50 transition-all flex items-center gap-3" style="background: linear-gradient(135deg, rgba(0, 255, 0, 0.1), rgba(127, 255, 0, 0.1)); border-color: rgba(0, 255, 0, 0.3);">
                            <span class="text-2xl">✅</span>
                            <span class="font-semibold">Approve All Changes</span>
                        </button>` : ''}
                        <button onclick="if(confirm('Clear all campaigns for this month? This action cannot be undone.')) { clearMonthWithLoading(); } else { document.getElementById('commandPaletteModal').remove(); }" class="w-full glass-card p-4 text-left hover:border-red-500/50 transition-all flex items-center gap-3">
                            <span class="text-2xl">🗑️</span>
                            <span class="font-semibold">Clear This Month</span>
                        </button>
                    </div>
                    <button onclick="document.getElementById('commandPaletteModal').remove()" class="glow-button w-full mt-6">Cancel</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show modal with animation
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        
        
        // PHASE 3: Search and Filter
        window.searchQuery = '';

        function filterEvents(query) {
            searchQuery = query.toLowerCase();
            
            // Re-render current view with filter
            if (calendarManager.currentView === 'list') {
                renderListView();
            } else if (calendarManager.currentView === 'week') {
                renderWeekView();
            } else {
                calendarManager.renderCalendar();
            }
        }

        // Update shouldShowCampaign to respect search
        const originalShouldShowCampaign = shouldShowCampaign;
        shouldShowCampaign = function(campaign) {
            if (!originalShouldShowCampaign(campaign)) return false;
            
            if (!searchQuery) return true;
            
            return campaign.name.toLowerCase().includes(searchQuery) ||
                   campaign.type?.toLowerCase().includes(searchQuery) ||
                   campaign.segment?.toLowerCase().includes(searchQuery) ||
                   campaign.description?.toLowerCase().includes(searchQuery);
        };

        // Global keyboard shortcuts - attach to window for better capture
        window.addEventListener('keydown', (e) => {
            // Toggle theme with Ctrl+T or Cmd+T
            if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                e.preventDefault();
                e.stopPropagation();
                toggleTheme();
                return;
            }
            
            // Command palette with Cmd+K or Ctrl+K
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                e.stopPropagation();
                showCommandPalette();
                return;
            }
            
            // Quick month navigation with Alt+Arrow keys (when not in input)
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                if (e.key === 'ArrowLeft' && e.altKey) {
                    e.preventDefault();
                    previousMonth();
                    return;
                } else if (e.key === 'ArrowRight' && e.altKey) {
                    e.preventDefault();
                    nextMonth();
                    return;
                }
            }
            
        }, true);

        // PHASE 2: Comprehensive Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Skip if typing in input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                // Exception: allow Ctrl+K to focus search
                if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    document.getElementById('searchInput')?.focus();
                }
                return;
            }
            
            // Navigation
            if (e.key === 'ArrowLeft' && !e.altKey && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                if (calendarManager.currentView === 'week') {
                    previousWeek();
                } else {
                    previousMonth();
                }
            } else if (e.key === 'ArrowRight' && !e.altKey && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                if (calendarManager.currentView === 'week') {
                    nextWeek();
                } else {
                    nextMonth();
                }
            }
            
            // View switching
            else if (e.key === 'm' || e.key === 'M') {
                setView('month');
            } else if (e.key === 'w' || e.key === 'W') {
                setView('week');
            } else if (e.key === 'l' || e.key === 'L') {
                setView('list');
            }
            
            // Actions
            else if (e.key === 'n' || e.key === 'N') {
                e.preventDefault();
                document.getElementById('createCampaignModal')?.classList.add('show');
            } else if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                document.getElementById('searchInput')?.focus();
            } else if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                calendarManager.saveToCloud();
            } else if (e.key === 'Escape') {
                // Close any open modals
                document.querySelectorAll('.modal-backdrop.show').forEach(m => m.classList.remove('show'));
                // Hide shortcuts modal if open
                const shortcutsModal = document.getElementById('shortcutsModal');
                if (shortcutsModal) shortcutsModal.classList.remove('show');
            } else if (e.key === '?') {
                e.preventDefault();
                toggleShortcutsModal();
            }
        });

        function toggleShortcutsModal() {
            const modal = document.getElementById('shortcutsModal');
            if (modal) {
                modal.classList.toggle('show');
            }
        }


        // Suppress expected browser extension errors that we cannot control
        window.addEventListener('error', (event) => {
            // Chrome extension communication errors - these are external and cannot be prevented
            if (event.message && (
                event.message.includes('extension') ||
                event.message.includes('Could not establish connection') ||
                event.message.includes('Receiving end does not exist') ||
                event.message.includes('Extension context invalidated') ||
                event.message.includes('chrome-extension') ||
                event.message.includes('moz-extension')
            )) {
                console.debug('Browser extension error suppressed (external):', event.message);
                event.preventDefault(); // Prevent the error from appearing in console
                event.stopPropagation(); // Stop the error from bubbling
                return true; // Prevent default error handling
            }
        }, true); // Use capture phase

        // Suppress unhandled promise rejections from browser extensions
        window.addEventListener('unhandledrejection', (event) => {
            // Extension-related promise rejections
            if (event.reason && event.reason.message && (
                event.reason.message.includes('extension') ||
                event.reason.message.includes('Could not establish connection') ||
                event.reason.message.includes('Receiving end does not exist') ||
                event.reason.message.includes('Extension context invalidated') ||
                event.reason.message.includes('chrome-extension') ||
                event.reason.message.includes('moz-extension')
            )) {
                console.debug('Browser extension promise rejection suppressed (external):', event.reason.message);
                event.preventDefault(); // Prevent the unhandled rejection warning
                return true;
            }
        });

        // Initialize on load
        window.addEventListener('load', async () => {
            console.log('Calendar Master: Page loaded, initializing...');

            // Show loading screen IMMEDIATELY before any async operations
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'flex';
            }

            // Initialize theme
            initTheme();

            await calendarManager.loadClients();

            // Restore last selected client and month from localStorage
            const lastClient = localStorage.getItem('lastSelectedClient');
            const lastMonth = localStorage.getItem('lastSelectedMonth');

            if (lastMonth) {
                try {
                    calendarManager.selectedDate = new Date(lastMonth);
                } catch (e) {
                    console.warn('Could not restore last month:', e);
                }
            }

            updateMonthDisplay();
            calendarManager.renderCalendar();

            // Auto-select last client if available
            if (lastClient) {
                setTimeout(() => {
                    selectClient(lastClient);
                }, 100);
            }
            
            // Set up periodic change checking
            setInterval(() => {
                if (calendarManager.selectedClient) {
                    checkForChanges();
                }
            }, 30000); // Check every 30 seconds
            
            // Add fade-in animations
            document.querySelectorAll('.fade-in').forEach((el, i) => {
                setTimeout(() => {
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, i * 100);
            });
            
            // Initialize engaging grade button features
            initializeGradeEngagement();
            
            // Fix Performance box to show teacher emoji and "Grade" text with NEW badge
            setTimeout(() => {
                const gradeDisplay = document.getElementById('gradeDisplay');
                const gradeLabel = document.getElementById('gradeLabel');
                const gradeCard = document.querySelector('.grade-card');
                const curiosityBadge = document.getElementById('curiosityBadge');
                
                // Ensure the grade display shows the teacher emoji and Grade text
                if (gradeDisplay) {
                    gradeDisplay.innerHTML = '<span class="grade-icon" aria-hidden="true">🧑‍🏫</span><span>Grade</span>';
                }
                
                // Ensure the label shows Performance
                if (gradeLabel) {
                    gradeLabel.textContent = 'Performance';
                }
                
                // Remove any has-grade class that might interfere
                if (gradeCard) {
                    gradeCard.classList.remove('has-grade');
                    gradeCard.classList.add('needs-grading');
                }
                
                // Show the NEW! badge if user hasn't clicked before
                if (curiosityBadge) {
                    const hasBeenClicked = localStorage.getItem('gradeButtonClicked') === 'true';
                    if (!hasBeenClicked) {
                        curiosityBadge.style.display = 'block';
                        curiosityBadge.textContent = 'NEW!';
                    }
                }
            }, 200);
            
            // Initialize AI chat input with multiple fallbacks
            function initializeChatInput() {
                const chatInput = document.getElementById('chatInput');
                const aiSection = document.getElementById('aiChatSection');
                const chatHistory = document.getElementById('chatHistory');
                
                if (!chatInput) {
                    console.error('Chat input not found!');
                    return;
                }
                
                // Check if client is selected and update AI Assistant accordingly
                if (!window.calendarManager || !window.calendarManager.selectedClient) {
                    // Disable input and show message
                    chatInput.disabled = true;
                    chatInput.placeholder = 'Select a client above to use Ask EmailPilot';
                    
                    if (chatHistory) {
                        chatHistory.innerHTML = `
                            <div class="ai-message">
                                <div class="text-sm text-yellow-400 mb-1">⚠️ Client Required</div>
                                <div class="text-white/90">Please select a client from the dropdown above to use Ask EmailPilot.</div>
                                <div class="text-white/60 text-sm mt-2">Once you select a client, I can help you:</div>
                                <ul class="text-white/50 text-sm mt-2 ml-4 list-disc">
                                    <li>Add and manage email campaigns</li>
                                    <li>Analyze your calendar performance</li>
                                    <li>Generate AI-powered campaign suggestions</li>
                                </ul>
                            </div>
                        `;
                    }
                } else {
                    // Enable input when client is selected
                    chatInput.disabled = false;
                    chatInput.placeholder = 'Ask me anything about your calendar...';
                }
                
                // Clear all potential blockers
                chatInput.removeAttribute('disabled');
                chatInput.removeAttribute('readonly');
                chatInput.style.cssText += 'pointer-events: auto !important; opacity: 1 !important; z-index: 9999 !important; position: relative !important;';
                
                // Add multiple event handlers
                chatInput.onclick = function(e) {
                    e.stopPropagation();
                    this.focus();
                };
                
                chatInput.onfocus = function() {
                    console.log('Chat input focused');
                };
                
                chatInput.onkeydown = function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('Enter pressed, sending message');
                        sendChatMessage();
                    }
                };
                
                if (aiSection) {
                    aiSection.style.cssText += 'opacity: 1 !important; pointer-events: auto !important;';
                }
                
                // Test that it works
                chatInput.placeholder = 'Ask me to add, move, or delete campaigns...';
                console.log('Chat input initialized successfully');
            }
            
            // Try multiple times to ensure it works
            setTimeout(initializeChatInput, 100);
            setTimeout(initializeChatInput, 500);
            setTimeout(initializeChatInput, 1000);
        });
    </script>
    
    <!-- Holiday Management Modal -->
    <div class="holiday-modal" id="holidayModal">
        <div class="holiday-modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Holiday & Event Management</h2>
                <button onclick="closeHolidayManager()" class="text-2xl hover:text-red-500">×</button>
            </div>
            
            <div class="grid gap-4">
                <!-- Add Custom Holiday -->
                <div class="glass-card p-4">
                    <h3 class="text-lg font-semibold mb-3">Add Custom Holiday/Event</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="date" id="holidayDate" class="form-input" placeholder="Date">
                        <input type="text" id="holidayName" class="form-input" placeholder="Holiday Name">
                        <select id="holidayType" class="form-select">
                            <option value="holiday">Holiday</option>
                            <option value="klaviyo">Klaviyo Event</option>
                            <option value="custom">Custom Event</option>
                        </select>
                        <select id="holidayCategory" class="form-select">
                            <option value="major">Major</option>
                            <option value="federal">Federal</option>
                            <option value="cultural">Cultural</option>
                            <option value="retail">Retail</option>
                            <option value="planning">Planning</option>
                            <option value="campaign">Campaign</option>
                        </select>
                        <input type="text" id="holidayEmoji" class="form-input" placeholder="Emoji (optional)" maxlength="2">
                        <button onclick="addCustomHoliday()" class="glow-button primary">Add Holiday</button>
                    </div>
                </div>
                
                <!-- Import/Export -->
                <div class="glass-card p-4">
                    <h3 class="text-lg font-semibold mb-3">Import/Export Holidays</h3>
                    <div class="flex gap-3">
                        <button onclick="exportHolidays()" class="glow-button">📥 Export Current</button>
                        <input type="file" id="holidayImport" accept=".json" style="display: none" onchange="importHolidays(event)">
                        <button onclick="document.getElementById('holidayImport').click()" class="glow-button">📤 Import JSON</button>
                        <button onclick="resetHolidays()" class="glow-button" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">🔄 Reset to Default</button>
                    </div>
                </div>
                
                <!-- Current Holidays List -->
                <div class="glass-card p-4">
                    <h3 class="text-lg font-semibold mb-3">Current Month Holidays</h3>
                    <div id="holidayList" class="max-h-64 overflow-y-auto">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Holiday Management Functions (in global scope)
        window.deleteHoliday = async function(holidayId) {
            if (!confirm('Delete this holiday?')) return;
            
            try {
                const response = await fetch(`/api/calendar/holidays/custom/${holidayId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await window.calendarManager.loadHolidaysAndEvents();
                    window.calendarManager.renderCalendar();
                    loadCurrentHolidays();
                }
            } catch (error) {
                console.error('Error deleting holiday:', error);
            }
        }
        
        function toggleHolidays() {
            const manager = window.calendarManager;
            if (!manager) return;

            manager.showHolidays = !manager.showHolidays;
            const toggle = document.getElementById('holidayToggle');

            if (manager.showHolidays) {
                toggle.classList.add('active');
                toggle.title = 'Hide Holidays';
            } else {
                toggle.classList.remove('active');
                toggle.title = 'Show Holidays';
            }

            // Re-render the current view
            if (manager.currentView === 'list') {
                renderListView();
            } else if (manager.currentView === 'week') {
                renderWeekView();
            } else {
                manager.renderCalendar();
            }
        }
        
        window.openHolidayManager = function() {
            document.getElementById('holidayModal').classList.add('active');
            loadCurrentHolidays();
        }
        
        window.closeHolidayManager = function() {
            document.getElementById('holidayModal').classList.remove('active');
        }
        
        window.loadCurrentHolidays = async function() {
            const manager = window.calendarManager;
            if (!manager) return;
            
            const year = manager.selectedDate.getFullYear();
            const month = manager.selectedDate.getMonth() + 1;
            
            try {
                const response = await fetch(`/api/calendar/holidays/?year=${year}&month=${month}`);
                const data = await response.json();
                
                const listDiv = document.getElementById('holidayList');
                listDiv.innerHTML = data.holidays.map(h => {
                    // Show delete button for all holidays (they're all in Firestore now)
                    // If no ID, use a combination of date and name as identifier
                    const holidayId = h.id || `${h.date}_${h.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    const canDelete = true; // All holidays can be deleted from Firestore
                    
                    return `
                        <div class="flex items-center justify-between p-2 hover:bg-white/5 rounded">
                            <div class="flex items-center gap-2">
                                <span>${h.emoji || '📅'}</span>
                                <span class="text-sm">${h.name}</span>
                                <span class="text-xs opacity-60">${h.date}</span>
                                <span class="holiday-indicator ${h.category}">${h.type}</span>
                            </div>
                            ${canDelete ? `<button onclick="window.deleteHoliday('${holidayId}')" class="text-red-500 hover:text-red-300 text-xl px-2">×</button>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading holidays:', error);
            }
        }
        
        window.addCustomHoliday = async function() {
            const date = document.getElementById('holidayDate').value;
            const name = document.getElementById('holidayName').value;
            const type = document.getElementById('holidayType').value;
            const category = document.getElementById('holidayCategory').value;
            const emoji = document.getElementById('holidayEmoji').value || '📅';
            
            if (!date || !name) {
                alert('Please enter a date and name');
                return;
            }
            
            try {
                const response = await fetch('/api/calendar/holidays/custom', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date, name, type, category, emoji, admin_only: true })
                });
                
                if (response.ok) {
                    // Clear form
                    document.getElementById('holidayDate').value = '';
                    document.getElementById('holidayName').value = '';
                    document.getElementById('holidayEmoji').value = '';
                    
                    // Reload holidays
                    await window.calendarManager.loadHolidaysAndEvents();
                    window.calendarManager.renderCalendar();
                    loadCurrentHolidays();
                }
            } catch (error) {
                console.error('Error adding holiday:', error);
                alert('Failed to add holiday');
            }
        }
        
        window.exportHolidays = async function() {
            const manager = window.calendarManager;
            if (!manager) return;
            
            const year = manager.selectedDate.getFullYear();
            
            try {
                const response = await fetch(`/api/calendar/holidays/?year=${year}`);
                const data = await response.json();
                
                const blob = new Blob([JSON.stringify(data.holidays, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `holidays_${year}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting holidays:', error);
            }
        }
        
        window.importHolidays = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const holidays = JSON.parse(text);
                
                for (const holiday of holidays) {
                    if (!holiday.date || !holiday.name) continue;
                    
                    await fetch('/api/calendar/holidays/custom', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            date: holiday.date,
                            name: holiday.name,
                            type: holiday.type || 'custom',
                            category: holiday.category || 'custom',
                            emoji: holiday.emoji || '📅',
                            admin_only: true
                        })
                    });
                }
                
                await window.calendarManager.loadHolidaysAndEvents();
                window.calendarManager.renderCalendar();
                loadCurrentHolidays();
                alert('Holidays imported successfully!');
            } catch (error) {
                console.error('Error importing holidays:', error);
                alert('Failed to import holidays. Please check the file format.');
            }
        }
        
        window.resetHolidays = async function() {
            if (!confirm('This will re-initialize all holidays for the current year. Continue?')) return;
            
            const manager = window.calendarManager;
            if (!manager) return;
            
            const year = manager.selectedDate.getFullYear();
            
            try {
                const response = await fetch(`/api/calendar/holidays/initialize/${year}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                alert(data.message);
                
                await window.calendarManager.loadHolidaysAndEvents();
                window.calendarManager.renderCalendar();
                loadCurrentHolidays();
            } catch (error) {
                console.error('Error resetting holidays:', error);
            }
        }

        // Initialize auto-refresh for approval status when page loads
        if (typeof window !== 'undefined') {
            window.addEventListener('load', () => {
                // Start auto-refresh after a short delay to allow calendar to initialize
                setTimeout(() => {
                    if (typeof startApprovalAutoRefresh === 'function') {
                        startApprovalAutoRefresh();
                    }
                }, 2000);
            });

            // Stop auto-refresh when page is about to unload (cleanup)
            window.addEventListener('beforeunload', () => {
                if (typeof stopApprovalAutoRefresh === 'function') {
                    stopApprovalAutoRefresh();
                }
            });
        }
    </script>

    <!-- Client Manager Modal (Iframe) -->
    <div id="clientManagerModal" class="modal-backdrop" style="display: none; z-index: 10000;">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: 1400px; padding: 0; overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-4); background: rgba(255, 255, 255, 0.05); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <h3 class="text-xl font-bold gradient-text">Client Management</h3>
                <button onclick="closeClientManager()" class="text-2xl hover:text-purple-400 transition-colors" style="background: none; border: none; cursor: pointer; color: white;">×</button>
            </div>
            <iframe
                id="clientManagerIframe"
                src="https://emailpilot-orchestrator-935786836546.us-central1.run.app/static/client_manager.html"
                style="width: 100%; height: calc(95vh - 60px); border: none; background: #0a0a0f;"
                allow="clipboard-read; clipboard-write">
            </iframe>
        </div>
    </div>

    <!-- Command Palette Modal (Quick Actions Menu) -->
    <div id="commandModal" class="modal-backdrop" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="text-2xl font-black gradient-text mb-6">Quick Actions</h3>
            <div class="space-y-2">
                <button onclick="cycleTheme(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">🎨</span>
                    <div>
                        <div class="font-semibold">Toggle Theme</div>
                        <div class="text-sm text-white/60">Dark → Light → Reading Mode</div>
                    </div>
                </button>
                <button onclick="createClientApprovalPage(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">📄</span>
                    <div>
                        <div class="font-semibold">Create Client Approval Page</div>
                        <div class="text-sm text-white/60">Generate shareable approval link</div>
                    </div>
                </button>
                <button onclick="showChangeRequests(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">💬</span>
                    <div>
                        <div class="font-semibold">View Change Requests</div>
                        <div class="text-sm text-white/60">See client feedback</div>
                    </div>
                </button>
                <button onclick="openHolidayManager(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">🎄</span>
                    <div>
                        <div class="font-semibold">Holiday & Event Management</div>
                        <div class="text-sm text-white/60">Manage special dates</div>
                    </div>
                </button>
                <button onclick="addNewClient(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">➕</span>
                    <div>
                        <div class="font-semibold">Add Client</div>
                        <div class="text-sm text-white/60">Create new client profile</div>
                    </div>
                </button>
                <button onclick="openGoalManager(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">🎯</span>
                    <div>
                        <div class="font-semibold">Goal Management</div>
                        <div class="text-sm text-white/60">Set campaign goals</div>
                    </div>
                </button>
                <button onclick="viewStats(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">📊</span>
                    <div>
                        <div class="font-semibold">View Stats</div>
                        <div class="text-sm text-white/60">Calendar analytics</div>
                    </div>
                </button>
                <button onclick="exportForBriefGeneration(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">📤</span>
                    <div>
                        <div class="font-semibold">Export for Brief Generation</div>
                        <div class="text-sm text-white/60">Download reviewed calendar with all edits</div>
                    </div>
                </button>
                <button onclick="if(confirm('Clear all campaigns for this month? This action cannot be undone.')) { clearMonthWithLoading(); closeCommandModal(); } else { closeCommandModal(); }" class="command-item">
                    <span class="text-2xl">🗑️</span>
                    <div>
                        <div class="font-semibold">Clear This Month</div>
                        <div class="text-sm text-white/60">Remove all campaigns</div>
                    </div>
                </button>
                <button onclick="closeCommandModal()" class="glow-button mt-4 w-full">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Project Configurator Modal -->
    <div id="projectConfigModal" class="modal-backdrop" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold mb-2">Configure Asana Projects</h2>
                <p class="text-white/60">Map each client to their Asana project and set the Account Management project</p>
            </div>

            <!-- Loading State -->
            <div id="projectConfigLoading" style="text-align: center; padding: 40px;">
                <div class="loading-spinner"></div>
                <p class="mt-4">Loading configuration...</p>
            </div>

            <!-- Configuration Form -->
            <div id="projectConfigForm" style="display: none;">
                <!-- Account Management Project -->
                <div class="mb-6 p-4" style="background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <label class="block font-semibold mb-2">
                        <span class="text-xl">🏢</span> Account Management Project
                    </label>
                    <select id="accountMgmtProject" class="w-full p-3" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white;">
                        <option value="">-- Select Account Management Project --</option>
                    </select>
                    <p class="text-sm text-white/60 mt-2">Tasks will be multi-homed in this project for centralized tracking</p>
                </div>

                <!-- Client Projects -->
                <div class="mb-6">
                    <h3 class="font-semibold text-xl mb-4">
                        <span class="text-xl">👥</span> Client Projects
                    </h3>
                    <div id="clientProjectsList" class="space-y-3">
                        <!-- Client project mappings will be inserted here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4 mt-8">
                    <button onclick="saveProjectConfiguration()" class="glow-button flex-1">
                        <span class="text-xl">💾</span> Save Configuration
                    </button>
                    <button onclick="closeProjectConfigurator()" class="secondary-button flex-1">
                        Cancel
                    </button>
                </div>

                <!-- Status Message -->
                <div id="projectConfigStatus" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Command Fab (Floating Action Button) -->
    <div id="commandFab" class="fab" onclick="openCommandModal()" title="Quick Actions Menu">
        <span id="fabThemeIcon" style="font-size: 24px;">⚡</span>
        <div id="fabNotificationBadge" class="notification-badge" style="display: none;">0</div>
    </div>

    <script>
        // Command Modal Functions
        function openCommandModal() {
            const modal = document.getElementById('commandModal');
            const commandsContainer = modal.querySelector('.space-y-2');
            const hasClient = calendarManager && calendarManager.selectedClient;

            // Clear existing commands
            commandsContainer.innerHTML = '';

            // Always show Toggle Theme
            commandsContainer.innerHTML += `
                <button onclick="cycleTheme(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">🎨</span>
                    <div>
                        <div class="font-semibold">Toggle Theme</div>
                        <div class="text-sm text-white/60">Dark → Light → Reading Mode</div>
                    </div>
                </button>
            `;

            // Always show Add Client
            commandsContainer.innerHTML += `
                <button onclick="addNewClient(); closeCommandModal();" class="command-item">
                    <span class="text-2xl">➕</span>
                    <div>
                        <div class="font-semibold">Add Client</div>
                        <div class="text-sm text-white/60">Create new client profile</div>
                    </div>
                </button>
            `;

            // Show additional commands only if client is selected
            if (hasClient) {
                commandsContainer.innerHTML += `
                    <button onclick="createClientApprovalPage(); closeCommandModal();" class="command-item">
                        <span class="text-2xl">📄</span>
                        <div>
                            <div class="font-semibold">Create Client Approval Page</div>
                            <div class="text-sm text-white/60">Generate shareable approval link</div>
                        </div>
                    </button>
                    <button onclick="showChangeRequests(); closeCommandModal();" class="command-item">
                        <span class="text-2xl">💬</span>
                        <div>
                            <div class="font-semibold">View Change Requests</div>
                            <div class="text-sm text-white/60">See client feedback</div>
                        </div>
                    </button>
                    <button onclick="undoLastChange(); closeCommandModal();" class="command-item">
                        <span class="text-2xl">↩️</span>
                        <div>
                            <div class="font-semibold">Undo Last Change</div>
                            <div class="text-sm text-white/60">Revert recent action</div>
                        </div>
                    </button>
                    <button onclick="openHolidayManager(); closeCommandModal();" class="command-item">
                        <span class="text-2xl">🎄</span>
                        <div>
                            <div class="font-semibold">Holiday & Event Management</div>
                            <div class="text-sm text-white/60">Manage special dates</div>
                        </div>
                    </button>
                    <button onclick="openGoalManager(); closeCommandModal();" class="command-item">
                        <span class="text-2xl">🎯</span>
                        <div>
                            <div class="font-semibold">Goal Management</div>
                            <div class="text-sm text-white/60">Set campaign goals</div>
                        </div>
                    </button>
                    <button onclick="viewStats(); closeCommandModal();" class="command-item">
                        <span class="text-2xl">📊</span>
                        <div>
                            <div class="font-semibold">View Stats</div>
                            <div class="text-sm text-white/60">Calendar analytics</div>
                        </div>
                    </button>
                    <button onclick="openProjectConfigurator(); closeCommandModal();" class="command-item">
                        <span class="text-2xl">⚙️</span>
                        <div>
                            <div class="font-semibold">Configure Projects</div>
                            <div class="text-sm text-white/60">Map clients to Asana projects</div>
                        </div>
                    </button>
                    <button onclick="if(confirm('Clear all campaigns for this month? This action cannot be undone.')) { clearMonthWithLoading(); closeCommandModal(); } else { closeCommandModal(); }" class="command-item">
                        <span class="text-2xl">🗑️</span>
                        <div>
                            <div class="font-semibold">Clear This Month</div>
                            <div class="text-sm text-white/60">Remove all campaigns</div>
                        </div>
                    </button>
                    <button onclick="testBriefsCompleteOverride(); closeCommandModal();" class="command-item" style="border: 2px dashed #f59e0b;">
                        <span class="text-2xl">🧪</span>
                        <div>
                            <div class="font-semibold text-amber-400">[TEST] Briefs Complete Override</div>
                            <div class="text-sm text-amber-300/60">Simulate approved + briefs complete state</div>
                        </div>
                    </button>
                `;
            }

            // Always show Cancel button
            commandsContainer.innerHTML += `
                <button onclick="closeCommandModal()" class="glow-button mt-4 w-full">
                    Cancel
                </button>
            `;

            modal.style.display = 'flex';
        }

        function closeCommandModal() {
            document.getElementById('commandModal').style.display = 'none';
        }

        // Project Configurator Functions
        async function openProjectConfigurator() {
            const modal = document.getElementById('projectConfigModal');
            const loadingDiv = document.getElementById('projectConfigLoading');
            const formDiv = document.getElementById('projectConfigForm');
            const statusDiv = document.getElementById('projectConfigStatus');

            // Show modal with loading state
            modal.style.display = 'flex';
            loadingDiv.style.display = 'block';
            formDiv.style.display = 'none';
            statusDiv.style.display = 'none';

            try {
                // Fetch clients and projects from backend
                const response = await fetch('/api/admin/asana/configuration/clients-and-projects');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error('Failed to load configuration data');
                }

                // Populate Account Management Project dropdown
                const accountMgmtSelect = document.getElementById('accountMgmtProject');
                accountMgmtSelect.innerHTML = '<option value="">-- Select Account Management Project --</option>';

                data.asana_projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.gid;
                    option.textContent = project.name;
                    if (project.gid === data.account_management_project_gid) {
                        option.selected = true;
                    }
                    accountMgmtSelect.appendChild(option);
                });

                // Populate Client Projects list
                const clientsList = document.getElementById('clientProjectsList');
                clientsList.innerHTML = '';

                data.clients.forEach(client => {
                    const clientRow = document.createElement('div');
                    clientRow.className = 'p-3';
                    clientRow.style.cssText = 'background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);';

                    clientRow.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <div class="font-semibold">${client.name}</div>
                                <div class="text-sm text-white/60">${client.client_slug}</div>
                            </div>
                            <div class="flex-1">
                                <select
                                    id="client-project-${client.id}"
                                    data-client-id="${client.id}"
                                    class="w-full p-2"
                                    style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 14px;"
                                >
                                    <option value="">-- No Project --</option>
                                    ${data.asana_projects.map(p =>
                                        `<option value="${p.gid}" ${p.gid === client.asana_project_gid ? 'selected' : ''}>${p.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    `;

                    clientsList.appendChild(clientRow);
                });

                // Hide loading, show form
                loadingDiv.style.display = 'none';
                formDiv.style.display = 'block';

            } catch (error) {
                console.error('Error loading project configuration:', error);
                loadingDiv.innerHTML = `
                    <div style="color: #ef4444; text-align: center;">
                        <div class="text-2xl mb-2">⚠️</div>
                        <div class="font-semibold">Failed to load configuration</div>
                        <div class="text-sm mt-2">${error.message}</div>
                        <button onclick="closeProjectConfigurator()" class="glow-button mt-4">Close</button>
                    </div>
                `;
            }
        }

        function closeProjectConfigurator() {
            document.getElementById('projectConfigModal').style.display = 'none';
        }

        async function saveProjectConfiguration() {
            const statusDiv = document.getElementById('projectConfigStatus');
            const accountMgmtGid = document.getElementById('accountMgmtProject').value;

            // Collect all client-project mappings
            const clientMappings = {};
            document.querySelectorAll('[data-client-id]').forEach(select => {
                const clientId = select.getAttribute('data-client-id');
                const projectGid = select.value || null;
                clientMappings[clientId] = projectGid;
            });

            // Show saving status
            statusDiv.style.display = 'block';
            statusDiv.style.cssText = 'padding: 12px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; color: #60a5fa;';
            statusDiv.innerHTML = '💾 Saving configuration...';

            try {
                const response = await fetch('/api/admin/asana/configuration/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_mappings: clientMappings,
                        account_management_project_gid: accountMgmtGid || null
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const result = await response.json();

                if (result.success) {
                    statusDiv.style.cssText = 'padding: 12px; background: rgba(16, 185, 129, 0.2); border-radius: 8px; color: #34d399;';
                    statusDiv.innerHTML = `
                        <div class="font-semibold">✅ Configuration saved successfully!</div>
                        <div class="text-sm mt-1">Updated ${result.updated_count} client(s)</div>
                        ${result.account_management_message ? `<div class="text-sm mt-1">${result.account_management_message}</div>` : ''}
                        ${result.errors && result.errors.length > 0 ? `<div class="text-sm mt-2 text-yellow-400">⚠️ ${result.errors.join(', ')}</div>` : ''}
                    `;

                    // Close modal after 3 seconds
                    setTimeout(() => {
                        closeProjectConfigurator();
                        showToast('Project configuration saved', 'success');
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Save failed');
                }

            } catch (error) {
                console.error('Error saving configuration:', error);
                statusDiv.style.cssText = 'padding: 12px; background: rgba(239, 68, 68, 0.2); border-radius: 8px; color: #f87171;';
                statusDiv.innerHTML = `
                    <div class="font-semibold">❌ Failed to save configuration</div>
                    <div class="text-sm mt-1">${error.message}</div>
                `;
            }
        }

        // Placeholder functions for command actions (some may already exist)
        function createClientApprovalPage() {
            if (typeof createApprovalPage === 'function') {
                createApprovalPage();
            } else {
                showToast('Approval page generation coming soon!', 'info');
            }
        }

        function showChangeRequests() {
            const section = document.getElementById('changeRequestsSection');
            if (section) {
                section.classList.remove('hidden');
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }


        function openHolidayManager() {
            if (typeof window.openHolidayManager !== 'undefined' && window.openHolidayManager !== openHolidayManager) {
                window.openHolidayManager();
            } else {
                document.getElementById('holidayModal').classList.add('active');
                loadCurrentHolidays();
            }
        }

        function addNewClient() {
            openClientManager('create');
        }

        function editCurrentClient() {
            if (calendarManager && calendarManager.selectedClient) {
                const clientSlug = calendarManager.selectedClient.slug || calendarManager.selectedClient.client_slug || calendarManager.selectedClient.id;
                openClientManager('edit', clientSlug);
            } else {
                showToast('No client selected', 'warning');
            }
        }

        function openClientManager(mode = 'list', clientSlug = null) {
            const modal = document.getElementById('clientManagerModal');
            const iframe = document.getElementById('clientManagerIframe');

            // Build iframe URL with mode parameter
            let iframeUrl = 'https://emailpilot-orchestrator-935786836546.us-central1.run.app/static/client_manager.html';

            if (mode === 'create') {
                iframeUrl += '?action=create';
            } else if (mode === 'edit' && clientSlug) {
                iframeUrl += `?action=edit&client=${clientSlug}`;
            }

            iframe.src = iframeUrl;
            modal.style.display = 'flex';

            // Add escape key listener
            document.addEventListener('keydown', handleClientManagerEscape);
        }

        function closeClientManager() {
            const modal = document.getElementById('clientManagerModal');
            modal.style.display = 'none';

            // Remove escape key listener
            document.removeEventListener('keydown', handleClientManagerEscape);

            // Refresh client list after closing (in case changes were made)
            if (calendarManager) {
                calendarManager.loadClients();
            }
        }

        function handleClientManagerEscape(event) {
            if (event.key === 'Escape') {
                closeClientManager();
            }
        }

        // Listen for messages from client manager iframe
        window.addEventListener('message', function(event) {
            // Security: verify origin
            if (event.origin !== 'https://emailpilot-orchestrator-935786836546.us-central1.run.app') {
                return;
            }

            const data = event.data;

            // Handle different message types
            if (data.type === 'CLIENT_CREATED') {
                showToast(`✅ Client "${data.clientName}" created successfully!`, 'success');
                closeClientManager();
                if (calendarManager) {
                    calendarManager.loadClients();
                }
            } else if (data.type === 'CLIENT_UPDATED') {
                showToast(`✅ Client "${data.clientName}" updated successfully!`, 'success');
                closeClientManager();
                if (calendarManager) {
                    calendarManager.loadClients();
                }
            } else if (data.type === 'CLIENT_DELETED') {
                showToast(`🗑️ Client "${data.clientName}" removed`, 'info');
                closeClientManager();
                if (calendarManager) {
                    calendarManager.loadClients();
                    // If deleted client was selected, clear selection
                    if (calendarManager.selectedClient &&
                        (calendarManager.selectedClient.slug === data.clientSlug ||
                         calendarManager.selectedClient.client_slug === data.clientSlug ||
                         calendarManager.selectedClient.id === data.clientSlug)) {
                        calendarManager.selectedClient = null;
                        document.getElementById('selectedClientName').textContent = 'Select Client';
                        showClientModal();
                    }
                }
            } else if (data.type === 'CLOSE_MANAGER') {
                closeClientManager();
            }
        });

        function openGoalManager() {
            showToast('Goal management coming soon!', 'info');
        }

        function viewStats() {
            showToast('Analytics dashboard coming soon!', 'info');
        }

        function clearThisMonth() {
            if (confirm('Are you sure you want to clear all campaigns for this month?')) {
                if (typeof window.calendarManager !== 'undefined') {
                    const year = window.calendarManager.selectedDate.getFullYear();
                    const month = window.calendarManager.selectedDate.getMonth();

                    // Clear campaigns for current month
                    window.calendarManager.campaigns = window.calendarManager.campaigns.filter(c => {
                        const campDate = new Date(c.date);
                        return campDate.getFullYear() !== year || campDate.getMonth() !== month;
                    });

                    window.calendarManager.renderCalendar();
                    window.calendarManager.saveToLocalStorage();
                    showToast('Month cleared successfully', 'success');
                }
            }
        }

        // Close modal when clicking backdrop
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('commandModal');
            if (e.target === modal) {
                closeCommandModal();
            }
        });
    </script>


    <!-- PHASE 2: Keyboard Shortcuts Help Modal -->
    <div id="shortcutsModal" class="shortcuts-modal">
        <h3 class="text-2xl font-bold mb-4 gradient-text">⌨️ Keyboard Shortcuts</h3>
        <div class="shortcuts-grid text-sm">
            <span class="shortcut-key">←/→</span>
            <span>Navigate weeks/months</span>
            
            <span class="shortcut-key">M</span>
            <span>Switch to Month view</span>
            
            <span class="shortcut-key">W</span>
            <span>Switch to Week view</span>
            
            <span class="shortcut-key">L</span>
            <span>Switch to List view</span>
            
            <span class="shortcut-key">N</span>
            <span>Create new campaign</span>
            
            <span class="shortcut-key">/</span>
            <span>Focus search</span>
            
            <span class="shortcut-key">Ctrl/Cmd + S</span>
            <span>Save to cloud</span>
            
            <span class="shortcut-key">Ctrl/Cmd + T</span>
            <span>Toggle theme</span>
            
            <span class="shortcut-key">Ctrl/Cmd + K</span>
            <span>Command palette</span>
            
            <span class="shortcut-key">ESC</span>
            <span>Close modals</span>
            
            <span class="shortcut-key">?</span>
            <span>Show this help</span>
        </div>
        <div class="mt-6 text-center">
            <button onclick="toggleShortcutsModal()" class="glow-button">Close</button>
        </div>
    </div>

</body>
</html>
