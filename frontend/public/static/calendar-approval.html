<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Approval - EmailPilot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Red Hat Display', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0F0F1E 0%, #1A1A2E 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #8A6CF7, #C5FF75);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .glow-button {
            background: linear-gradient(135deg, #8A6CF7, #7B5FEE);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .glow-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(138, 108, 247, 0.4);
        }
        
        .glow-button.primary {
            background: linear-gradient(135deg, #C5FF75, #9FD938);
            color: #1A1A2E;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-header {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            font-weight: 600;
            padding: 8px;
        }
        
        .calendar-day {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 8px;
            min-height: 120px;
            position: relative;
        }
        
        .calendar-day.has-campaigns {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(138, 108, 247, 0.3);
        }
        
        .campaign-pill {
            background: linear-gradient(135deg, rgba(138, 108, 247, 0.8), rgba(197, 255, 117, 0.8));
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            margin: 2px 0;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            z-index: 100;
        }
        
        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 1px solid rgba(255, 193, 7, 0.4);
        }
        
        .status-approved {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.4);
        }
    </style>
</head>
<body class="text-white">
    <!-- Status Badge -->
    <div id="statusBadge" class="status-badge status-pending">
        Pending Approval
    </div>

    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-black gradient-text mb-4">Campaign Calendar Approval</h1>
            <div id="clientInfo" class="text-xl text-white/80">
                <!-- Client info will be loaded here -->
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-4 gap-4 mb-8">
            <div class="glass-card text-center">
                <div class="text-2xl font-bold" id="totalCampaigns">0</div>
                <div class="text-sm text-white/50">Total Campaigns</div>
            </div>
            <div class="glass-card text-center">
                <div class="text-2xl font-bold" id="expectedRevenue">$0</div>
                <div class="text-sm text-white/50">Expected Revenue</div>
            </div>
            <div class="glass-card text-center">
                <div class="text-2xl font-bold" id="avgOpenRate">0%</div>
                <div class="text-sm text-white/50">Avg Open Rate</div>
            </div>
            <div class="glass-card text-center">
                <div class="text-2xl font-bold" id="monthGoal">$0</div>
                <div class="text-sm text-white/50">Month Goal</div>
            </div>
        </div>

        <!-- Calendar View -->
        <div class="glass-card mb-8">
            <div id="calendarContainer" class="calendar-grid">
                <!-- Calendar will be rendered here -->
            </div>
        </div>

        <!-- Campaign List -->
        <div class="glass-card mb-8">
            <h2 class="text-2xl font-bold mb-4">Campaign Details</h2>
            <div id="campaignList" class="space-y-2">
                <!-- Campaign list will be rendered here -->
            </div>
        </div>

        <!-- Approval Actions -->
        <div class="glass-card text-center">
            <h2 class="text-2xl font-bold mb-4">Review & Approve</h2>
            <p class="text-white/60 mb-6">
                Please review the campaign calendar above. Once you're satisfied with the schedule, 
                click the approve button to confirm.
            </p>
            
            <div class="flex gap-4 justify-center">
                <button onclick="approveCalendar()" class="glow-button primary" id="approveBtn">
                    ‚úÖ Approve Calendar
                </button>
                <button onclick="toggleChangeRequest()" class="glow-button" id="changeRequestBtn">
                    ‚úèÔ∏è Request Changes
                </button>
            </div>
            
            <div id="approvalMessage" class="mt-6 hidden">
                <div class="text-green-400 text-xl font-bold">‚úÖ Calendar Approved!</div>
                <p class="text-white/60 mt-2">Thank you for your approval. We'll begin executing this campaign schedule.</p>
            </div>
        </div>
    </div>

    <script>
        let approvalData = null;
        
        // Get approval ID from URL (supports both path and hash)
        function getApprovalId() {
            // First check if there's a hash (for static serving)
            if (window.location.hash) {
                return window.location.hash.substring(1);
            }
            // Otherwise get from path
            const pathParts = window.location.pathname.split('/');
            const lastPart = pathParts[pathParts.length - 1];
            // If we're on the static page without an ID, return null
            if (lastPart === 'calendar-approval.html') {
                return null;
            }
            return lastPart;
        }
        
        // Load approval data
        async function loadApprovalData() {
            const approvalId = getApprovalId();
            
            if (!approvalId) {
                document.body.innerHTML = `
                    <div class="container mx-auto px-4 py-16 text-center">
                        <h1 class="text-4xl font-bold text-red-400 mb-4">No Approval ID Provided</h1>
                        <p class="text-white/60">Please use the link provided in your email or by your account manager.</p>
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/api/calendar/approval/${approvalId}`);
                if (!response.ok) throw new Error('Failed to load approval page');
                
                const result = await response.json();
                approvalData = result.data;
                
                renderApprovalPage();
            } catch (error) {
                console.error('Error loading approval:', error);
                document.body.innerHTML = `
                    <div class="container mx-auto px-4 py-16 text-center">
                        <h1 class="text-4xl font-bold text-red-400 mb-4">Page Not Found</h1>
                        <p class="text-white/60">This approval page could not be found or has expired.</p>
                    </div>
                `;
            }
        }
        
        // Render the approval page
        function renderApprovalPage() {
            if (!approvalData) return;
            
            // Update client info
            document.getElementById('clientInfo').innerHTML = `
                <strong>${approvalData.client_name}</strong> - ${approvalData.month_name} ${approvalData.year}
            `;
            
            // Update status badge
            if (approvalData.status === 'approved') {
                const badge = document.getElementById('statusBadge');
                badge.className = 'status-badge status-approved';
                badge.textContent = 'Approved';
                
                // Hide approve button
                document.getElementById('approveBtn').style.display = 'none';
                document.getElementById('approvalMessage').classList.remove('hidden');
            }
            
            // Calculate stats
            const campaigns = approvalData.campaigns || [];
            const totalRevenue = campaigns.reduce((sum, c) => 
                sum + (c.metrics?.revenue || c.expected_metrics?.revenue || 0), 0);
            const avgOpenRate = campaigns.reduce((sum, c) => 
                sum + (c.metrics?.openRate || c.expected_metrics?.open_rate || 0), 0) / (campaigns.length || 1);
            
            // Update stats
            document.getElementById('totalCampaigns').textContent = campaigns.length;
            document.getElementById('expectedRevenue').textContent = `$${Math.round(totalRevenue).toLocaleString()}`;
            document.getElementById('avgOpenRate').textContent = `${(avgOpenRate * 100).toFixed(1)}%`;
            document.getElementById('monthGoal').textContent = '$50k'; // Default, could be from client settings
            
            // Render calendar
            renderCalendar(campaigns);
            
            // Render campaign list
            renderCampaignList(campaigns);
        }
        
        // Render calendar grid
        function renderCalendar(campaigns) {
            const container = document.getElementById('calendarContainer');
            const year = approvalData.year;
            const month = parseInt(approvalData.month) - 1; // JS months are 0-indexed
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Clear and add headers
            container.innerHTML = `
                <div class="calendar-header">Sun</div>
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
            `;
            
            // Add empty cells
            for (let i = 0; i < firstDay; i++) {
                container.innerHTML += '<div class="calendar-day opacity-30"></div>';
            }
            
            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCampaigns = campaigns.filter(c => {
                    const campaignDate = new Date(c.date);
                    return campaignDate.getDate() === day;
                });
                
                const hasCampaigns = dayCampaigns.length > 0 ? 'has-campaigns' : '';
                
                container.innerHTML += `
                    <div class="calendar-day ${hasCampaigns}">
                        <div class="text-xs text-white/50 mb-1">${day}</div>
                        ${dayCampaigns.map(c => `
                            <div class="campaign-pill">
                                <span>${c.emoji || 'üìß'}</span>
                                <span class="truncate">${c.name}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
        
        // Render campaign list
        function renderCampaignList(campaigns) {
            const container = document.getElementById('campaignList');
            
            const sortedCampaigns = [...campaigns].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            container.innerHTML = sortedCampaigns.map(c => {
                const date = new Date(c.date);
                const dateStr = date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="glass-card p-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${c.emoji || 'üìß'}</span>
                            <div>
                                <div class="font-semibold">${c.name}</div>
                                <div class="text-sm text-white/50">${dateStr} at ${c.time || '10:00 AM'}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-white/50">Expected</div>
                            <div class="font-semibold">
                                $${Math.round(c.metrics?.revenue || c.expected_metrics?.revenue || 0).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Approve calendar
        async function approveCalendar() {
            const approvalId = getApprovalId();
            
            try {
                const response = await fetch(`/api/calendar/approval/${approvalId}/accept`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error('Failed to approve calendar');
                
                // Update UI
                const badge = document.getElementById('statusBadge');
                badge.className = 'status-badge status-approved';
                badge.textContent = 'Approved';
                
                document.getElementById('approveBtn').style.display = 'none';
                document.getElementById('approvalMessage').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error approving calendar:', error);
                alert('Failed to approve calendar. Please try again.');
            }
        }
        
        // Request changes
        function requestChanges() {
            const email = `mailto:team@emailpilot.ai?subject=Calendar Change Request - ${approvalData.client_name}&body=Hi, I'd like to request the following changes to the ${approvalData.month_name} ${approvalData.year} calendar:%0A%0A[Please describe your requested changes here]`;
            window.location.href = email;
        }
        
        // Load on page ready
        document.addEventListener('DOMContentLoaded', loadApprovalData);
    </script>
</body>
</html>