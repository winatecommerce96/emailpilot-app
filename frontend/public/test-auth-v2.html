<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmailPilot Auth V2 Test</title>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom styles -->
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <!-- Load Auth Components -->
    <script src="/static/dist/components/AuthV2Provider.js"></script>
    <script src="/static/dist/components/LoginV2.js"></script>
    
    <script>
        // Test Dashboard Component
        function AuthV2TestDashboard() {
            const { 
                user, 
                tenant, 
                loading, 
                error, 
                isAuthenticated,
                logout,
                createApiKey,
                listApiKeys,
                revokeApiKey,
                authenticatedFetch
            } = useAuthV2();
            
            const [apiKeys, setApiKeys] = React.useState([]);
            const [newKeyName, setNewKeyName] = React.useState('');
            const [createdKey, setCreatedKey] = React.useState(null);
            const [testResult, setTestResult] = React.useState('');
            
            // Load API keys on mount
            React.useEffect(() => {
                if (isAuthenticated) {
                    loadApiKeys();
                }
            }, [isAuthenticated]);
            
            const loadApiKeys = async () => {
                try {
                    const keys = await listApiKeys();
                    setApiKeys(keys);
                } catch (err) {
                    console.error('Failed to load API keys:', err);
                }
            };
            
            const handleCreateApiKey = async () => {
                if (!newKeyName) return;
                
                try {
                    const key = await createApiKey(newKeyName, ['read', 'write'], 30);
                    setCreatedKey(key);
                    setNewKeyName('');
                    await loadApiKeys();
                } catch (err) {
                    console.error('Failed to create API key:', err);
                }
            };
            
            const handleRevokeKey = async (keyId) => {
                if (!confirm('Are you sure you want to revoke this API key?')) return;
                
                try {
                    await revokeApiKey(keyId);
                    await loadApiKeys();
                } catch (err) {
                    console.error('Failed to revoke API key:', err);
                }
            };
            
            const testAuthenticatedFetch = async () => {
                try {
                    setTestResult('Testing...');
                    const response = await authenticatedFetch('/api/calendar/health');
                    const data = await response.json();
                    setTestResult(JSON.stringify(data, null, 2));
                } catch (err) {
                    setTestResult(`Error: ${err.message}`);
                }
            };
            
            if (loading) {
                return React.createElement('div', {
                    className: 'min-h-screen flex items-center justify-center'
                },
                    React.createElement('div', {
                        className: 'text-center'
                    },
                        React.createElement('div', {
                            className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto'
                        }),
                        React.createElement('p', {
                            className: 'mt-4 text-gray-600'
                        }, 'Loading...')
                    )
                );
            }
            
            if (!isAuthenticated) {
                return React.createElement(LoginV2);
            }
            
            return React.createElement('div', {
                className: 'min-h-screen bg-gray-50'
            },
                // Header
                React.createElement('div', {
                    className: 'gradient-bg text-white'
                },
                    React.createElement('div', {
                        className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6'
                    },
                        React.createElement('div', {
                            className: 'flex justify-between items-center'
                        },
                            React.createElement('h1', {
                                className: 'text-2xl font-bold'
                            }, 'Auth V2 Test Dashboard'),
                            React.createElement('button', {
                                onClick: logout,
                                className: 'px-4 py-2 bg-white text-purple-600 rounded-lg hover:bg-gray-100 transition'
                            }, 'Logout')
                        )
                    )
                ),
                
                // Content
                React.createElement('div', {
                    className: 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8'
                },
                    // User Info Card
                    React.createElement('div', {
                        className: 'bg-white rounded-lg card-shadow p-6 mb-6'
                    },
                        React.createElement('h2', {
                            className: 'text-xl font-semibold mb-4'
                        }, 'User Information'),
                        React.createElement('div', {
                            className: 'grid grid-cols-1 md:grid-cols-2 gap-4'
                        },
                            React.createElement('div', null,
                                React.createElement('p', {
                                    className: 'text-sm text-gray-500'
                                }, 'Email'),
                                React.createElement('p', {
                                    className: 'font-medium'
                                }, user?.email || 'N/A')
                            ),
                            React.createElement('div', null,
                                React.createElement('p', {
                                    className: 'text-sm text-gray-500'
                                }, 'Name'),
                                React.createElement('p', {
                                    className: 'font-medium'
                                }, user?.name || 'N/A')
                            ),
                            React.createElement('div', null,
                                React.createElement('p', {
                                    className: 'text-sm text-gray-500'
                                }, 'Role'),
                                React.createElement('p', {
                                    className: 'font-medium'
                                }, user?.role || 'user')
                            ),
                            React.createElement('div', null,
                                React.createElement('p', {
                                    className: 'text-sm text-gray-500'
                                }, 'Tenant'),
                                React.createElement('p', {
                                    className: 'font-medium'
                                }, tenant?.name || 'Personal')
                            )
                        )
                    ),
                    
                    // API Keys Card
                    React.createElement('div', {
                        className: 'bg-white rounded-lg card-shadow p-6 mb-6'
                    },
                        React.createElement('h2', {
                            className: 'text-xl font-semibold mb-4'
                        }, 'API Keys'),
                        
                        // Create new key
                        React.createElement('div', {
                            className: 'flex gap-2 mb-4'
                        },
                            React.createElement('input', {
                                type: 'text',
                                value: newKeyName,
                                onChange: (e) => setNewKeyName(e.target.value),
                                placeholder: 'API Key Name',
                                className: 'flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500'
                            }),
                            React.createElement('button', {
                                onClick: handleCreateApiKey,
                                className: 'px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition'
                            }, 'Create Key')
                        ),
                        
                        // Show created key
                        createdKey && React.createElement('div', {
                            className: 'mb-4 p-4 bg-green-50 border border-green-200 rounded-md'
                        },
                            React.createElement('p', {
                                className: 'text-sm text-green-800 font-medium mb-2'
                            }, '✅ API Key Created Successfully'),
                            React.createElement('p', {
                                className: 'text-xs text-green-600 mb-2'
                            }, 'Store this key securely. It won\'t be shown again.'),
                            React.createElement('code', {
                                className: 'block p-2 bg-white rounded border border-green-300 text-xs break-all'
                            }, createdKey.api_key)
                        ),
                        
                        // List existing keys
                        React.createElement('div', {
                            className: 'space-y-2'
                        },
                            apiKeys.length === 0 
                                ? React.createElement('p', {
                                    className: 'text-gray-500 text-sm'
                                }, 'No API keys yet')
                                : apiKeys.map(key => 
                                    React.createElement('div', {
                                        key: key.id,
                                        className: 'flex items-center justify-between p-3 bg-gray-50 rounded-md'
                                    },
                                        React.createElement('div', null,
                                            React.createElement('p', {
                                                className: 'font-medium text-sm'
                                            }, key.name),
                                            React.createElement('p', {
                                                className: 'text-xs text-gray-500'
                                            }, `${key.key_prefix}... • Used ${key.usage_count} times`)
                                        ),
                                        React.createElement('button', {
                                            onClick: () => handleRevokeKey(key.id),
                                            className: 'text-red-600 hover:text-red-800 text-sm'
                                        }, 'Revoke')
                                    )
                                )
                        )
                    ),
                    
                    // Test Authenticated Fetch
                    React.createElement('div', {
                        className: 'bg-white rounded-lg card-shadow p-6'
                    },
                        React.createElement('h2', {
                            className: 'text-xl font-semibold mb-4'
                        }, 'Test Authenticated Fetch'),
                        React.createElement('button', {
                            onClick: testAuthenticatedFetch,
                            className: 'px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition mb-4'
                        }, 'Test /api/calendar/health'),
                        testResult && React.createElement('pre', {
                            className: 'p-4 bg-gray-100 rounded-md text-xs overflow-auto'
                        }, testResult)
                    )
                )
            );
        }
        
        // Main App Component
        function App() {
            return React.createElement(AuthV2Provider, null,
                React.createElement(AuthV2TestDashboard)
            );
        }
        
        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>