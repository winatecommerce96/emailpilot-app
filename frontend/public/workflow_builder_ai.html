<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Workflow Builder - EmailPilot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #4f46e5;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .workflow-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .code-block {
            max-height: 400px;
            overflow-y: auto;
        }
        .langgraph-frame {
            min-height: 500px;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="/static/workflow_hub.html" class="text-gray-600 hover:text-gray-800 mr-4">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h1 class="text-xl font-semibold text-gray-800">AI Workflow Builder</h1>
                    <span class="ml-3 px-2 py-1 bg-green-100 text-green-700 rounded text-xs">Powered by LangGraph</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="window.location.href='/static/workflow_manager.html'" class="px-3 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg text-sm hover:bg-purple-700">
                        <i class="fas fa-layer-group mr-1"></i>Workflow Manager
                    </button>
                    <button onclick="openAgentCreator()" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700">
                        <i class="fas fa-robot mr-1"></i>Agent Creator
                    </button>
                    <button onclick="viewWorkflowAgents()" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">
                        <i class="fas fa-users mr-1"></i>View Agents
                    </button>
                    <select id="llm-selector" class="px-3 py-2 border rounded-lg text-sm">
                        <!-- OpenAI Models (Good ‚Üí Better ‚Üí Best) -->
                        <optgroup label="OpenAI">
                            <option value="gpt-4o-mini">GPT-4o Mini üí∞</option>
                            <option value="gpt-4o" selected>GPT-4o ‚öñÔ∏è</option>
                            <option value="o1-preview">O1 Preview üß†</option>
                        </optgroup>
                        <!-- Anthropic Models (Good ‚Üí Better ‚Üí Best) -->
                        <optgroup label="Anthropic">
                            <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku üí∞</option>
                            <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet ‚öñÔ∏è</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus üß†</option>
                        </optgroup>
                        <!-- Google Models (Good ‚Üí Better ‚Üí Best) -->
                        <optgroup label="Google">
                            <option value="gemini-1.5-flash-002">Gemini 1.5 Flash üí∞</option>
                            <option value="gemini-1.5-pro-002">Gemini 1.5 Pro ‚öñÔ∏è</option>
                            <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash üöÄ</option>
                        </optgroup>
                    </select>
                    <select id="client-selector" class="px-3 py-2 border rounded-lg text-sm">
                        <option value="">Loading clients...</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Variable Panel Toggle -->
        <div class="mb-4 flex justify-end">
            <button onclick="toggleVariables()" id="var-toggle-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                <i class="fas fa-code mr-2"></i>Show Variables
            </button>
        </div>

        <div class="flex gap-6">
            <!-- Variable Discovery Panel (Hidden by default) -->
            <div id="variable-panel" class="hidden w-80 flex-shrink-0">
                <div class="bg-white rounded-lg shadow-md p-4 sticky top-4">
                    <h3 class="text-lg font-semibold mb-3">üìå Available Variables</h3>
                    <div class="mb-3">
                        <input type="text" id="var-search" placeholder="Search variables..." 
                               onkeyup="filterVars()"
                               class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                    </div>
                    <div id="variable-list" class="max-h-96 overflow-y-auto space-y-1">
                        <!-- Variables will be loaded here -->
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded text-sm">
                        <p class="font-semibold mb-1">üí° Tips:</p>
                        <ul class="text-xs text-gray-700 space-y-1">
                            <li>‚Ä¢ Click to copy variable</li>
                            <li>‚Ä¢ Use {variable} syntax</li>
                            <li>‚Ä¢ AI will suggest more</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-grow">
        <!-- Prompt Interface -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Describe Your Workflow</h2>
            <p class="text-gray-600 mb-4">Tell me what you want to automate, and I'll create the workflow for you. Use {variables} for dynamic values.</p>
            
            <!-- Example Prompts -->
            <div class="mb-4">
                <p class="text-sm font-semibold text-gray-700 mb-2">Try these examples:</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="setExample('campaign')" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm hover:bg-indigo-200">
                        üìß Analyze last month's campaigns and suggest improvements
                    </button>
                    <button onclick="setExample('revenue')" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200">
                        üí∞ Generate revenue goals for Q1 2025
                    </button>
                    <button onclick="setExample('calendar')" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm hover:bg-purple-200">
                        üìÖ Plan February email calendar with AI
                    </button>
                    <button onclick="setExample('segment')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200">
                        üë• Analyze customer segments and create targeted campaigns
                    </button>
                </div>
            </div>

            <!-- Prompt Input -->
            <div class="relative">
                <textarea id="workflow-prompt" 
                          placeholder="Example: Create a workflow that analyzes campaign performance, identifies top performers, and generates recommendations for next month..."
                          class="w-full px-4 py-3 border rounded-lg resize-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                          rows="4"></textarea>
                <button onclick="generateWorkflow()" 
                        class="absolute bottom-3 right-3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                    <i class="fas fa-magic mr-2"></i>Generate
                </button>
            </div>

            <!-- Advanced Options -->
            <details class="mt-4">
                <summary class="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                    <i class="fas fa-cog mr-1"></i>Advanced Options
                </summary>
                <div class="mt-3 p-4 bg-gray-50 rounded-lg">
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Workflow Type</label>
                            <select id="workflow-type" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="auto">Auto-detect</option>
                                <option value="sequential">Sequential</option>
                                <option value="parallel">Parallel</option>
                                <option value="conditional">Conditional</option>
                                <option value="map-reduce">Map-Reduce</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Optimization</label>
                            <select id="optimization" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="balanced">Balanced</option>
                                <option value="speed">Speed</option>
                                <option value="cost">Cost</option>
                                <option value="accuracy">Accuracy</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Memory</label>
                            <select id="memory-type" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="none">No Memory</option>
                                <option value="buffer">Buffer Memory</option>
                                <option value="summary">Summary Memory</option>
                                <option value="kg">Knowledge Graph</option>
                            </select>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- Generation Status -->
        <div id="generation-status" class="hidden bg-blue-50 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <div class="typing-indicator mr-3">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <p id="status-message" class="text-blue-800">Analyzing your request...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <!-- Workflow Summary -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold mb-3">Generated Workflow</h3>
                <div id="workflow-summary" class="prose max-w-none">
                    <!-- Summary will be inserted here -->
                </div>
                
                <div class="mt-4 flex space-x-3">
                    <button onclick="deployWorkflow()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-rocket mr-2"></i>Deploy
                    </button>
                    <button onclick="testWorkflow()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-play mr-2"></i>Test
                    </button>
                    <button onclick="openInLangGraph()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-external-link-alt mr-2"></i>Open in LangGraph
                    </button>
                </div>
            </div>

            <!-- Generated Code -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold">LangChain Expression Language (LCEL)</h3>
                    <button onclick="copyCode()" class="text-sm text-indigo-600 hover:text-indigo-800">
                        <i class="fas fa-copy mr-1"></i>Copy
                    </button>
                </div>
                <div class="code-block">
                    <pre><code id="generated-code" class="language-python"></code></pre>
                </div>
            </div>

            <!-- LangGraph Visualization -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-3">LangGraph Visualization</h3>
                <div id="langgraph-container" class="langgraph-frame bg-gray-50 rounded-lg p-4">
                    <!-- LangGraph will be embedded here -->
                    <iframe id="langgraph-iframe" 
                            src="" 
                            width="100%" 
                            height="500"
                            class="rounded-lg hidden">
                    </iframe>
                    <div id="graph-placeholder" class="text-center py-20 text-gray-400">
                        <i class="fas fa-project-diagram text-6xl mb-4"></i>
                        <p>Graph visualization will appear here</p>
                    </div>
                </div>
            </div>
            </div> <!-- Close flex-grow div -->
        </div> <!-- Close flex div -->
    </div>

    <!-- Load Prism for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

    <script>
        // Variable management
        let availableVariables = [];
        let variablePanel = false;
        let availableClients = [];

        async function loadVariables() {
            try {
                const clientId = document.getElementById('client-selector').value;
                const response = await fetch(`/api/langchain/orchestration/discover-variables?client_id=${clientId}`);
                if (response.ok) {
                    const data = await response.json();
                    availableVariables = data.sources || [];
                    renderVariables();
                }
            } catch (error) {
                console.error('Error loading variables:', error);
            }
        }

        function renderVariables() {
            const container = document.getElementById('variable-list');
            if (!container) return;

            let html = '';
            const categories = {
                'client': 'üë§ Client Info',
                'performance': 'üìä Performance',
                'goals': 'üéØ Goals',
                'campaign': 'üìß Campaigns',
                'segment': 'üë• Segments'
            };

            // Group variables by category
            const grouped = {};
            availableVariables.forEach(source => {
                source.fields?.forEach(field => {
                    const category = field.category || 'other';
                    if (!grouped[category]) grouped[category] = [];
                    grouped[category].push(field);
                });
            });

            // Render by category
            Object.entries(categories).forEach(([key, label]) => {
                if (grouped[key] && grouped[key].length > 0) {
                    html += `
                        <div class="mb-3">
                            <div class="font-semibold text-sm text-gray-700 mb-1">${label}</div>
                            <div class="space-y-1">
                                ${grouped[key].slice(0, 10).map(v => `
                                    <div onclick="copyVariable('${v.name}')" class="cursor-pointer p-2 bg-gray-50 hover:bg-blue-50 rounded text-xs">
                                        <span class="font-mono text-blue-600">{${v.name}}</span>
                                        <div class="text-gray-500">${v.description || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html || '<div class="text-gray-500 text-sm">No variables found</div>';
        }

        function toggleVariables() {
            const panel = document.getElementById('variable-panel');
            const btn = document.getElementById('var-toggle-btn');
            
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.innerHTML = '<i class="fas fa-code mr-2"></i>Hide Variables';
                loadVariables();
            } else {
                panel.classList.add('hidden');
                btn.innerHTML = '<i class="fas fa-code mr-2"></i>Show Variables';
            }
        }

        function filterVars() {
            const search = document.getElementById('var-search').value.toLowerCase();
            const items = document.querySelectorAll('#variable-list > div > div > div');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'block' : 'none';
            });
        }

        function copyVariable(varName) {
            const textarea = document.getElementById('workflow-prompt');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            textarea.value = textBefore + `{${varName}}` + textAfter;
            textarea.focus();
            textarea.setSelectionRange(cursorPos + varName.length + 2, cursorPos + varName.length + 2);
            
            // Show toast
            showToast(`Inserted: {${varName}}`);
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        function extractVariablesFromPrompt(prompt) {
            const regex = /\{([a-zA-Z_][a-zA-Z0-9_]*)\}/g;
            const matches = [];
            let match;
            while ((match = regex.exec(prompt)) !== null) {
                if (!matches.includes(match[1])) {
                    matches.push(match[1]);
                }
            }
            return matches;
        }

        // Initialize on client change
        document.addEventListener('DOMContentLoaded', () => {
            // Load clients when page loads
            loadClients();
            
            document.getElementById('client-selector').addEventListener('change', () => {
                if (!document.getElementById('variable-panel').classList.contains('hidden')) {
                    loadVariables();
                }
            });
        });

        // Example prompts with variables
        const examples = {
            campaign: "Analyze the performance of last month's email campaigns for the selected client. Identify the top 3 performers by revenue and click rate. Generate specific recommendations for improving underperforming campaigns.",
            revenue: "Generate monthly revenue goals for Q1 2025 based on historical performance. Factor in seasonality, growth trends, and industry benchmarks. Create stretch goals and minimum targets.",
            calendar: "Plan the February 2025 email calendar with 8-10 campaigns. Include Valentine's Day promotions, product launches, and engagement campaigns. Optimize send times based on past performance.",
            segment: "Analyze all customer segments, identify high-value segments, and create targeted campaign strategies for each. Include personalization recommendations and optimal send frequencies."
        };

        function setExample(type) {
            document.getElementById('workflow-prompt').value = examples[type];
        }

        // Load clients from API
        async function loadClients() {
            try {
                const response = await fetch('/api/admin/clients');
                if (!response.ok) {
                    throw new Error('Failed to load clients');
                }
                const data = await response.json();
                availableClients = data.clients || [];
                
                // Sort clients by name
                availableClients.sort((a, b) => a.name.localeCompare(b.name));
                
                // Update client dropdown
                updateClientDropdown();
            } catch (error) {
                console.error('Error loading clients:', error);
                availableClients = [];
                updateClientDropdown();
            }
        }

        // Update client dropdown with loaded clients
        function updateClientDropdown() {
            const clientSelect = document.getElementById('client-selector');
            if (!clientSelect) return;
            
            clientSelect.innerHTML = '';
            
            if (availableClients.length === 0) {
                clientSelect.innerHTML = '<option value="">No clients available</option>';
                return;
            }
            
            // Add default option
            clientSelect.innerHTML = '<option value="">Select a client...</option>';
            
            // Add client options
            availableClients.forEach(client => {
                if (client.is_active !== false) {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    clientSelect.appendChild(option);
                }
            });
            
            // Select first active client by default if available
            const activeClients = availableClients.filter(c => c.is_active !== false);
            if (activeClients.length > 0) {
                clientSelect.selectedIndex = 1;
            }
        }

        async function generateWorkflow() {
            const prompt = document.getElementById('workflow-prompt').value;
            if (!prompt.trim()) {
                alert('Please describe your workflow first');
                return;
            }

            // Extract variables from prompt
            const variables = extractVariablesFromPrompt(prompt);
            if (variables.length > 0) {
                console.log('Detected variables:', variables);
            }

            // Show status
            document.getElementById('generation-status').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            
            // Update status messages
            const messages = [
                "Analyzing your request...",
                "Identifying required tools and agents...",
                "Generating LangChain workflow...",
                "Creating visual representation...",
                "Optimizing for performance..."
            ];
            
            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                if (messageIndex < messages.length) {
                    document.getElementById('status-message').textContent = messages[messageIndex];
                    messageIndex++;
                }
            }, 2000);

            try {
                // Call backend API to generate workflow
                const response = await fetch('/api/workflow/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        client_id: document.getElementById('client-selector').value,
                        llm: document.getElementById('llm-selector').value,
                        type: document.getElementById('workflow-type').value,
                        optimization: document.getElementById('optimization').value,
                        memory: document.getElementById('memory-type').value
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    throw new Error(errorData.detail || 'Failed to generate workflow');
                }

                const result = await response.json();
                
                // Clear interval
                clearInterval(messageInterval);
                
                // Display results
                displayResults(result);
                
            } catch (error) {
                clearInterval(messageInterval);
                console.error('Workflow generation error:', error);
                
                // Show error notification
                showNotification(`Error: ${error.message || 'Failed to generate workflow'}`, 'error');
                
                // For development, still show mock results
                displayMockResults(prompt);
            }
        }

        function displayResults(result) {
            // Hide status, show results
            document.getElementById('generation-status').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            // Display summary
            document.getElementById('workflow-summary').innerHTML = result.summary;
            
            // Display code
            document.getElementById('generated-code').textContent = result.code;
            Prism.highlightElement(document.getElementById('generated-code'));
            
            // Load LangGraph visualization
            if (result.graph_url) {
                document.getElementById('langgraph-iframe').src = result.graph_url;
                document.getElementById('langgraph-iframe').classList.remove('hidden');
                document.getElementById('graph-placeholder').classList.add('hidden');
            }
        }

        function displayMockResults(prompt) {
            const client = document.getElementById('client-selector').value;
            const clientName = document.getElementById('client-selector').options[
                document.getElementById('client-selector').selectedIndex
            ].text;

            // Hide status, show results
            document.getElementById('generation-status').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            // Mock summary
            const summary = `
                <div class="space-y-4">
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-semibold text-green-800 mb-2">Workflow Overview</h4>
                        <p class="text-sm text-gray-700">${prompt}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Components Used:</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>Client:</strong> ${clientName}</li>
                            <li><strong>Enhanced MCP Tools:</strong> campaigns.list, metrics.aggregate, segments.list</li>
                            <li><strong>AI Agents:</strong> campaign_analyzer, revenue_analyst, calendar_planner</li>
                            <li><strong>Data Sources:</strong> Real-time Klaviyo data via Enhanced MCP</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Workflow Steps:</h4>
                        <ol class="list-decimal list-inside text-sm space-y-1">
                            <li>Fetch campaign data from Klaviyo</li>
                            <li>Analyze performance metrics</li>
                            <li>Generate insights using AI agents</li>
                            <li>Create recommendations</li>
                            <li>Return structured results</li>
                        </ol>
                    </div>
                </div>
            `;
            document.getElementById('workflow-summary').innerHTML = summary;
            
            // Mock LCEL code
            const code = `# Generated LangChain Expression Language (LCEL) Workflow
# Client: ${clientName}

from langchain_core.runnables import RunnablePassthrough, RunnableParallel
from langgraph.graph import StateGraph, END
from typing import TypedDict, List, Dict, Any
from multi_agent.integrations.langchain_core.adapters.enhanced_mcp_adapter import get_enhanced_mcp_adapter

# Initialize Enhanced MCP adapter
adapter = get_enhanced_mcp_adapter()

# Define workflow state
class WorkflowState(TypedDict):
    """State for the workflow"""
    client_id: str
    prompt: str
    campaign_data: List[Dict[str, Any]]
    metrics: Dict[str, Any]
    insights: str
    recommendations: List[str]

# Create workflow graph
workflow = StateGraph(WorkflowState)

# Node 1: Fetch campaign data
async def fetch_campaigns(state: WorkflowState) -> WorkflowState:
    """Fetch campaign data using Enhanced MCP"""
    tools = adapter.get_tools_for_agent("campaign_analyzer", state["client_id"])
    campaigns_tool = next((t for t in tools if t.name == "klaviyo_campaigns"), None)
    
    if campaigns_tool:
        state["campaign_data"] = await campaigns_tool.ainvoke({
            "client_id": state["client_id"],
            "limit": 50
        })
    return state

# Node 2: Analyze metrics
async def analyze_metrics(state: WorkflowState) -> WorkflowState:
    """Analyze campaign metrics"""
    tools = adapter.get_tools_for_agent("revenue_analyst", state["client_id"])
    metrics_tool = next((t for t in tools if t.name == "klaviyo_metrics_aggregate"), None)
    
    if metrics_tool:
        state["metrics"] = await metrics_tool.ainvoke({
            "client_id": state["client_id"],
            "campaigns": state["campaign_data"]
        })
    return state

# Node 3: Generate insights
async def generate_insights(state: WorkflowState) -> WorkflowState:
    """Generate insights using AI"""
    from langchain_google_genai import ChatGoogleGenerativeAI
    
    llm = ChatGoogleGenerativeAI(model="gemini-1.5-flash")
    prompt = f"""
    Analyze the following campaign data and metrics:
    Campaigns: {state['campaign_data'][:5]}  # First 5 for context
    Metrics: {state['metrics']}
    
    Generate key insights and recommendations.
    """
    
    state["insights"] = await llm.ainvoke(prompt)
    return state

# Node 4: Create recommendations
async def create_recommendations(state: WorkflowState) -> WorkflowState:
    """Create actionable recommendations"""
    # Parse insights and create structured recommendations
    state["recommendations"] = [
        "Increase send frequency for high-engagement segments",
        "A/B test subject lines for better open rates",
        "Optimize send times based on engagement patterns"
    ]
    return state

# Build the workflow
workflow.add_node("fetch_campaigns", fetch_campaigns)
workflow.add_node("analyze_metrics", analyze_metrics)
workflow.add_node("generate_insights", generate_insights)
workflow.add_node("create_recommendations", create_recommendations)

# Define edges
workflow.set_entry_point("fetch_campaigns")
workflow.add_edge("fetch_campaigns", "analyze_metrics")
workflow.add_edge("analyze_metrics", "generate_insights")
workflow.add_edge("generate_insights", "create_recommendations")
workflow.add_edge("create_recommendations", END)

# Compile the workflow
app = workflow.compile()

# Execute the workflow
async def run_workflow(client_id: str, prompt: str):
    """Execute the workflow with given inputs"""
    initial_state = {
        "client_id": client_id,
        "prompt": prompt,
        "campaign_data": [],
        "metrics": {},
        "insights": "",
        "recommendations": []
    }
    
    result = await app.ainvoke(initial_state)
    return result

# Run with: asyncio.run(run_workflow("${client}", "${prompt.slice(0, 50)}..."))`;
            
            document.getElementById('generated-code').textContent = code;
            Prism.highlightElement(document.getElementById('generated-code'));
            
            // Show LangGraph placeholder
            document.getElementById('graph-placeholder').innerHTML = `
                <div class="text-center py-10">
                    <i class="fas fa-project-diagram text-6xl mb-4 text-indigo-500"></i>
                    <p class="text-gray-700 font-semibold mb-2">LangGraph Studio Ready</p>
                    <p class="text-sm text-gray-600 mb-4">Click "Open in LangGraph" to visualize this workflow</p>
                    <div class="inline-flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg">
                        <i class="fas fa-info-circle mr-2"></i>
                        <span class="text-sm">Studio URL: http://localhost:2024</span>
                    </div>
                </div>
            `;
        }

        async function deployWorkflow() {
            showNotification('Deploying workflow...', 'info');
            
            // Extract workflow details from the generated code
            const code = document.getElementById('generated-code').textContent;
            const workflowName = prompt('Enter a name for this workflow:', 'Custom Email Workflow');
            
            if (workflowName) {
                // Extract execution requirements from the workflow
                const executionParams = extractExecutionParams(code);
                
                const workflowConfig = {
                    name: workflowName,
                    description: document.getElementById('workflow-prompt').value || 'AI-generated workflow',
                    icon: 'üîÑ',
                    color: '#8A6CF7',
                    agents: extractAgentsFromCode(code),
                    langgraph_enabled: true,
                    trace_url: 'https://smith.langchain.com/studio/',
                    code: code,
                    execution_params: executionParams
                };
                
                const workflowId = await registerWorkflowWithAgents(workflowConfig);
                
                if (workflowId) {
                    setTimeout(() => {
                        showNotification('Workflow deployed successfully! Agents registered and LangGraph tracing enabled.', 'success');
                        
                        // Offer to open Agent Creator with the new workflow
                        if (confirm('Would you like to edit the agents for this workflow?')) {
                            window.open(`/static/agent_creator_enhanced.html?workflow=${workflowId}`, '_blank');
                        }
                    }, 1500);
                }
            }
        }

        function testWorkflow() {
            // Redirect to test lab with the generated workflow
            const code = document.getElementById('generated-code').textContent;
            localStorage.setItem('test-workflow', code);
            window.location.href = '/static/workflow_test_lab.html';
        }

        function openInLangGraph() {
            // Open LangGraph Studio
            window.open('http://localhost:2024', '_blank');
            showNotification('Opening LangGraph Studio...', 'info');
        }

        function openAgentCreator() {
            // Open Agent Creator with workflow context
            window.open('/static/agent_creator_enhanced.html?workflow=current', '_blank');
        }
        
        function viewWorkflowAgents() {
            // Show modal with current workflow agents
            fetchWorkflowAgents();
        }
        
        async function fetchWorkflowAgents() {
            try {
                const response = await fetch('/api/workflow-agents/workflow/calendar_workflow');
                if (response.ok) {
                    const data = await response.json();
                    showAgentsModal(data.agents);
                }
            } catch (error) {
                console.error('Failed to fetch workflow agents:', error);
                showNotification('Failed to load workflow agents', 'error');
            }
        }
        
        function showAgentsModal(agents) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900">ü§ñ Workflow Agents</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                        ${agents.map(agent => `
                            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold text-gray-800">${agent.name}</h4>
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${agent.role}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${agent.description}</p>
                                <div class="text-xs text-gray-500">
                                    <span class="inline-block bg-gray-100 rounded px-2 py-1 mr-1">Order: ${agent.order}</span>
                                    ${agent.dependencies.length > 0 ? 
                                        `<span class="inline-block bg-yellow-100 rounded px-2 py-1">Depends: ${agent.dependencies.join(', ')}</span>` : 
                                        '<span class="inline-block bg-green-100 rounded px-2 py-1">No dependencies</span>'
                                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-4 flex justify-end space-x-3">
                        <button onclick="window.open('/static/agent_creator_enhanced.html?workflow=calendar_workflow', '_blank')" 
                                class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            <i class="fas fa-edit mr-1"></i>Edit Agents
                        </button>
                        <button onclick="this.closest('.fixed').remove()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function extractExecutionParams(code) {
            // Parse the generated code to identify required parameters
            const params = {
                required: [],
                optional: []
            };
            
            // Look for TypedDict or parameter definitions in the code
            const paramRegex = /(\w+):\s*(str|int|float|bool|Optional\[.*?\])/g;
            let match;
            
            while ((match = paramRegex.exec(code)) !== null) {
                const paramName = match[1];
                const paramType = match[2];
                
                // Skip common system params
                if (['self', 'state', 'context'].includes(paramName)) continue;
                
                const param = {
                    name: paramName,
                    type: paramType.replace('Optional[', '').replace(']', ''),
                    required: !paramType.includes('Optional'),
                    description: ''
                };
                
                if (param.required) {
                    params.required.push(param);
                } else {
                    params.optional.push(param);
                }
            }
            
            // If no params found, add default ones based on workflow type
            if (params.required.length === 0) {
                const prompt = document.getElementById('workflow-prompt').value.toLowerCase();
                
                if (prompt.includes('calendar') || prompt.includes('campaign')) {
                    params.required = [
                        { name: 'client_id', type: 'str', description: 'Client identifier' },
                        { name: 'client_name', type: 'str', description: 'Client name' },
                        { name: 'selected_month', type: 'str', description: 'Target month (YYYY-MM)' }
                    ];
                    params.optional = [
                        { name: 'campaign_count', type: 'int', description: 'Number of campaigns', default: 12 },
                        { name: 'sales_goal', type: 'float', description: 'Monthly sales goal', default: 50000 }
                    ];
                } else if (prompt.includes('revenue') || prompt.includes('analysis')) {
                    params.required = [
                        { name: 'start_date', type: 'str', description: 'Analysis start date' },
                        { name: 'end_date', type: 'str', description: 'Analysis end date' }
                    ];
                    params.optional = [
                        { name: 'metrics', type: 'list', description: 'Metrics to analyze' }
                    ];
                }
            }
            
            return params;
        }
        
        function extractAgentsFromCode(code) {
            // Extract agent names from the generated code
            const agents = [];
            
            // Look for agent definitions or imports
            const agentRegex = /from\s+[\w.]+\s+import\s+(\w+_agent|\w+Agent)/gi;
            let match;
            
            while ((match = agentRegex.exec(code)) !== null) {
                const agentName = match[1].replace('_agent', '').replace('Agent', '').toLowerCase();
                if (!agents.includes(agentName)) {
                    agents.push(agentName);
                }
            }
            
            // Also look for agent node definitions
            const nodeRegex = /add_node\(['"](\w+)['"]/g;
            while ((match = nodeRegex.exec(code)) !== null) {
                const nodeName = match[1];
                if (!agents.includes(nodeName) && !['start', 'end'].includes(nodeName)) {
                    agents.push(nodeName);
                }
            }
            
            // If no agents found, use defaults
            if (agents.length === 0) {
                agents.push('analyzer', 'optimizer', 'executor');
            }
            
            return agents;
        }
        
        async function registerWorkflowWithAgents(workflowConfig) {
            try {
                // Register the workflow
                const response = await fetch('/api/workflow-agents/create-workflow', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(workflowConfig)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showNotification(`Workflow '${workflowConfig.name}' registered with ${workflowConfig.agents.length} agents`, 'success');
                    
                    // Enable LangGraph tracing
                    await enableLangGraphTracing(data.workflow_id);
                    
                    return data.workflow_id;
                }
            } catch (error) {
                console.error('Failed to register workflow:', error);
                showNotification('Failed to register workflow', 'error');
            }
        }
        
        async function enableLangGraphTracing(workflowId) {
            try {
                const response = await fetch(`/api/workflow-agents/langgraph-status/${workflowId}`);
                if (response.ok) {
                    const status = await response.json();
                    if (status.enabled) {
                        console.log(`LangGraph tracing enabled for workflow: ${workflowId}`);
                        console.log(`Trace URL: ${status.trace_url}`);
                    }
                }
            } catch (error) {
                console.error('Failed to check LangGraph status:', error);
            }
        }
        
        function copyCode() {
            const code = document.getElementById('generated-code').textContent;
            navigator.clipboard.writeText(code);
            showNotification('Code copied to clipboard!', 'success');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>