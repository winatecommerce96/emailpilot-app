INFO:     Will watch for changes in these directories: ['/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app']
INFO:     Uvicorn running on http://localhost:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [2799] using WatchFiles
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [2812]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.middleware.security:request
INFO:     127.0.0.1:52883 - "GET /health HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:52907 - "POST /api/performance/orders/monitor/rogue-creamery HTTP/1.1" 405 Method Not Allowed
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Revenue API is healthy and responding
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-17: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-16: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-15: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-14: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-13: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Revenue API is healthy and responding
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-17: {"detail":"Unable to resolve Klaviyo API key for client."}
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
INFO:app.middleware.security:request
INFO:     127.0.0.1:53032 - "GET /klaviyo_cors_fixed.html HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53032 - "GET /static/dist/component-loader.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53042 - "GET /static/dist/CalendarViewLocal.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53037 - "GET /static/dist/GeminiChatService.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53038 - "GET /static/dist/GoalsDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53034 - "GET /static/dist/FirebaseCalendarService.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53041 - "GET /static/dist/CalendarViewSimple.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53034 - "GET /static/dist/CalendarDynamic.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53038 - "GET /static/dist/EventModal.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53032 - "GET /static/dist/Calendar.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53042 - "GET /static/dist/EventModalDynamic.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53037 - "GET /static/dist/PlanCampaignDialog.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53041 - "GET /static/dist/CalendarPlanningModal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53037 - "GET /static/dist/GoalsAwareCalendarDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53041 - "GET /static/dist/GoalsDataStatus.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53032 - "GET /static/dist/GoalsCompanyDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53038 - "GET /static/dist/CalendarView.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53042 - "GET /static/dist/GoalsEnhancedDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53034 - "GET /static/dist/CalendarChat.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53037 - "GET /static/dist/AdminClientManagement.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53041 - "GET /static/dist/GoalGeneratorPanel.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53038 - "GET /static/dist/AuthScreen.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53032 - "GET /static/dist/AdminOAuthConfig.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53042 - "GET /static/dist/AdminAgentsPanel.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53034 - "GET /static/dist/UserManager.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53037 - "GET /static/dist/UserManagerEnhanced.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53041 - "GET /static/router.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53032 - "GET /static/dist/app.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53032 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53032 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53032 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53032 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:53032 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:app.middleware.security:request
INFO:     127.0.0.1:53068 - "GET /klaviyo_cors_fixed.htm HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53068 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53068 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53068 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53068 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:53068 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed after 25s timeout: 
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:     127.0.0.1:53086 - "OPTIONS /api/auth/google/me HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:53086 - "OPTIONS /api/auth/google/me HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:53086 - "OPTIONS /api/auth/google/me HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:53086 - "OPTIONS /api/auth/google/me HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:53086 - "OPTIONS /api/auth/google/me HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:53086 - "OPTIONS /api/auth/google/me HTTP/1.1" 400 Bad Request
INFO:     127.0.0.1:53086 - "OPTIONS /api/auth/google/me HTTP/1.1" 400 Bad Request
WARNING:app.services.order_monitor:Revenue API health check failed after 25s timeout: 
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
WARNING:app.services.order_monitor:Revenue API health check failed after 25s timeout: 
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
WARNING:app.services.order_monitor:Revenue API health check failed after 25s timeout: 
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
WARNING:app.services.order_monitor:Revenue API health check failed after 25s timeout: 
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53221 - "GET /static/dist/FirebaseCalendarService.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53220 - "GET /static/dist/component-loader.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53226 - "GET /static/dist/GoalsDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53227 - "GET /static/dist/CalendarViewSimple.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53225 - "GET /static/dist/GeminiChatService.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53229 - "GET /static/dist/CalendarViewLocal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53226 - "GET /static/dist/EventModal.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53220 - "GET /static/dist/CalendarDynamic.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53227 - "GET /static/dist/EventModalDynamic.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53221 - "GET /static/dist/Calendar.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53225 - "GET /static/dist/PlanCampaignDialog.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53229 - "GET /static/dist/CalendarPlanningModal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53220 - "GET /static/dist/CalendarView.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53227 - "GET /static/dist/GoalsAwareCalendarDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53226 - "GET /static/dist/CalendarChat.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53225 - "GET /static/dist/GoalsCompanyDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53221 - "GET /static/dist/GoalsEnhancedDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53229 - "GET /static/dist/GoalsDataStatus.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53226 - "GET /static/dist/GoalGeneratorPanel.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53221 - "GET /static/dist/AuthScreen.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53225 - "GET /static/dist/AdminAgentsPanel.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53227 - "GET /static/dist/AdminOAuthConfig.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53220 - "GET /static/dist/AdminClientManagement.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53229 - "GET /static/dist/UserManager.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53226 - "GET /static/dist/UserManagerEnhanced.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53221 - "GET /static/router.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:53220 - "GET /static/dist/app.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53220 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53220 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53220 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53220 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:53220 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed after 25s timeout: 
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Revenue API is healthy and responding
INFO:app.services.order_monitor:Fetching 5-day revenue data for client nnNjrbpYTs2a4lypoER1 from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client nnNjrbpYTs2a4lypoER1
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/nnNjrbpYTs2a4lypoER1/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-17: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/nnNjrbpYTs2a4lypoER1/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-16: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/nnNjrbpYTs2a4lypoER1/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-15: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/nnNjrbpYTs2a4lypoER1/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-14: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/nnNjrbpYTs2a4lypoER1/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Revenue API returned 400 for 2025-08-13: {"detail":"Unable to resolve Klaviyo API key for client."}
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client nnNjrbpYTs2a4lypoER1 in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client nnNjrbpYTs2a4lypoER1 (critical)
INFO:app.services.order_monitor:Revenue alert sent for client nnNjrbpYTs2a4lypoER1: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client nnNjrbpYTs2a4lypoER1: 5 zero-revenue days
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Revenue API is healthy and responding
INFO:app.services.order_monitor:Fetching 5-day revenue data for client rogue-creamery from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client rogue-creamery
WARNING:  WatchFiles detected changes in 'app/services/order_monitor.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for background tasks to complete. (CTRL+C to force quit)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/rogue-creamery/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/rogue-creamery/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client rogue-creamery in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client rogue-creamery (critical)
INFO:app.services.order_monitor:Revenue alert sent for client rogue-creamery: 3 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client rogue-creamery: 3 zero-revenue days
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Revenue API is healthy and responding
INFO:app.services.order_monitor:Fetching 5-day revenue data for client vlasic-labs from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client vlasic-labs
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/vlasic-labs/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: 
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/vlasic-labs/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client vlasic-labs in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client vlasic-labs (critical)
INFO:app.services.order_monitor:Revenue alert sent for client vlasic-labs: 3 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client vlasic-labs: 3 zero-revenue days
INFO:app.services.order_monitor:Checking Revenue API health at http://localhost:9090...
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Revenue API is healthy and responding
INFO:app.services.order_monitor:Fetching 5-day revenue data for client wheelchair-getaways from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client wheelchair-getaways
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/wheelchair-getaways/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/wheelchair-getaways/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client wheelchair-getaways in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client wheelchair-getaways (critical)
INFO:app.services.order_monitor:Revenue alert sent for client wheelchair-getaways: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client wheelchair-getaways: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed: 6/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 6/12 successful, 6 alerts
INFO:app.middleware.security:request
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [2812]
WARNING:  WatchFiles detected changes in 'app/services/order_monitor.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [5498]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [5622]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.middleware.security:request
INFO:     127.0.0.1:53427 - "GET /health HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53388 - "GET /static/klaviyo_cors_fixed.html HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:get_5_day_orders is deprecated, use get_5_day_revenue instead
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client rogue-creamery from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client rogue-creamery
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/rogue-creamery/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/rogue-creamery/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client rogue-creamery in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client rogue-creamery (critical)
INFO:app.services.order_monitor:Revenue alert sent for client rogue-creamery: 3 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client rogue-creamery: 3 zero-revenue days
INFO:app.middleware.security:request
INFO:     127.0.0.1:53695 - "GET /api/performance/orders/5-day/rogue-creamery HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53814 - "GET /static/klaviyo_cors_fixed.html HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53819 - "GET /health HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53819 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53822 - "GET /health HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53822 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53822 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53822 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
ERROR:main_firestore:Global exception: cannot access local variable 'user_email' where it is not associated with a value
INFO:     127.0.0.1:53822 - "GET /api/klaviyo/available-accounts HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/opt/anaconda3/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    |     return await self.app(scope, receive, send)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    |     await responder(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    |     await self.app(scope, receive, self.send_with_compression)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    |     await self.app(scope, receive, send_wrapper)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    |     logger.error(f"Error getting available accounts for {user_email}: {e}")
    |                                                          ^^^^^^^^^^
    | UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    await responder(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    await self.app(scope, receive, self.send_with_compression)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    await self.app(scope, receive, send_wrapper)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    logger.error(f"Error getting available accounts for {user_email}: {e}")
                                                         ^^^^^^^^^^
UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
INFO:app.middleware.security:request
INFO:     127.0.0.1:53827 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53827 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
ERROR:main_firestore:Global exception: cannot access local variable 'user_email' where it is not associated with a value
INFO:     127.0.0.1:53827 - "GET /api/klaviyo/available-accounts HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/opt/anaconda3/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    |     return await self.app(scope, receive, send)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    |     await responder(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    |     await self.app(scope, receive, self.send_with_compression)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    |     await self.app(scope, receive, send_wrapper)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    |     logger.error(f"Error getting available accounts for {user_email}: {e}")
    |                                                          ^^^^^^^^^^
    | UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    await responder(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    await self.app(scope, receive, self.send_with_compression)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    await self.app(scope, receive, send_wrapper)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    logger.error(f"Error getting available accounts for {user_email}: {e}")
                                                         ^^^^^^^^^^
UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
INFO:app.middleware.security:request
ERROR:main_firestore:Global exception: cannot access local variable 'user_email' where it is not associated with a value
INFO:     127.0.0.1:53874 - "GET /api/klaviyo/available-accounts HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/opt/anaconda3/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    |     return await self.app(scope, receive, send)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    |     await responder(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    |     await self.app(scope, receive, self.send_with_compression)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    |     await self.app(scope, receive, send_wrapper)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    |     logger.error(f"Error getting available accounts for {user_email}: {e}")
    |                                                          ^^^^^^^^^^
    | UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    await responder(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    await self.app(scope, receive, self.send_with_compression)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    await self.app(scope, receive, send_wrapper)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    logger.error(f"Error getting available accounts for {user_email}: {e}")
                                                         ^^^^^^^^^^
UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
INFO:app.middleware.security:request
INFO:     127.0.0.1:53889 - "GET /static/klaviyo_cors_fixed.html HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53889 - "GET /static/klaviyo_cors_fixed.html HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:53904 - "GET /health HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53904 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53904 - "GET /health HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53904 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53975 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53975 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
ERROR:main_firestore:Global exception: cannot access local variable 'user_email' where it is not associated with a value
INFO:     127.0.0.1:53975 - "GET /api/klaviyo/available-accounts HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/opt/anaconda3/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    |     return await self.app(scope, receive, send)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    |     await responder(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    |     await self.app(scope, receive, self.send_with_compression)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    |     await self.app(scope, receive, send_wrapper)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    |     logger.error(f"Error getting available accounts for {user_email}: {e}")
    |                                                          ^^^^^^^^^^
    | UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    await responder(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    await self.app(scope, receive, self.send_with_compression)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    await self.app(scope, receive, send_wrapper)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    logger.error(f"Error getting available accounts for {user_email}: {e}")
                                                         ^^^^^^^^^^
UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
INFO:app.middleware.security:request
INFO:     127.0.0.1:53981 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 401 Unauthorized
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53999 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:54004 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:54006 - "GET /favicon.ico HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:     127.0.0.1:54003 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:54003 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:53999 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:54003 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:     127.0.0.1:54004 - "GET /api/admin/users/domains/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:54038 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:53999 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:app.middleware.security:request
INFO:     127.0.0.1:54125 - "GET /api/integrations/klaviyo/auth HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client PXPdTiHtJmvdLoxHIgrT
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: POST https://a.klaviyo.com/oauth/token "HTTP/1.1 200 OK"
INFO:app.services.secrets:Secret oauth-klaviyo-damon-winatecommerce-com already exists, will add new version
INFO:app.services.secrets:Updated existing secret: oauth-klaviyo-damon-winatecommerce-com
INFO:app.api.service_oauth:Stored klaviyo OAuth token for user damon@winatecommerce.com
INFO:app.middleware.security:request
INFO:     127.0.0.1:54194 - "GET /api/integrations/klaviyo/callback?code=iSXh18SSFstRBtpabJHKVvXqM9ZRXU5FYofqYJcHQ71TpoFe&state=_Pt5q3iD8PlHOQNLrZjC1nT4JMh5e-7uOeQrEUKh8Cs HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:app.middleware.security:request
INFO:     127.0.0.1:54194 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
INFO:app.middleware.security:request
INFO:     127.0.0.1:54280 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 401 Unauthorized
INFO:app.middleware.security:request
INFO:     127.0.0.1:54280 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:54280 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
ERROR:main_firestore:Global exception: cannot access local variable 'user_email' where it is not associated with a value
INFO:     127.0.0.1:54280 - "GET /api/klaviyo/available-accounts HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/opt/anaconda3/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    |     return await self.app(scope, receive, send)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    |     await responder(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    |     await self.app(scope, receive, self.send_with_compression)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    |     await self.app(scope, receive, send_wrapper)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    |     logger.error(f"Error getting available accounts for {user_email}: {e}")
    |                                                          ^^^^^^^^^^
    | UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    await responder(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    await self.app(scope, receive, self.send_with_compression)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    await self.app(scope, receive, send_wrapper)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    logger.error(f"Error getting available accounts for {user_email}: {e}")
                                                         ^^^^^^^^^^
UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
INFO:app.middleware.security:request
INFO:     127.0.0.1:54298 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 401 Unauthorized
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/12 successful, 2 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:54000 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/12 successful, 2 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:54006 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
WARNING:  WatchFiles detected changes in 'test_klaviyo_oauth_flow.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [5622]
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [7896]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.middleware.security:request
INFO:     127.0.0.1:54619 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:54620 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client PXPdTiHtJmvdLoxHIgrT
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:  WatchFiles detected changes in 'app/api/reports.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for connections to close. (CTRL+C to force quit)
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/12 successful, 2 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:54618 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:     Waiting for background tasks to complete. (CTRL+C to force quit)
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [7896]
WARNING:  WatchFiles detected changes in 'app/services/slack_alerts.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [8809]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [9005]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.middleware.security:request
INFO:     127.0.0.1:55032 - "GET /health HTTP/1.1" 200 OK
INFO:app.api.reports:Starting weekly report generation...
INFO:app.api.reports:Found 12 clients in database
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing clients for revenue data...
INFO:app.api.reports:Processing client 1/12: Test Client API Integration (NlqSaqGB8UQ2x3r48baS)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:app.api.reports:Client Test Client API Integration has no Klaviyo API key configured - skipping
INFO:app.api.reports:Processing client 2/12: Enhanced API Test Client (PXPdTiHtJmvdLoxHIgrT)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/PXPdTiHtJmvdLoxHIgrT/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:app.api.reports:Client Enhanced API Test Client has no Klaviyo API key configured - skipping
INFO:app.api.reports:Processing client 3/12: Christopher Bean Coffee (christopher-bean-coffee)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/christopher-bean-coffee/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing client 4/12: Colorado Hemp Honey (colorado-hemp-honey)
ERROR:app.api.reports:Failed to get revenue for client Colorado Hemp Honey: 
INFO:app.api.reports:Processing client 5/12: Consumer Law Attorneys (consumer-law-attorneys)
WARNING:  WatchFiles detected changes in 'test_klaviyo_oauth_flow.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for connections to close. (CTRL+C to force quit)
ERROR:app.api.reports:Failed to get revenue for client Consumer Law Attorneys: 
INFO:app.api.reports:Processing client 6/12: First Aid Supplies Online (first-aid-supplies-online)
ERROR:app.api.reports:Failed to get revenue for client First Aid Supplies Online: 
INFO:app.api.reports:Processing client 7/12: Test Client 091332 (hCmSCRriYfB9ycVR2sES)
ERROR:app.api.reports:Failed to get revenue for client Test Client 091332: 
INFO:app.api.reports:Processing client 8/12: Milagro Mushrooms (milagro-mushrooms)
ERROR:app.api.reports:Failed to get revenue for client Milagro Mushrooms: 
INFO:app.api.reports:Processing client 9/12: Test Client Basic (nnNjrbpYTs2a4lypoER1)
ERROR:app.api.reports:Failed to get revenue for client Test Client Basic: 
INFO:app.api.reports:Processing client 10/12: Rogue Creamery (rogue-creamery)
ERROR:app.api.reports:Failed to get revenue for client Rogue Creamery: 
INFO:app.api.reports:Processing client 11/12: Vlasic Labs (vlasic-labs)
ERROR:app.api.reports:Failed to get revenue for client Vlasic Labs: 
INFO:app.api.reports:Processing client 12/12: Wheelchair Getaways (wheelchair-getaways)
ERROR:app.api.reports:Failed to get revenue for client Wheelchair Getaways: 
INFO:app.api.reports:Weekly report compiled: $3,246.13 total revenue from 1 clients
INFO:app.middleware.security:request
INFO:app.api.reports:Sending weekly report to Slack...
INFO:     127.0.0.1:55040 - "POST /api/reports/weekly/generate HTTP/1.1" 200 OK
INFO:     Waiting for background tasks to complete. (CTRL+C to force quit)
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Weekly revenue report sent to Slack successfully
INFO:app.api.reports:Weekly report sent to Slack successfully
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [9005]
WARNING:  WatchFiles detected changes in 'test_klaviyo_oauth_flow.py', 'app/api/service_oauth.py', 'check_klaviyo_status.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [9721]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [9825]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.middleware.security:request
INFO:     127.0.0.1:55252 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:     127.0.0.1:55253 - "GET /api/admin/system/status HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55251 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55377 - "GET /admin/users HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55379 - "GET /static/dist/component-loader.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55384 - "GET /static/dist/GeminiChatService.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55387 - "GET /static/dist/CalendarViewSimple.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55381 - "GET /static/dist/FirebaseCalendarService.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55385 - "GET /static/dist/GoalsDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55377 - "GET /static/styles/animations.css HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55384 - "GET /static/dist/Calendar.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55381 - "GET /static/dist/EventModal.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55379 - "GET /static/dist/CalendarViewLocal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55387 - "GET /static/dist/CalendarDynamic.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55385 - "GET /static/dist/EventModalDynamic.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55377 - "GET /static/dist/PlanCampaignDialog.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55384 - "GET /static/dist/CalendarPlanningModal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55379 - "GET /static/dist/CalendarChat.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55381 - "GET /static/dist/CalendarView.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55385 - "GET /static/dist/GoalsEnhancedDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55387 - "GET /static/dist/GoalsAwareCalendarDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55377 - "GET /static/dist/GoalsCompanyDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55384 - "GET /static/dist/GoalsDataStatus.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55379 - "GET /static/dist/GoalGeneratorPanel.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55381 - "GET /static/dist/AdminClientManagement.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55385 - "GET /static/dist/AdminOAuthConfig.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55387 - "GET /static/dist/AdminAgentsPanel.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55377 - "GET /static/dist/AuthScreen.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55384 - "GET /static/dist/UserManager.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55379 - "GET /static/dist/UserManagerEnhanced.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55381 - "GET /static/router.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:55385 - "GET /static/dist/app.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55385 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55385 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55385 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55385 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:55385 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:55384 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55385 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:55379 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:55385 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
I0000 00:00:1755463676.573929 26077802 fork_posix.cc:75] Other threads are currently calling into gRPC, skipping fork() handlers
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: 
INFO:app.middleware.security:request
INFO:     127.0.0.1:55532 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:55527 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:     127.0.0.1:55533 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:     127.0.0.1:55530 - "GET /api/admin/users/domains/stats HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55532 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55528 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
ERROR:app.api.admin_users:Error fetching user details: 400 The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/emailpilot-438321/firestore/indexes?create_composite=Cldwcm9qZWN0cy9lbWFpbHBpbG90LTQzODMyMS9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvdXNlcl9hY3Rpdml0eS9pbmRleGVzL18QARoLCgd1c2VyX2lkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg
INFO:app.middleware.security:request
INFO:     127.0.0.1:55528 - "GET /api/admin/users/damon%40winatecommerce.com HTTP/1.1" 500 Internal Server Error
ERROR:app.api.admin_users:Error fetching user details: 400 The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/emailpilot-438321/firestore/indexes?create_composite=Cldwcm9qZWN0cy9lbWFpbHBpbG90LTQzODMyMS9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvdXNlcl9hY3Rpdml0eS9pbmRleGVzL18QARoLCgd1c2VyX2lkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg
INFO:app.middleware.security:request
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
INFO:     127.0.0.1:55528 - "GET /api/admin/users/damon%40winatecommerce.com HTTP/1.1" 500 Internal Server Error
ERROR:app.api.admin_users:Error fetching user details: 400 The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/emailpilot-438321/firestore/indexes?create_composite=Cldwcm9qZWN0cy9lbWFpbHBpbG90LTQzODMyMS9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvdXNlcl9hY3Rpdml0eS9pbmRleGVzL18QARoLCgd1c2VyX2lkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg
INFO:app.middleware.security:request
INFO:     127.0.0.1:55528 - "GET /api/admin/users/damon%40winatecommerce.com HTTP/1.1" 500 Internal Server Error
ERROR:app.api.admin_users:Error fetching user details: 400 The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/emailpilot-438321/firestore/indexes?create_composite=Cldwcm9qZWN0cy9lbWFpbHBpbG90LTQzODMyMS9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvdXNlcl9hY3Rpdml0eS9pbmRleGVzL18QARoLCgd1c2VyX2lkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg
INFO:app.middleware.security:request
INFO:     127.0.0.1:55528 - "GET /api/admin/users/damon%40winatecommerce.com HTTP/1.1" 500 Internal Server Error
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:     127.0.0.1:55567 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55564 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:55566 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:     127.0.0.1:55561 - "GET /api/admin/clients HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55563 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55600 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:     127.0.0.1:55597 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55599 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:     127.0.0.1:55563 - "GET /api/goals/clients HTTP/1.1" 200 OK
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.middleware.security:request
INFO:     127.0.0.1:55563 - "GET /api/goals/RoH3lLwiC1MvFYH9qC1g HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55597 - "GET /api/goals/Colorado%20Hemp%20Honey HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55600 - "GET /api/goals/Milagro%20Mushrooms HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55599 - "GET /api/goals/6eGU2mPAHuxndfxL1CMB HTTP/1.1" 200 OK
INFO:     127.0.0.1:55563 - "GET /api/goals/Vlasic%20Labs HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55597 - "GET /api/goals/fwPF4ALdV9c8519ir9lq HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55600 - "GET /api/goals/Christopher%20Bean%20Coffee HTTP/1.1" 200 OK
I0000 00:00:1755463707.277252 26079252 fork_posix.cc:75] Other threads are currently calling into gRPC, skipping fork() handlers
INFO:app.middleware.security:request
INFO:     127.0.0.1:55599 - "GET /api/goals/Wheelchair%20Getaways HTTP/1.1" 200 OK
I0000 00:00:1755463707.306815 26078990 fork_posix.cc:75] Other threads are currently calling into gRPC, skipping fork() handlers
INFO:app.middleware.security:request
INFO:     127.0.0.1:55597 - "GET /api/goals/First%20Aid%20Supplies%20Online HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55563 - "GET /api/goals/Rogue%20Creamery HTTP/1.1" 200 OK
WARNING:app.api.performance:Client document not found: RoH3lLwiC1MvFYH9qC1g
INFO:app.api.performance:No Klaviyo API key configured for client RoH3lLwiC1MvFYH9qC1g, returning mock data
WARNING:app.api.performance:Client document not found: Colorado Hemp Honey
INFO:app.api.performance:No Klaviyo API key configured for client Colorado Hemp Honey, returning mock data
WARNING:app.api.performance:Client document not found: Milagro Mushrooms
INFO:app.api.performance:No Klaviyo API key configured for client Milagro Mushrooms, returning mock data
WARNING:app.api.performance:Client document not found: 6eGU2mPAHuxndfxL1CMB
INFO:app.api.performance:No Klaviyo API key configured for client 6eGU2mPAHuxndfxL1CMB, returning mock data
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55600 - "GET /api/performance/mtd/RoH3lLwiC1MvFYH9qC1g?year=2025&month=8 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55599 - "GET /api/performance/mtd/Colorado%20Hemp%20Honey?year=2025&month=8 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55597 - "GET /api/performance/mtd/Milagro%20Mushrooms?year=2025&month=8 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55563 - "GET /api/performance/mtd/6eGU2mPAHuxndfxL1CMB?year=2025&month=8 HTTP/1.1" 200 OK
WARNING:app.api.performance:Client document not found: Christopher Bean Coffee
INFO:app.api.performance:No Klaviyo API key configured for client Christopher Bean Coffee, returning mock data
WARNING:app.api.performance:Client document not found: fwPF4ALdV9c8519ir9lq
INFO:app.api.performance:No Klaviyo API key configured for client fwPF4ALdV9c8519ir9lq, returning mock data
WARNING:app.api.performance:Client document not found: Wheelchair Getaways
INFO:app.api.performance:No Klaviyo API key configured for client Wheelchair Getaways, returning mock data
WARNING:app.api.performance:Client document not found: Vlasic Labs
INFO:app.api.performance:No Klaviyo API key configured for client Vlasic Labs, returning mock data
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55563 - "GET /api/performance/mtd/Christopher%20Bean%20Coffee?year=2025&month=8 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55599 - "GET /api/performance/mtd/fwPF4ALdV9c8519ir9lq?year=2025&month=8 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55597 - "GET /api/performance/mtd/Wheelchair%20Getaways?year=2025&month=8 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55600 - "GET /api/performance/mtd/Vlasic%20Labs?year=2025&month=8 HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
INFO:     127.0.0.1:55599 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
WARNING:app.api.performance:Client document not found: Rogue Creamery
INFO:app.api.performance:No Klaviyo API key configured for client Rogue Creamery, returning mock data
WARNING:app.api.performance:Client document not found: First Aid Supplies Online
INFO:app.api.performance:No Klaviyo API key configured for client First Aid Supplies Online, returning mock data
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55600 - "GET /api/performance/mtd/Rogue%20Creamery?year=2025&month=8 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55563 - "GET /api/performance/mtd/First%20Aid%20Supplies%20Online?year=2025&month=8 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55599 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55600 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55599 - "GET /static/dist/OrderAlertDetailsModal.js HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55599 - "GET /static/dist/OrderAlertsPanel.js HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55596 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:app.middleware.security:request
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:     127.0.0.1:55600 - "GET /api/performance/orders/health-check HTTP/1.1" 200 OK
INFO:     127.0.0.1:55599 - "GET /api/admin/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55597 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:app.middleware.security:request
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
INFO:app.middleware.security:request
INFO:     127.0.0.1:55684 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:     127.0.0.1:55597 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55600 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:     127.0.0.1:55596 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:55684 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:app.middleware.security:request
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
INFO:     127.0.0.1:55684 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55597 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:     127.0.0.1:55600 - "GET /api/admin/users/domains/stats HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55599 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55597 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:55684 - "GET /api/admin/system/status HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55596 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
INFO:app.middleware.security:request
INFO:     127.0.0.1:55747 - "GET /static/dist/LinkServiceModal.js HTTP/1.1" 304 Not Modified
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/12 successful, 2 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55381 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.middleware.security:request
INFO:     127.0.0.1:55787 - "GET /static/klaviyo_cors_fixed.html HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55787 - "GET /static/klaviyo_cors_fixed.html HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:55790 - "GET /health HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55790 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55790 - "GET /health HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55790 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55790 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55790 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
ERROR:main_firestore:Global exception: cannot access local variable 'user_email' where it is not associated with a value
INFO:     127.0.0.1:55790 - "GET /api/klaviyo/available-accounts HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
  + Exception Group Traceback (most recent call last):
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/opt/anaconda3/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    |     result = await app(  # type: ignore[func-returns-value]
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    |     return await self.app(scope, receive, send)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    |     return await call_next(request)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    |     response: Response = await call_next(request)
    |                          ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    |     raise app_exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    |     await responder(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    |     await self.app(scope, receive, self.send_with_compression)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    |     await self.app(scope, receive, send_wrapper)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    |     response = await f(request)
    |                ^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    |     raw_response = await run_endpoint_function(
    |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    |     return await dependant.call(**values)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    |     logger.error(f"Error getting available accounts for {user_email}: {e}")
    |                                                          ^^^^^^^^^^
    | UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/protocols/http/httptools_impl.py", line 411, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/middleware/proxy_headers.py", line 69, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 187, in __call__
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/ratelimit.py", line 45, in dispatch
    return await call_next(request)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 56, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 35, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/contextlib.py", line 158, in __exit__
    self.gen.throw(value)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/middleware/security.py", line 22, in dispatch
    response: Response = await call_next(request)
                         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 156, in call_next
    raise app_exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 29, in __call__
    await responder(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 126, in __call__
    await super().__call__(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 46, in __call__
    await self.app(scope, receive, self.send_with_compression)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/sessions.py", line 85, in __call__
    await self.app(scope, receive, send_wrapper)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/opt/anaconda3/lib/python3.12/site-packages/starlette/routing.py", line 73, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 301, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 175, in get_available_klaviyo_accounts
    logger.error(f"Error getting available accounts for {user_email}: {e}")
                                                         ^^^^^^^^^^
UnboundLocalError: cannot access local variable 'user_email' where it is not associated with a value
INFO:app.middleware.security:request
INFO:     127.0.0.1:55798 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 401 Unauthorized
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:     127.0.0.1:55788 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55808 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55809 - "GET /static/components/AdminOpsPanel.js?v=1755463852686 HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://127.0.0.1:9090/healthz "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: OPTIONS http://127.0.0.1:9090/clients/test/revenue/last7 "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/admin/ops/logs/large?threshold=500M HTTP/1.1" 200 OK
INFO:     127.0.0.1:55809 - "GET /api/admin/ops/files/big?threshold=200M HTTP/1.1" 200 OK
INFO:     127.0.0.1:55808 - "GET /api/admin/revenue/status?base=http%3A%2F%2F127.0.0.1%3A9090&origin=http%3A%2F%2Flocalhost%3A3000 HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:     127.0.0.1:55864 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:55808 - "GET /api/admin/environment HTTP/1.1" 200 OK
INFO:     127.0.0.1:55788 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
I0000 00:00:1755463863.735190 26084950 fork_posix.cc:75] Other threads are currently calling into gRPC, skipping fork() handlers
I0000 00:00:1755463863.740957 26084951 fork_posix.cc:75] Other threads are currently calling into gRPC, skipping fork() handlers
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
I0000 00:00:1755463863.949830 26085543 fork_posix.cc:75] Other threads are currently calling into gRPC, skipping fork() handlers
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:app.middleware.security:request
INFO:     127.0.0.1:55788 - "GET /api/ai-models/prompts?active_only=true HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55788 - "GET /api/ai-models/stats HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/ai-models/providers HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.middleware.security:request
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:app.middleware.security:request
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:     127.0.0.1:55807 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:55788 - "GET /api/admin/clients HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:     127.0.0.1:55807 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /static/dist/MCPManagement.js HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "GET /api/mcp/clients HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55788 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:     127.0.0.1:55788 - "GET /api/mcp/models HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:     127.0.0.1:55788 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:55788 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:55788 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55807 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 0/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 0/12 successful, 0 alerts
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 0/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 0/12 successful, 0 alerts
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:55808 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:     127.0.0.1:55864 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/12 successful, 2 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55803 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 1/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 1/12 successful, 1 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:55809 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
WARNING:  WatchFiles detected changes in 'app/api/reports.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [9825]
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [12305]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
WARNING:  WatchFiles detected changes in 'app/api/reports.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [12305]
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [12426]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.api.reports:Starting weekly report generation...
INFO:app.api.reports:Found 12 clients in database
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing clients for revenue data...
INFO:app.api.reports:Processing client 1/12: Test Client API Integration (id: NlqSaqGB8UQ2x3r48baS, slug: none)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.api.reports:Client Test Client API Integration has no Klaviyo API key configured - skipping
INFO:app.middleware.security:request
INFO:     127.0.0.1:56279 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.api.reports:Processing client 2/12: Enhanced API Test Client (id: PXPdTiHtJmvdLoxHIgrT, slug: enhanced-api-test-client)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:56288 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:56285 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:56287 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:     127.0.0.1:56284 - "GET /api/admin/users/domains/stats HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/enhanced-api-test-client/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 404 Not Found"
WARNING:app.api.reports:Revenue API returned 404 for Enhanced API Test Client: {"detail":"Client 'enhanced-api-test-client' not found in Firestore"}
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.reports:Processing client 3/12: Christopher Bean Coffee (id: christopher-bean-coffee, slug: christopher-bean-coffee)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/christopher-bean-coffee/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:app.api.reports:Processing client 4/12: Colorado Hemp Honey (id: colorado-hemp-honey, slug: colorado-hemp-honey)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client PXPdTiHtJmvdLoxHIgrT
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.api.reports:Failed to get revenue for client Colorado Hemp Honey: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:app.api.reports:Processing client 5/12: Consumer Law Attorneys (id: consumer-law-attorneys, slug: consumer-law-attorneys)
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
ERROR:app.api.reports:Failed to get revenue for client Consumer Law Attorneys: 
INFO:app.api.reports:Processing client 6/12: First Aid Supplies Online (id: first-aid-supplies-online, slug: first-aid-supplies-online)
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
ERROR:app.api.reports:Failed to get revenue for client First Aid Supplies Online: 
INFO:app.api.reports:Processing client 7/12: Test Client 091332 (id: hCmSCRriYfB9ycVR2sES, slug: test-client-091332)
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
ERROR:app.api.reports:Failed to get revenue for client Test Client 091332: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
INFO:app.api.reports:Processing client 8/12: Milagro Mushrooms (id: milagro-mushrooms, slug: milagro-mushrooms)
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
ERROR:app.api.reports:Failed to get revenue for client Milagro Mushrooms: 
INFO:app.api.reports:Processing client 9/12: Test Client Basic (id: nnNjrbpYTs2a4lypoER1, slug: none)
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/12 successful, 2 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:56280 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
ERROR:app.api.reports:Failed to get revenue for client Test Client Basic: 
INFO:app.api.reports:Processing client 10/12: Rogue Creamery (id: rogue-creamery, slug: rogue-creamery)
INFO:app.middleware.security:request
INFO:     127.0.0.1:56541 - "GET /api/admin/users HTTP/1.1" 200 OK
ERROR:app.api.admin_users:Error fetching user details: 400 The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/emailpilot-438321/firestore/indexes?create_composite=Cldwcm9qZWN0cy9lbWFpbHBpbG90LTQzODMyMS9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvdXNlcl9hY3Rpdml0eS9pbmRleGVzL18QARoLCgd1c2VyX2lkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg
INFO:app.middleware.security:request
INFO:     127.0.0.1:56541 - "GET /api/admin/users/damon%40winatecommerce.com HTTP/1.1" 500 Internal Server Error
ERROR:app.api.reports:Failed to get revenue for client Rogue Creamery: 
INFO:app.api.reports:Processing client 11/12: Vlasic Labs (id: vlasic-labs, slug: vlasic-labs)
ERROR:app.api.reports:Failed to get revenue for client Vlasic Labs: 
INFO:app.api.reports:Processing client 12/12: Wheelchair Getaways (id: wheelchair-getaways, slug: wheelchair-getaways)
ERROR:app.api.reports:Failed to get revenue for client Wheelchair Getaways: 
INFO:app.api.reports:Weekly report compiled: $3,250.58 total revenue from 1 clients
INFO:app.middleware.security:request
INFO:app.api.reports:Sending weekly report to Slack...
INFO:     127.0.0.1:56268 - "POST /api/reports/weekly/generate HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Weekly revenue report sent to Slack successfully
INFO:app.api.reports:Weekly report sent to Slack successfully
INFO:app.api.reports:Starting weekly report generation...
INFO:app.api.reports:Found 12 clients in database
WARNING:app.api.reports:Revenue API health check failed: 
ERROR:app.api.reports:Weekly report generation failed: 503: Revenue API service is not available at localhost:9090
INFO:app.middleware.security:request
INFO:     127.0.0.1:56574 - "POST /api/reports/weekly/generate HTTP/1.1" 500 Internal Server Error
INFO:app.api.reports:Starting weekly report generation...
INFO:app.api.reports:Found 12 clients in database
WARNING:app.api.reports:Revenue API health check failed: 
ERROR:app.api.reports:Weekly report generation failed: 503: Revenue API service is not available at localhost:9090
INFO:app.middleware.security:request
INFO:     127.0.0.1:56594 - "POST /api/reports/weekly/generate HTTP/1.1" 500 Internal Server Error
INFO:app.middleware.security:request
INFO:     127.0.0.1:56702 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:     127.0.0.1:56704 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client PXPdTiHtJmvdLoxHIgrT
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/12 successful, 2 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:56701 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.middleware.security:request
INFO:     127.0.0.1:57130 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:57131 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 12 clients
INFO:app.services.order_monitor:Processing client 1/12: NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 2/12: PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/by-slug/enhanced-api-test-client/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client PXPdTiHtJmvdLoxHIgrT has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client PXPdTiHtJmvdLoxHIgrT
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 3/12: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/12: colorado-hemp-honey
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/12: consumer-law-attorneys
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /admin/users HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /static/styles/animations.css HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57267 - "GET /static/dist/CalendarViewLocal.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57260 - "GET /static/dist/component-loader.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57261 - "GET /static/dist/FirebaseCalendarService.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57257 - "GET /static/dist/GeminiChatService.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57264 - "GET /static/dist/GoalsDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57265 - "GET /static/dist/CalendarViewSimple.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57261 - "GET /static/dist/Calendar.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57257 - "GET /static/dist/EventModalDynamic.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57267 - "GET /static/dist/CalendarDynamic.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57265 - "GET /static/dist/CalendarPlanningModal.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57264 - "GET /static/dist/PlanCampaignDialog.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57260 - "GET /static/dist/EventModal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57261 - "GET /static/dist/CalendarChat.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57257 - "GET /static/dist/CalendarView.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57264 - "GET /static/dist/GoalsAwareCalendarDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57260 - "GET /static/dist/GoalsCompanyDashboard.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57265 - "GET /static/dist/GoalsDataStatus.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57267 - "GET /static/dist/GoalsEnhancedDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57261 - "GET /static/dist/GoalGeneratorPanel.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /static/dist/AdminClientManagement.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57260 - "GET /static/dist/AuthScreen.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57267 - "GET /static/dist/AdminAgentsPanel.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57264 - "GET /static/dist/AdminOAuthConfig.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57265 - "GET /static/dist/UserManager.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57261 - "GET /static/dist/UserManagerEnhanced.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57260 - "GET /static/dist/app.js HTTP/1.1" 304 Not Modified
INFO:     127.0.0.1:57257 - "GET /static/router.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57260 - "GET /favicon.ico HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/12: first-aid-supplies-online
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/12: hCmSCRriYfB9ycVR2sES
INFO:     127.0.0.1:57257 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57281 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
I0000 00:00:1755464438.632082 26110271 fork_posix.cc:75] Other threads are currently calling into gRPC, skipping fork() handlers
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57285 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:     127.0.0.1:57279 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57257 - "GET /api/admin/users/domains/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:57281 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57285 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:57279 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:57279 - "GET /api/admin/system/status HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/12: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57286 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:     127.0.0.1:57277 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/12: nnNjrbpYTs2a4lypoER1
INFO:app.middleware.security:request
INFO:     127.0.0.1:57286 - "GET /admin/users HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57286 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57286 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57286 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57286 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:57286 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/12: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/12: vlasic-labs
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /static/settings.html HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57340 - "GET /api/integrations/asana/status HTTP/1.1" 200 OK
INFO:app.api.klaviyo_discovery:Getting available accounts for user: admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /api/klaviyo/available-accounts HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 12/12: wheelchair-getaways
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /campaigns HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:57338 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/12 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/12 successful, 2 alerts
INFO:app.middleware.security:request
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.api.klaviyo_discovery:Starting account discovery for user: admin@emailpilot.ai
ERROR:app.services.secrets:Failed to get secret oauth-klaviyo-admin@emailpilot.ai: 400 GET https://secretmanager.googleapis.com/v1/projects/emailpilot-438321/secrets/oauth-klaviyo-admin@emailpilot.ai/versions/latest:access?%24alt=json%3Benum-encoding%3Dint: The provided Secret ID [projects/emailpilot-438321/secrets/oauth-klaviyo-admin@emailpilot.ai/versions/latest] does not match the expected format [projects/*/secrets/*/versions/*]
ERROR:app.services.klaviyo_discovery:Failed to get OAuth token for admin@emailpilot.ai: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover accounts for admin@emailpilot.ai: Failed to get OAuth token: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover and store accounts for admin@emailpilot.ai: Failed to get OAuth token: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:57380 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 500 Internal Server Error
INFO:app.api.klaviyo_discovery:Starting account discovery for user: admin@emailpilot.ai
ERROR:app.services.secrets:Failed to get secret oauth-klaviyo-admin@emailpilot.ai: 400 GET https://secretmanager.googleapis.com/v1/projects/emailpilot-438321/secrets/oauth-klaviyo-admin@emailpilot.ai/versions/latest:access?%24alt=json%3Benum-encoding%3Dint: The provided Secret ID [projects/emailpilot-438321/secrets/oauth-klaviyo-admin@emailpilot.ai/versions/latest] does not match the expected format [projects/*/secrets/*/versions/*]
ERROR:app.services.klaviyo_discovery:Failed to get OAuth token for admin@emailpilot.ai: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover accounts for admin@emailpilot.ai: Failed to get OAuth token: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover and store accounts for admin@emailpilot.ai: Failed to get OAuth token: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:57390 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 500 Internal Server Error
INFO:app.api.klaviyo_discovery:Starting account discovery for user: admin@emailpilot.ai
ERROR:app.services.secrets:Failed to get secret oauth-klaviyo-admin@emailpilot.ai: 400 GET https://secretmanager.googleapis.com/v1/projects/emailpilot-438321/secrets/oauth-klaviyo-admin@emailpilot.ai/versions/latest:access?%24alt=json%3Benum-encoding%3Dint: The provided Secret ID [projects/emailpilot-438321/secrets/oauth-klaviyo-admin@emailpilot.ai/versions/latest] does not match the expected format [projects/*/secrets/*/versions/*]
ERROR:app.services.klaviyo_discovery:Failed to get OAuth token for admin@emailpilot.ai: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover accounts for admin@emailpilot.ai: Failed to get OAuth token: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover and store accounts for admin@emailpilot.ai: Failed to get OAuth token: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:57399 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 500 Internal Server Error
INFO:app.middleware.security:request
INFO:     127.0.0.1:57399 - "POST /api/integrations/klaviyo/disconnect HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57399 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57399 - "GET /api/integrations/asana/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57399 - "GET /api/integrations/asana/auth HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:     127.0.0.1:57425 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:     127.0.0.1:57430 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57432 - "GET /favicon.ico HTTP/1.1" 200 OK
INFO:     127.0.0.1:57441 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:     127.0.0.1:57429 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
INFO:app.services.order_monitor:Starting revenue monitoring for 11 clients
INFO:app.services.order_monitor:Processing client 1/11: NlqSaqGB8UQ2x3r48baS
INFO:     127.0.0.1:57430 - "GET /api/admin/users/domains/stats HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:     127.0.0.1:57432 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:57441 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:57429 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Starting revenue monitoring for 11 clients
INFO:app.services.order_monitor:Processing client 1/11: NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client NlqSaqGB8UQ2x3r48baS from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client NlqSaqGB8UQ2x3r48baS
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.middleware.security:request
INFO:     127.0.0.1:57429 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57429 - "GET /api/integrations/klaviyo/auth HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-17T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-16T00%3A00%3A00Z&end=2025-08-16T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-15T00%3A00%3A00Z&end=2025-08-15T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-14T00%3A00%3A00Z&end=2025-08-14T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-13T00%3A00%3A00Z&end=2025-08-13T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.services.order_monitor:Client NlqSaqGB8UQ2x3r48baS has no Klaviyo API key configured - skipping
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: No API key for client NlqSaqGB8UQ2x3r48baS
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client NlqSaqGB8UQ2x3r48baS in Firestore
INFO:httpx:HTTP Request: POST https://a.klaviyo.com/oauth/token "HTTP/1.1 200 OK"
INFO:app.services.secrets:Created new secret: oauth-klaviyo-damon-winatecommerce-com
INFO:app.services.secrets:Added initial version to new secret: oauth-klaviyo-damon-winatecommerce-com
INFO:app.api.service_oauth:Stored klaviyo OAuth token for user damon@winatecommerce.com
INFO:app.middleware.security:request
INFO:     127.0.0.1:57429 - "GET /api/integrations/klaviyo/callback?code=BVjEe3drvrlUNGvpXUHZabxthwU4qPMnUHMj3KXLjjIJLyIx&state=WOyfnjOZuEmYUiZJh4MuB-jjOBDos6t5uL92B5shaQc HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57429 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client NlqSaqGB8UQ2x3r48baS (critical)
INFO:app.services.order_monitor:Revenue alert sent for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client NlqSaqGB8UQ2x3r48baS: 5 zero-revenue days
INFO:app.services.order_monitor:Processing client 2/11: PXPdTiHtJmvdLoxHIgrT
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.services.order_monitor:Fetching 5-day revenue data for client PXPdTiHtJmvdLoxHIgrT from Revenue API...
INFO:app.services.order_monitor:Starting 5-day revenue fetch for client PXPdTiHtJmvdLoxHIgrT
INFO:app.services.order_monitor:Processing client 2/11: PXPdTiHtJmvdLoxHIgrT
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-17: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 3/11: christopher-bean-coffee
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-16: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/11: colorado-hemp-honey
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-15: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/11: consumer-law-attorneys
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-14: 
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/11: first-aid-supplies-online
ERROR:app.services.order_monitor:Failed to fetch revenue data for 2025-08-13: 
INFO:app.services.order_monitor:Successfully fetched revenue data for 5 days
INFO:app.services.order_monitor:Stored revenue data for client PXPdTiHtJmvdLoxHIgrT in Firestore
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Slack alert sent for client PXPdTiHtJmvdLoxHIgrT (critical)
INFO:app.services.order_monitor:Revenue alert sent for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
INFO:app.services.order_monitor:Revenue monitoring completed for client PXPdTiHtJmvdLoxHIgrT: 5 zero-revenue days
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/11: milagro-mushrooms
INFO:app.services.order_monitor:Processing client 3/11: christopher-bean-coffee
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/11: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 4/11: colorado-hemp-honey
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/11: rogue-creamery
INFO:app.middleware.security:request
INFO:     127.0.0.1:57613 - "GET /static/styles/animations.css HTTP/1.1" 304 Not Modified
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 5/11: consumer-law-attorneys
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/11: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 6/11: first-aid-supplies-online
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/11: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 7/11: milagro-mushrooms
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 1/11 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 1/11 successful, 1 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:57425 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 8/11: nnNjrbpYTs2a4lypoER1
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 9/11: rogue-creamery
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 10/11: vlasic-labs
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Processing client 11/11: wheelchair-getaways
WARNING:app.services.order_monitor:Revenue API health check failed: 
INFO:app.services.order_monitor:Revenue monitoring completed: 2/11 clients successful
INFO:app.api.performance:Bulk order monitoring completed: 2/11 successful, 2 alerts
INFO:app.middleware.security:request
INFO:     127.0.0.1:57426 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.middleware.security:request
INFO:     127.0.0.1:57836 - "GET /static/settings.html HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:57836 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57836 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:57838 - "GET /api/integrations/asana/status HTTP/1.1" 200 OK
INFO:app.api.klaviyo_discovery:Getting available accounts for user: admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:57836 - "GET /api/klaviyo/available-accounts HTTP/1.1" 200 OK
INFO:app.api.klaviyo_discovery:Starting account discovery for user: admin@emailpilot.ai
ERROR:app.services.secrets:Failed to get secret oauth-klaviyo-admin@emailpilot.ai: 400 GET https://secretmanager.googleapis.com/v1/projects/emailpilot-438321/secrets/oauth-klaviyo-admin@emailpilot.ai/versions/latest:access?%24alt=json%3Benum-encoding%3Dint: The provided Secret ID [projects/emailpilot-438321/secrets/oauth-klaviyo-admin@emailpilot.ai/versions/latest] does not match the expected format [projects/*/secrets/*/versions/*]
ERROR:app.services.klaviyo_discovery:Failed to get OAuth token for admin@emailpilot.ai: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover accounts for admin@emailpilot.ai: Failed to get OAuth token: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover and store accounts for admin@emailpilot.ai: Failed to get OAuth token: Failed to get secret oauth-klaviyo-admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:57836 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 500 Internal Server Error
WARNING:  WatchFiles detected changes in 'app/services/klaviyo_discovery.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [12426]
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [17788]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
WARNING:  WatchFiles detected changes in 'app/services/klaviyo_discovery.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [17788]
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [17906]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
WARNING:  WatchFiles detected changes in 'app/services/klaviyo_discovery.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [17906]
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [18103]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
WARNING:  WatchFiles detected changes in 'app/services/klaviyo_discovery.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [18103]
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
INFO:main_firestore:Service OAuth module available (Asana/Klaviyo)
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.email_sms_agents:Successfully imported MCP server classes
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:main_firestore:âœ… Authentication enabled with Google OAuth, Email/Password, and Guest access
INFO:main_firestore:ðŸ”— Auth compatibility shim enabled under /api/auth
INFO:main_firestore:âœ… Service integrations enabled (Asana/Klaviyo OAuth)
INFO:main_firestore:âœ… AI Models Management router enabled
INFO:main_firestore:âœ… Agent Configuration router enabled
INFO:     Started server process [18239]
INFO:     Waiting for application startup.
INFO:main_firestore:ðŸš€ Starting up with Google Cloud Project ID: emailpilot-438321
INFO:main_firestore:âœ… Secret Manager health check passed (test secret not found as expected).
INFO:main_firestore:âœ… Firestore health check passed
INFO:     Application startup complete.
INFO:app.api.reports:Starting weekly report generation...
INFO:app.api.reports:Found 11 clients in database
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing clients for revenue data...
INFO:app.api.reports:Processing client 1/11: Test Client API Integration (id: NlqSaqGB8UQ2x3r48baS, slug: none)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:app.api.reports:Client Test Client API Integration has no Klaviyo API key configured - skipping
INFO:app.api.reports:Processing client 2/11: Enhanced API Test Client (id: PXPdTiHtJmvdLoxHIgrT, slug: enhanced-api-test-client)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/enhanced-api-test-client/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 404 Not Found"
WARNING:app.api.reports:Revenue API returned 404 for Enhanced API Test Client: {"detail":"Client 'enhanced-api-test-client' not found in Firestore"}
INFO:app.api.reports:Processing client 3/11: Christopher Bean Coffee (id: christopher-bean-coffee, slug: christopher-bean-coffee)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/christopher-bean-coffee/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing client 4/11: Colorado Hemp Honey (id: colorado-hemp-honey, slug: colorado-hemp-honey)
ERROR:app.api.reports:Failed to get revenue for client Colorado Hemp Honey: 
INFO:app.api.reports:Processing client 5/11: Consumer Law Attorneys (id: consumer-law-attorneys, slug: consumer-law-attorneys)
ERROR:app.api.reports:Failed to get revenue for client Consumer Law Attorneys: 
INFO:app.api.reports:Processing client 6/11: First Aid Supplies Online (id: first-aid-supplies-online, slug: first-aid-supplies-online)
ERROR:app.api.reports:Failed to get revenue for client First Aid Supplies Online: 
INFO:app.api.reports:Processing client 7/11: Milagro Mushrooms (id: milagro-mushrooms, slug: milagro-mushrooms)
ERROR:app.api.reports:Failed to get revenue for client Milagro Mushrooms: 
INFO:app.api.reports:Processing client 8/11: Test Client Basic (id: nnNjrbpYTs2a4lypoER1, slug: none)
ERROR:app.api.reports:Failed to get revenue for client Test Client Basic: 
INFO:app.api.reports:Processing client 9/11: Rogue Creamery (id: rogue-creamery, slug: rogue-creamery)
ERROR:app.api.reports:Failed to get revenue for client Rogue Creamery: 
INFO:app.api.reports:Processing client 10/11: Vlasic Labs (id: vlasic-labs, slug: vlasic-labs)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/vlasic-labs/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing client 11/11: Wheelchair Getaways (id: wheelchair-getaways, slug: wheelchair-getaways)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/wheelchair-getaways/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:app.api.reports:Weekly report compiled: $4,827.61 total revenue from 3 clients
INFO:app.middleware.security:request
INFO:app.api.reports:Sending weekly report to Slack...
INFO:     127.0.0.1:58543 - "POST /api/reports/weekly/generate HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Weekly revenue report sent to Slack successfully
INFO:app.api.reports:Weekly report sent to Slack successfully
INFO:app.api.reports:Starting weekly report generation...
INFO:app.api.reports:Found 11 clients in database
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing clients for revenue data...
INFO:app.api.reports:Processing client 1/11: Test Client API Integration (id: NlqSaqGB8UQ2x3r48baS, slug: none)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:app.api.reports:Client Test Client API Integration has no Klaviyo API key configured - skipping
INFO:app.api.reports:Processing client 2/11: Enhanced API Test Client (id: PXPdTiHtJmvdLoxHIgrT, slug: enhanced-api-test-client)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/enhanced-api-test-client/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 404 Not Found"
WARNING:app.api.reports:Revenue API returned 404 for Enhanced API Test Client: {"detail":"Client 'enhanced-api-test-client' not found in Firestore"}
INFO:app.api.reports:Processing client 3/11: Christopher Bean Coffee (id: christopher-bean-coffee, slug: christopher-bean-coffee)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/christopher-bean-coffee/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing client 4/11: Colorado Hemp Honey (id: colorado-hemp-honey, slug: colorado-hemp-honey)
INFO:app.middleware.security:request
INFO:     127.0.0.1:58767 - "GET /static/settings.html HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58767 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58769 - "GET /favicon.ico HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58767 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58769 - "GET /api/integrations/asana/status HTTP/1.1" 200 OK
INFO:app.api.klaviyo_discovery:Getting available accounts for user: admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:58767 - "GET /api/klaviyo/available-accounts HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/colorado-hemp-honey/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing client 5/11: Consumer Law Attorneys (id: consumer-law-attorneys, slug: consumer-law-attorneys)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/consumer-law-attorneys/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
WARNING:app.api.reports:Revenue API returned 400 for Consumer Law Attorneys: {"detail":"Unable to resolve a valid 'Placed Order' metric_id."}
INFO:app.api.reports:Processing client 6/11: First Aid Supplies Online (id: first-aid-supplies-online, slug: first-aid-supplies-online)
INFO:app.api.reports:Starting weekly report generation...
INFO:app.api.reports:Found 11 clients in database
INFO:httpx:HTTP Request: GET http://localhost:9090/healthz "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing clients for revenue data...
INFO:app.api.reports:Processing client 1/11: Test Client API Integration (id: NlqSaqGB8UQ2x3r48baS, slug: none)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/NlqSaqGB8UQ2x3r48baS/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 400 Bad Request"
INFO:app.api.reports:Client Test Client API Integration has no Klaviyo API key configured - skipping
INFO:app.api.reports:Processing client 2/11: Enhanced API Test Client (id: PXPdTiHtJmvdLoxHIgrT, slug: enhanced-api-test-client)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/enhanced-api-test-client/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 404 Not Found"
WARNING:app.api.reports:Revenue API returned 404 for Enhanced API Test Client: {"detail":"Client 'enhanced-api-test-client' not found in Firestore"}
INFO:app.api.reports:Processing client 3/11: Christopher Bean Coffee (id: christopher-bean-coffee, slug: christopher-bean-coffee)
INFO:httpx:HTTP Request: GET http://localhost:9090/clients/first-aid-supplies-online/revenue/last7?start=2025-08-10T00%3A00%3A00Z&end=2025-08-17T23%3A59%3A59Z&recompute=true "HTTP/1.1 200 OK"
INFO:app.api.reports:Processing client 7/11: Milagro Mushrooms (id: milagro-mushrooms, slug: milagro-mushrooms)
INFO:app.middleware.security:request
INFO:     127.0.0.1:58847 - "POST /api/integrations/klaviyo/disconnect HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58847 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58847 - "GET /api/integrations/asana/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58847 - "GET /api/integrations/klaviyo/auth HTTP/1.1" 200 OK
ERROR:app.api.reports:Failed to get revenue for client Christopher Bean Coffee: 
INFO:httpx:HTTP Request: POST https://a.klaviyo.com/oauth/token "HTTP/1.1 200 OK"
INFO:app.services.secrets:Created new secret: oauth-klaviyo-damon-winatecommerce-com
INFO:app.services.secrets:Added initial version to new secret: oauth-klaviyo-damon-winatecommerce-com
INFO:app.api.service_oauth:Stored klaviyo OAuth token for user damon@winatecommerce.com
INFO:app.api.reports:Processing client 4/11: Colorado Hemp Honey (id: colorado-hemp-honey, slug: colorado-hemp-honey)
INFO:app.middleware.security:request
INFO:     127.0.0.1:58847 - "GET /api/integrations/klaviyo/callback?code=RMnNHHOutywo9Xv8R2eqbBK1q10cChysmyLGGmZwNWAIyfSo&state=Rk9Jy3_Igtc8qkp-R7ycAMTpEhiBuPJZFIKDkrS8mZE HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58847 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58871 - "GET /api/integrations/asana/status HTTP/1.1" 200 OK
INFO:app.api.klaviyo_discovery:Getting available accounts for user: admin@emailpilot.ai
INFO:app.middleware.security:request
ERROR:app.api.reports:Failed to get revenue for client Milagro Mushrooms: 
INFO:     127.0.0.1:58847 - "GET /api/klaviyo/available-accounts HTTP/1.1" 200 OK
INFO:app.api.klaviyo_discovery:Starting account discovery for user: admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover accounts for admin@emailpilot.ai: No Klaviyo OAuth token found for user admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover and store accounts for admin@emailpilot.ai: No Klaviyo OAuth token found for user admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:58871 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 404 Not Found
INFO:app.api.reports:Processing client 8/11: Test Client Basic (id: nnNjrbpYTs2a4lypoER1, slug: none)
INFO:app.api.klaviyo_discovery:Starting account discovery for user: admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover accounts for admin@emailpilot.ai: No Klaviyo OAuth token found for user admin@emailpilot.ai
ERROR:app.services.klaviyo_discovery:Failed to discover and store accounts for admin@emailpilot.ai: No Klaviyo OAuth token found for user admin@emailpilot.ai
INFO:app.middleware.security:request
INFO:     127.0.0.1:58903 - "POST /api/klaviyo/discover-accounts HTTP/1.1" 404 Not Found
ERROR:app.api.reports:Failed to get revenue for client Colorado Hemp Honey: 
INFO:app.api.reports:Processing client 5/11: Consumer Law Attorneys (id: consumer-law-attorneys, slug: consumer-law-attorneys)
ERROR:app.api.reports:Failed to get revenue for client Test Client Basic: 
INFO:app.api.reports:Processing client 9/11: Rogue Creamery (id: rogue-creamery, slug: rogue-creamery)
INFO:app.middleware.security:request
INFO:     127.0.0.1:58903 - "POST /api/integrations/klaviyo/disconnect HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58903 - "GET /api/integrations/klaviyo/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58903 - "GET /api/integrations/asana/status HTTP/1.1" 200 OK
ERROR:app.api.reports:Failed to get revenue for client Consumer Law Attorneys: 
INFO:app.api.reports:Processing client 6/11: First Aid Supplies Online (id: first-aid-supplies-online, slug: first-aid-supplies-online)
ERROR:app.api.reports:Failed to get revenue for client Rogue Creamery: 
INFO:app.api.reports:Processing client 10/11: Vlasic Labs (id: vlasic-labs, slug: vlasic-labs)
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET / HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/styles/animations.css HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/component-loader.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/FirebaseCalendarService.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/GeminiChatService.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/GoalsDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/CalendarViewSimple.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/CalendarViewLocal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/Calendar.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/CalendarDynamic.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/EventModal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/EventModalDynamic.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/PlanCampaignDialog.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/CalendarPlanningModal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/CalendarChat.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/CalendarView.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/GoalsAwareCalendarDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/GoalsEnhancedDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/GoalsCompanyDashboard.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/GoalsDataStatus.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/GoalGeneratorPanel.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/AdminClientManagement.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/AdminOAuthConfig.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/AdminAgentsPanel.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/AuthScreen.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/UserManager.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /static/dist/UserManagerEnhanced.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58926 - "GET /static/router.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58928 - "GET /static/dist/app.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58928 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58928 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58928 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58928 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:58928 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:58928 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:58935 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.performance:Starting bulk order monitoring for all clients
INFO:app.middleware.security:request
ERROR:app.api.reports:Failed to get revenue for client First Aid Supplies Online: 
INFO:app.middleware.security:request
INFO:     127.0.0.1:58943 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:app.services.ai_models_service:OpenAI client initialized
INFO:app.services.ai_models_service:Gemini client initialized
INFO:app.services.ai_models_service:Claude client initialized
/opt/anaconda3/lib/python3.12/site-packages/google/cloud/firestore_v1/base_collection.py:304: UserWarning: Detected filter using positional arguments. Prefer using the 'filter' keyword argument instead.
  return query.where(field_path, op_string, value)
INFO:app.services.agent_service_enhanced:Loaded Firestore prompt config for agent: content_strategist
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: content_strategist with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: copywriter with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: designer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: segmentation_expert with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: ab_test_coordinator with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: compliance_officer with AI Models integration
INFO:app.services.agent_service_enhanced:Loaded enhanced agent: performance_analyst with AI Models integration
INFO:     127.0.0.1:58924 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.api.reports:Processing client 7/11: Milagro Mushrooms (id: milagro-mushrooms, slug: milagro-mushrooms)
INFO:app.middleware.security:request
INFO:app.middleware.security:request
ERROR:app.api.reports:Failed to get revenue for client Vlasic Labs: 
INFO:     127.0.0.1:58935 - "GET /api/agent-config/agents HTTP/1.1" 200 OK
INFO:     127.0.0.1:58928 - "GET /api/admin/users/domains/stats HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58943 - "GET /api/admin/ops/logs/large?threshold=1G HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.api.reports:Processing client 11/11: Wheelchair Getaways (id: wheelchair-getaways, slug: wheelchair-getaways)
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:email-sms-mcp-server:Loaded agent: content_strategist
INFO:email-sms-mcp-server:Loaded agent: copywriter
INFO:email-sms-mcp-server:Loaded agent: designer
INFO:email-sms-mcp-server:Loaded agent: segmentation_expert
INFO:email-sms-mcp-server:Loaded agent: ab_test_coordinator
INFO:email-sms-mcp-server:Loaded agent: compliance_officer
INFO:email-sms-mcp-server:Loaded agent: performance_analyst
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /api/admin/system/status HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:58943 - "GET /static/dist/LinkServiceModal.js HTTP/1.1" 304 Not Modified
INFO:app.middleware.security:request
INFO:     127.0.0.1:58924 - "GET /api/integrations/klaviyo/auth HTTP/1.1" 200 OK
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
WARNING:app.services.order_monitor:Revenue API health check failed: 
ERROR:app.services.order_monitor:Revenue API is not available - aborting bulk monitoring
INFO:app.api.performance:Bulk order monitoring completed: 0/0 successful, 0 alerts
INFO:app.middleware.security:request
INFO:app.middleware.security:request
INFO:     127.0.0.1:58944 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
INFO:     127.0.0.1:58926 - "POST /api/performance/orders/monitor-all HTTP/1.1" 200 OK
ERROR:app.api.reports:Failed to get revenue for client Milagro Mushrooms: 
INFO:httpx:HTTP Request: POST https://a.klaviyo.com/oauth/token "HTTP/1.1 200 OK"
INFO:app.services.secrets:Created new secret: oauth-klaviyo-damon-winatecommerce-com
INFO:app.services.secrets:Added initial version to new secret: oauth-klaviyo-damon-winatecommerce-com
INFO:app.api.service_oauth:Stored klaviyo OAuth token for user damon@winatecommerce.com
INFO:app.middleware.security:request
INFO:     127.0.0.1:58944 - "GET /api/integrations/klaviyo/callback?code=sUwUEYRaCpR8ueYqK0lIWNyEXJs2FRb2LDffletKjhD9G314&state=gFp0_ix_MJZdiCLATK5CGD_0nsd5ueFc9xkVlaTu4Ak HTTP/1.1" 200 OK
INFO:app.api.reports:Processing client 8/11: Test Client Basic (id: nnNjrbpYTs2a4lypoER1, slug: none)
INFO:app.middleware.security:request
ERROR:app.api.reports:Failed to get revenue for client Wheelchair Getaways: 
INFO:app.api.reports:Weekly report compiled: $5,269.09 total revenue from 3 clients
INFO:     127.0.0.1:58944 - "GET /api/admin/users HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:app.api.reports:Sending weekly report to Slack...
INFO:     127.0.0.1:58715 - "POST /api/reports/weekly/generate HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Weekly revenue report sent to Slack successfully
INFO:app.api.reports:Weekly report sent to Slack successfully
ERROR:app.api.reports:Failed to get revenue for client Test Client Basic: 
INFO:app.api.reports:Processing client 9/11: Rogue Creamery (id: rogue-creamery, slug: rogue-creamery)
ERROR:app.api.reports:Failed to get revenue for client Rogue Creamery: 
INFO:app.api.reports:Processing client 10/11: Vlasic Labs (id: vlasic-labs, slug: vlasic-labs)
ERROR:app.api.reports:Failed to get revenue for client Vlasic Labs: 
INFO:app.api.reports:Processing client 11/11: Wheelchair Getaways (id: wheelchair-getaways, slug: wheelchair-getaways)
ERROR:app.api.reports:Failed to get revenue for client Wheelchair Getaways: 
INFO:app.api.reports:Weekly report compiled: $0.00 total revenue from 0 clients
INFO:app.middleware.security:request
INFO:app.api.reports:Sending weekly report to Slack...
INFO:     127.0.0.1:58812 - "POST /api/reports/weekly/generate HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://hooks.slack.com/services/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 "HTTP/1.1 200 OK"
INFO:app.services.slack_alerts:Weekly revenue report sent to Slack successfully
INFO:app.api.reports:Weekly report sent to Slack successfully
INFO:app.middleware.security:request
INFO:     127.0.0.1:59096 - "GET /profile/settings HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:59096 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:59098 - "GET /api/auth/google/me HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:59098 - "GET /api/clients/ HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:59098 - "GET /api/goals/clients HTTP/1.1" 200 OK
INFO:app.middleware.security:request
INFO:     127.0.0.1:59098 - "GET /api/reports/ HTTP/1.1" 200 OK
INFO:app.api.performance:No Klaviyo API key found for client NlqSaqGB8UQ2x3r48baS
INFO:app.api.performance:No Klaviyo API key configured for client NlqSaqGB8UQ2x3r48baS, returning mock data
INFO:app.middleware.security:request
INFO:     127.0.0.1:59098 - "GET /api/performance/mtd/NlqSaqGB8UQ2x3r48baS HTTP/1.1" 200 OK
WARNING:  WatchFiles detected changes in 'app/api/klaviyo_discovery.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [18239]
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
Process SpawnProcess-15:
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 78, in subprocess_started
    target(sockets=sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 65, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 69, in serve
    await self._serve(sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 76, in _serve
    config.load()
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/config.py", line 433, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/main_firestore.py", line 66, in <module>
    from app.api.klaviyo_discovery import router as klaviyo_discovery_router
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 17, in <module>
    from app.deps import get_current_user
ImportError: cannot import name 'get_current_user' from 'app.deps' (/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/deps/__init__.py)
WARNING:  WatchFiles detected changes in 'app/api/reports.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
WARNING:  WatchFiles detected changes in 'app/api/klaviyo_discovery.py'. Reloading...
Process SpawnProcess-16:
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 78, in subprocess_started
    target(sockets=sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 65, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 69, in serve
    await self._serve(sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 76, in _serve
    config.load()
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/config.py", line 433, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/main_firestore.py", line 66, in <module>
    from app.api.klaviyo_discovery import router as klaviyo_discovery_router
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 17, in <module>
    from app.deps import get_current_user
ImportError: cannot import name 'get_current_user' from 'app.deps' (/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/deps/__init__.py)
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
Process SpawnProcess-17:
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 78, in subprocess_started
    target(sockets=sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 65, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 69, in serve
    await self._serve(sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 76, in _serve
    config.load()
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/config.py", line 433, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/main_firestore.py", line 66, in <module>
    from app.api.klaviyo_discovery import router as klaviyo_discovery_router
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 17, in <module>
    from app.deps import get_current_user
ImportError: cannot import name 'get_current_user' from 'app.deps' (/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/deps/__init__.py)
WARNING:  WatchFiles detected changes in 'scripts/standardize_klaviyo_keys.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
Process SpawnProcess-18:
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 78, in subprocess_started
    target(sockets=sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 65, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 69, in serve
    await self._serve(sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 76, in _serve
    config.load()
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/config.py", line 433, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/main_firestore.py", line 66, in <module>
    from app.api.klaviyo_discovery import router as klaviyo_discovery_router
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 17, in <module>
    from app.deps import get_current_user
ImportError: cannot import name 'get_current_user' from 'app.deps' (/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/deps/__init__.py)
WARNING:  WatchFiles detected changes in 'app/api/admin_clients.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
Process SpawnProcess-19:
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 78, in subprocess_started
    target(sockets=sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 65, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 69, in serve
    await self._serve(sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 76, in _serve
    config.load()
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/config.py", line 433, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/main_firestore.py", line 66, in <module>
    from app.api.klaviyo_discovery import router as klaviyo_discovery_router
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 17, in <module>
    from app.deps import get_current_user
ImportError: cannot import name 'get_current_user' from 'app.deps' (/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/deps/__init__.py)
WARNING:  WatchFiles detected changes in 'app/api/admin_clients.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
Process SpawnProcess-20:
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 78, in subprocess_started
    target(sockets=sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 65, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 69, in serve
    await self._serve(sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 76, in _serve
    config.load()
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/config.py", line 433, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/main_firestore.py", line 66, in <module>
    from app.api.klaviyo_discovery import router as klaviyo_discovery_router
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 17, in <module>
    from app.deps import get_current_user
ImportError: cannot import name 'get_current_user' from 'app.deps' (/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/deps/__init__.py)
WARNING:  WatchFiles detected changes in 'app/api/service_oauth.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
Process SpawnProcess-21:
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 78, in subprocess_started
    target(sockets=sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 65, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 69, in serve
    await self._serve(sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 76, in _serve
    config.load()
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/config.py", line 433, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/main_firestore.py", line 66, in <module>
    from app.api.klaviyo_discovery import router as klaviyo_discovery_router
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 17, in <module>
    from app.deps import get_current_user
ImportError: cannot import name 'get_current_user' from 'app.deps' (/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/deps/__init__.py)
WARNING:  WatchFiles detected changes in 'app/api/service_oauth.py'. Reloading...
INFO:app.deps.firestore:Using Firestore credentials from Secret Manager
Process SpawnProcess-22:
Traceback (most recent call last):
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 314, in _bootstrap
    self.run()
  File "/opt/anaconda3/lib/python3.12/multiprocessing/process.py", line 108, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/_subprocess.py", line 78, in subprocess_started
    target(sockets=sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 65, in run
    return asyncio.run(self.serve(sockets=sockets))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 194, in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "uvloop/loop.pyx", line 1518, in uvloop.loop.Loop.run_until_complete
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 69, in serve
    await self._serve(sockets)
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/server.py", line 76, in _serve
    config.load()
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/config.py", line 433, in load
    self.loaded_app = import_from_string(self.app)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/site-packages/uvicorn/importer.py", line 19, in import_from_string
    module = importlib.import_module(module_str)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/anaconda3/lib/python3.12/importlib/__init__.py", line 90, in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<frozen importlib._bootstrap>", line 1387, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1360, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1331, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 935, in _load_unlocked
  File "<frozen importlib._bootstrap_external>", line 995, in exec_module
  File "<frozen importlib._bootstrap>", line 488, in _call_with_frames_removed
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/main_firestore.py", line 66, in <module>
    from app.api.klaviyo_discovery import router as klaviyo_discovery_router
  File "/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/api/klaviyo_discovery.py", line 17, in <module>
    from app.deps import get_current_user
ImportError: cannot import name 'get_current_user' from 'app.deps' (/Users/Damon/klaviyo/klaviyo-audit-automation/emailpilot-app/app/deps/__init__.py)
INFO:     Stopping reloader process [2799]
