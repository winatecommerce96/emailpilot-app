#!/bin/bash

# Frontend Build Script - EmailPilot Dashboard
# Compiles JSX components to plain JavaScript for production
set -e

echo "ğŸš€ Building EmailPilot Frontend..."

# Check if we're in the right directory
if [[ ! -f "frontend/public/index.html" ]]; then
    echo "âŒ Error: Must run from project root directory"
    echo "   Looking for frontend/public/index.html"
    exit 1
fi

# Create dist directory if it doesn't exist
mkdir -p frontend/public/dist

# Check for required tools
if ! command -v npx &> /dev/null; then
    echo "âŒ Error: npm/npx not found. Please install Node.js"
    exit 1
fi

# Install esbuild locally if not available
if ! npx esbuild --version &> /dev/null; then
    echo "ğŸ“¦ Installing esbuild..."
    npm init -y &> /dev/null || true
    npm install --save-dev esbuild
fi

echo "ğŸ¨ Building Tailwind CSS..."

# Build Tailwind CSS
if [[ -f "frontend/public/styles/main.css" ]]; then
    echo "  ğŸ“„ Compiling Tailwind CSS..."
    npx tailwindcss -i frontend/public/styles/main.css -o frontend/public/dist/styles.css --minify
    echo "  âœ… CSS compiled to frontend/public/dist/styles.css"
else
    echo "  âš ï¸  No main.css found, skipping Tailwind build"
fi

echo "ğŸ”§ Compiling JSX components..."

# Define components that need JSX compilation
JSX_COMPONENTS=(
    "app.js"
    "AdminAgentsPanel.js"
    "Calendar.js"
    "EventModal.js" 
    "CalendarChat.js"
    "CalendarView.js"
    "GoalsAwareCalendarDashboard.js"
    "GoalsEnhancedDashboard.js"
    "GoalsCompanyDashboard.js"
    "GoalsDataStatus.js"
    "GoalGeneratorPanel.js"
    "GoalsDashboard.js"
    "CalendarViewLocal.js"
    "MCPManagement.js"
    "CalendarDynamic.js"
    "EventModalDynamic.js"
    "PlanCampaignDialog.js"
    "CalendarPlanningModal.js"
    "AuthScreen.js"
    "UserManager.js"
    "UserManagerEnhanced.js"
    "AIModelsAdmin.js"
    "OrderAlertsPanel.js"
    "OrderAlertDetailsModal.js"
)

# Compile main app.js with esbuild for browser compatibility
echo "  ğŸ“„ Compiling app.js..."
npx esbuild frontend/public/app.js \
  --outfile=frontend/public/dist/app.js \
  --format=iife \
  --global-name=EmailPilotApp \
  --jsx=transform \
  --jsx-factory=React.createElement \
  --jsx-fragment=React.Fragment \
  --target=es2015 \
  --bundle=false \
  --loader:.js=jsx \
  --tsconfig-raw='{"compilerOptions":{"jsx":"react","jsxFactory":"React.createElement","jsxFragmentFactory":"React.Fragment"}}'

# Compile each JSX component individually
for component in "${JSX_COMPONENTS[@]}"; do
    if [[ -f "frontend/public/components/$component" ]]; then
        echo "  ğŸ“„ Compiling $component..."
        
        # Extract component name without .js extension
        component_name=$(basename "$component" .js)
        
        # Compile with esbuild for browser compatibility  
        npx esbuild "frontend/public/components/$component" \
          --outfile="frontend/public/dist/$component" \
          --format=iife \
          --jsx=transform \
          --jsx-factory=React.createElement \
          --jsx-fragment=React.Fragment \
          --target=es2015 \
          --bundle=false \
          --loader:.js=jsx \
          --tsconfig-raw='{"compilerOptions":{"jsx":"react","jsxFactory":"React.createElement","jsxFragmentFactory":"React.Fragment"}}'
    else
        echo "  âš ï¸  Component $component not found, skipping..."
    fi
done

# Copy non-JSX components directly to dist
echo "ğŸ“‹ Copying non-JSX components..."
NON_JSX_COMPONENTS=(
    "FirebaseCalendarService.js"
    "GeminiChatService.js"
    "CalendarViewSimple.js"
    "AdminClientManagement.js"
    "AdminOAuthConfig.js"
    "DevLogin.js"
    "MCPKlaviyoManagement.js"
    "MCPManagementLocal.js"
    "UnifiedClientForm.js"
)

# Copy utilities from utils folder
echo "ğŸ“‹ Copying utility files..."
UTILITY_FILES=(
    "auth.js"
)

for utility in "${UTILITY_FILES[@]}"; do
    if [[ -f "frontend/public/utils/$utility" ]]; then
        echo "  ğŸ“„ Copying utils/$utility..."
        cp "frontend/public/utils/$utility" "frontend/public/dist/$utility"
    else
        echo "  âš ï¸  Utility $utility not found, skipping..."
    fi
done

for component in "${NON_JSX_COMPONENTS[@]}"; do
    if [[ -f "frontend/public/components/$component" ]]; then
        echo "  ğŸ“„ Copying $component..."
        cp "frontend/public/components/$component" "frontend/public/dist/$component"
    else
        echo "  âš ï¸  Component $component not found, skipping..."
    fi
done

# Create a component loader to ensure proper loading order
echo "ğŸ”— Creating component loader..."
cat > frontend/public/dist/component-loader.js << 'EOF'
// Component loader with event-based ready signal
(function() {
    const requiredComponents = ['CalendarView', 'Calendar', 'EventModal', 'CalendarViewSimple'];
    
    function checkComponents() {
        const missing = [];
        const available = [];
        
        requiredComponents.forEach(name => {
            if (typeof window[name] === 'function') {
                available.push(name);
            } else {
                missing.push(name);
            }
        });
        
        console.log('Component check:', {
            required: requiredComponents,
            available: available,
            missing: missing
        });
        
        return missing.length === 0;
    }
    
    function notifyReady() {
        console.log('All components ready!');
        window.dispatchEvent(new CustomEvent('components:ready', {
            detail: { components: requiredComponents }
        }));
    }
    
    // Check immediately
    if (checkComponents()) {
        notifyReady();
    } else {
        // Poll for components
        let attempts = 0;
        const maxAttempts = 30; // 3 seconds at 100ms intervals
        
        const interval = setInterval(() => {
            attempts++;
            if (checkComponents()) {
                clearInterval(interval);
                notifyReady();
            } else if (attempts >= maxAttempts) {
                clearInterval(interval);
                console.warn('Component loading timeout - some components may be missing');
                window.dispatchEvent(new CustomEvent('components:timeout', {
                    detail: { 
                        missing: requiredComponents.filter(n => typeof window[n] !== 'function')
                    }
                }));
            }
        }, 100);
    }
})();
EOF

echo "âœ… Frontend build complete!"
echo ""
echo "ğŸ“ Generated files:"
echo "   - frontend/public/dist/app.js (main application bundle)"
echo "   - frontend/public/dist/component-loader.js (loading utilities)"
echo "   - frontend/public/dist/*.js (individual components)"
echo ""
echo "ğŸ¯ Next steps:"
echo "   1. Update frontend/public/index.html to use compiled bundles"
echo "   2. Remove Babel runtime dependency"
echo "   3. Test the application"
echo ""
echo "ğŸ’¡ To run: ./scripts/build_frontend.sh"