<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theme System Test</title>
    <!-- Early theme application -->
    <script>
        (function(){
            var t=localStorage.getItem('emailpilot-theme')||'system';
            var d=t==='system'?(window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'):t;
            document.documentElement.setAttribute('data-theme',d);
            document.documentElement.style.backgroundColor=d==='dark'?'#111827':'#f9fafb';
        })();
    </script>
    <style>
        /* Theme variables */
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-primary: #374151;
        }
        
        [data-theme="light"],
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-primary: #e5e7eb;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-item {
            padding: 15px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.pass {
            background-color: #10b981;
            color: white;
        }
        
        .status.fail {
            background-color: #ef4444;
            color: white;
        }
        
        button {
            padding: 10px 20px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #2563eb;
        }
        
        #log {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üé® EmailPilot Theme System Test</h1>
            <p>This page tests the global theme system implementation.</p>
        </div>
        
        <div class="card">
            <h2>Theme Controls</h2>
            <button onclick="setTheme('light')">‚òÄÔ∏è Light Mode</button>
            <button onclick="setTheme('dark')">üåô Dark Mode</button>
            <button onclick="setTheme('system')">üñ•Ô∏è System Default</button>
            <button onclick="toggleTheme()">üîÑ Toggle Theme</button>
        </div>
        
        <div class="card">
            <h2>Test Results</h2>
            <div class="test-grid" id="tests"></div>
        </div>
        
        <div class="card">
            <h2>Current State</h2>
            <div id="state"></div>
        </div>
        
        <div class="card">
            <h2>Event Log</h2>
            <div id="log"></div>
        </div>
    </div>
    
    <!-- Load theme system -->
    <script src="/static/dist/theme-global.js"></script>
    
    <script>
        const log = (msg) => {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `[${time}] ${msg}<br>` + logDiv.innerHTML;
        };
        
        const updateState = () => {
            const stateDiv = document.getElementById('state');
            const current = window.EmailPilotTheme ? window.EmailPilotTheme.get() : 'unknown';
            const saved = localStorage.getItem('emailpilot-theme') || 'not set';
            const dataAttr = document.documentElement.getAttribute('data-theme') || 'not set';
            const system = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            
            stateDiv.innerHTML = `
                <p><strong>Current Theme:</strong> ${current}</p>
                <p><strong>Saved Preference:</strong> ${saved}</p>
                <p><strong>HTML Attribute:</strong> ${dataAttr}</p>
                <p><strong>System Preference:</strong> ${system}</p>
            `;
        };
        
        const runTests = () => {
            const tests = [
                {
                    name: 'Theme API Exists',
                    test: () => window.EmailPilotTheme !== undefined
                },
                {
                    name: 'Set Method Works',
                    test: () => typeof window.EmailPilotTheme.set === 'function'
                },
                {
                    name: 'Get Method Works',
                    test: () => typeof window.EmailPilotTheme.get === 'function'
                },
                {
                    name: 'Toggle Method Works',
                    test: () => typeof window.EmailPilotTheme.toggle === 'function'
                },
                {
                    name: 'HTML Attribute Set',
                    test: () => document.documentElement.hasAttribute('data-theme')
                },
                {
                    name: 'CSS Variables Active',
                    test: () => {
                        const style = getComputedStyle(document.documentElement);
                        return style.getPropertyValue('--bg-primary').trim() !== '';
                    }
                },
                {
                    name: 'No Flash on Load',
                    test: () => {
                        // Check if theme was applied before DOMContentLoaded
                        return document.documentElement.hasAttribute('data-theme');
                    }
                },
                {
                    name: 'LocalStorage Works',
                    test: () => {
                        try {
                            localStorage.setItem('test', 'test');
                            localStorage.removeItem('test');
                            return true;
                        } catch (e) {
                            return false;
                        }
                    }
                }
            ];
            
            const testsDiv = document.getElementById('tests');
            testsDiv.innerHTML = '';
            
            tests.forEach(({ name, test }) => {
                const passed = test();
                const div = document.createElement('div');
                div.className = 'test-item';
                div.innerHTML = `
                    <div>${name}</div>
                    <div class="status ${passed ? 'pass' : 'fail'}">
                        ${passed ? 'PASS' : 'FAIL'}
                    </div>
                `;
                testsDiv.appendChild(div);
                log(`Test "${name}": ${passed ? 'PASS' : 'FAIL'}`);
            });
        };
        
        const setTheme = (theme) => {
            if (window.EmailPilotTheme) {
                window.EmailPilotTheme.set(theme);
                log(`Theme set to: ${theme}`);
                updateState();
            } else {
                log('ERROR: Theme system not loaded');
            }
        };
        
        const toggleTheme = () => {
            if (window.EmailPilotTheme) {
                const newTheme = window.EmailPilotTheme.toggle();
                log(`Theme toggled to: ${newTheme}`);
                updateState();
            } else {
                log('ERROR: Theme system not loaded');
            }
        };
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            log('Page loaded');
            
            // Listen for theme changes
            if (window.EmailPilotTheme) {
                window.EmailPilotTheme.listen((theme, userTheme) => {
                    log(`Theme changed to: ${theme} (user setting: ${userTheme})`);
                    updateState();
                });
            }
            
            // Run tests
            setTimeout(() => {
                runTests();
                updateState();
            }, 100);
        });
        
        // Listen for theme ready event
        window.addEventListener('theme-ready', () => {
            log('Theme system ready');
        });
        
        // Listen for theme change events
        window.addEventListener('theme-change', (e) => {
            log(`Theme change event: ${e.detail.theme}`);
        });
    </script>
</body>
</html>